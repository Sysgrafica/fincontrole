<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinControle - Seu Controle Financeiro Pessoal</title>

    <!-- Google Fonts - Open Sans para compatibilidade com o tema Argon -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Argon Dashboard Tailwind CSS -->
    <link rel="stylesheet" href="css/argon-dashboard-tailwind.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase Config -->
    <script src="firebase-config.js"></script>
    
    <!-- Arquivo de compatibilidade para funções removidas -->
    <script src="js/compatibility.js"></script>
    
    <!-- Scripts de correção -->
    <script src="fix_modals.js"></script>
    <script src="fix_pix.js"></script>
    
    <!-- Script para corrigir problemas de data -->
    <script>
        // Função para obter a data local corrigida no formato YYYY-MM-DD (antes do carregamento do fix_modals.js)
        window.getDataLocalCorrigida = function() {
            const data = new Date();
            // Configurar para o fuso horário de São Paulo/Brasil (GMT-3)
            const options = { timeZone: 'America/Sao_Paulo' };
            const dataLocal = new Intl.DateTimeFormat('pt-BR', options).format(data).split('/');
            const dia = dataLocal[0];
            const mes = dataLocal[1];
            const ano = dataLocal[2];
            return `${ano}-${mes}-${dia}`;
        };
    </script>

    <!-- Estilos CSS personalizados -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Argon Dashboard JavaScript -->
    <script src="js/argon-dashboard.js"></script>
    
    <!-- Dashboard Utilities -->
    <script src="js/dashboard-utils.js"></script>
    
    <style>
        :root {
            --primary-color: #5e72e4; /* Cor primária do Argon */
            --secondary-color: #2dce89; /* Cor secundária do Argon */
            --danger-color: #f5365c; /* Cor de perigo do Argon */
            --text-color: #344767; /* Cor de texto do Argon */
            --subtle-text-color: #67748e;
            --border-color: #e9ecef;
            --surface-color: #ffffff;
            --background-color: #f8f9fa;
            --shadow: 0 7px 14px rgba(50,50,93,.1), 0 3px 6px rgba(0,0,0,.08);
            --border-radius: 8px;
        }
        
        /* Viewport meta tag já está adicionada no head */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
        }
        
        /* Dashboard Sections */
        .dashboard-section {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--surface-color);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .dashboard-section .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background-color: #f8fafc;
        }
        
        .dashboard-section .card-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        #dashboard-cards-container {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        /* Botões de navegação do dashboard */
        #btn-dashboard-anterior:hover,
        #btn-dashboard-atual:hover,
        #btn-dashboard-proximo:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        #btn-dashboard-atual.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* --- Rendas Page --- */
        .rendas-card {
            padding: 0;
            overflow: visible;
        }
        
        .rendas-container {
            padding: 1rem;
        }
        
        .card-actions {
            display: flex;
            gap: 10px;
        }
        
        .rendas-view-toggle {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }
        
        .rendas-view-toggle .view-btn {
            background: none;
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .rendas-view-toggle .view-btn:first-child {
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }
        
        .rendas-view-toggle .view-btn:last-child {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }
        
        .rendas-view-toggle .view-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .table-responsive {
            overflow-x: auto;
            width: 100%;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .renda-card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            padding: 1rem;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
        }
        
        .renda-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .renda-card-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin: 0;
        }
        
        .renda-card-valor {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--secondary-color);
        }
        
        .renda-card-info {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .renda-card-info-label {
            font-weight: 500;
            color: var(--subtle-text-color);
        }
        
        .renda-card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: auto;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }
        
        .renda-card-actions button {
            padding: 0.5rem;
            background: none;
            border: none;
            cursor: pointer;
            border-radius: var(--border-radius);
            transition: all 0.2s;
        }
        
        .renda-card-actions button:hover {
            background-color: var(--border-color);
        }
        
        .filtro-mes-rendas {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .text-success {
            color: var(--secondary-color);
            font-weight: 500;
        }
        
        .text-danger {
            color: var(--danger-color);
            font-weight: 500;
        }
        
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--subtle-text-color);
            font-style: italic;
        }
        
        /* Responsividade para a página de Rendas */
        @media (max-width: 768px) {
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .card-actions {
                width: 100%;
            }
            
            .filtro-mes-rendas {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .filtro-mes-rendas select,
            .filtro-mes-rendas button {
                width: 100%;
            }
            
            .rendas-table-view {
                display: none;
            }
            
            .rendas-cards-view {
                display: block !important;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 576px) {
            .btn-texto {
                display: none;
            }
            
            .card-actions .btn {
                padding: 0.5rem;
                width: auto;
            }
        }

        /* --- Auth Container --- */
        #auth-container {
            width: 100%;
            max-width: 450px;
            padding: 2rem;
            margin: 2rem auto;
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        #auth-container h1 {
            text-align: center;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            font-weight: 600;
        }
        #auth-container h1 .fa-wallet {
            margin-right: 0.5rem;
        }

        #auth-container p {
            text-align: center;
            color: var(--subtle-text-color);
            margin-bottom: 2rem;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--subtle-text-color);
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }

        .auth-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-group input:not([type="checkbox"]),
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-group input[type="checkbox"] {
            margin-right: 0.5rem;
        }
        
        .form-group input[type="file"] {
            padding: 0.5rem 0;
            border: none;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }

        .btn {
            width: 100%;
            padding: 0.875rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: var(--border-color) !important;
            color: var(--subtle-text-color) !important;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--primary-hover);
        }
        .btn-primary:disabled {
            background-color: #a5b4fc;
            cursor: not-allowed;
        }

        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            color: var(--subtle-text-color);
            margin: 1.5rem 0;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid var(--border-color);
        }
        .divider:not(:empty)::before {
            margin-right: .25em;
        }
        .divider:not(:empty)::after {
            margin-left: .25em;
        }
        
        .btn-google {
            background-color: white;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        .btn-google:hover {
        
        /* Estilos para valores positivos e negativos nas movimentações */
        .valor-positivo {
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .valor-negativo {
            color: var(--danger-color);
            font-weight: 600;
        }
        
        /* Estilo para a navegação entre meses */
        .mes-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
        }
            background-color: #f9fafb;
        }

        .auth-link {
            display: block;
            text-align: right;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: var(--primary-color);
            text-decoration: none;
        }
        .auth-link:hover {
            text-decoration: underline;
        }

        /* --- App Container --- */
        #app-container {
            display: none; /* Hidden by default */
            visibility: hidden;
            width: 100vw;
            height: 100vh;
            grid-template-columns: 260px 1fr;
            grid-template-rows: 70px 1fr;
            grid-template-areas:
                "sidebar topbar"
                "sidebar main";
            transition: all 0.3s ease;
            position: fixed;
            top: 0;
            left: 0;
            background-color: var(--background-color);
        }

        .sidebar {
            grid-area: sidebar;
            background-color: var(--surface-color);
            padding: 1.5rem;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 2rem;
        }

        .sidebar nav ul {
            list-style: none;
        }
        .sidebar nav li a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: var(--border-radius);
            color: var(--subtle-text-color);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        .sidebar nav li a:hover {
            background-color: #f1f5f9;
            color: var(--text-color);
        }
        .sidebar nav li a.active {
            background-color: #eef2ff;
            color: var(--primary-color);
        }
        .sidebar nav li a .fa-fw {
            width: 20px;
        }
        .sidebar .logout-link {
            margin-top: auto;
        }
        /* Estilos para o menu dropdown */
        .sidebar nav li.dropdown {
            position: relative;
        }
        .sidebar nav li.dropdown .dropdown-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .sidebar nav li.dropdown .dropdown-icon {
            font-size: 0.75rem;
            transition: transform 0.3s ease;
        }
        .sidebar nav li.dropdown.active .dropdown-icon {
            transform: rotate(180deg);
        }
        .sidebar nav li.dropdown .dropdown-menu {
            display: none;
            margin-left: 1.5rem;
            margin-top: -0.25rem;
            margin-bottom: 0.5rem;
        }
        .sidebar nav li.dropdown.active .dropdown-menu {
            display: block;
        }
        .sidebar nav li.dropdown .dropdown-menu a {
            font-size: 0.95rem;
            padding: 0.75rem 1rem;
        }
        /* Estilos para o módulo de horas extras */
        .horas-extras-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .filtro-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: var(--light-bg-color);
            border-radius: var(--border-radius);
        }
        
        .horas-resumo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .resumo-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background-color: var(--light-bg-color);
            border-radius: var(--border-radius);
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-sm);
        }
        
        .resumo-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .horas-extras-view-toggle {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
        }
        
        .horas-extras-view-toggle .view-btn {
            padding: 0.5rem;
            background-color: var(--light-bg-color);
            border: 1px solid var(--border-color);
            color: var(--subtle-text-color);
        }
        
        .horas-extras-view-toggle .view-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .horas-extras-view-toggle .view-btn:first-child {
            border-radius: var(--border-radius) 0 0 var(--border-radius);
        }
        
        .horas-extras-view-toggle .view-btn:last-child {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }
        
        .horas-extras-table-view {
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }
        
        .horas-extras-cards-view {
            display: none;
            margin-bottom: 1.5rem;
        }
        
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .hora-extra-card {
            background-color: var(--light-bg-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s ease;
        }
        
        .hora-extra-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .hora-extra-card h4 {
            margin-top: 0;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .hora-extra-card-content {
            margin: 1rem 0;
        }
        
        .hora-extra-card-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .hora-extra-card-label {
            font-weight: 500;
            color: var(--subtle-text-color);
        }
        
        .hora-extra-card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .horas-extras-acoes {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 1.5rem;
        }
        
        /* Responsividade para dispositivos móveis */
        @media (max-width: 768px) {
            .filtro-container {
                grid-template-columns: 1fr;
            }
            
            .horas-resumo {
                grid-template-columns: 1fr;
            }
            
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            .horas-extras-acoes {
                flex-direction: column;
                align-items: stretch;
            }
            
            .data-table th, .data-table td {
                padding: 0.5rem;
                font-size: 0.9rem;
            }
            
            .btn-texto {
                display: none;
            }
            
            .add-hora-extra-btn .fa-plus {
                margin-right: 0;
            }
        }

        .topbar {
            grid-area: topbar;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .topbar h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .user-profile span {
            font-weight: 500;
        }
        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }


        main {
            grid-area: main;
            overflow-y: auto;
            padding: 2rem;
            background-color: var(--background-color);
        }

        .main-content {
            display: none;
        }
        .main-content.active {
            display: block;
        }

        .card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .card-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        /* Generic table styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .data-table th {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--subtle-text-color);
            text-transform: uppercase;
        }
        .data-table td .actions {
            display: flex;
            gap: 0.5rem;
        }
        .data-table td .actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            color: var(--subtle-text-color);
        }
        .data-table td .actions button:hover {
            color: var(--primary-color);
        }
        .data-table td .actions .delete-btn:hover {
            color: var(--danger-color);
        }
        .data-table td .actions .view-btn:hover {
            color: var(--secondary-color);
        }
        
        .data-table td small {
            color: var(--subtle-text-color);
            font-size: 0.875rem;
        }
        
        .data-table td .cartao-info,
        .data-table td .banco-info {
            margin-top: 0.25rem;
            font-size: 0.875rem;
        }
        
        .status-icon {
            margin-right: 8px;
            display: inline-flex;
            align-items: center;
        }
        
        .text-success {
            color: #28a745;
        }
        
        .text-warning {
            color: #ffc107;
        }
        
        .data-table td .actions button:hover {
            color: var(--primary-color);
        }

        /* Estilos para os boxes de resumo no Dashboard */
        .summary-box {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background-color: #f8fafc;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .summary-box:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        .summary-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            color: white;
        }
        .summary-icon i {
            font-size: 1.5rem;
        }
        .summary-info h4 {
            font-size: 1rem;
            margin: 0;
            color: var(--subtle-text-color);
        }
        .summary-info p {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0.25rem 0 0 0;
        }
        
        /* Estilos para o dashboard moderno e responsivo */
        .dashboard-card {
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .dashboard-header-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .dashboard-header-title i {
            color: var(--primary-color);
            font-size: 1.2rem;
        }
        
        .dashboard-header-title h3 {
            margin: 0;
            white-space: nowrap;
            font-size: 1.2rem;
        }
        
        #dashboard-mes-atual {
            font-weight: 600;
        }
        
        .dashboard-month-nav {
            display: flex;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .dashboard-month-nav .btn-icon {
            margin: 0;
            border-radius: 0;
            padding: 0.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-right: 1px solid var(--border-color);
        }
        
        .dashboard-month-nav .btn-icon:last-child {
            border-right: none;
        }
        
        .dashboard-month-nav .btn-icon.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        #dashboard-cards-container {
            padding: 1rem;
        }
        
        .dashboard-section {
            background-color: white;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: #f8fafc;
        }
        
        .section-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .btn-section-action {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .dashboard-content {
            padding: 1rem;
        }
        
        .loading-state, .empty-state {
            text-align: center;
            padding: 2rem 0;
            color: var(--subtle-text-color);
        }
        
        .loading-state i, .empty-state i {
            font-size: 2rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .loading-state p, .empty-state p {
            margin-bottom: 1.5rem;
        }
        
        .empty-state {
            display: none;
        }
        
        .data-list {
            display: none;
        }
        
        /* Cards de resumo no dashboard */
        .dashboard-summary-cards {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin: 1rem;
        }
        
        .summary-card {
            flex: 1;
            min-width: 200px;
            padding: 1.25rem;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .summary-card h4 {
            margin-bottom: 0.75rem;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .summary-card p {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }
        
        .summary-card.positive {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
        }
        
        .summary-card.positive h4 {
            color: #003a8c;
        }
        
        .summary-card.positive p {
            color: var(--secondary-color);
        }
        
        .summary-card.negative {
            background-color: #fff1f0;
            border: 1px solid #ffa39e;
        }
        
        .summary-card.negative h4 {
            color: #a8071a;
        }
        
        .summary-card.negative p {
            color: var(--danger-color);
        }
        
        .summary-card.balance {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
        }
        
        .summary-card.balance h4 {
            color: #135200;
        }
        
        /* Estilos para as tabelas no dashboard */
        #dashboard-page .data-table {
            margin-bottom: 0;
            width: 100%;
            display: table;
        }
        
        /* Responsividade para tabelas no dashboard */
        @media (max-width: 768px) {
            .dashboard-summary-cards {
                flex-direction: column;
            }
            
            .summary-card {
                min-width: 100%;
            }
            
            .btn-section-action .btn-texto {
                display: none;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .dashboard-month-nav {
                align-self: flex-end;
            }
            
            #dashboard-page .data-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            #dashboard-page .data-table th,
            #dashboard-page .data-table td {
                white-space: nowrap;
            }
        }
        
        /* Estilos para cards de dados em visualização mobile */
        .dashboard-card-view {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .dashboard-data-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .dashboard-data-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding: 0;
            border: none;
        }
        
        .dashboard-data-card .card-title {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-color);
        }
        
        .dashboard-data-card .card-value {
            font-weight: 700;
            font-size: 1.25rem;
        }
        
        .dashboard-data-card .card-value.positive {
            color: var(--secondary-color);
        }
        
        .dashboard-data-card .card-value.negative {
            color: var(--danger-color);
        }
        
        .dashboard-data-card .card-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .dashboard-data-card .card-item {
            display: flex;
            flex-direction: column;
        }
        
        .dashboard-data-card .card-label {
            font-size: 0.8rem;
            color: var(--subtle-text-color);
            margin-bottom: 0.25rem;
        }
        
        .dashboard-data-card .card-text {
            font-weight: 500;
        }
        
        .dashboard-data-card .card-footer {
            display: flex;
            justify-content: flex-end;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }
        
        @media (max-width: 576px) {
            #dashboard-page .data-table {
                display: none;
            }
            
            .dashboard-card-view {
                display: flex;
            }
        }
        
        /* Estilos para os status */
        .text-success {
            color: var(--secondary-color);
        }
        .text-danger {
            color: var(--danger-color);
        }
        .text-primary {
            color: var(--primary-color);
        }
        .text-muted {
            color: var(--subtle-text-color);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal.is-open {
            display: flex;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
        }

        /* --- Notification Container --- */
        #notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        /* Estilos para a página de configurações */
        .config-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .config-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .config-section h4 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-color);
        }
        
        .config-option {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .config-option label {
            font-weight: 500;
        }
        
        .config-option small {
            color: var(--subtle-text-color);
            font-size: 0.875rem;
        }
        
        .config-option.checkbox-option {
            flex-direction: row;
            align-items: center;
            gap: 0.75rem;
        }
        
        .config-option.checkbox-option input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
        }
        
        .config-option .color-picker {
            width: 100px;
            height: 40px;
            padding: 0;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
        }
        
        .config-actions {
            margin-top: 2rem;
            display: flex;
            justify-content: flex-end;
        }
        
        .danger-zone {
            margin-top: 1.5rem;
            padding: 1rem;
            border: 1px dashed var(--danger-color);
            border-radius: var(--border-radius);
        }
        
        .danger-zone h5 {
            color: var(--danger-color);
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Estilo específico para o botão de excluir todas as rendas */
        #delete-all-rendas-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
        }
        
        #delete-all-rendas-btn:hover {
            background-color: #b91c1c; /* Vermelho mais escuro ao passar o mouse */
        }

        .notification {
            min-width: 300px;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            color: white;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.5s forwards, fadeOut 0.5s 4.5s forwards;
        }

        .notification.success { background-color: var(--secondary-color); }
        .notification.error { background-color: var(--danger-color); }
        .notification.info { background-color: var(--primary-color); }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* Responsividade */
        @media (max-width: 768px) {
            #app-container {
                grid-template-columns: 1fr;
                grid-template-rows: 70px auto 1fr;
                 grid-template-areas:
                    "topbar"
                    "sidebar"
                    "main";
            }
            .sidebar {
                flex-direction: row;
                justify-content: center;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: 0.5rem;
            }
            .sidebar-header, .sidebar .logout-link {
                display: none;
            }
            .sidebar nav ul {
                display: flex;
                gap: 0.5rem;
            }
             .sidebar nav li a {
                flex-direction: column;
                gap: 0.25rem;
                padding: 0.5rem;
                font-size: 0.75rem;
             }
            .topbar {
                padding: 0 1rem;
            }
            .user-profile span {
                display: none;
            }
            main {
                padding: 1rem;
            }
        }

        /* Estilos para a página de cartões */
        #cartoes-sidebar-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .cartao-sidebar-item {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .cartao-sidebar-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .cartao-sidebar-item.active {
            border-left: 3px solid var(--primary-color);
            background-color: #f8fafc;
        }
        
        .cartao-sidebar-item h4 {
            margin: 0;
            font-size: 1rem;
            color: var(--text-color);
        }
        
        .cartao-sidebar-item p {
            margin: 0.25rem 0 0 0;
            font-size: 0.875rem;
            color: var(--subtle-text-color);
        }
        
        .cartao-sidebar-empty {
            text-align: center;
            padding: 1.5rem 0;
            color: var(--subtle-text-color);
        }
    </style>
    
    <!-- CSS adicional para remodelar a página de cartões (moderno e responsivo) -->
    <style>
        /* Estilo modernizado e responsivo para a página de cartões */
        .cartoes-grid {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 600px;
        }
        
        .cartoes-sidebar {
            border-right: 1px solid var(--border-color);
            padding: 1.25rem;
            height: 100%;
            overflow-y: auto;
        }
        
        .cartoes-sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .cartoes-sidebar-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }
        
        .cartoes-sidebar-header .btn {
            width: auto;
            padding: 0.35rem 0.75rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }
        
        #cartoes-sidebar-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .cartao-sidebar-item {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .cartao-sidebar-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        
        .cartao-sidebar-item.active {
            border-left: 3px solid var(--primary-color);
            background-color: #f8fafc;
        }
        
        .cartao-sidebar-item h4 {
            margin: 0;
            font-size: 1rem;
            color: var(--text-color);
        }
        
        .cartao-sidebar-item p {
            margin: 0.25rem 0 0 0;
            font-size: 0.875rem;
            color: var(--subtle-text-color);
        }
        
        .cartao-sidebar-empty {
            text-align: center;
            padding: 2rem 0;
            color: var(--subtle-text-color);
        }
        
        .cartoes-conteudo {
            padding: 1.5rem;
            overflow: visible;
            height: auto;
        }
        
        #cartao-detalhe-vazio {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 400px;
            color: var(--subtle-text-color);
        }
        
        #cartao-detalhe-vazio i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        #cartao-detalhe {
            display: none;
            overflow: visible;
            height: auto;
        }
        
        .cartao-header {
            margin-bottom: 2rem;
        }
        
        .cartao-visual {
            background: linear-gradient(135deg, var(--primary-color), #3b82f6);
            color: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }
        
        .cartao-visual::after {
            content: '';
            position: absolute;
            bottom: -20px;
            right: -20px;
            width: 140px;
            height: 140px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        
        .cartao-info-principal {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .cartao-identificacao h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .cartao-identificacao p {
            margin: 0.5rem 0 0 0;
            opacity: 0.8;
        }
        
        #cartao-detalhe-bandeira {
            font-size: 1.75rem;
        }
        
        .cartao-info-financeira {
            display: flex;
            justify-content: space-between;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .cartao-limite, .cartao-valor-fatura {
            flex: 1;
        }
        
        .cartao-limite small, .cartao-valor-fatura small {
            opacity: 0.8;
            font-size: 0.85rem;
        }
        
        .cartao-limite h4, .cartao-valor-fatura h4 {
            margin: 0.25rem 0 0 0;
            font-size: 1.25rem;
            word-break: break-word;
            font-weight: 500;
        }
        
        .cartao-acoes-principais {
            text-align: center;
        }
        
        .btn-light {
            background-color: white;
            color: var(--primary-color);
            font-weight: 500;
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .btn-light:hover {
            background-color: #f9fafb;
            transform: translateY(-2px);
        }
        
        .cartao-info-boxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .info-box {
            background-color: var(--surface-color);
            padding: 1rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        .info-box small {
            color: var(--subtle-text-color);
            font-size: 0.8rem;
        }
        
        .info-box h4 {
            margin: 0.25rem 0 0 0;
            word-break: break-word;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .cartao-acoes-secundarias {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .cartao-acoes-secundarias .btn {
            flex: 1;
            max-width: 180px;
            padding: 0.75rem 0.5rem;
            font-weight: 500;
        }
        
        .cartao-fatura {
            overflow: visible;
            height: auto;
            margin-top: 2rem;
            margin-bottom: 3rem;
        }
        
        .fatura-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .fatura-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .fatura-navigation {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .fatura-navigation .btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            white-space: nowrap;
        }
        
        #fatura-vazia {
            display: none;
            text-align: center;
            padding: 3rem 0;
            color: var(--subtle-text-color);
        }
        
        #fatura-vazia i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .fatura-tabela-container {
            margin-bottom: 1.5rem;
            overflow-x: auto;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        .fatura-acoes {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.25rem;
        }
        
        .fatura-novo-lancamento {
            width: 100%;
            text-align: center;
        }
        
        #btn-add-lancamento {
            padding: 0.75rem 1.5rem;
            max-width: 300px;
            width: 100%;
            font-weight: 500;
        }
        
        .fatura-total {
            text-align: center;
            padding: 0.75rem;
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            width: 100%;
        }
        
        #cartao-detalhe-total-fatura {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            word-break: break-word;
        }
        
        /* Garantir que as tabelas de faturas e cartões não fiquem cortadas */
        .data-table {
            margin-bottom: 0;
            width: 100%;
            display: table;
        }
        
        /* Correção específica para detalhes de cartão */
        #cartoes-page {
            overflow: visible !important;
        }
        
        #cartao-detalhe {
            overflow: visible !important;
            height: auto !important;
        }
        
        .cartao-fatura {
            overflow: visible !important;
            height: auto !important;
        }
        
        /* Aumentar o espaço no final da página para garantir que o conteúdo seja exibido corretamente */
        #cartoes-page .card {
            margin-bottom: 5rem;
        }
        
        /* Final da página com espaço extra */
        main {
            padding-bottom: 5rem !important;
        }
        
        /* Media queries para responsividade específica da página de cartões */
        @media (max-width: 1024px) {
            .cartoes-grid {
                grid-template-columns: 240px 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .cartoes-grid {
                grid-template-columns: 1fr;
            }
            
            .cartoes-sidebar {
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: 1rem;
                height: auto;
                max-height: none;
            }
            
            #cartoes-sidebar-list {
                flex-direction: row;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 0.5rem;
                -webkit-overflow-scrolling: touch;
                scroll-snap-type: x mandatory;
                gap: 0.5rem;
            }
            
            .cartao-sidebar-item {
                min-width: 200px;
                scroll-snap-align: start;
                flex-shrink: 0;
            }
            
            .cartao-sidebar-item.active {
                border-left: 1px solid var(--border-color);
                border-bottom: 3px solid var(--primary-color);
            }
            
            .cartoes-conteudo {
                padding: 1rem;
            }
            
            .fatura-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .fatura-navigation {
                width: 100%;
                justify-content: space-between;
            }
            
            .fatura-navigation .btn {
                flex: 1;
            }
            
            .cartao-info-boxes {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .cartao-acoes-secundarias {
                flex-direction: column;
            }
            
            .cartao-acoes-secundarias .btn {
                max-width: none;
            }
        }
        
        @media (max-width: 576px) {
            .cartao-info-financeira {
                flex-direction: column;
                gap: 1rem;
            }
            
            .cartao-info-boxes {
                grid-template-columns: 1fr;
            }
            
            .fatura-navigation .btn {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
            
            .fatura-tabela-container {
                overflow-x: auto;
                max-width: 100%;
            }
            
            /* Cards de lançamentos para mobile */
            .data-table-card-view {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
                margin-top: 1rem;
            }
            
            .data-table-card {
                background: var(--surface-color);
                border: 1px solid var(--border-color);
                border-radius: var(--border-radius);
                padding: 1rem;
                position: relative;
            }
            
            .data-table-card .data-label {
                color: var(--subtle-text-color);
                font-size: 0.75rem;
                display: block;
                margin-bottom: 0.25rem;
            }
            
            .data-table-card .data-value {
                font-weight: 500;
                margin-bottom: 0.75rem;
                font-size: 0.95rem;
            }
            
            .data-table-card .card-row {
                display: flex;
                justify-content: space-between;
                gap: 0.5rem;
            }
            
            .data-table-card .card-col {
                flex: 1;
            }
            
            .data-table-card .card-actions {
                display: flex;
                justify-content: flex-end;
                gap: 0.5rem;
                margin-top: 0.75rem;
                border-top: 1px solid var(--border-color);
                padding-top: 0.75rem;
            }
            
            .data-table-card .card-valor {
                font-size: 1.1rem;
                font-weight: 600;
                color: var(--primary-color);
            }
        }
        
        /* Estilo modernizado e responsivo para a página de gastos */
        .gastos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .gastos-header-title h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .gastos-header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: var(--border-radius);
            background-color: var(--surface-color);
            color: var(--subtle-text-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-icon:hover {
            background-color: var(--background-color);
            color: var(--text-color);
        }
        
        .btn-view-toggle {
            font-size: 1rem;
        }
        
        #add-gasto-btn {
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        
        #gastos-view-container {
            margin-top: 1rem;
        }
        
        #gastos-cards-view {
            display: none;
        }
        
        /* Cabeçalho para valores totais de gastos e filtros */
        .filtro-container {
            margin-bottom: 1.25rem;
            padding: 1.25rem;
            background-color: #f8fafc;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        
        #total-gastos-filtrados {
            margin-bottom: 1.25rem;
            padding: 1.25rem;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 1.1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
        
        /* Cards de gastos para visualização mobile */
        .gasto-card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        
        .gasto-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }
        
        .gasto-card.pendente {
            border-left: 4px solid #ff9800;
            background-color: #fff8e1;
        }
        
        .gasto-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .gasto-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-right: 1rem;
            margin-bottom: 0.25rem;
        }
        
        .gasto-card-valor {
            font-weight: 700;
            color: var(--danger-color);
            font-size: 1.25rem;
            white-space: nowrap;
        }
        
        .gasto-card-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .gasto-card-info-item {
            display: flex;
            flex-direction: column;
        }
        
        .gasto-card-label {
            font-size: 0.8rem;
            color: var(--subtle-text-color);
            margin-bottom: 0.25rem;
        }
        
        .gasto-card-value {
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .gasto-card-details {
            background-color: rgba(0,0,0,0.02);
            border-radius: var(--border-radius);
            padding: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .gasto-card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            border-top: 1px solid var(--border-color);
            padding-top: 0.75rem;
        }
        
        .gasto-card-actions button {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        
        .gasto-card-actions button:hover {
            background-color: var(--background-color);
        }
        
        .gasto-card-actions .edit-btn:hover {
            color: var(--primary-color);
        }
        
        .gasto-card-actions .delete-btn:hover {
            color: var(--danger-color);
        }
        
        .gasto-card-actions .view-btn:hover {
            color: var(--secondary-color);
        }
        
        .gasto-card-actions .pay-btn:hover {
            color: var(--primary-color);
        }
        
        /* Estilos para filtros responsivos */
        .filtro-linha {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .filtro-campo {
            flex: 1;
            min-width: 200px;
        }
        
        .filtro-campo label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .filtro-campo input,
        .filtro-campo select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }
        
        .filtro-botoes {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 1rem;
        }
        
        /* Media queries para responsividade específica da página de gastos */
        @media (max-width: 768px) {
            .gastos-header {
                padding: 1rem;
            }
            
            .filtro-campo {
                min-width: 100%;
            }
            
            .filtro-container {
                padding: 1rem;
            }
            
            #total-gastos-filtrados {
                padding: 1rem;
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
            }
            
            #filtro-info-text {
                font-size: 0.9rem;
            }
            
            #valor-total-gastos {
                margin-top: 0.5rem;
                font-size: 1.25rem;
            }
            
            .btn-texto {
                display: none;
            }
            
            #add-gasto-btn {
                padding: 0.5rem;
                width: 40px;
                height: 40px;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            
            #add-gasto-btn i {
                margin: 0;
            }
            
            /* Mostre cards em vez de tabela em mobile */
            #gastos-table-view {
                display: none;
            }
            
            #gastos-cards-view {
                display: block;
            }
        }
        
        /* Estilo modernizado e responsivo para a página de bancos */
        .bancos-cards-view {
            display: none;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .banco-card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        
        .banco-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .banco-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .banco-card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .banco-card-title i {
            color: var(--primary-color);
        }
        
        .banco-card-saldo {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--secondary-color);
        }
        
        .banco-card-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .banco-card-info-item {
            display: flex;
            flex-direction: column;
        }
        
        .banco-card-label {
            font-size: 0.8rem;
            color: var(--subtle-text-color);
            margin-bottom: 0.25rem;
        }
        
        .banco-card-value {
            font-weight: 500;
        }
        
        .banco-card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }
        
        .banco-card-actions button {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .banco-card-actions button:hover {
            background-color: var(--background-color);
        }
        
        .banco-card-actions .edit-btn:hover {
            color: var(--primary-color);
        }
        
        .banco-card-actions .delete-btn:hover {
            color: var(--danger-color);
        }
        
        /* Cards de movimentações para visualização mobile */
        .movimentacoes-cards-view {
            display: none;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .movimentacao-card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            padding: 1rem;
        }
        
        .movimentacao-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }
        
        .movimentacao-card-data {
            font-weight: 500;
            color: var(--subtle-text-color);
            font-size: 0.9rem;
        }
        
        .movimentacao-card-tipo {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .movimentacao-card-tipo.entrada {
            background-color: #e6ffec;
            color: var(--secondary-color);
        }
        
        .movimentacao-card-tipo.saida {
            background-color: #fff1f0;
            color: var(--danger-color);
        }
        
        .movimentacao-card-descricao {
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        
        .movimentacao-card-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        
        .movimentacao-card-banco {
            font-size: 0.9rem;
            color: var(--primary-color);
        }
        
        .movimentacao-card-valores {
            text-align: right;
        }
        
        .movimentacao-card-valor {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .movimentacao-card-valor.entrada {
            color: var(--secondary-color);
        }
        
        .movimentacao-card-valor.saida {
            color: var(--danger-color);
        }
        
        .movimentacao-card-saldo {
            font-size: 0.8rem;
            color: var(--subtle-text-color);
        }
        
        @media (max-width: 768px) {
            /* Adapta o botão de adicionar banco */
            #add-banco-btn .btn-texto {
                display: none;
            }
            
            #add-banco-btn {
                width: auto;
                padding: 0.5rem;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            
            /* Esconde a tabela e mostra os cards em mobile */
            .bancos-table-view {
                display: none;
            }
            
            .bancos-cards-view {
                display: flex;
            }
            
            .movimentacoes-table-view {
                display: none;
            }
            
            .movimentacoes-cards-view {
                display: flex;
            }
            
            /* Ajusta o cabeçalho da seção de movimentações */
            .mes-navigation .btn-texto {
                display: none;
            }
        }
    </style>
    
    <!-- Script para gerenciamento de menu em dispositivos móveis e adaptação responsiva de tabelas para cards -->
    <script>
        // Função para transformar a tabela de faturas em cards em dispositivos móveis
        function transformarTabelaEmCards() {
            const isMobile = window.innerWidth <= 576;
            const faturaTableBody = document.getElementById('fatura-table-body');
            const faturaTable = document.querySelector('.fatura-tabela-container table');
            
            // Se não for mobile ou ainda não temos a tabela carregada, não fazemos nada
            if (!isMobile || !faturaTableBody || !faturaTable) return;
            
            // Se já existe a visualização em cards, não precisamos criar novamente
            if (document.querySelector('.data-table-card-view')) return;
            
            // Criar container para os cards
            const cardContainer = document.createElement('div');
            cardContainer.className = 'data-table-card-view';
            
            // Obter todas as linhas da tabela
            const rows = faturaTableBody.querySelectorAll('tr');
            
            // Se não tiver linhas, não precisa fazer nada
            if (!rows || rows.length === 0) return;
            
            // Obter os títulos das colunas
            const headers = Array.from(faturaTable.querySelectorAll('thead th')).map(th => th.textContent.trim());
            
            // Para cada linha da tabela, criar um card
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return;
                
                const card = document.createElement('div');
                card.className = 'data-table-card';
                
                // Criar conteúdo principal: Descrição e Valor
                const mainInfo = document.createElement('div');
                mainInfo.className = 'card-main-info';
                
                const descricao = cells[1].textContent.trim();
                const valor = cells[4].textContent.trim();
                
                const descricaoEl = document.createElement('div');
                descricaoEl.className = 'card-valor';
                descricaoEl.textContent = descricao;
                mainInfo.appendChild(descricaoEl);
                
                const valorEl = document.createElement('div');
                valorEl.className = 'card-valor';
                valorEl.textContent = valor;
                mainInfo.appendChild(valorEl);
                
                card.appendChild(mainInfo);
                
                // Criar linhas para dados adicionais
                const dataRow = document.createElement('div');
                dataRow.className = 'card-row';
                
                // Data
                const dataCol = document.createElement('div');
                dataCol.className = 'card-col';
                
                const dataLabel = document.createElement('span');
                dataLabel.className = 'data-label';
                dataLabel.textContent = 'Data';
                dataCol.appendChild(dataLabel);
                
                const dataValue = document.createElement('div');
                dataValue.className = 'data-value';
                dataValue.textContent = cells[0].textContent.trim();
                dataCol.appendChild(dataValue);
                
                dataRow.appendChild(dataCol);
                
                // Categoria
                const categoriaCol = document.createElement('div');
                categoriaCol.className = 'card-col';
                
                const categoriaLabel = document.createElement('span');
                categoriaLabel.className = 'data-label';
                categoriaLabel.textContent = 'Categoria';
                categoriaCol.appendChild(categoriaLabel);
                
                const categoriaValue = document.createElement('div');
                categoriaValue.className = 'data-value';
                categoriaValue.textContent = cells[2].textContent.trim();
                categoriaCol.appendChild(categoriaValue);
                
                dataRow.appendChild(categoriaCol);
                
                card.appendChild(dataRow);
                
                // Parcelas
                const parcelasRow = document.createElement('div');
                parcelasRow.className = 'card-row';
                
                const parcelasCol = document.createElement('div');
                parcelasCol.className = 'card-col';
                
                const parcelasLabel = document.createElement('span');
                parcelasLabel.className = 'data-label';
                parcelasLabel.textContent = 'Parcelas';
                parcelasCol.appendChild(parcelasLabel);
                
                const parcelasValue = document.createElement('div');
                parcelasValue.className = 'data-value';
                parcelasValue.textContent = cells[3].textContent.trim();
                parcelasCol.appendChild(parcelasValue);
                
                parcelasRow.appendChild(parcelasCol);
                card.appendChild(parcelasRow);
                
                // Adicionar botões de ações
                const actionsCell = cells[5];
                if (actionsCell) {
                    const actions = document.createElement('div');
                    actions.className = 'card-actions';
                    actions.innerHTML = actionsCell.innerHTML;
                    card.appendChild(actions);
                }
                
                // Adicionar o card ao container
                cardContainer.appendChild(card);
            });
            
            // Esconder a tabela original e adicionar os cards após ela
            faturaTable.style.display = 'none';
            faturaTable.parentNode.appendChild(cardContainer);
        }
        
        // Função para transformar a tabela de gastos em cards
        function transformarGastosParaCards() {
            const gastosTableBody = document.getElementById('gastos-table-body');
            const gastosTable = document.querySelector('#gastos-table-view table');
            const gastosCardsView = document.getElementById('gastos-cards-view');
            
            // Limpa a visualização em cards anterior
            gastosCardsView.innerHTML = '';
            
            // Verifica se há dados na tabela
            const rows = gastosTableBody.querySelectorAll('tr');
            if (!rows.length) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = 'empty-state';
                emptyMsg.innerHTML = `
                    <i class="fas fa-receipt" style="font-size: 3rem; color: var(--subtle-text-color); opacity: 0.3; margin-bottom: 1rem;"></i>
                    <p>Nenhum gasto encontrado.</p>
                `;
                gastosCardsView.appendChild(emptyMsg);
                return;
            }
            
            // Para cada linha da tabela, criar um card
            rows.forEach(row => {
                if (row.querySelector('td[colspan]')) {
                    // Esta é uma linha de mensagem (como "Nenhum gasto encontrado")
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = 'empty-state';
                    emptyMsg.innerHTML = row.innerHTML;
                    gastosCardsView.appendChild(emptyMsg);
                    return;
                }
                
                const cells = row.querySelectorAll('td');
                if (!cells.length) return;
                
                // Cria o card
                const card = document.createElement('div');
                card.className = 'gasto-card';
                
                // Verifica se é um gasto pendente
                if (row.classList.contains('gasto-pendente')) {
                    card.classList.add('pendente');
                }
                
                // Cabeçalho com descrição e valor
                const header = document.createElement('div');
                header.className = 'gasto-card-header';
                
                const title = document.createElement('div');
                title.className = 'gasto-card-title';
                title.textContent = cells[0].textContent.trim(); // Descrição
                
                const valor = document.createElement('div');
                valor.className = 'gasto-card-valor';
                valor.textContent = cells[1].textContent.trim(); // Valor
                
                header.appendChild(title);
                header.appendChild(valor);
                card.appendChild(header);
                
                // Informações adicionais (Data, Categoria, Método)
                const info = document.createElement('div');
                info.className = 'gasto-card-info';
                
                // Data
                const dataItem = document.createElement('div');
                dataItem.className = 'gasto-card-info-item';
                
                const dataLabel = document.createElement('div');
                dataLabel.className = 'gasto-card-label';
                dataLabel.textContent = 'Data';
                
                const dataValue = document.createElement('div');
                dataValue.className = 'gasto-card-value';
                dataValue.textContent = cells[2].textContent.trim(); // Data
                
                dataItem.appendChild(dataLabel);
                dataItem.appendChild(dataValue);
                info.appendChild(dataItem);
                
                // Categoria
                const categoriaItem = document.createElement('div');
                categoriaItem.className = 'gasto-card-info-item';
                
                const categoriaLabel = document.createElement('div');
                categoriaLabel.className = 'gasto-card-label';
                categoriaLabel.textContent = 'Categoria';
                
                const categoriaValue = document.createElement('div');
                categoriaValue.className = 'gasto-card-value';
                categoriaValue.textContent = cells[3].textContent.trim(); // Categoria
                
                categoriaItem.appendChild(categoriaLabel);
                categoriaItem.appendChild(categoriaValue);
                info.appendChild(categoriaItem);
                
                // Método
                const metodoItem = document.createElement('div');
                metodoItem.className = 'gasto-card-info-item';
                
                const metodoLabel = document.createElement('div');
                metodoLabel.className = 'gasto-card-label';
                metodoLabel.textContent = 'Método';
                
                const metodoValue = document.createElement('div');
                metodoValue.className = 'gasto-card-value';
                metodoValue.textContent = cells[4].textContent.trim(); // Método
                
                metodoItem.appendChild(metodoLabel);
                metodoItem.appendChild(metodoValue);
                info.appendChild(metodoItem);
                
                card.appendChild(info);
                
                // Detalhes (se existirem)
                if (cells[5] && cells[5].textContent.trim() !== '-') {
                    const details = document.createElement('div');
                    details.className = 'gasto-card-details';
                    details.innerHTML = cells[5].innerHTML; // Detalhes
                    card.appendChild(details);
                }
                
                // Ações
                if (cells[6]) {
                    const actions = document.createElement('div');
                    actions.className = 'gasto-card-actions';
                    actions.innerHTML = cells[6].innerHTML; // Ações
                    card.appendChild(actions);
                }
                
                gastosCardsView.appendChild(card);
            });
        }
        
        // Função para alternar entre visualização de tabela e cards
        function alternarVisualizacaoGastos() {
            const tableView = document.getElementById('gastos-table-view');
            const cardsView = document.getElementById('gastos-cards-view');
            const toggleBtn = document.getElementById('toggle-gastos-view');
            
            if (tableView.style.display === 'none') {
                // Mudar para visualização de tabela
                tableView.style.display = 'block';
                cardsView.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-th"></i>';
                toggleBtn.title = 'Ver como cards';
            } else {
                // Mudar para visualização de cards
                tableView.style.display = 'none';
                cardsView.style.display = 'block';
                transformarGastosParaCards();
                toggleBtn.innerHTML = '<i class="fas fa-list"></i>';
                toggleBtn.title = 'Ver como tabela';
            }
        }
        
        // Adicionar evento para chamar a função quando a página carregar e quando redimensionar
        document.addEventListener('DOMContentLoaded', function() {
            // Cartões: Verificar se estamos na página de cartões
            const cartoesPage = document.getElementById('cartoes-page');
            if (cartoesPage) {
                // Transformar tabela em cards se for mobile
                transformarTabelaEmCards();
                
                // Adicionar evento para quando o cartão for selecionado
                document.addEventListener('click', function(e) {
                    const cartaoItem = e.target.closest('.cartao-sidebar-item');
                    if (cartaoItem) {
                        setTimeout(function() {
                            transformarTabelaEmCards();
                        }, 300);
                    }
                });
                
                // Adicionar evento de mudança de fatura
                const btnFaturaAnterior = document.getElementById('btn-fatura-anterior');
                const btnFaturaAtual = document.getElementById('btn-fatura-atual');
                const btnFaturaProxima = document.getElementById('btn-fatura-proxima');
                
                if (btnFaturaAnterior) btnFaturaAnterior.addEventListener('click', () => setTimeout(transformarTabelaEmCards, 300));
                if (btnFaturaAtual) btnFaturaAtual.addEventListener('click', () => setTimeout(transformarTabelaEmCards, 300));
                if (btnFaturaProxima) btnFaturaProxima.addEventListener('click', () => setTimeout(transformarTabelaEmCards, 300));
            }
            
            // Gastos: Verificar se estamos na página de gastos
            const gastosPage = document.getElementById('gastos-page');
            if (gastosPage) {
                // Configurar botão para alternar visualização
                const toggleBtn = document.getElementById('toggle-gastos-view');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', alternarVisualizacaoGastos);
                }
                
                // Em dispositivos móveis, mostrar cards por padrão
                if (window.innerWidth <= 768) {
                    const tableView = document.getElementById('gastos-table-view');
                    const cardsView = document.getElementById('gastos-cards-view');
                    
                    if (tableView && cardsView) {
                        tableView.style.display = 'none';
                        cardsView.style.display = 'block';
                        transformarGastosParaCards();
                        
                        if (toggleBtn) {
                            toggleBtn.innerHTML = '<i class="fas fa-list"></i>';
                            toggleBtn.title = 'Ver como tabela';
                        }
                    }
                }
                
                // Observer para modificações na tabela de gastos
                const gastosTableObserver = new MutationObserver(function(mutations) {
                    // Se a visualização em cards estiver ativa, atualize os cards
                    if (document.getElementById('gastos-cards-view').style.display === 'block') {
                        transformarGastosParaCards();
                    }
                });
                
                const gastosTableBody = document.getElementById('gastos-table-body');
                if (gastosTableBody) {
                    gastosTableObserver.observe(gastosTableBody, { childList: true, subtree: true });
                }
            }
        });
        
        // Adicionar evento de redimensionamento para adaptar interface
        window.addEventListener('resize', function() {
            // Cartões: Verificar se estamos na página de cartões
            const cartoesPage = document.getElementById('cartoes-page');
            if (cartoesPage) {
                const isMobile = window.innerWidth <= 576;
                const cardView = document.querySelector('.data-table-card-view');
                const faturaTable = document.querySelector('.fatura-tabela-container table');
                
                if (isMobile) {
                    if (!cardView) {
                        transformarTabelaEmCards();
                    } else {
                        // Mostrar cards e esconder tabela
                        if (cardView) cardView.style.display = 'flex';
                        if (faturaTable) faturaTable.style.display = 'none';
                    }
                } else {
                    // Em telas maiores, mostrar a tabela e esconder os cards
                    if (cardView) cardView.style.display = 'none';
                    if (faturaTable) faturaTable.style.display = 'table';
                }
            }
            
            // Gastos: Verificar se estamos na página de gastos
            const gastosPage = document.getElementById('gastos-page');
            if (gastosPage) {
                const isMobile = window.innerWidth <= 768;
                const tableView = document.getElementById('gastos-table-view');
                const cardsView = document.getElementById('gastos-cards-view');
                const toggleBtn = document.getElementById('toggle-gastos-view');
                
                // Em dispositivos móveis, mostrar cards por padrão
                if (isMobile && tableView && cardsView) {
                    if (cardsView.style.display !== 'block') {
                        tableView.style.display = 'none';
                        cardsView.style.display = 'block';
                        transformarGastosParaCards();
                        
                        if (toggleBtn) {
                            toggleBtn.innerHTML = '<i class="fas fa-list"></i>';
                            toggleBtn.title = 'Ver como tabela';
                        }
                    }
                }
            }
            
            // Dashboard: Verificar se estamos na página de dashboard
            const dashboardPage = document.getElementById('dashboard-page');
            if (dashboardPage) {
                const isMobile = window.innerWidth <= 576;
                
                if (isMobile) {
                    // Transformar tabelas em cards quando redimensionar para mobile
                    transformarTabelasDashboardEmCards();
                } else {
                    // Em telas maiores, esconder os cards e mostrar as tabelas
                    const cardViews = dashboardPage.querySelectorAll('.dashboard-card-view');
                    cardViews.forEach(cardView => {
                        cardView.style.display = 'none';
                    });
                    
                    const tables = dashboardPage.querySelectorAll('.data-table');
                    tables.forEach(table => {
                        table.style.display = 'table';
                    });
                }
            }
            
            // Rendas: Verificar se estamos na página de rendas
            const rendasPage = document.getElementById('rendas-page');
            if (rendasPage) {
                const isMobile = window.innerWidth <= 768;
                const tableView = rendasPage.querySelector('.rendas-table-view');
                const cardsView = rendasPage.querySelector('.rendas-cards-view');
                const cardsButton = rendasPage.querySelector('.rendas-view-toggle .view-btn[data-view="cards"]');
                const tableButton = rendasPage.querySelector('.rendas-view-toggle .view-btn[data-view="table"]');
                
                if (isMobile && tableView && cardsView) {
                    if (tableView.style.display !== 'none') {
                        tableView.style.display = 'none';
                        cardsView.style.display = 'block';
                        
                        if (tableButton && cardsButton) {
                            tableButton.classList.remove('active');
                            cardsButton.classList.add('active');
                        }
                    }
                }
            }
        });
    </script>
<body>

    <!-- Container de Autenticação -->
    <div id="auth-container">
        <h1><i class="fas fa-wallet"></i>FinControle</h1>
        <p>Seu assistente financeiro pessoal</p>
        
        <div class="auth-tabs">
            <div class="auth-tab active" data-tab="login">Login</div>
            <div class="auth-tab" data-tab="register">Cadastro</div>
        </div>

        <!-- Formulário de Login -->
        <form id="login-form" class="auth-form active">
            <div class="form-group">
                <label for="login-email">E-mail</label>
                <input type="email" id="login-email" required>
            </div>
            <div class="form-group">
                <label for="login-password">Senha</label>
                <input type="password" id="login-password" required>
            </div>
            <button type="submit" class="btn btn-primary">Entrar</button>
            <a href="#" id="forgot-password-link" class="auth-link">Esqueceu a senha?</a>
        </form>

        <!-- Formulário de Cadastro -->
        <form id="register-form" class="auth-form">
            <div class="form-group">
                <label for="register-name">Nome Completo</label>
                <input type="text" id="register-name" required>
            </div>
            <div class="form-group">
                <label for="register-email">E-mail</label>
                <input type="email" id="register-email" required>
            </div>
            <div class="form-group">
                <label for="register-password">Senha</label>
                <input type="password" id="register-password" required>
            </div>
             <div class="form-group">
                <label for="register-confirm-password">Confirmar Senha</label>
                <input type="password" id="register-confirm-password" required>
            </div>
            <button type="submit" class="btn btn-primary">Cadastrar</button>
        </form>

        <div class="divider">ou</div>
        
        <button id="google-login-btn" class="btn btn-google">
            <img src="https://www.google.com/favicon.ico" alt="Google icon" width="20" height="20">
            Entrar com Google
        </button>
    </div>

    <!-- Container Principal da Aplicação -->
    <div id="app-container">
        <!-- Sidebar (Menu Lateral) -->
        <aside class="sidebar" id="app-sidebar"></aside>

        <!-- Topbar (Barra Superior) -->
        <header class="topbar" id="app-topbar"></header>

        <!-- Conteúdo Principal -->
        <main id="app-main">
            <!-- Seção do Dashboard -->
            <div id="dashboard-page" class="main-content">
                <!-- Card principal com navegação entre meses -->
                <div class="card dashboard-card">
                    <div class="dashboard-header">
                        <div class="dashboard-header-title">
                            <i class="fas fa-calendar-alt"></i>
                            <h3 id="dashboard-mes-titulo">Visão: <span id="dashboard-mes-atual">Mês Atual</span></h3>
                        </div>
                        <div class="dashboard-month-nav">
                            <button id="btn-dashboard-anterior" class="btn btn-icon">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button id="btn-dashboard-atual" class="btn btn-icon">
                                <i class="fas fa-calendar-day"></i>
                            </button>
                            <button id="btn-dashboard-proximo" class="btn btn-icon">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div id="dashboard-cards-container">
                        <!-- Resumo Progressivo -->
                        <div class="dashboard-section">
                            <div class="section-header">
                                <h3>Resumo Progressivo</h3>
                            </div>
                            <div id="dashboard-resumo-progressivo" class="dashboard-summary-cards">
                                <div class="summary-card positive">
                                    <h4>Valor Total Positivo</h4>
                                    <p id="resumo-valor-positivo">R$ 0,00</p>
                                </div>
                                <div class="summary-card negative">
                                    <h4>Valor Total Negativo</h4>
                                    <p id="resumo-valor-negativo">R$ 0,00</p>
                                </div>
                                <div class="summary-card balance">
                                    <h4>Saldo Previsto</h4>
                                    <p id="resumo-saldo-previsto">R$ 0,00</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lista de bancos no Dashboard -->
                        <div class="dashboard-section">
                            <div class="section-header">
                                <h3>Meus Bancos</h3>
                                <a href="#bancos" class="btn btn-primary btn-section-action">
                                    <i class="fas fa-university"></i> <span class="btn-texto">Gerenciar</span>
                                </a>
                            </div>
                            <div id="dashboard-bancos" class="dashboard-content">
                                <div id="dashboard-bancos-loading" class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Carregando seus bancos...</p>
                                </div>
                                <div id="dashboard-bancos-empty" class="empty-state">
                                    <i class="fas fa-university"></i>
                                    <p>Você ainda não cadastrou nenhum banco.</p>
                                    <a href="#bancos" class="btn btn-primary">
                                        Cadastrar Banco
                                    </a>
                                </div>
                                <div id="dashboard-bancos-list" class="data-list">
                                    <!-- Lista de bancos será inserida aqui -->
                                </div>
                            </div>
                        </div>

                        <!-- Lista de faturas de cartões no Dashboard -->
                        <div class="dashboard-section">
                            <div class="section-header">
                                <h3>Faturas de Cartões</h3>
                                <a href="#cartoes" class="btn btn-primary btn-section-action">
                                    <i class="fas fa-credit-card"></i> <span class="btn-texto">Gerenciar</span>
                                </a>
                            </div>
                            <div id="dashboard-faturas" class="dashboard-content">
                                <div id="dashboard-faturas-loading" class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Carregando suas faturas...</p>
                                </div>
                                <div id="dashboard-faturas-empty" class="empty-state">
                                    <i class="fas fa-credit-card"></i>
                                    <p>Você ainda não possui faturas de cartões ou não cadastrou nenhum cartão.</p>
                                    <a href="#cartoes" class="btn btn-primary">
                                        Cadastrar Cartão
                                    </a>
                                </div>
                                <div id="dashboard-faturas-list" class="data-list">
                                    <!-- Lista de faturas será inserida aqui -->
                                </div>
                            </div>
                        </div>

                        <!-- Lista de rendas no Dashboard -->
                        <div class="dashboard-section">
                            <div class="section-header">
                                <h3>Rendas</h3>
                                <a href="#rendas" class="btn btn-primary btn-section-action">
                                    <i class="fas fa-coins"></i> <span class="btn-texto">Gerenciar</span>
                                </a>
                            </div>
                            <div id="dashboard-rendas" class="dashboard-content">
                                <div id="dashboard-rendas-loading" class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Carregando suas rendas...</p>
                                </div>
                                <div id="dashboard-rendas-empty" class="empty-state">
                                    <i class="fas fa-coins"></i>
                                    <p>Você ainda não possui rendas cadastradas para este mês.</p>
                                    <a href="#rendas" class="btn btn-primary">
                                        Cadastrar Renda
                                    </a>
                                </div>
                                <div id="dashboard-rendas-list" class="data-list">
                                    <!-- Lista de rendas será inserida aqui -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gastos Pendentes no Dashboard -->
                        <div class="dashboard-section">
                            <div class="section-header">
                                <h3>Gastos Pendentes</h3>
                                <a href="#gastos" class="btn btn-primary btn-section-action">
                                    <i class="fas fa-exclamation-triangle"></i> <span class="btn-texto">Gerenciar</span>
                                </a>
                            </div>
                            <div id="dashboard-gastos-pendentes" class="dashboard-content">
                                <div id="dashboard-gastos-pendentes-loading" class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Carregando seus gastos pendentes...</p>
                                </div>
                                <div id="dashboard-gastos-pendentes-empty" class="empty-state">
                                    <i class="fas fa-check-circle"></i>
                                    <p>Você não possui gastos pendentes para este mês.</p>
                                    <a href="#gastos" class="btn btn-primary">
                                        Cadastrar Gasto
                                    </a>
                                </div>
                                <div id="dashboard-gastos-pendentes-list" class="data-list">
                                    <!-- Lista de gastos pendentes será inserida aqui -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Metas personalizadas no Dashboard -->
                        <div class="dashboard-section">
                            <div class="section-header">
                                <h3>Metas Personalizadas</h3>
                                <a href="#configuracoes" class="btn btn-primary btn-section-action">
                                    <i class="fas fa-cog"></i> <span class="btn-texto">Configurar</span>
                                </a>
                            </div>
                            <div id="dashboard-metas" class="dashboard-content">
                                <div id="dashboard-metas-loading" class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Carregando suas metas...</p>
                                </div>
                                <div id="dashboard-metas-empty" class="empty-state">
                                    <i class="fas fa-bullseye"></i>
                                    <p>Você ainda não configurou metas personalizadas.</p>
                                    <a href="#configuracoes" class="btn btn-primary">
                                        Configurar Metas
                                    </a>
                                </div>
                                <div id="dashboard-metas-list" class="data-list">
                                    <!-- Lista de metas será inserida aqui -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Gastos -->
            <div id="gastos-page" class="main-content">
                <div class="card">
                    <div class="card-header gastos-header">
                        <div class="gastos-header-title">
                            <h3>Meus Gastos</h3>
                        </div>
                        <div class="gastos-header-actions">
                            <button id="toggle-gastos-view" class="btn btn-icon btn-view-toggle" title="Alternar visualização">
                                <i class="fas fa-list"></i>
                            </button>
                            <button id="add-gasto-btn" class="btn btn-primary">
                                <i class="fas fa-plus"></i> <span class="btn-texto">Novo Gasto</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Container para tabela e visualização em cards -->
                    <div id="gastos-view-container">
                        <!-- Visualização em tabela (padrão) -->
                        <div id="gastos-table-view">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Descrição</th>
                                        <th>Valor</th>
                                        <th>Data</th>
                                        <th>Categoria</th>
                                        <th>Método</th>
                                        <th>Detalhes</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="gastos-table-body">
                                    <!-- Linhas de gastos serão inseridas aqui -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Visualização em cards (para mobile) -->
                        <div id="gastos-cards-view">
                            <!-- Cards de gastos serão inseridos aqui -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Rendas -->
            <div id="rendas-page" class="main-content">
                <div class="card rendas-card">
                    <div class="card-header">
                        <h3>Minhas Rendas</h3>
                        <div class="card-actions">
                            <button id="add-renda-btn" class="btn btn-primary">
                                <i class="fas fa-plus"></i> <span class="btn-texto">Nova Renda</span>
                            </button>
                            <button id="delete-all-rendas-btn" class="btn btn-danger">
                                <i class="fas fa-trash-alt"></i> <span class="btn-texto">Excluir Todas</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="rendas-container">
                        <!-- Filtro de mês será inserido aqui via JavaScript -->
                        <div class="rendas-view-toggle">
                            <button class="view-btn active" data-view="table">
                                <i class="fas fa-table"></i> Tabela
                            </button>
                            <button class="view-btn" data-view="cards">
                                <i class="fas fa-th-large"></i> Cards
                            </button>
                        </div>
                        
                        <!-- Visualização em tabela -->
                        <div class="rendas-table-view">
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Descrição</th>
                                            <th>Valor</th>
                                            <th>Data</th>
                                            <th>Categoria</th>
                                            <th>Detalhes</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rendas-table-body">
                                        <!-- Linhas de rendas serão inseridas aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Visualização em cards -->
                        <div class="rendas-cards-view" style="display: none;">
                            <div id="rendas-cards-container" class="cards-grid">
                                <!-- Cards de rendas serão inseridos aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Cartões -->
            <div id="cartoes-page" class="main-content">
                <div class="card" style="padding: 0; overflow: visible;">
                    <div class="cartoes-grid">
                        <!-- Menu Lateral de Cartões -->
                        <div class="cartoes-sidebar">
                            <div class="cartoes-sidebar-header">
                                <h3>Meus Cartões</h3>
                                <button id="add-cartao-btn" class="btn btn-primary">
                                   <i class="fas fa-plus"></i><span class="btn-texto">Novo</span>
                                </button>
                            </div>
                            <div id="cartoes-sidebar-list">
                                <!-- Lista de cartões será inserida aqui -->
                                <div class="cartao-sidebar-empty">Nenhum cartão cadastrado.</div>
                            </div>
                        </div>
                        
                        <!-- Área de Detalhes do Cartão -->
                        <div class="cartoes-conteudo">
                            <div id="cartao-detalhe-vazio">
                                <i class="fas fa-credit-card"></i>
                                <p>Selecione um cartão para ver os detalhes</p>
                            </div>
                            
                            <div id="cartao-detalhe">
                                <div class="cartao-header">
                                    <div class="cartao-visual">
                                        <div class="cartao-info-principal">
                                            <div class="cartao-identificacao">
                                                <h3 id="cartao-detalhe-nome"></h3>
                                                <p id="cartao-detalhe-final"></p>
                                            </div>
                                            <div id="cartao-detalhe-bandeira"></div>
                                        </div>
                                        <div class="cartao-info-financeira">
                                            <div class="cartao-limite">
                                                <small>Limite Disponível</small>
                                                <h4 id="cartao-detalhe-limite-disponivel"></h4>
                                            </div>
                                            <div class="cartao-valor-fatura">
                                                <small>Valor da Fatura</small>
                                                <h4 id="cartao-detalhe-valor-fatura"></h4>
                                            </div>
                                        </div>
                                        <div class="cartao-acoes-principais">
                                            <button id="btn-pagar-fatura" class="btn btn-light">
                                                <i class="fas fa-money-bill-wave"></i> Pagar Fatura
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="cartao-info-boxes">
                                        <div class="info-box">
                                            <small>Limite Total</small>
                                            <h4 id="cartao-detalhe-limite"></h4>
                                        </div>
                                        <div class="info-box">
                                            <small>Vencimento</small>
                                            <h4 id="cartao-detalhe-vencimento"></h4>
                                        </div>
                                        <div class="info-box">
                                            <small>Fechamento</small>
                                            <h4 id="cartao-detalhe-fechamento"></h4>
                                        </div>
                                        <div class="info-box">
                                            <small>Status</small>
                                            <h4 id="cartao-detalhe-status"></h4>
                                        </div>
                                    </div>
                                    
                                    <div class="cartao-acoes-secundarias">
                                        <button id="btn-editar-cartao" class="btn">
                                            <i class="fas fa-edit"></i> Editar Cartão
                                        </button>
                                        <button id="btn-excluir-cartao" class="btn btn-danger">
                                            <i class="fas fa-trash"></i> Excluir Cartão
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="cartao-fatura">
                                    <div class="fatura-header">
                                        <h3>Fatura <span id="cartao-detalhe-mes-fatura">atual</span></h3>
                                        <div class="fatura-navigation">
                                            <button id="btn-fatura-anterior" class="btn">
                                                <i class="fas fa-chevron-left"></i> Anterior
                                            </button>
                                            <button id="btn-fatura-atual" class="btn">
                                                Atual
                                            </button>
                                            <button id="btn-fatura-proxima" class="btn">
                                                Próxima <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div id="fatura-vazia">
                                        <i class="fas fa-receipt"></i>
                                        <p>Não há lançamentos nesta fatura</p>
                                    </div>
                                    
                                    <div class="fatura-tabela-container">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Data</th>
                                                    <th>Descrição</th>
                                                    <th>Categoria</th>
                                                    <th>Parcelas</th>
                                                    <th>Valor</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="fatura-table-body">
                                                <!-- Os lançamentos da fatura serão inseridos aqui -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="fatura-acoes">
                                        <div class="fatura-novo-lancamento">
                                            <button id="btn-add-lancamento" class="btn btn-primary">
                                                <i class="fas fa-plus"></i> Novo Lançamento
                                            </button>
                                        </div>
                                        <div class="fatura-total">
                                            <strong>Total da fatura: </strong>
                                            <span id="cartao-detalhe-total-fatura"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Bancos -->
            <div id="bancos-page" class="main-content">
                <div class="dashboard-section">
                    <div class="dashboard-header">
                        <div class="dashboard-header-title">
                            <i class="fas fa-university"></i>
                            <h3>Meus Bancos</h3>
                        </div>
                        <button id="add-banco-btn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> <span class="btn-texto">Novo Banco</span>
                        </button>
                    </div>
                    
                    <!-- Cards de bancos para visualização responsiva -->
                    <div id="bancos-cards-container" class="dashboard-content">
                        <div id="bancos-loading" class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Carregando seus bancos...</p>
                        </div>
                        
                        <div id="bancos-empty" class="empty-state">
                            <i class="fas fa-university"></i>
                            <p>Você ainda não cadastrou nenhum banco.</p>
                        </div>
                        
                        <div id="bancos-lista">
                            <!-- Visualização em tabela (desktop) -->
                            <div class="bancos-table-view">
                                <div class="table-responsive">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Nome do Banco</th>
                                                <th>Tipo de Conta</th>
                                                <th>Agência</th>
                                                <th>Conta</th>
                                                <th>Saldo</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="bancos-table-body">
                                           <!-- Linhas de bancos serão inseridas aqui -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Visualização em cards (mobile) -->
                            <div class="bancos-cards-view">
                                <!-- Cards de bancos serão inseridos dinamicamente via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nova seção para movimentações do banco -->
                <div class="dashboard-section" style="margin-top: 1.5rem;">
                    <div class="dashboard-header">
                        <div class="dashboard-header-title">
                            <i class="fas fa-exchange-alt"></i>
                            <h3>Movimentações do Mês</h3>
                        </div>
                        <div class="mes-navigation">
                            <button id="btn-mes-anterior" class="btn btn-icon">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <span id="mes-atual-label" style="margin: 0 1rem; font-weight: 600;"></span>
                            <button id="btn-mes-proximo" class="btn btn-icon">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="dashboard-content">
                        <div id="movimentacoes-loading" class="loading-state">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Carregando movimentações...</p>
                        </div>
                        
                        <div id="movimentacoes-empty" class="empty-state">
                            <i class="fas fa-info-circle"></i>
                            <p>Não há movimentações para este mês.</p>
                        </div>
                        
                        <div id="movimentacoes-content" style="display: none;">
                            <!-- Visualização em tabela (desktop) -->
                            <div class="movimentacoes-table-view">
                                <div class="table-responsive">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Data</th>
                                                <th>Descrição</th>
                                                <th>Banco</th>
                                                <th>Tipo</th>
                                                <th>Valor</th>
                                                <th>Saldo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="movimentacoes-table-body">
                                            <!-- Movimentações serão inseridas aqui -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Visualização em cards (mobile) -->
                            <div class="movimentacoes-cards-view">
                                <!-- Cards de movimentações serão inseridos dinamicamente via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção de Configurações -->
            <div id="configuracoes-page" class="main-content">
                <div class="card">
                    <div class="card-header">
                        <h3>Configurações do Sistema</h3>
                    </div>
                    <div class="card-body" style="padding: 1.5rem;">
                        <!-- Seção de Aparência -->
                        <div class="config-section">
                            <h4>Aparência</h4>
                            <div class="config-option">
                                <label for="tema-select">Tema:</label>
                                <select id="tema-select" class="form-control">
                                    <option value="claro">Claro</option>
                                    <option value="escuro">Escuro</option>
                                    <option value="sistema">Seguir Sistema</option>
                                </select>
                            </div>
                            <div class="config-option">
                                <label for="cor-primaria">Cor Primária:</label>
                                <input type="color" id="cor-primaria" class="form-control color-picker">
                            </div>
                        </div>

                        <!-- Seção de Preferências -->
                        <div class="config-section">
                            <h4>Preferências</h4>
                            <div class="config-option">
                                <label for="moeda-select">Moeda:</label>
                                <select id="moeda-select" class="form-control">
                                    <option value="BRL">Real (R$)</option>
                                    <option value="USD">Dólar (US$)</option>
                                    <option value="EUR">Euro (€)</option>
                                </select>
                            </div>
                            <div class="config-option">
                                <label for="formato-data-select">Formato de Data:</label>
                                <select id="formato-data-select" class="form-control">
                                    <option value="DD/MM/YYYY">DD/MM/AAAA</option>
                                    <option value="MM/DD/YYYY">MM/DD/AAAA</option>
                                    <option value="YYYY-MM-DD">AAAA-MM-DD</option>
                                </select>
                            </div>
                            <div class="config-option">
                                <label for="dia-inicio-mes">Dia de Início do Mês:</label>
                                <input type="number" id="dia-inicio-mes" class="form-control" min="1" max="31" value="1">
                                <small>Define o dia em que o mês financeiro começa para cálculos.</small>
                            </div>
                        </div>

                        <!-- Seção de Notificações -->
                        <div class="config-section">
                            <h4>Notificações</h4>
                            <div class="config-option checkbox-option">
                                <input type="checkbox" id="notif-vencimentos" checked>
                                <label for="notif-vencimentos">Avisar sobre vencimentos próximos</label>
                            </div>
                            <div class="config-option checkbox-option">
                                <input type="checkbox" id="notif-limites" checked>
                                <label for="notif-limites">Avisar quando o limite do cartão estiver próximo</label>
                            </div>
                            <div class="config-option">
                                <label for="dias-antecedencia">Dias de antecedência para avisos:</label>
                                <input type="number" id="dias-antecedencia" class="form-control" min="1" max="30" value="3">
                            </div>
                        </div>

                        <!-- Seção de Dados -->
                        <div class="config-section">
                            <h4>Dados</h4>
                            <div class="config-option">
                                <button id="btn-exportar-dados" class="btn">
                                    <i class="fas fa-file-export"></i> Exportar Dados
                                </button>
                                <button id="btn-importar-dados" class="btn">
                                    <i class="fas fa-file-import"></i> Importar Dados
                                </button>
                            </div>
                            <div class="config-option danger-zone">
                                <h5>Zona de Perigo</h5>
                                <button id="btn-limpar-dados" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> Limpar Todos os Dados
                                </button>
                            </div>
                        </div>

                        <!-- Seção de Metas e Limites -->
                        <div class="config-section">
                            <h4>Metas e Limites</h4>
                            <p style="margin-bottom: 1rem;">Configure suas metas de rendas e limites de gastos para exibição no dashboard.</p>
                            
                            <div class="config-option">
                                <button id="btn-gerenciar-metas-rendas" class="btn">
                                    <i class="fas fa-bullseye"></i> Gerenciar Metas de Rendas
                                </button>
                                <button id="btn-gerenciar-limites-gastos" class="btn">
                                    <i class="fas fa-chart-line"></i> Gerenciar Limites de Gastos
                                </button>
                            </div>
                        </div>
                        
                        <!-- Seção de Conta -->
                        <div class="config-section">
                            <h4>Conta</h4>
                            <div class="config-option">
                                <button id="btn-alterar-senha" class="btn">
                                    <i class="fas fa-key"></i> Alterar Senha
                                </button>
                                <button id="btn-atualizar-perfil" class="btn">
                                    <i class="fas fa-user-edit"></i> Atualizar Perfil
                                </button>
                            </div>
                        </div>

                        <!-- Botão de Salvar -->
                        <div class="config-actions">
                            <button id="btn-salvar-config" class="btn btn-primary">
                                <i class="fas fa-save"></i> Salvar Configurações
                            </button>
                        </div>
                    </div>
                </div>
            </div>



        </main>
    </div>

    <!-- Modal Genérico -->
    <div id="generic-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modal-title" style="margin-bottom: 1.5rem;">Título do Modal</h3>
            <div id="modal-body">
                <!-- Conteúdo do formulário do modal será inserido aqui -->
            </div>
        </div>
    </div>

    <!-- Container de Notificações -->
    <div id="notification-container"></div>
    
    <!-- Correção para modais -->
    <script src="fix_modals.js"></script>

    <!-- Correção para datas -->
    <script>
        // Função para corrigir datas em formulários
        document.addEventListener('DOMContentLoaded', function() {
            // Função para obter a data local corrigida no formato YYYY-MM-DD
            window.getDataLocalCorrigida = function() {
                const data = new Date();
                const ano = data.getFullYear();
                const mes = String(data.getMonth() + 1).padStart(2, '0');
                const dia = String(data.getDate()).padStart(2, '0');
                return `${ano}-${mes}-${dia}`;
            };

            // Sobrescrever todas as chamadas de new Date().toISOString().split('T')[0]
            const originalDateToISOString = Date.prototype.toISOString;
            Date.prototype.toISOString = function() {
                // Se estamos tentando obter uma data para um input date, retorne a data local
                const stack = new Error().stack || '';
                if (stack.includes('split') && stack.includes('[0]')) {
                    const ano = this.getFullYear();
                    const mes = String(this.getMonth() + 1).padStart(2, '0');
                    const dia = String(this.getDate()).padStart(2, '0');
                    return `${ano}-${mes}-${dia}T00:00:00.000Z`;
                }
                
                // Caso contrário, usar o comportamento original
                return originalDateToISOString.call(this);
            };

            console.log('Correção de datas aplicada');
        });
    </script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importar funções necessárias dos SDKs do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            GoogleAuthProvider,
            signInWithPopup,
            sendPasswordResetEmail,
            signOut,
            updateProfile,
            EmailAuthProvider,
            reauthenticateWithCredential,
            updatePassword
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore,
            setLogLevel,
            collection,
            doc as firestoreDoc,
            addDoc,
            getDocs,
            getDoc,
            onSnapshot,
            query,
            updateDoc,
            deleteDoc,
            serverTimestamp,
            runTransaction,
            where,
            setDoc,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 1. CONFIGURAÇÃO E INICIALIZAÇÃO ---
        
        // ATENÇÃO: As configurações do Firebase devem ser carregadas de um arquivo externo
        // que não é enviado para o repositório público.
        // Crie um arquivo chamado firebase-config.js na raiz do projeto com o seguinte conteúdo:
        /*
        // firebase-config.js
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "seu-projeto.firebaseapp.com",
            projectId: "seu-projeto",
            storageBucket: "seu-projeto.appspot.com",
            messagingSenderId: "seu-messagingSenderId",
            appId: "seu-appId"
        };
        */
        
        // Verificar se as configurações do Firebase foram carregadas
        if (typeof firebaseConfig === 'undefined') {
            // Configuração de fallback para desenvolvimento local apenas
            // NÃO inclua chaves reais aqui
            const firebaseConfig = {
                apiKey: "INSIRA_SUA_API_KEY_AQUI",
                authDomain: "fincontrole-70ec4.firebaseapp.com",
                projectId: "fincontrole-70ec4",
                storageBucket: "fincontrole-70ec4.appspot.com",
                messagingSenderId: "250535426531",
                appId: "1:250535426531:web:6f509f1ee9914a550188d6"
            };
            console.error("Arquivo de configuração do Firebase não encontrado! Por favor, crie o arquivo firebase-config.js");
        }
        
        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug'); // 'debug' para ver logs detalhados, 'silent' para desativar

        let currentUser = null;
        let gastosUnsubscribe = null;
        let cartoesUnsubscribe = null;
        let bancosUnsubscribe = null;
        let rendasUnsubscribe = null;

        // --- 2. SELETORES DE ELEMENTOS DO DOM ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const notificationContainer = document.getElementById('notification-container');
        
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        
        const modal = document.getElementById('generic-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeModalBtn = document.querySelector('.close-button');


        // --- 3. FUNÇÕES UTILITÁRIAS ---
        
        /**
         * Inicializa todos os tooltips na página
         */
        function initializeTooltips() {
            document.querySelectorAll('.tooltip').forEach(tooltip => {
                if (tooltip) {
                    tooltip.addEventListener('mouseenter', function() {
                        const tooltipText = safeQuerySelector(this, '.tooltiptext');
                        if (tooltipText) {
                            tooltipText.style.visibility = 'visible';
                            tooltipText.style.opacity = '1';
                        }
                    });
                    
                    tooltip.addEventListener('mouseleave', function() {
                        const tooltipText = safeQuerySelector(this, '.tooltiptext');
                        if (tooltipText) {
                            tooltipText.style.visibility = 'hidden';
                            tooltipText.style.opacity = '0';
                        }
                    });
                }
            });
        }
        
        /**
         * Converte um arquivo para base64
         * @param {File} file - O arquivo a ser convertido
         * @returns {Promise<string>} - Promise que resolve para a string base64
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }
                
                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                reader.onload = () => {
                    resolve(reader.result);
                };
                
                reader.onerror = (error) => {
                    console.error('Erro ao converter arquivo para base64:', error);
                    reject(error);
                };
            });
        }
        
        /**
         * Verifica e limita o tamanho de uma string base64
         * @param {string} base64String - A string base64 a ser verificada
         * @param {number} maxSizeMB - Tamanho máximo em MB
         * @returns {object} - Objeto com a string base64 (possivelmente redimensionada) e informação se foi redimensionada
         */
        function verificarTamanhoBase64(base64String, maxSizeMB = 1) {
            if (!base64String) return { base64: null, redimensionada: false };
            
            // Calcula o tamanho aproximado em bytes
            // Uma string base64 usa aproximadamente 4 caracteres para cada 3 bytes dos dados originais
            const aproximateSizeInBytes = (base64String.length * 3) / 4;
            const sizeMB = aproximateSizeInBytes / (1024 * 1024);
            
            if (sizeMB <= maxSizeMB) {
                return { base64: base64String, redimensionada: false };
            }
            
            // Se a imagem for muito grande, vamos criar uma versão com qualidade reduzida
            return redimensionarImagemBase64(base64String, maxSizeMB);
        }
        
        /**
         * Redimensiona uma imagem base64 para reduzir seu tamanho
         * @param {string} base64String - A string base64 da imagem
         * @param {number} maxSizeMB - Tamanho máximo desejado em MB
         * @returns {Promise<object>} - Objeto com a string base64 redimensionada e flag de redimensionamento
         */
        function redimensionarImagemBase64(base64String, maxSizeMB) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64String;
                
                img.onload = () => {
                    // Criar um canvas para redimensionar
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Reduzir o tamanho mantendo a proporção
                    const MAX_WIDTH = 1200;
                    const MAX_HEIGHT = 1200;
                    
                    if (width > height) {
                        if (width > MAX_WIDTH) {
                            height = Math.round(height * (MAX_WIDTH / width));
                            width = MAX_WIDTH;
                        }
                    } else {
                        if (height > MAX_HEIGHT) {
                            width = Math.round(width * (MAX_HEIGHT / height));
                            height = MAX_HEIGHT;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Desenhar a imagem redimensionada
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Converter de volta para base64 com qualidade reduzida
                    // Ajustar a qualidade se necessário (0.7 = 70% de qualidade)
                    const newBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    
                    resolve({ base64: newBase64, redimensionada: true });
                };
                
                img.onerror = () => {
                    // Em caso de erro, retornar a string original
                    resolve({ base64: base64String, redimensionada: false });
                };
            });
        }
        
        /**
         * Utilitário para querySelector seguro que evita erros quando o elemento não existe
         * @param {Element|null} element - O elemento onde buscar
         * @param {string} selector - O seletor CSS
         * @returns {Element|null} - O elemento encontrado ou null
         */
        function safeQuerySelector(element, selector) {
            try {
                if (!element) return null;
                return element.querySelector(selector);
            } catch (e) {
                console.error(`Erro ao buscar elemento ${selector}:`, e);
                return null;
            }
        }
        
        /**
         * Exibe uma notificação na tela.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} type - O tipo de notificação ('success', 'error', 'info').
         */
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconClass = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                info: 'fa-info-circle'
            }[type];

            notification.innerHTML = `<i class="fas ${iconClass}"></i><span>${message}</span>`;
            notificationContainer.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        /**
         * Abre o modal genérico com um título e conteúdo de formulário.
         * @param {string} title - O título do modal.
         * @param {string} formHtml - O HTML do corpo do formulário.
         * @param {function} submitCallback - Função a ser chamada no submit do formulário.
         */
        function openModal(title, formHtml, setupCallbackOrSubmitCallback, submitCallbackOrUndefined) {
            modalTitle.textContent = title;
            modalBody.innerHTML = formHtml;
            modal.classList.add('is-open');
            
            // Inicializar tooltips no modal
            setTimeout(() => {
                initializeTooltips();
                // Inicializa os campos de data com a data atual no fuso horário brasileiro
                inicializarCamposData();
            }, 100);

            // Compatibilidade com versão anterior
            let setupCallback, submitCallback;
            
            if (typeof submitCallbackOrUndefined === 'function') {
                // Nova versão: 4 parâmetros
                setupCallback = setupCallbackOrSubmitCallback;
                submitCallback = submitCallbackOrUndefined;
            } else {
                // Versão antiga: 3 parâmetros, onde o terceiro é o submitCallback
                setupCallback = null;
                submitCallback = setupCallbackOrSubmitCallback;
            }

            const form = modalBody.querySelector('form');
            if (form && typeof submitCallback === 'function') {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());
                    submitCallback(data);
                });
            }
            
            // Verificar se há imagens de comprovante no modal e ajustar conforme necessário
            setTimeout(() => {
                const imgComprovantes = modalBody.querySelectorAll('img[alt="Comprovante de pagamento"]');
                imgComprovantes.forEach(img => {
                    // Adicionar tratamento de erro para imagens que não carregam
                    img.onerror = function() {
                        console.error('Erro ao carregar imagem do comprovante');
                        this.style.display = 'none';
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'alert alert-warning';
                        errorMsg.innerHTML = `
                            <i class="fas fa-exclamation-triangle"></i> 
                            Não foi possível exibir o comprovante como imagem. 
                            <br>
                            <a href="#" id="alt-download-btn" class="btn btn-sm btn-primary" style="margin-top:10px;">
                                Baixar comprovante
                            </a>
                        `;
                        this.parentNode.insertBefore(errorMsg, this);
                        
                        // Adicionar evento para tentar baixar o comprovante
                        document.getElementById('alt-download-btn').addEventListener('click', (e) => {
                            e.preventDefault();
                            const src = this.getAttribute('src');
                            const a = document.createElement('a');
                            a.href = src;
                            a.download = 'comprovante.jpg';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        });
                    };
                });
            }, 50);
            
            // Executa o callback de configuração após o HTML do modal ser inserido no DOM
            if (typeof setupCallback === 'function') {
                // Pequeno timeout para garantir que o DOM está completamente atualizado
                setTimeout(() => {
                    setupCallback();
                }, 10);
            }
            
            // Verifica especificamente para o modal de pagamento
            setTimeout(() => {
                // Verificar se este é o modal de pagamento
                const metodoSelect = document.getElementById('pagamento-metodo');
                if (metodoSelect) {
                    const bancoContainer = document.getElementById('banco-origem-container');
                    const cartaoContainer = document.getElementById('cartao-container');
                    
                    if (bancoContainer && cartaoContainer) {
                        const metodo = metodoSelect.value;
                        console.log('Verificação geral do modal - método:', metodo);
                        
                        // Mesma lógica para exibir os campos adequados
                        if (['Pix', 'Transferência', 'Cartão de Débito'].includes(metodo)) {
                            console.log('Força exibição do banco');
                            bancoContainer.style.display = 'block';
                            cartaoContainer.style.display = 'none';
                        } else if (metodo === 'Cartão de Crédito') {
                            console.log('Força exibição do cartão');
                            bancoContainer.style.display = 'none';
                            cartaoContainer.style.display = 'block';
                        }
                        
                        // Adiciona evento para garantir que está associado
                        metodoSelect.addEventListener('change', function() {
                            const metodoNovo = this.value;
                            console.log('Método alterado para (evento global):', metodoNovo);
                            
                            if (['Pix', 'Transferência', 'Cartão de Débito'].includes(metodoNovo)) {
                                bancoContainer.style.display = 'block';
                                cartaoContainer.style.display = 'none';
                            } else if (metodoNovo === 'Cartão de Crédito') {
                                bancoContainer.style.display = 'none';
                                cartaoContainer.style.display = 'block';
                            } else {
                                bancoContainer.style.display = 'none';
                                cartaoContainer.style.display = 'none';
                            }
                        });
                    }
                }
            }, 200);
        }
        
        function closeModal() {
            modal.classList.remove('is-open');
            modalBody.innerHTML = '';
        }
        closeModalBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => {
            if (event.target == modal) {
                closeModal();
            }
        });


        /**
         * Converte string de data para o fuso horário de São Paulo (Brasil)
         * @param {string|Date} dataString - A data a ser convertida
         * @returns {Date} - A data no fuso horário de São Paulo
         */
        function converterDataParaFusoBrasil(dataString) {
            // Se for uma string de data no formato YYYY-MM-DD
            if (dataString && typeof dataString === 'string') {
                // Cria a data com o fuso horário de São Paulo (GMT-3)
                const data = new Date(`${dataString}T12:00:00-03:00`);
                return data;
            }
            // Se for um objeto Date, retorna como está
            if (dataString instanceof Date) {
                return dataString;
            }
            // Caso contrário, retorna a data atual no fuso de São Paulo
            return new Date(new Date().toLocaleString("en-US", {timeZone: "America/Sao_Paulo"}));
        }
        
        /**
         * Formata data no formato brasileiro
         * @param {Date|string} data - A data a ser formatada
         * @returns {string} - A data formatada no padrão brasileiro
         */
        function formatarDataBrasil(data) {
            if (!(data instanceof Date)) {
                if (typeof data === 'string') {
                    data = converterDataParaFusoBrasil(data);
                } else {
                    return '';
                }
            }
            return data.toLocaleDateString('pt-BR', {timeZone: 'America/Sao_Paulo'});
        }
        
        /**
         * Retorna a data atual no fuso horário de São Paulo (Brasil)
         * @returns {Date} - A data atual no fuso horário de São Paulo
         */
        function obterDataAtualBrasil() {
            return new Date(new Date().toLocaleString("en-US", {timeZone: "America/Sao_Paulo"}));
        }
        
        /**
         * Retorna a data atual no fuso horário de São Paulo (Brasil) no formato YYYY-MM-DD
         * @returns {string} - A data atual no formato YYYY-MM-DD
         */
        function obterDataAtualBrasilFormatada() {
            return obterDataAtualBrasil().toISOString().split('T')[0];
        }


        // Função para inicializar todos os campos de data com a data atual no fuso horário brasileiro
function inicializarCamposData() {
    // Substitui todas as strings de template que usam new Date().toISOString() por obterDataAtualBrasilFormatada()
    document.querySelectorAll('input[type="date"]').forEach(input => {
        if (input.value === '') {
            input.value = obterDataAtualBrasilFormatada();
        }
    });
}

// Adiciona a função ao carregamento da página
document.addEventListener('DOMContentLoaded', function() {
    inicializarCamposData();
});

// --- 4. LÓGICA DE AUTENTICAÇÃO (AUTH) ---

        // Gerenciador de abas de login/cadastro
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.auth-tab, .auth-form').forEach(el => el.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-form`).classList.add('active');
            });
        });

        // Evento de submit do formulário de login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showNotification('Login realizado com sucesso!', 'success');
            } catch (error) {
                console.error("Erro no login:", error);
                
                let mensagemErro = "Erro ao fazer login. Tente novamente.";
                
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    mensagemErro = "E-mail ou senha incorretos. Por favor, verifique e tente novamente.";
                } else if (error.code === 'auth/invalid-email') {
                    mensagemErro = "E-mail inválido. Por favor, verifique o formato.";
                } else if (error.code === 'auth/too-many-requests') {
                    mensagemErro = "Conta temporariamente bloqueada. Tente novamente mais tarde ou recupere sua senha.";
                } else if (error.code === 'auth/network-request-failed') {
                    mensagemErro = "Problemas de conexão. Verifique sua internet e tente novamente.";
                }
                
                showNotification(mensagemErro, 'error');
            }
        });

        // Evento de submit do formulário de cadastro
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = registerForm['register-name'].value;
            const email = registerForm['register-email'].value;
            const password = registerForm['register-password'].value;
            const confirmPassword = registerForm['register-confirm-password'].value;

            if (password !== confirmPassword) {
                showNotification('As senhas não coincidem.', 'error');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name });
                showNotification('Cadastro realizado com sucesso!', 'success');
                // O onAuthStateChanged irá lidar com a transição da UI
            } catch (error) {
                console.error("Erro no cadastro:", error);
                
                // Personaliza as mensagens de erro para melhor experiência do usuário
                let mensagemErro = "Erro ao cadastrar. Tente novamente.";
                
                if (error.code === 'auth/email-already-in-use') {
                    mensagemErro = "Este e-mail já está cadastrado. Tente fazer login ou use outro e-mail.";
                } else if (error.code === 'auth/weak-password') {
                    mensagemErro = "Senha muito fraca. Use pelo menos 6 caracteres com letras e números.";
                } else if (error.code === 'auth/invalid-email') {
                    mensagemErro = "E-mail inválido. Por favor, verifique o formato.";
                } else if (error.code === 'auth/network-request-failed') {
                    mensagemErro = "Problemas de conexão. Verifique sua internet e tente novamente.";
                }
                
                showNotification(mensagemErro, 'error');
            }
        });
        
        // Evento de clique para login com Google
        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                showNotification('Login com Google realizado com sucesso!', 'success');
            } catch (error) {
                console.error("Erro no login com Google:", error);
                
                let mensagemErro = "Erro ao entrar com Google. Tente novamente.";
                
                if (error.code === 'auth/popup-closed-by-user') {
                    mensagemErro = "O login foi cancelado. Tente novamente quando precisar.";
                } else if (error.code === 'auth/popup-blocked') {
                    mensagemErro = "O pop-up foi bloqueado pelo navegador. Permita pop-ups e tente novamente.";
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    mensagemErro = "Este e-mail já está sendo usado com outro método de login.";
                } else if (error.code === 'auth/network-request-failed') {
                    mensagemErro = "Problemas de conexão. Verifique sua internet e tente novamente.";
                }
                
                showNotification(mensagemErro, 'error');
            }
        });
        
        // Evento para recuperação de senha
        forgotPasswordLink.addEventListener('click', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            if (!email) {
                showNotification('Por favor, digite seu e-mail no campo de login primeiro.', 'info');
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                showNotification(`E-mail de recuperação enviado para ${email}.`, 'success');
            } catch (error) {
                console.error("Erro ao enviar email de recuperação:", error);
                
                let mensagemErro = "Erro ao enviar e-mail de recuperação.";
                
                if (error.code === 'auth/user-not-found') {
                    mensagemErro = "Não encontramos uma conta com este e-mail. Verifique ou crie uma nova conta.";
                } else if (error.code === 'auth/invalid-email') {
                    mensagemErro = "E-mail inválido. Por favor, verifique o formato.";
                } else if (error.code === 'auth/too-many-requests') {
                    mensagemErro = "Muitas tentativas. Aguarde alguns minutos antes de tentar novamente.";
                } else if (error.code === 'auth/network-request-failed') {
                    mensagemErro = "Problemas de conexão. Verifique sua internet e tente novamente.";
                }
                
                showNotification(mensagemErro, 'error');
            }
        });

        // Função de Logout
        async function handleLogout() {
            try {
                await signOut(auth);
                if (gastosUnsubscribe) gastosUnsubscribe();
                if (cartoesUnsubscribe) cartoesUnsubscribe();
                if (bancosUnsubscribe) bancosUnsubscribe();
                if (rendasUnsubscribe) rendasUnsubscribe();
                showNotification('Você saiu da sua conta.', 'info');
            } catch (error) {
                console.error("Erro ao sair:", error);
                showNotification(`Erro ao sair: ${error.message}`, 'error');
            }
        }

        // --- 5. LÓGICA DA APLICAÇÃO (APP) ---
        
        // Monitora mudanças no estado de autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                initializeAppUI();
            } else {
                resetAppUI();
            }
        });

        /**
         * Inicializa a interface da aplicação quando o usuário está logado.
         */
        function initializeAppUI() {
            // Esconde o container de autenticação
            authContainer.style.display = 'none';
            
            // Mostra o container da aplicação
            appContainer.style.display = 'grid';
            appContainer.style.visibility = 'visible';
            
            renderSidebar();
            renderTopbar();
            setupNavigation();
            setupDashboardNavigation();
            
            // Inicializa os campos de data com a data atual no fuso horário brasileiro
            inicializarCamposData();
        }

        /**
         * Volta para a tela de autenticação quando o usuário está deslogado.
         */
        function resetAppUI() {
            // Esconde o container da aplicação
            appContainer.style.display = 'none';
            appContainer.style.visibility = 'hidden';
            
            // Mostra o container de autenticação
            authContainer.style.display = 'block';
            
            // Limpa os dados do usuário e listeners
            currentUser = null;
            if (gastosUnsubscribe) gastosUnsubscribe();
            if (cartoesUnsubscribe) cartoesUnsubscribe();
            if (bancosUnsubscribe) bancosUnsubscribe();
            if (rendasUnsubscribe) rendasUnsubscribe();
        }

        /**
         * Renderiza o menu lateral (sidebar).
         */
        function renderSidebar() {
            const sidebar = document.getElementById('app-sidebar');
            sidebar.innerHTML = `
                <div class="sidebar-header">
                    <i class="fas fa-wallet"></i>
                    <span>FinControle</span>
                </div>
                <nav>
                    <ul>
                        <li><a href="#dashboard" class="nav-link"><i class="fas fa-fw fa-chart-pie"></i> <span>Dashboard</span></a></li>
                        <li><a href="#gastos" class="nav-link"><i class="fas fa-fw fa-money-bill-wave"></i> <span>Gastos</span></a></li>
                        <li><a href="#rendas" class="nav-link"><i class="fas fa-fw fa-coins"></i> <span>Rendas</span></a></li>
                        <li><a href="#cartoes" class="nav-link"><i class="fas fa-fw fa-credit-card"></i> <span>Cartões</span></a></li>
                        <li><a href="#bancos" class="nav-link"><i class="fas fa-fw fa-university"></i> <span>Bancos</span></a></li>
                        <li><a href="#configuracoes" class="nav-link"><i class="fas fa-fw fa-cog"></i> <span>Configurações</span></a></li>
                    </ul>
                </nav>
                <a href="#" id="logout-btn" class="nav-link logout-link"><i class="fas fa-fw fa-sign-out-alt"></i> <span>Sair</span></a>
            `;
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                handleLogout();
            });
        }

        /**
         * Renderiza a barra superior (topbar).
         */
        function renderTopbar() {
            const topbar = document.getElementById('app-topbar');
            const userName = currentUser?.displayName || 'Usuário';
            
            // Usar URL de imagem local como fallback
            const defaultPhotoUrl = 'https://placehold.co/40x40/4f46e5/ffffff?text=U';
            
            // Verificar se a URL da foto é de alguma origem problemática
            const userPhotoUrl = currentUser?.photoURL || defaultPhotoUrl;
            const problematicDomains = ['photos.fife.usercontent.google.com', 'instagram.', 'fbcdn.net', 'gravatar.com'];
            
            // Verificar se a URL contém algum dos domínios problemáticos
            const isProblematicUrl = problematicDomains.some(domain => 
                userPhotoUrl && userPhotoUrl.includes(domain)
            );
            
            // Usar URL padrão se for problemática
            const userPhoto = isProblematicUrl ? defaultPhotoUrl : userPhotoUrl;
            
            topbar.innerHTML = `
                <button id="mobile-menu-toggle" class="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="page-title">Dashboard</h2>
                <div class="user-profile">
                    <span>Olá, ${userName}</span>
                    <img src="${userPhoto}" alt="Foto do perfil" onerror="this.src='${defaultPhotoUrl}'; this.onerror=null;">
                </div>
            `;
            
            // Forçar a limpar qualquer armazenamento problemático quando a página carrega
            setTimeout(() => {
                try {
                    const profileImg = document.querySelector('.user-profile img');
                    if (profileImg && profileImg.complete && profileImg.naturalHeight === 0) {
                        profileImg.src = defaultPhotoUrl;
                    }
                } catch (e) {
                    console.error('Erro ao verificar a imagem de perfil:', e);
                }
            }, 1000);
        }

        // --- 6. NAVEGAÇÃO E ROTEAMENTO ---
        
        /**
         * Configura os listeners para a navegação baseada em hash.
         */
        function setupNavigation() {
            // Atualiza a navegação quando o hash muda
            window.addEventListener('hashchange', () => {
                const page = window.location.hash.substring(1) || 'dashboard';
                navigateTo(page);
            });

            // Configura a navegação inicial
            const initialPage = window.location.hash.substring(1) || 'dashboard';
            navigateTo(initialPage);

            // Listener para os links da sidebar (usando delegação de eventos)
            document.getElementById('app-sidebar').addEventListener('click', e => {
                const link = e.target.closest('.nav-link');
                
                // Tratamento especial para dropdown toggle
                if (link && link.classList.contains('dropdown-toggle')) {
                    e.preventDefault();
                    const dropdownItem = link.closest('.dropdown');
                    dropdownItem.classList.toggle('active');
                    return;
                }
                
                if (link && link.href.includes('#')) {
                    e.preventDefault(); // Previne o comportamento padrão
                    const page = link.getAttribute('href').substring(1);
                    navigateTo(page);
                }
            });
        }
        
        /**
         * Navega para a página especificada.
         * @param {string} pageName - O nome da página (e.g., 'dashboard', 'gastos').
         */
        function navigateTo(pageName) {
            if (!pageName) pageName = 'dashboard';
            
            // Atualiza o hash da URL sem disparar o evento hashchange
            if (window.location.hash !== `#${pageName}`) {
                history.pushState(null, '', `#${pageName}`);
            }
            
            // Esconde todas as páginas
            document.querySelectorAll('.main-content').forEach(p => p.classList.remove('active'));
            
            // Remove a classe 'active' de todos os links de navegação
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));

            // Mostra a página correta
            const targetPage = document.getElementById(`${pageName}-page`);
            if (targetPage) {
                targetPage.classList.add('active');
            } else {
                // Página padrão caso o hash seja inválido
                document.getElementById('dashboard-page').classList.add('active');
                pageName = 'dashboard';
            }
            
            // Ativa o link correspondente
            const activeLink = document.querySelector(`.nav-link[href="#${pageName}"]`);
            if (activeLink) activeLink.classList.add('active');

            // Atualiza o título da página na topbar
            const pageTitleEl = document.getElementById('page-title');
            if (pageTitleEl) {
                const titleMap = {
                    dashboard: 'Dashboard',
                    gastos: 'Meus Gastos',
                    rendas: 'Minhas Rendas',
                    cartoes: 'Meus Cartões',
                    bancos: 'Meus Bancos',
                    configuracoes: 'Configurações do Sistema',
                };
                pageTitleEl.textContent = titleMap[pageName] || 'Dashboard';
            }

            // Carrega os dados da página
            loadPageData(pageName);
        }

        /**
         * Carrega os dados específicos para a página ativa.
         */
        function loadPageData(pageName) {
            // Cancela listeners anteriores para evitar duplicação
            if (gastosUnsubscribe) { gastosUnsubscribe(); gastosUnsubscribe = null; }
            if (cartoesUnsubscribe) { cartoesUnsubscribe(); cartoesUnsubscribe = null; }
            if (bancosUnsubscribe) { bancosUnsubscribe(); bancosUnsubscribe = null; }
            if (rendasUnsubscribe) { rendasUnsubscribe(); rendasUnsubscribe = null; }
            
            // Inicializar tooltips após um breve delay para garantir que o DOM foi atualizado
            setTimeout(() => {
                initializeTooltips();
            }, 300);
            
            switch (pageName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'gastos':
                    loadGastosData();
                    break;
                case 'rendas':
                    loadRendasData();
                    break;
                case 'cartoes':
                    loadCartoesData();
                    break;
                case 'bancos':
                    loadBancosData();
                    break;
                case 'configuracoes':
                    loadConfiguracoesData();
                    break;
            }
        }
        

        // --- 7. MÓDULOS DE FUNCIONALIDADE (DASHBOARD, GASTOS, CARTÕES) ---
        
        // Variável global para controlar o mês atual do dashboard
        let dashboardMesAtual = new Date();
        
        // Função para configurar a navegação do dashboard
        function setupDashboardNavigation() {
            // Configurar botão de mês anterior
            document.getElementById('btn-dashboard-anterior').addEventListener('click', () => {
                const novoMes = new Date(dashboardMesAtual);
                novoMes.setMonth(novoMes.getMonth() - 1);
                loadDashboardData(novoMes);
            });
            
            // Configurar botão de mês atual
            document.getElementById('btn-dashboard-atual').addEventListener('click', () => {
                loadDashboardData(new Date());
            });
            
            // Configurar botão de próximo mês
            document.getElementById('btn-dashboard-proximo').addEventListener('click', () => {
                const novoMes = new Date(dashboardMesAtual);
                novoMes.setMonth(novoMes.getMonth() + 1);
                loadDashboardData(novoMes);
            });
            
            // Marcar o botão do mês atual como ativo
            document.getElementById('btn-dashboard-atual').classList.add('active');
                  }
          
          // Função para criar rodapé com botão de ação (se existir)
          // A função criarRodapeCard foi movida para o arquivo dashboard-utils.js
        
        // As funções criarCardRenda, criarCardGasto e criarCardGenerico foram movidas para o arquivo dashboard-utils.js
        
        // --- Dashboard ---
        async function loadDashboardData(mes = new Date()) {
            if (!currentUser) return;
            
            // Atualizar a variável global
            dashboardMesAtual = new Date(mes);
            
            // Atualizar o título do dashboard
            const mesNome = dashboardMesAtual.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            document.getElementById('dashboard-mes-atual').textContent = mesNome;
            
            // Atualizar estado dos botões
            const hoje = new Date();
            const mesAtual = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const mesLimite = new Date(hoje.getFullYear() + 1, hoje.getMonth(), 1);
            
            document.getElementById('btn-dashboard-proximo').disabled = 
                dashboardMesAtual.getFullYear() > mesLimite.getFullYear() || 
                (dashboardMesAtual.getFullYear() === mesLimite.getFullYear() && 
                 dashboardMesAtual.getMonth() >= mesLimite.getMonth());
                 
            document.getElementById('btn-dashboard-atual').disabled = 
                dashboardMesAtual.getMonth() === mesAtual.getMonth() && 
                dashboardMesAtual.getFullYear() === mesAtual.getFullYear();
            
            // Definir o início e fim do mês selecionado
            const inicioDoMes = new Date(dashboardMesAtual.getFullYear(), dashboardMesAtual.getMonth(), 1);
            const fimDoMes = new Date(dashboardMesAtual.getFullYear(), dashboardMesAtual.getMonth() + 1, 0);
            
            // Formatar para comparação com string ISO
            const inicioDoMesStr = inicioDoMes.toISOString().split('T')[0];
            const fimDoMesStr = fimDoMes.toISOString().split('T')[0];
            
            // Balanço mensal foi removido
            // await carregarBalancoMensal();
            
            // 1. Carregar dados de gastos APENAS do mês atual para os cards
            const gastosRef = collection(db, 'users', currentUser.uid, 'gastos');
            const gastosQuery = query(gastosRef, 
                where("data", ">=", inicioDoMesStr),
                where("data", "<=", fimDoMesStr)
            );
            const gastosSnapshot = await getDocs(gastosQuery);
            
            let totalGastosMes = 0;
            const gastosPorCategoria = {};
            
            gastosSnapshot.forEach(doc => {
                const gasto = doc.data();
                const categoria = gasto.categoria || 'Outros';
                const valor = parseFloat(gasto.valor);
                
                totalGastosMes += valor;
                
                // Para o gráfico de categorias (somente mês atual)
                if (!gastosPorCategoria[categoria]) {
                    gastosPorCategoria[categoria] = 0;
                }
                gastosPorCategoria[categoria] += valor;
            });
            
            // Atualizar o elemento de total de gastos (se existir)
            const totalGastosElement = document.getElementById('total-gastos');
            if (totalGastosElement) {
                totalGastosElement.textContent = `R$ ${totalGastosMes.toFixed(2)}`;
            }
            
            // 2. Carregar dados de rendas APENAS do mês atual para os cards
            const rendasRef = collection(db, 'users', currentUser.uid, 'rendas');
            const rendasQuery = query(rendasRef,
                where("data", ">=", inicioDoMesStr),
                where("data", "<=", fimDoMesStr)
            );
            const rendasSnapshot = await getDocs(rendasQuery);
            
            let totalRendasMes = 0;
            let rendasAguardando = 0;
            const rendas = [];
            
            rendasSnapshot.forEach(doc => {
                const renda = doc.data();
                renda.id = doc.id;
                rendas.push(renda);
                const valor = parseFloat(renda.valor);
                totalRendasMes += valor;
                
                // Calcular rendas aguardando para o resumo progressivo
                if (renda.statusRecebimento === 'aguardando') {
                    rendasAguardando += valor;
                }
            });
            
            // Atualizar o elemento de total de rendas (se existir)
            const totalRendasElement = document.getElementById('total-rendas');
            if (totalRendasElement) {
                totalRendasElement.textContent = `R$ ${totalRendasMes.toFixed(2)}`;
            }
            
            // Carregar a lista de rendas no dashboard
            await carregarRendasDashboard(rendas);
            
            // Carregar metas e limites no dashboard
            await carregarMetasDashboard();
            
            // Carregar gastos pendentes e fixos no dashboard
            const totalGastosPendentes = await atualizarDashboardGastos(dashboardMesAtual);
            
            // Calcular o saldo do mês
            const saldoMes = totalRendasMes - totalGastosMes;
            
            // Atualizar o saldo do mês (se o elemento existir)
            const saldoMesElement = document.getElementById('saldo-mes');
            if (saldoMesElement) {
                saldoMesElement.textContent = `R$ ${saldoMes.toFixed(2)}`;
                
                // Aplicar cor ao saldo (vermelho se negativo, verde se positivo)
                if (saldoMes < 0) {
                    saldoMesElement.style.color = 'var(--danger-color)';
                } else {
                    saldoMesElement.style.color = 'var(--secondary-color)';
                }
            }
            
            // 3. Carregar dados de bancos
            const bancosRef = collection(db, 'users', currentUser.uid, 'bancos');
            const bancosSnapshot = await getDocs(bancosRef);
            
            let saldoTotalBancos = 0;
            const bancos = [];

            bancosSnapshot.forEach(doc => {
                const banco = { id: doc.id, ...doc.data() };
                bancos.push(banco);
                saldoTotalBancos += parseFloat(banco.saldo);
            });
            
            // Atualizar o elemento de saldo em bancos (se existir)
            const totalBancosElement = document.getElementById('total-bancos');
            if (totalBancosElement) {
                totalBancosElement.textContent = `R$ ${saldoTotalBancos.toFixed(2)}`;
            }
            
            // 4. Carregar faturas não pagas para o valor total negativo
            const valorFaturasNaoPagas = await carregarValorFaturasNaoPagas(dashboardMesAtual);
            
            // Atualizar o resumo progressivo
            await atualizarResumoProgressivo(saldoTotalBancos, rendasAguardando, totalGastosPendentes, valorFaturasNaoPagas);
            
            // Atualizar a Visão Financeira Detalhada
            await atualizarVisaoFinanceiraDetalhada(saldoTotalBancos, totalRendasMes, totalGastosMes, fimDoMesStr);
            
            // Exibir a lista de bancos no dashboard
            const dashboardBancosList = document.getElementById('dashboard-bancos-list');
            const dashboardBancosLoading = document.getElementById('dashboard-bancos-loading');
            const dashboardBancosEmpty = document.getElementById('dashboard-bancos-empty');
            
            dashboardBancosLoading.style.display = 'none';
            
            if (bancos.length === 0) {
                dashboardBancosEmpty.style.display = 'block';
                return;
            }
            
            // Ordena os bancos por saldo (maior para menor)
            bancos.sort((a, b) => parseFloat(b.saldo) - parseFloat(a.saldo));
            
            // Limpar visualização anterior em cards (se existir)
            const cardViewExistente = dashboardBancosList.querySelector('.dashboard-card-view');
            if (cardViewExistente) {
                cardViewExistente.remove();
            }
            
            // Cria a lista de bancos
            dashboardBancosList.style.display = 'block';
            dashboardBancosList.innerHTML = '';
            
            // Adiciona o cabeçalho da tabela
            const tabelaBancos = document.createElement('table');
            tabelaBancos.className = 'data-table';
            tabelaBancos.innerHTML = `
                <thead>
                    <tr>
                        <th>Banco</th>
                        <th>Tipo de Conta</th>
                        <th>Agência/Conta</th>
                        <th>Saldo</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" style="text-align: right; font-weight: bold;">Total</td>
                        <td style="font-weight: bold; ${saldoTotalBancos < 0 ? 'color: var(--danger-color)' : 'color: var(--secondary-color)'}">R$ ${saldoTotalBancos.toFixed(2)}</td>
                    </tr>
                </tfoot>
            `;
            
            const tbody = tabelaBancos.querySelector('tbody');
            
            // Adiciona as linhas dos bancos
            bancos.forEach(banco => {
                const row = document.createElement('tr');
                
                // Define a cor do saldo (vermelho se negativo, verde se positivo)
                const saldoColor = parseFloat(banco.saldo) < 0 ? 'color: var(--danger-color)' : 'color: var(--secondary-color)';
                
                row.innerHTML = `
                    <td>${banco.nome}</td>
                    <td>${banco.tipoConta}</td>
                    <td>${banco.agencia} / ${banco.conta}</td>
                    <td style="font-weight: 500; ${saldoColor}">R$ ${parseFloat(banco.saldo).toFixed(2)}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            dashboardBancosList.appendChild(tabelaBancos);
            
            // Adiciona um link para ir para a página de bancos
            const verTodosLink = document.createElement('div');
            verTodosLink.style.textAlign = 'right';
            verTodosLink.style.marginTop = '1rem';
            verTodosLink.innerHTML = `
                <a href="#bancos" class="btn" style="width: auto; padding: 0.5rem 1rem; display: inline-block;">
                    <i class="fas fa-eye"></i> Ver Todos
                </a>
            `;
            
            dashboardBancosList.appendChild(verTodosLink);
            
            // Previsão financeira foi removida
            // await carregarPrevisaoFinanceira();
            
            // 4. Carregar dados de faturas de cartões para o mês selecionado
            await carregarFaturasCartoes(dashboardMesAtual);
            
            // 5. Carregar dados de gastos (fixos e pendentes)
            await atualizarDashboardGastos(dashboardMesAtual);
            
            // 6. Transformar tabelas em cards para visualização mobile
            setTimeout(transformarTabelasDashboardEmCards, 500);
        }
        
        // Função para carregar o balanço mensal foi removida
        async function carregarBalancoMensal() {
            // Essa função foi mantida como stub para não quebrar referências,
            // mas todo o conteúdo foi removido já que o card foi excluído
            return;
        }
        
        // Função para atualizar a Visão Financeira Detalhada
        async function atualizarVisaoFinanceiraDetalhada(saldoTotalBancos, totalRendasMes, totalGastosMes, fimDoMesStr) {
            if (!currentUser) return;
            
            // 1. Saldo Atual = Saldo em Bancos
            const saldoAtual = saldoTotalBancos;
            // Os elementos da "Visão Financeira Detalhada" foram removidos, não precisamos mais atualizar esses elementos
            
            // 2. Buscar gastos pendentes (todos os gastos não pagos do mês atual)
            const hoje = new Date();
            const dataHoje = hoje.toISOString().split('T')[0];
            
            // Obtém gastos desde hoje até o fim do mês
            const gastosRef = collection(db, 'users', currentUser.uid, 'gastos');
            const gastosFuturosQuery = query(gastosRef,
                where("data", ">=", dataHoje),
                where("data", "<=", fimDoMesStr),
                where("pago", "==", false)
            );
            
            // Obtém rendas desde hoje até o fim do mês
            const rendasRef = collection(db, 'users', currentUser.uid, 'rendas');
            const rendasFuturasQuery = query(rendasRef,
                where("data", ">=", dataHoje),
                where("data", "<=", fimDoMesStr),
                where("recebido", "==", false)
            );
            
            // Execute as consultas em paralelo
            const [gastosFuturosSnapshot, rendasFuturasSnapshot] = await Promise.all([
                getDocs(gastosFuturosQuery),
                getDocs(rendasFuturasQuery)
            ]);
            
            // 3. Calcular total de gastos pendentes
            let gastosPendentes = 0;
            gastosFuturosSnapshot.forEach(doc => {
                const gasto = doc.data();
                gastosPendentes += parseFloat(gasto.valor);
            });
            
            // Adicionar também as faturas de cartão pendentes
            const cartoesRef = collection(db, 'users', currentUser.uid, 'cartoes');
            const cartoesSnapshot = await getDocs(cartoesRef);
            
            // Para cada cartão, verificar se há fatura em aberto
            for (const cartaoDoc of cartoesSnapshot.docs) {
                const cartao = cartaoDoc.data();
                const faturasRef = collection(db, 'users', currentUser.uid, 'cartoes', cartaoDoc.id, 'faturas');
                
                // Buscar faturas em aberto
                const faturasQuery = query(faturasRef, 
                    where("status", "in", ["Aberta", "Vencida"]),
                    where("dataVencimento", ">=", dataHoje),
                    where("dataVencimento", "<=", fimDoMesStr)
                );
                
                const faturasSnapshot = await getDocs(faturasQuery);
                
                faturasSnapshot.forEach(doc => {
                    const fatura = doc.data();
                    if (parseFloat(fatura.valor) > 0) {
                        gastosPendentes += parseFloat(fatura.valor);
                    }
                });
            }
            
            // Os elementos da "Visão Financeira Detalhada" foram removidos
            // Mantemos os cálculos para uso em outros lugares, mas não atualizamos mais os elementos HTML
            
            // 4. Calcular total de recebimentos pendentes
            let recebimentosPendentes = 0;
            rendasFuturasSnapshot.forEach(doc => {
                const renda = doc.data();
                recebimentosPendentes += parseFloat(renda.valor);
            });
            
            // 5. Calcular saldo futuro previsto
            // Saldo futuro = Saldo atual - Gastos pendentes + Recebimentos pendentes
            const saldoFuturo = saldoAtual - gastosPendentes + recebimentosPendentes;
        }
        
        // Função para obter o primeiro e último dia do mês
        function getPrimeiroeUltimoDiaMes(mes) {
            const primeiroDiaMes = new Date(mes.getFullYear(), mes.getMonth(), 1);
            const ultimoDiaMes = new Date(mes.getFullYear(), mes.getMonth() + 1, 0);
            return [primeiroDiaMes, ultimoDiaMes];
        }
        
        // Função para carregar os gastos pendentes no dashboard
        async function carregarGastosPendentesDashboard(mes = dashboardMesAtual) {
            if (!currentUser) return 0;
            
            const dashboardGastosPendentesLoading = document.getElementById('dashboard-gastos-pendentes-loading');
            const dashboardGastosPendentesEmpty = document.getElementById('dashboard-gastos-pendentes-empty');
            const dashboardGastosPendentesList = document.getElementById('dashboard-gastos-pendentes-list');
            
            // Limpar conteúdos anteriores
            dashboardGastosPendentesList.innerHTML = '';
            
            // Mostrar loading
            dashboardGastosPendentesLoading.style.display = 'block';
            dashboardGastosPendentesEmpty.style.display = 'none';
            dashboardGastosPendentesList.style.display = 'none';
            
            // Obter o primeiro e último dia do mês
            const [primeiroDiaMes, ultimoDiaMes] = getPrimeiroeUltimoDiaMes(mes);
            
            // Buscar todos os gastos pendentes do mês
            const gastosRef = collection(db, 'users', currentUser.uid, 'gastos');
            const q = query(
                gastosRef,
                where('data', '>=', primeiroDiaMes.toISOString().split('T')[0]),
                where('data', '<=', ultimoDiaMes.toISOString().split('T')[0]),
                where('pago', '==', false)
            );
            const querySnapshot = await getDocs(q);
            
            const gastosPendentes = [];
            querySnapshot.forEach(doc => {
                gastosPendentes.push({ id: doc.id, ...doc.data() });
            });
            
            // Buscar também gastos com método de pagamento "Pendente"
            const qPendentes = query(
                gastosRef,
                where('data', '>=', primeiroDiaMes.toISOString().split('T')[0]),
                where('data', '<=', ultimoDiaMes.toISOString().split('T')[0]),
                where('metodoPagamento', '==', 'Pendente')
            );
            const pendentesSnapshot = await getDocs(qPendentes);
            
            pendentesSnapshot.forEach(doc => {
                const gasto = { id: doc.id, ...doc.data() };
                // Verificar se já não foi adicionado
                if (!gastosPendentes.some(g => g.id === gasto.id)) {
                    gastosPendentes.push(gasto);
                }
            });
            
            // Se não há gastos pendentes para mostrar
            if (gastosPendentes.length === 0) {
                dashboardGastosPendentesLoading.style.display = 'none';
                dashboardGastosPendentesEmpty.style.display = 'block';
                return 0;
            }
            
            // Ordenar gastos por data (mais próximos primeiro)
            gastosPendentes.sort((a, b) => new Date(a.data) - new Date(b.data));
            
            // Calcular total de gastos pendentes
            let totalGastosPendentes = 0;
            gastosPendentes.forEach(gasto => {
                totalGastosPendentes += parseFloat(gasto.valor);
            });
            
            // Criar a tabela de gastos pendentes
            const tabelaGastosPendentes = document.createElement('table');
            tabelaGastosPendentes.className = 'data-table';
            tabelaGastosPendentes.innerHTML = `
                <thead>
                    <tr>
                        <th>Descrição</th>
                        <th>Valor</th>
                        <th>Data</th>
                        <th>Categoria</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                    <tr>
                        <td colspan="1" style="text-align: right; font-weight: bold;">Total Pendente:</td>
                        <td style="font-weight: bold; color: var(--danger-color);">R$ ${totalGastosPendentes.toFixed(2)}</td>
                        <td colspan="3"></td>
                    </tr>
                </tfoot>
            `;
            
            const tbody = tabelaGastosPendentes.querySelector('tbody');
            
            // Adicionar as linhas dos gastos pendentes
            gastosPendentes.forEach(gasto => {
                const row = document.createElement('tr');
                row.style.backgroundColor = '#fff8e1'; // Fundo amarelo claro
                
                // Calcular quantos dias faltam para o vencimento
                const dataGasto = new Date(gasto.data);
                const hoje = new Date();
                const diasRestantes = Math.floor((dataGasto - hoje) / (1000 * 60 * 60 * 24));
                
                let statusPagamento = '';
                if (diasRestantes < 0) {
                    statusPagamento = `<span style="color: red; font-weight: bold;">Atrasado (${Math.abs(diasRestantes)} dias)</span>`;
                } else if (diasRestantes === 0) {
                    statusPagamento = '<span style="color: red; font-weight: bold;">Vence hoje</span>';
                } else if (diasRestantes <= 3) {
                    statusPagamento = `<span style="color: orange; font-weight: bold;">Vence em ${diasRestantes} dias</span>`;
                } else {
                    statusPagamento = `<span style="color: green;">Vence em ${diasRestantes} dias</span>`;
                }
                
                row.innerHTML = `
                    <td>${gasto.descricao}</td>
                    <td>R$ ${parseFloat(gasto.valor).toFixed(2)}</td>
                    <td>${new Date(gasto.data).toLocaleDateString()} <br> ${statusPagamento}</td>
                    <td>${gasto.categoria}</td>
                    <td class="actions">
                        <button class="pay-btn" data-id="${gasto.id}" title="Realizar Pagamento">
                            <i class="fas fa-money-bill-wave"></i>
                        </button>
                        <button class="view-btn" data-id="${gasto.id}" title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Exibir a tabela
            dashboardGastosPendentesLoading.style.display = 'none';
            dashboardGastosPendentesList.style.display = 'block';
            dashboardGastosPendentesList.appendChild(tabelaGastosPendentes);
            
            // Adicionar link para ver todos
            const verTodosLink = document.createElement('div');
            verTodosLink.style.textAlign = 'right';
            verTodosLink.style.marginTop = '1rem';
            verTodosLink.innerHTML = `
                <a href="#gastos" class="btn" style="width: auto; padding: 0.5rem 1rem; display: inline-block;">
                    <i class="fas fa-eye"></i> Ver Todos
                </a>
            `;
            
            dashboardGastosPendentesList.appendChild(verTodosLink);
            
            // Adicionar listener para o botão de pagamento
            dashboardGastosPendentesList.addEventListener('click', async (event) => {
                const target = event.target.closest('.pay-btn');
                if (!target) return;
                
                const gastoId = target.dataset.id;
                if (!gastoId) return;
                
                // Abrir modal de pagamento
                await abrirModalPagamento(gastoId);
            });
            
            return totalGastosPendentes;
        }
        
        // Função para atualizar o dashboard de gastos (fixos e pendentes)
        async function atualizarDashboardGastos(mes = dashboardMesAtual) {
            if (!currentUser) return 0;
            
            // Carregar apenas gastos pendentes (seção de gastos fixos foi removida)
            const totalGastosPendentes = await carregarGastosPendentesDashboard(mes);
            
            // Retornar o total de gastos pendentes para cálculos de saldo futuro
            return totalGastosPendentes;
        }
        
        // Função para carregar rendas no dashboard
        async function carregarRendasDashboard(rendas, mes = dashboardMesAtual) {
            if (!currentUser) return;
            
            const dashboardRendasLoading = document.getElementById('dashboard-rendas-loading');
            const dashboardRendasEmpty = document.getElementById('dashboard-rendas-empty');
            const dashboardRendasList = document.getElementById('dashboard-rendas-list');
            
            // Limpar conteúdos anteriores
            dashboardRendasList.innerHTML = '';
            
            // Mostrar loading
            dashboardRendasLoading.style.display = 'block';
            dashboardRendasEmpty.style.display = 'none';
            dashboardRendasList.style.display = 'none';
            
            // Se não há rendas para mostrar
            if (rendas.length === 0) {
                dashboardRendasLoading.style.display = 'none';
                dashboardRendasEmpty.style.display = 'block';
                return;
            }
            
            // Ordenar rendas por data (mais recentes primeiro)
            rendas.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            // Separar rendas por status de recebimento
            const rendasAguardando = rendas.filter(renda => renda.statusRecebimento === 'aguardando');
            const rendasRecebidas = rendas.filter(renda => renda.statusRecebimento === 'recebido');
            
            // Calcular totais
            let totalAguardando = 0;
            let totalRecebido = 0;
            
            rendasAguardando.forEach(renda => {
                totalAguardando += parseFloat(renda.valor);
            });
            
            rendasRecebidas.forEach(renda => {
                totalRecebido += parseFloat(renda.valor);
            });
            
            // Criar a tabela de rendas
            const tabelaRendas = document.createElement('table');
            tabelaRendas.className = 'data-table';
            tabelaRendas.innerHTML = `
                <thead>
                    <tr>
                        <th>Descrição</th>
                        <th>Data</th>
                        <th>Valor</th>
                        <th>Categoria</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                    <tr>
                        <td colspan="2" style="text-align: right; font-weight: bold;">Total Aguardando:</td>
                        <td style="font-weight: bold; color: var(--danger-color);">R$ ${totalAguardando.toFixed(2)}</td>
                        <td colspan="3"></td>
                    </tr>
                    <tr>
                        <td colspan="2" style="text-align: right; font-weight: bold;">Total Recebido:</td>
                        <td style="font-weight: bold; color: var(--secondary-color);">R$ ${totalRecebido.toFixed(2)}</td>
                        <td colspan="3"></td>
                    </tr>
                </tfoot>
            `;
            
            const tbody = tabelaRendas.querySelector('tbody');
            
            // Adicionar as linhas das rendas
            rendas.forEach(renda => {
                const row = document.createElement('tr');
                
                // Prepara informações adicionais
                let detalhes = [];
                
                if (renda.parcela) {
                    detalhes.push(`Parcela ${renda.parcela}`);
                }
                
                if (renda.recorrente) {
                    const frequenciaMap = {
                        mensal: 'Mensal',
                        quinzenal: 'Quinzenal',
                        semanal: 'Semanal',
                        bimestral: 'Bimestral',
                        trimestral: 'Trimestral',
                        semestral: 'Semestral',
                        anual: 'Anual'
                    };
                    detalhes.push(`${frequenciaMap[renda.frequencia] || renda.frequencia}`);
                }
                
                const statusClass = renda.statusRecebimento === 'recebido' ? 'text-success' : 'text-danger';
                const statusText = renda.statusRecebimento === 'recebido' ? 'Recebido' : 'Aguardando';
                
                row.innerHTML = `
                    <td>${renda.descricao} ${detalhes.length > 0 ? `<small>(${detalhes.join(', ')})</small>` : ''}</td>
                    <td>${new Date(renda.data).toLocaleDateString()}</td>
                    <td>R$ ${parseFloat(renda.valor).toFixed(2)}</td>
                    <td>${renda.categoria}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td class="actions">
                        ${renda.statusRecebimento === 'aguardando' ? `
                        <button class="view-btn mark-received-btn" data-id="${renda.id}" title="Marcar como recebido">
                            <i class="fas fa-check-circle"></i>
                        </button>` : ''}
                        <button class="view-btn" data-id="${renda.id}" title="Ver detalhes">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Exibir a tabela
            dashboardRendasLoading.style.display = 'none';
            dashboardRendasList.style.display = 'block';
            dashboardRendasList.appendChild(tabelaRendas);
            
            // Adicionar link para ver todos
            const verTodosLink = document.createElement('div');
            verTodosLink.style.textAlign = 'right';
            verTodosLink.style.marginTop = '1rem';
            verTodosLink.innerHTML = `
                <a href="#rendas" class="btn" style="width: auto; padding: 0.5rem 1rem; display: inline-block;">
                    <i class="fas fa-eye"></i> Ver Todas
                </a>
            `;
            
            dashboardRendasList.appendChild(verTodosLink);
            
            // Adicionar listener para o botão de marcar como recebido
            dashboardRendasList.addEventListener('click', async (event) => {
                const target = event.target.closest('.mark-received-btn');
                if (!target) return;
                
                const rendaId = target.dataset.id;
                if (!rendaId) return;
                
                // Usa a função centralizada para abrir o modal de recebimento
                await abrirModalRecebimento(rendaId);
            });
        }
        
        // Função para carregar as faturas de todos os cartões
        async function carregarFaturasCartoes(mes = dashboardMesAtual) {
            if (!currentUser) return;
            
            const dashboardFaturasList = document.getElementById('dashboard-faturas-list');
            const dashboardFaturasLoading = document.getElementById('dashboard-faturas-loading');
            
            // Obter o mês selecionado para filtrar as faturas
            const mesAtual = mes.getMonth() + 1;
            const anoAtual = mes.getFullYear();
            const mesFaturaAtual = `${anoAtual}-${String(mesAtual).padStart(2, '0')}`;
            
            // 1. Buscar todos os cartões do usuário
            const cartoesRef = collection(db, 'users', currentUser.uid, 'cartoes');
            const cartoesSnapshot = await getDocs(cartoesRef);
            
            if (cartoesSnapshot.empty) {
                dashboardFaturasLoading.style.display = 'none';
                return;
            }
            
            const cartoes = [];
            cartoesSnapshot.forEach(doc => {
                cartoes.push({ id: doc.id, ...doc.data() });
            });
            
            // 2. Buscar as faturas para cada cartão (apenas do mês atual)
            const todasFaturas = [];
            let valorTotalFaturas = 0;
            let valorFaturasNaoPagas = 0;
            
            // Para cada cartão, buscar suas faturas do mês atual
            for (const cartao of cartoes) {
                // Referência específica para a fatura do mês atual
                const faturaRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', cartao.id, 'faturas', mesFaturaAtual);
                const faturaSnap = await getDoc(faturaRef);
                
                if (faturaSnap.exists()) {
                    const fatura = faturaSnap.data();
                    
                    // Calcula a data de vencimento
                    const dataVencimento = new Date(anoAtual, mesAtual - 1, parseInt(cartao.vencimento));
                    
                    const valorFatura = parseFloat(fatura.valorTotal || 0);
                    const faturaPaga = fatura.pago === true || fatura.status === "Paga";
                    
                    // Adiciona à lista de faturas
                    todasFaturas.push({
                        id: mesFaturaAtual,
                        cartaoId: cartao.id,
                        cartaoNome: cartao.nome,
                        cartaoFinal: cartao.final,
                        dataVencimento,
                        valor: valorFatura,
                        mes: mesAtual,
                        ano: anoAtual,
                        pago: faturaPaga,
                        status: fatura.status || "Pendente"
                    });
                    
                    valorTotalFaturas += valorFatura;
                    
                    // Soma apenas faturas não pagas
                    if (!faturaPaga) {
                        valorFaturasNaoPagas += valorFatura;
                    }
                }
            }
            
            // Se não encontrou nenhuma fatura
            if (todasFaturas.length === 0) {
                dashboardFaturasLoading.style.display = 'none';
                return;
            }
            
            // 3. Ordena as faturas por nome do cartão (já são apenas do mês atual)
            todasFaturas.sort((a, b) => {
                return a.cartaoNome.localeCompare(b.cartaoNome);
            });
            
            // 4. Exibe a lista de faturas
            dashboardFaturasLoading.style.display = 'none';
            dashboardFaturasList.style.display = 'block';
            dashboardFaturasList.innerHTML = '';
            
            // Cria a tabela de faturas
            const tabelaFaturas = document.createElement('table');
            tabelaFaturas.className = 'data-table';
            tabelaFaturas.innerHTML = `
                <thead>
                    <tr>
                        <th>Cartão</th>
                        <th>Vencimento</th>
                        <th>Valor</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                    <tr>
                        <td colspan="2" style="text-align: right; font-weight: bold;">Total a Pagar</td>
                        <td colspan="2" style="font-weight: bold;">R$ ${valorFaturasNaoPagas.toFixed(2)}</td>
                    </tr>
                </tfoot>
            `;
            
            const tbody = tabelaFaturas.querySelector('tbody');
            
            // Nomes dos meses em português
            const nomesMeses = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            
            // Adiciona as linhas das faturas
            todasFaturas.forEach(fatura => {
                const row = document.createElement('tr');
                
                // Adiciona classe para identificar a linha como clicável
                row.className = 'clickable-row';
                row.style.cursor = 'pointer';
                
                // Adiciona atributos de dados para permitir a navegação
                row.dataset.cartaoId = fatura.cartaoId;
                row.dataset.faturaId = fatura.id;
                
                // Determina o status da fatura
                let status = '';
                let statusClass = '';
                
                const dataVencimento = fatura.dataVencimento;
                const mesAno = new Date(fatura.ano, fatura.mes - 1, 1);
                const dataHoje = new Date(); // usando dataHoje em vez de hoje para evitar conflito
                
                // Verifica primeiro se a fatura está paga
                if (fatura.pago === true || fatura.status === "Paga") {
                    status = 'Paga';
                    statusClass = 'text-success';
                } else if (dataVencimento < dataHoje && mesAno <= dataHoje) {
                    status = 'Vencida';
                    statusClass = 'text-danger';
                } else if (mesAno.getMonth() === dataHoje.getMonth() && mesAno.getFullYear() === dataHoje.getFullYear()) {
                    status = 'Pendente';
                    statusClass = 'text-primary';
                } else if (mesAno > dataHoje) {
                    status = 'Futura';
                    statusClass = 'text-muted';
                } else {
                    status = 'Fechada';
                    statusClass = 'text-success';
                }
                
                const nomeMes = nomesMeses[fatura.mes - 1];
                
                row.innerHTML = `
                    <td>${fatura.cartaoNome} (final ${fatura.cartaoFinal})</td>
                    <td>${dataVencimento.toLocaleDateString()}</td>
                    <td>R$ ${parseFloat(fatura.valor).toFixed(2)}</td>
                    <td>
                        <span class="${statusClass}" style="font-weight: 500;">${status}</span>
                        ${parseFloat(fatura.valor) > 0 && status !== 'Paga' ? 
                            `<button class="btn-pagar-dashboard" data-cartao-id="${fatura.cartaoId}" data-fatura-id="${fatura.id}" data-valor="${fatura.valor}" style="margin-left: 10px; padding: 2px 8px; font-size: 0.8rem; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-money-bill-wave"></i> Pagar
                            </button>` : 
                            ''}
                    </td>
                `;
                
                // Adiciona evento de clique para navegar para a fatura
                row.addEventListener('click', () => {
                    // Primeiro navegamos para a página de cartões
                    window.location.hash = `#cartoes#${fatura.cartaoId}`;
                    
                    // Depois de um pequeno delay, selecionamos o cartão e a fatura
                    setTimeout(() => {
                        // Seleciona o cartão
                        const cartaoItem = document.querySelector(`.cartao-sidebar-item[data-id="${fatura.cartaoId}"]`);
                        if (cartaoItem) {
                            cartaoItem.click();
                            
                            // Agora, selecionamos a fatura específica
                            // Primeiro, obtemos as referências dos botões de navegação da fatura
                            const btnFaturaAnterior = document.getElementById('btn-fatura-anterior');
                            const btnFaturaAtual = document.getElementById('btn-fatura-atual');
                            const btnFaturaProxima = document.getElementById('btn-fatura-proxima');
                            
                            // Cria uma data para o mês/ano da fatura clicada
                            const dataFaturaClicada = new Date(fatura.ano, fatura.mes - 1, 1);
                            
                            // Criamos uma função para simular o clique nos botões de navegação até chegar na fatura desejada
                            const navegarParaFatura = () => {
                                // Obtém o texto do mês/ano atual mostrado na página
                                const textoMesFatura = document.getElementById('cartao-detalhe-mes-fatura').textContent;
                                
                                // Se for "atual", primeiro vamos para este mês como referência
                                if (textoMesFatura === 'atual') {
                                    btnFaturaAtual.click();
                                }
                                
                                // Agora obtemos o texto novamente que deve estar no formato "mês de ano"
                                const textoMesFatura2 = document.getElementById('cartao-detalhe-mes-fatura').textContent;
                                
                                // Extrai o mês e ano do texto (ex: "janeiro de 2023")
                                const partesTexto = textoMesFatura2.split(' de ');
                                if (partesTexto.length === 2) {
                                    // Converte o nome do mês para número (0-11)
                                    const nomesMeses = [
                                        'janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho',
                                        'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'
                                    ];
                                    const mesAtual = nomesMeses.indexOf(partesTexto[0].toLowerCase());
                                    const anoAtual = parseInt(partesTexto[1]);
                                    
                                    // Cria uma data para o mês/ano atual mostrado
                                    const dataFaturaAtual = new Date(anoAtual, mesAtual, 1);
                                    
                                    // Compara as datas para determinar qual botão clicar
                                    if (dataFaturaClicada > dataFaturaAtual) {
                                        // Clica em próximo
                                        btnFaturaProxima.click();
                                        // Verifica se chegamos na fatura desejada
                                        setTimeout(navegarParaFatura, 100);
                                    } else if (dataFaturaClicada < dataFaturaAtual) {
                                        // Clica em anterior
                                        btnFaturaAnterior.click();
                                        // Verifica se chegamos na fatura desejada
                                        setTimeout(navegarParaFatura, 100);
                                    }
                                    // Caso contrário, já estamos na fatura desejada
                                }
                            };
                            
                            // Inicia a navegação
                            setTimeout(navegarParaFatura, 300);
                        }
                    }, 300);
                });
                
                tbody.appendChild(row);
            });
            
            dashboardFaturasList.appendChild(tabelaFaturas);
            
            // Adiciona os eventos para os botões de pagar fatura
            const botoesPagar = tabelaFaturas.querySelectorAll('.btn-pagar-dashboard');
            botoesPagar.forEach(botao => {
                botao.addEventListener('click', (e) => {
                    e.stopPropagation(); // Impede que o evento de clique propague para a linha
                    
                    const cartaoId = botao.dataset.cartaoId;
                    const faturaId = botao.dataset.faturaId;
                    const valorFatura = parseFloat(botao.dataset.valor);
                    
                    pagarFatura(cartaoId, faturaId, valorFatura);
                });
            });
            
            // Adiciona um link para ir para a página de cartões
            const verTodosFaturas = document.createElement('div');
            verTodosFaturas.style.textAlign = 'right';
            verTodosFaturas.style.marginTop = '1rem';
            verTodosFaturas.innerHTML = `
                <a href="#cartoes" class="btn" style="width: auto; padding: 0.5rem 1rem; display: inline-block;">
                    <i class="fas fa-eye"></i> Ver Todos os Cartões
                </a>
            `;
            
            dashboardFaturasList.appendChild(verTodosFaturas);
        }

        // --- Gastos ---
        function loadGastosData() {
            if (!currentUser) return;
            const tableBody = document.getElementById('gastos-table-body');
            const gastosRef = collection(db, 'users', currentUser.uid, 'gastos');
            
            // Remove qualquer filtro existente para evitar duplicação
            const filtroExistente = document.querySelector('.filtro-container');
            if (filtroExistente) {
                filtroExistente.remove();
            }
            
            // Remove o total de gastos filtrados existente para evitar duplicação
            const totalGastosExistente = document.getElementById('total-gastos-filtrados');
            if (totalGastosExistente) {
                totalGastosExistente.remove();
            }
            
            // Criando o container de filtros
            const filtroContainer = document.createElement('div');
            filtroContainer.className = 'filtro-container';
            
            // Adiciona o elemento para mostrar o valor total dos gastos filtrados
            const totalGastosDiv = document.createElement('div');
            totalGastosDiv.id = 'total-gastos-filtrados';
            
            // Lado esquerdo - informações sobre os filtros
            const filtroInfoDiv = document.createElement('div');
            
            const filtroIcon = document.createElement('i');
            filtroIcon.className = 'fas fa-filter';
            
            const filtroText = document.createElement('span');
            filtroText.id = 'filtro-info-text';
            filtroText.textContent = 'Todos os gastos';
            
            filtroInfoDiv.appendChild(filtroIcon);
            filtroInfoDiv.appendChild(filtroText);
            
            // Lado direito - valor total
            const totalValorDiv = document.createElement('div');
            totalValorDiv.style.display = 'flex';
            totalValorDiv.style.flexDirection = 'column';
            totalValorDiv.style.alignItems = 'flex-end';
            
            const totalLabel = document.createElement('span');
            totalLabel.textContent = 'Total de gastos:';
            
            const totalValor = document.createElement('span');
            totalValor.id = 'valor-total-gastos';
            totalValor.textContent = 'R$ 0,00';
            
            totalValorDiv.appendChild(totalLabel);
            totalValorDiv.appendChild(totalValor);
            
            // Adiciona os elementos ao container principal
            totalGastosDiv.appendChild(filtroInfoDiv);
            totalGastosDiv.appendChild(totalValorDiv);
            
            // Linha superior dos filtros (pesquisa e datas)
            const filtroLinha1 = document.createElement('div');
            filtroLinha1.className = 'filtro-linha';
            
            // Campo de pesquisa
            const pesquisaDiv = document.createElement('div');
            pesquisaDiv.className = 'filtro-campo';
            
            const pesquisaLabel = document.createElement('label');
            pesquisaLabel.textContent = 'Pesquisar:';
            pesquisaLabel.htmlFor = 'filtro-pesquisa';
            
            const pesquisaInput = document.createElement('input');
            pesquisaInput.type = 'text';
            pesquisaInput.id = 'filtro-pesquisa';
            pesquisaInput.placeholder = 'Buscar por descrição...';
            
            pesquisaDiv.appendChild(pesquisaLabel);
            pesquisaDiv.appendChild(pesquisaInput);
            
            // Filtro de data inicial
            const dataInicialDiv = document.createElement('div');
            dataInicialDiv.className = 'filtro-campo';
            
            const dataInicialLabel = document.createElement('label');
            dataInicialLabel.textContent = 'Data inicial:';
            dataInicialLabel.htmlFor = 'filtro-data-inicial';
            
            const dataInicialInput = document.createElement('input');
            dataInicialInput.type = 'date';
            dataInicialInput.id = 'filtro-data-inicial';
            
            dataInicialDiv.appendChild(dataInicialLabel);
            dataInicialDiv.appendChild(dataInicialInput);
            
            // Filtro de data final
            const dataFinalDiv = document.createElement('div');
            dataFinalDiv.className = 'filtro-campo';
            
            const dataFinalLabel = document.createElement('label');
            dataFinalLabel.textContent = 'Data final:';
            dataFinalLabel.htmlFor = 'filtro-data-final';
            
            const dataFinalInput = document.createElement('input');
            dataFinalInput.type = 'date';
            dataFinalInput.id = 'filtro-data-final';
            
            dataFinalDiv.appendChild(dataFinalLabel);
            dataFinalDiv.appendChild(dataFinalInput);
            
            // Adiciona os elementos da linha 1
            filtroLinha1.appendChild(pesquisaDiv);
            filtroLinha1.appendChild(dataInicialDiv);
            filtroLinha1.appendChild(dataFinalDiv);
            
            // Linha inferior dos filtros (mês, categoria e método)
            const filtroLinha2 = document.createElement('div');
            filtroLinha2.className = 'filtro-linha';
            
            // Filtro de mês
            const mesDiv = document.createElement('div');
            mesDiv.className = 'filtro-campo';
            
            const mesLabel = document.createElement('label');
            mesLabel.textContent = 'Mês:';
            mesLabel.htmlFor = 'filtro-mes';
            
            const selectMes = document.createElement('select');
            selectMes.id = 'filtro-mes';
            
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();
            
            // Opção padrão
            const optionPadrao = document.createElement('option');
            optionPadrao.value = '';
            optionPadrao.textContent = 'Todos os meses';
            selectMes.appendChild(optionPadrao);
            
            // Adiciona opções para os últimos 12 meses e próximos 6 meses
            for (let i = -11; i <= 6; i++) {
                const data = new Date(anoAtual, mesAtual + i, 1);
                const option = document.createElement('option');
                option.value = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                
                // Nome do mês em português
                const nomesMeses = [
                    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                option.textContent = `${nomesMeses[data.getMonth()]} de ${data.getFullYear()}`;
                
                // Seleciona o mês atual por padrão
                if (i === 0) {
                    option.selected = true;
                }
                selectMes.appendChild(option);
            }
            
            mesDiv.appendChild(mesLabel);
            mesDiv.appendChild(selectMes);
            
            // Filtro de categoria
            const categoriaDiv = document.createElement('div');
            categoriaDiv.className = 'filtro-campo';
            
            const categoriaLabel = document.createElement('label');
            categoriaLabel.textContent = 'Categoria:';
            categoriaLabel.htmlFor = 'filtro-categoria';
            
            const selectCategoria = document.createElement('select');
            selectCategoria.id = 'filtro-categoria';
            
            // Opção padrão para categoria
            const optionCategoriaPadrao = document.createElement('option');
            optionCategoriaPadrao.value = '';
            optionCategoriaPadrao.textContent = 'Todas as categorias';
            selectCategoria.appendChild(optionCategoriaPadrao);
            
            // Categorias padrão
            const categoriasPadrao = [
                'Alimentação', 'Transporte', 'Moradia', 'Saúde', 
                'Educação', 'Lazer', 'Vestuário', 'Outros'
            ];
            
            categoriasPadrao.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria;
                option.textContent = categoria;
                selectCategoria.appendChild(option);
            });
            
            categoriaDiv.appendChild(categoriaLabel);
            categoriaDiv.appendChild(selectCategoria);
            
            // Filtro de método de pagamento
            const metodoDiv = document.createElement('div');
            metodoDiv.className = 'filtro-campo';
            
            const metodoLabel = document.createElement('label');
            metodoLabel.textContent = 'Método de pagamento:';
            metodoLabel.htmlFor = 'filtro-metodo';
            
            const selectMetodo = document.createElement('select');
            selectMetodo.id = 'filtro-metodo';
            
            // Opção padrão para método
            const optionMetodoPadrao = document.createElement('option');
            optionMetodoPadrao.value = '';
            optionMetodoPadrao.textContent = 'Todos os métodos';
            selectMetodo.appendChild(optionMetodoPadrao);
            
            // Métodos de pagamento
            const metodosPagamento = [
                'Cartão de Crédito', 'Cartão de Débito', 'Pix', 
                'Dinheiro', 'Transferência', 'Boleto', 'Pendente'
            ];
            
            metodosPagamento.forEach(metodo => {
                const option = document.createElement('option');
                option.value = metodo;
                option.textContent = metodo;
                selectMetodo.appendChild(option);
            });
            
            metodoDiv.appendChild(metodoLabel);
            metodoDiv.appendChild(selectMetodo);
            
            // Adiciona os elementos da linha 2
            filtroLinha2.appendChild(mesDiv);
            filtroLinha2.appendChild(categoriaDiv);
            filtroLinha2.appendChild(metodoDiv);
            
            // Linha de botões
            const botoesDiv = document.createElement('div');
            botoesDiv.className = 'filtro-botoes';
            
            // Botão para aplicar filtros
            const btnAplicarFiltro = document.createElement('button');
            btnAplicarFiltro.textContent = 'Aplicar Filtros';
            btnAplicarFiltro.className = 'btn btn-primary';
            
            // Botão para limpar filtros
            const btnLimparFiltro = document.createElement('button');
            btnLimparFiltro.textContent = 'Limpar Filtros';
            btnLimparFiltro.className = 'btn';
            
            botoesDiv.appendChild(btnLimparFiltro);
            botoesDiv.appendChild(btnAplicarFiltro);
            
            // Adiciona tudo ao container de filtros
            filtroContainer.appendChild(filtroLinha1);
            filtroContainer.appendChild(filtroLinha2);
            filtroContainer.appendChild(botoesDiv);
            
            // Adiciona o filtro acima da tabela
            const gastosPage = document.getElementById('gastos-page');
            const cardHeader = gastosPage.querySelector('.card-header');
            
            // Adiciona o elemento de total de gastos logo após o cabeçalho
            cardHeader.parentNode.insertBefore(totalGastosDiv, cardHeader.nextSibling);
            
            // Adiciona o container de filtros após o elemento de total
            cardHeader.parentNode.insertBefore(filtroContainer, totalGastosDiv.nextSibling);
            
            // Carregar categorias personalizadas do usuário
            carregarCategoriasFiltro();
            
            // Função para carregar categorias personalizadas
            async function carregarCategoriasFiltro() {
                try {
                    const categoriasRef = collection(db, 'users', currentUser.uid, 'categorias');
                    const categoriasSnap = await getDocs(categoriasRef);
                    
                    if (!categoriasSnap.empty) {
                        categoriasSnap.forEach(doc => {
                            const categoria = doc.data().nome;
                            if (categoria && !categoriasPadrao.includes(categoria)) {
                                const option = document.createElement('option');
                                option.value = categoria;
                                option.textContent = categoria;
                                selectCategoria.appendChild(option);
                            }
                        });
                    }
                } catch (error) {
                    console.error('Erro ao carregar categorias personalizadas:', error);
                }
            }
            
            // Função para carregar os gastos com filtro
            function carregarGastosComFiltro() {
                const q = query(gastosRef);
                
                gastosUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    tableBody.innerHTML = '';
                    if (querySnapshot.empty) {
                        tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Nenhum gasto encontrado.</td></tr>';
                        return;
                    }
                    
                    // Array para armazenar todos os gastos
                    const gastos = [];
                    querySnapshot.forEach(doc => {
                        gastos.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Obtém os valores dos filtros
                    const filtroMes = document.getElementById('filtro-mes').value;
                    const filtroCategoria = document.getElementById('filtro-categoria').value;
                    const filtroMetodo = document.getElementById('filtro-metodo').value;
                    const filtroPesquisa = document.getElementById('filtro-pesquisa').value.toLowerCase();
                    const filtroDataInicial = document.getElementById('filtro-data-inicial').value;
                    const filtroDataFinal = document.getElementById('filtro-data-final').value;
                    
                    // Filtra os gastos de acordo com os critérios
                    let gastosExibidos = gastos;
                    
                    // Filtro por mês
                    if (filtroMes) {
                        const [anoFiltro, mesFiltro] = filtroMes.split('-').map(Number);
                        
                        gastosExibidos = gastosExibidos.filter(gasto => {
                            const dataGasto = new Date(gasto.data + 'T00:00:00');
                            const anoGasto = dataGasto.getFullYear();
                            const mesGasto = dataGasto.getMonth() + 1; // getMonth() retorna 0-11
                            
                            return anoGasto === anoFiltro && mesGasto === mesFiltro;
                        });
                    }
                    
                    // Filtro por categoria
                    if (filtroCategoria) {
                        gastosExibidos = gastosExibidos.filter(gasto => 
                            gasto.categoria === filtroCategoria
                        );
                    }
                    
                    // Filtro por método de pagamento
                    if (filtroMetodo) {
                        gastosExibidos = gastosExibidos.filter(gasto => 
                            gasto.metodoPagamento === filtroMetodo
                        );
                    }
                    
                    // Filtro por pesquisa (na descrição e observação)
                    if (filtroPesquisa) {
                        gastosExibidos = gastosExibidos.filter(gasto => 
                            gasto.descricao.toLowerCase().includes(filtroPesquisa) || 
                            (gasto.observacao && gasto.observacao.toLowerCase().includes(filtroPesquisa))
                        );
                    }
                    
                    // Filtro por data inicial
                    if (filtroDataInicial) {
                        const dataInicial = new Date(filtroDataInicial + 'T00:00:00');
                        gastosExibidos = gastosExibidos.filter(gasto => 
                            new Date(gasto.data + 'T00:00:00') >= dataInicial
                        );
                    }
                    
                    // Filtro por data final
                    if (filtroDataFinal) {
                        const dataFinal = new Date(filtroDataFinal + 'T23:59:59');
                        gastosExibidos = gastosExibidos.filter(gasto => 
                            new Date(gasto.data + 'T00:00:00') <= dataFinal
                        );
                    }
                    
                    if (gastosExibidos.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Nenhum gasto encontrado com os filtros aplicados.</td></tr>';
                        
                        // Atualiza o valor total para zero quando não há gastos
                        document.getElementById('valor-total-gastos').textContent = 'R$ 0,00';
                        
                        // Atualiza o texto informativo sobre os filtros aplicados
                        const filtroInfoText = document.getElementById('filtro-info-text');
                        const filtrosAplicados = [];
                        
                        if (filtroMes) {
                            const [ano, mes] = filtroMes.split('-');
                            const nomesMeses = [
                                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                            ];
                            filtrosAplicados.push(`${nomesMeses[parseInt(mes) - 1]}/${ano}`);
                        }
                        
                        if (filtroCategoria) {
                            filtrosAplicados.push(`Categoria: ${filtroCategoria}`);
                        }
                        
                        if (filtroMetodo) {
                            filtrosAplicados.push(`Método: ${filtroMetodo}`);
                        }
                        
                        if (filtroPesquisa) {
                            filtrosAplicados.push(`Busca: "${filtroPesquisa}"`);
                        }
                        
                        if (filtroDataInicial && filtroDataFinal) {
                            const dataInicialFormatada = new Date(filtroDataInicial).toLocaleDateString();
                            const dataFinalFormatada = new Date(filtroDataFinal).toLocaleDateString();
                            filtrosAplicados.push(`Período: ${dataInicialFormatada} a ${dataFinalFormatada}`);
                        } else if (filtroDataInicial) {
                            const dataFormatada = new Date(filtroDataInicial).toLocaleDateString();
                            filtrosAplicados.push(`A partir de: ${dataFormatada}`);
                        } else if (filtroDataFinal) {
                            const dataFormatada = new Date(filtroDataFinal).toLocaleDateString();
                            filtrosAplicados.push(`Até: ${dataFormatada}`);
                        }
                        
                        if (filtrosAplicados.length > 0) {
                            filtroInfoText.textContent = `Filtros: ${filtrosAplicados.join(' | ')} (0 gastos)`;
                        } else {
                            filtroInfoText.textContent = 'Todos os gastos (0 gastos)';
                        }
                        
                        return;
                    }
                    
                    // Calcula o valor total dos gastos filtrados
                    const valorTotal = gastosExibidos.reduce((total, gasto) => {
                        return total + parseFloat(gasto.valor || 0);
                    }, 0);
                    
                    // Atualiza o elemento com o valor total formatado
                    document.getElementById('valor-total-gastos').textContent = `R$ ${valorTotal.toFixed(2)}`;
                    
                    // Atualiza o texto informativo sobre os filtros aplicados
                    const filtroInfoText = document.getElementById('filtro-info-text');
                    const filtrosAplicados = [];
                    
                    if (filtroMes) {
                        const [ano, mes] = filtroMes.split('-');
                        const nomesMeses = [
                            'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                            'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                        ];
                        filtrosAplicados.push(`${nomesMeses[parseInt(mes) - 1]}/${ano}`);
                    }
                    
                    if (filtroCategoria) {
                        filtrosAplicados.push(`Categoria: ${filtroCategoria}`);
                    }
                    
                    if (filtroMetodo) {
                        filtrosAplicados.push(`Método: ${filtroMetodo}`);
                    }
                    
                    if (filtroPesquisa) {
                        filtrosAplicados.push(`Busca: "${filtroPesquisa}"`);
                    }
                    
                    if (filtroDataInicial && filtroDataFinal) {
                        const dataInicialFormatada = new Date(filtroDataInicial).toLocaleDateString();
                        const dataFinalFormatada = new Date(filtroDataFinal).toLocaleDateString();
                        filtrosAplicados.push(`Período: ${dataInicialFormatada} a ${dataFinalFormatada}`);
                    } else if (filtroDataInicial) {
                        const dataFormatada = new Date(filtroDataInicial).toLocaleDateString();
                        filtrosAplicados.push(`A partir de: ${dataFormatada}`);
                    } else if (filtroDataFinal) {
                        const dataFormatada = new Date(filtroDataFinal).toLocaleDateString();
                        filtrosAplicados.push(`Até: ${dataFormatada}`);
                    }
                    
                    if (filtrosAplicados.length > 0) {
                        filtroInfoText.textContent = `Filtros: ${filtrosAplicados.join(' | ')}`;
                    } else {
                        filtroInfoText.textContent = 'Todos os gastos';
                    }
                    
                    // Atualiza o contador de resultados
                    const quantidadeGastos = gastosExibidos.length;
                    const pluralGastos = quantidadeGastos === 1 ? 'gasto encontrado' : 'gastos encontrados';
                    document.getElementById('filtro-info-text').textContent += ` (${quantidadeGastos} ${pluralGastos})`;
                    
                    // Ordena os gastos por data (mais recentes primeiro)
                    gastosExibidos.sort((a, b) => new Date(b.data) - new Date(a.data));
                    
                    // Exibe os gastos filtrados
                    gastosExibidos.forEach(gasto => {
                        const row = document.createElement('tr');
                        
                        // Destacar gastos pendentes
                        if (!gasto.pago || gasto.metodoPagamento === 'Pendente') {
                            row.classList.add('gasto-pendente');
                        }
                        
                        // Prepara os detalhes do gasto
                        let detalhes = [];
                        if (gasto.metodoPagamento === 'Pendente' || (!gasto.pago && gasto.data)) {
                            detalhes.push('<span style="color: #ff9800; font-weight: bold;"><i class="fas fa-exclamation-triangle"></i> Pagamento Pendente</span>');
                        }
                        else if (gasto.metodoPagamento === 'Cartão de Crédito' && gasto.parcela) {
                            // Adiciona informação da parcela com formatação aprimorada
                            const parcela = document.createElement('div');
                            parcela.style.fontWeight = 'bold';
                            parcela.style.color = 'var(--primary-color)';
                            parcela.innerHTML = `Parcela ${gasto.parcela}`;
                            
                            // Formata o mês/ano da parcela
                            const dataParcela = new Date(gasto.data);
                            const nomesMeses = [
                                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                            ];
                            const mesParcela = nomesMeses[dataParcela.getMonth()];
                            const anoParcela = dataParcela.getFullYear();
                            
                            detalhes.push(`Parcela ${gasto.parcela} <span style="font-size: 0.85em; opacity: 0.8;">(${mesParcela}/${anoParcela})</span>`);
                            
                            if (gasto.valorTotal) {
                                detalhes.push(`Total: R$ ${parseFloat(gasto.valorTotal).toFixed(2)}`);
                            }
                            
                            // Se houver outras parcelas, adiciona botão para ver todas
                            if (gasto.parcelaGrupoId && gasto.totalParcelas > 1) {
                                const verTodasBtn = `<button class="btn-ver-parcelas" data-grupo-id="${gasto.parcelaGrupoId}" style="font-size: 0.8em; padding: 2px 8px; margin-top: 5px; background: #f1f5f9; border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">Ver todas as parcelas</button>`;
                                detalhes.push(verTodasBtn);
                            }
                        }
                        if (gasto.recorrente) {
                            detalhes.push(`Recorrente (${gasto.frequencia})`);
                        }
                        
                        row.innerHTML = `
                            <td>${gasto.descricao}</td>
                            <td>R$ ${parseFloat(gasto.valor).toFixed(2)}</td>
                            <td>${new Date(gasto.data).toLocaleDateString()}</td>
                            <td>${gasto.categoria}</td>
                            <td>${gasto.metodoPagamento || '-'}</td>
                            <td>
                                ${detalhes.length > 0 ? detalhes.join('<br>') : '-'}
                                ${gasto.cartaoId ? '<div class="cartao-info"></div>' : ''}
                                ${gasto.bancoId ? '<div class="banco-info"></div>' : ''}
                                ${gasto.observacao ? `<br><small>${gasto.observacao}</small>` : ''}
                            </td>
                            <td class="actions">
                                <button class="edit-btn" data-id="${gasto.id}" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" data-id="${gasto.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                                ${gasto.comprovante ? `<button class="view-btn" data-comprovante="${gasto.comprovante}" title="Ver comprovante de compra"><i class="fas fa-file-invoice"></i></button>` : ''}
                                ${gasto.comprovantePagamento ? `<button class="view-btn" data-comprovante="${gasto.comprovantePagamento}" title="Ver comprovante de pagamento"><i class="fas fa-receipt"></i></button>` : ''}
                                ${(gasto.metodoPagamento === 'Pendente' || !gasto.pago) ? `<button class="pay-btn" data-id="${gasto.id}" title="Realizar Pagamento"><i class="fas fa-money-bill-wave"></i></button>` : ''}
                            </td>
                        `;

                        // Carrega informações adicionais de cartão e banco se necessário
                        if (gasto.cartaoId) {
                            const cartaoRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', gasto.cartaoId);
                            getDoc(cartaoRef).then(cartaoDoc => {
                                if (cartaoDoc.exists()) {
                                    const cartao = cartaoDoc.data();
                                    const cartaoCell = row.querySelector('.cartao-info');
                                    cartaoCell.textContent = `${cartao.nome} (final ${cartao.final})`;
                                }
                            });
                        }
                        if (gasto.bancoId) {
                            const bancoRef = firestoreDoc(db, 'users', currentUser.uid, 'bancos', gasto.bancoId);
                            getDoc(bancoRef).then(bancoDoc => {
                                if (bancoDoc.exists()) {
                                    const banco = bancoDoc.data();
                                    const bancoCell = row.querySelector('.banco-info');
                                    bancoCell.textContent = banco.nome;
                                }
                            });
                        }
                        tableBody.appendChild(row);
                    });
                });
            }
            
            // Inicializa com os filtros padrão
            carregarGastosComFiltro();
            
            // Atualiza a visualização de cards quando a tabela é atualizada
            const atualizarCardsMobile = () => {
                // Se estamos em modo de visualização de cards, atualize-os
                if (document.getElementById('gastos-cards-view').style.display === 'block') {
                    transformarGastosParaCards();
                }
            };
            
            // Adiciona listeners para os botões de filtro
            document.getElementById('filtro-mes').addEventListener('change', () => {
                // Atualiza apenas quando o usuário clicar em "Aplicar Filtros"
            });
            
            const filtroPesquisa = document.getElementById('filtro-pesquisa');
            if (filtroPesquisa) {
                filtroPesquisa.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        carregarGastosComFiltro();
                        setTimeout(atualizarCardsMobile, 300);
                        e.preventDefault();
                    }
                });
            }
            
            btnAplicarFiltro.addEventListener('click', () => {
                carregarGastosComFiltro();
                setTimeout(atualizarCardsMobile, 300);
            });
            
            btnLimparFiltro.addEventListener('click', () => {
                // Limpa todos os filtros
                document.getElementById('filtro-mes').value = '';
                document.getElementById('filtro-categoria').value = '';
                document.getElementById('filtro-metodo').value = '';
                document.getElementById('filtro-pesquisa').value = '';
                document.getElementById('filtro-data-inicial').value = '';
                document.getElementById('filtro-data-final').value = '';
                
                // Recarrega os gastos sem filtros
                carregarGastosComFiltro();
                setTimeout(atualizarCardsMobile, 300);
            });
            
            // Adiciona listener para mostrar todas as parcelas de um grupo
            // Remove o listener antigo para evitar duplicação
            const oldListener = tableBody._verParcelasListener;
            if (oldListener) {
                tableBody.removeEventListener('click', oldListener);
            }
            
            // Cria novo listener e armazena referência
            const verParcelasListener = async (event) => {
                const target = event.target.closest('.btn-ver-parcelas');
                if (!target) return;
                
                const grupoId = target.dataset.grupoId;
                if (!grupoId) return;
                
                try {
                    // Busca todas as parcelas do mesmo grupo
                    const parcelasRef = collection(db, 'users', currentUser.uid, 'gastos');
                    const q = query(parcelasRef, where("parcelaGrupoId", "==", grupoId));
                    const parcelasSnap = await getDocs(q);
                    
                    if (parcelasSnap.empty) {
                        showNotification('Nenhuma parcela encontrada para este grupo.', 'error');
                        return;
                    }
                    
                    // Cria a tabela de parcelas
                    const parcelas = [];
                    parcelasSnap.forEach(doc => {
                        parcelas.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Ordena as parcelas pelo número
                    parcelas.sort((a, b) => a.numeroParcela - b.numeroParcela);
                    
                    // Prepara o HTML da tabela de parcelas
                    const descricaoGasto = parcelas[0].descricao;
                    const valorTotal = parcelas[0].valorTotal;
                    
                    let tabelaHTML = `
                        <h4 style="margin-bottom: 15px;">${descricaoGasto}</h4>
                        <p style="margin-bottom: 20px;">Valor Total: R$ ${parseFloat(valorTotal).toFixed(2)}</p>
                        <table class="data-table" style="margin-bottom: 15px;">
                            <thead>
                                <tr>
                                    <th>Parcela</th>
                                    <th>Valor</th>
                                    <th>Data</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    const hoje = new Date();
                    
                    parcelas.forEach(parcela => {
                        const dataParcela = new Date(parcela.data + 'T00:00:00');
                        const dataFormatada = dataParcela.toLocaleDateString();
                        
                        // Determina o status da parcela
                        let status = '';
                        let statusClass = '';
                        
                        if (dataParcela < hoje) {
                            status = 'Paga';
                            statusClass = 'text-success';
                        } else if (dataParcela.getMonth() === hoje.getMonth() && dataParcela.getFullYear() === hoje.getFullYear()) {
                            status = 'Atual';
                            statusClass = 'text-primary';
                        } else {
                            status = 'Futura';
                            statusClass = 'text-muted';
                        }
                        
                        tabelaHTML += `
                            <tr>
                                <td>${parcela.parcela}</td>
                                <td>R$ ${parseFloat(parcela.valor).toFixed(2)}</td>
                                <td>${dataFormatada}</td>
                                <td class="${statusClass}" style="font-weight: 500;">${status}</td>
                            </tr>
                        `;
                    });
                    
                    tabelaHTML += `
                            </tbody>
                        </table>
                    `;
                    
                    openModal('Detalhes do Parcelamento', tabelaHTML, () => {
                        closeModal();
                    });
                    
                } catch (error) {
                    console.error('Erro ao buscar parcelas:', error);
                    showNotification('Erro ao buscar detalhes das parcelas.', 'error');
                }
            };
            
            // Armazena a referência do listener para poder removê-lo depois
            tableBody._verParcelasListener = verParcelasListener;
            tableBody.addEventListener('click', verParcelasListener);
            
            // Adiciona evento para botões de edição e exclusão de gastos
            tableBody.addEventListener('click', async function(event) {
                const target = event.target.closest('button');
                if (!target) return;
                
                const gastoId = target.dataset.id;
                if (!gastoId) return;
                
                // Gerencia evento para o botão de exclusão
                if (target.classList.contains('delete-btn')) {
                    if (confirm('Tem certeza que deseja excluir este gasto?')) {
                        try {
                            await excluirGasto(gastoId);
                        } catch (error) {
                            console.error('Erro ao excluir gasto:', error);
                            showNotification('Erro ao excluir gasto.', 'error');
                        }
                    }
                }
                // Gerencia evento para o botão de edição
                else if (target.classList.contains('edit-btn')) {
                    try {
                        await editarGasto(gastoId);
                    } catch (error) {
                        console.error('Erro ao editar gasto:', error);
                        showNotification('Erro ao editar gasto.', 'error');
                    }
                }
                // Gerencia evento para o botão de pagamento
                else if (target.classList.contains('pay-btn')) {
                    try {
                        await realizarPagamentoGasto(gastoId);
                    } catch (error) {
                        console.error('Erro ao processar pagamento:', error);
                        showNotification('Erro ao processar pagamento.', 'error');
                    }
                }
            });
        }
        
        document.getElementById('add-gasto-btn').addEventListener('click', () => {
            const formHtml = `
                <form id="gasto-form">
                    <div class="form-group">
                        <label for="gasto-descricao">Descrição</label>
                        <input type="text" id="gasto-descricao" name="descricao" required>
                    </div>
                    <div class="form-group">
                        <label for="gasto-valor">Valor (R$)</label>
                        <input type="number" step="0.01" id="gasto-valor" name="valor" required>
                    </div>
                    <div class="form-group">
                        <label for="gasto-data">Data</label>
                        <input type="date" id="gasto-data" name="data" required>
                    </div>
                    <div class="form-group">
                        <label for="gasto-categoria">Categoria</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="gasto-categoria" name="categoria" required style="flex-grow: 1;">
                                <option value="">Selecione uma categoria</option>
                                <option value="Alimentação">Alimentação</option>
                                <option value="Transporte">Transporte</option>
                                <option value="Moradia">Moradia</option>
                                <option value="Saúde">Saúde</option>
                                <option value="Educação">Educação</option>
                                <option value="Lazer">Lazer</option>
                                <option value="Vestuário">Vestuário</option>
                                <option value="Outros">Outros</option>
                                <!-- Categorias personalizadas serão adicionadas aqui -->
                                <option value="nova_categoria">+ Nova Categoria</option>
                            </select>
                            <button type="button" id="btn-gerenciar-categorias" class="btn" style="white-space: nowrap;">
                                <i class="fas fa-cog"></i> Gerenciar
                            </button>
                        </div>
                        <!-- Campo para nova categoria (inicialmente oculto) -->
                        <div id="nova-categoria-field" style="display: none; margin-top: 10px;">
                            <input type="text" id="nova-categoria-input" placeholder="Digite o nome da nova categoria" class="form-control">
                            <small style="display: block; margin-top: 5px; color: var(--subtle-text-color);">
                                A nova categoria será salva automaticamente quando você registrar o gasto.
                            </small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="gasto-metodo">Método de Pagamento</label>
                        <select id="gasto-metodo" name="metodoPagamento" required>
                            <option value="">Selecione o método</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option>
                            <option value="Cartão de Débito">Cartão de Débito</option>
                            <option value="Pix">Pix</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Transferência">Transferência</option>
                            <option value="Boleto">Boleto</option>
                            <option value="Pendente">Pagamento Pendente</option>
                        </select>
                    </div>
                    
                    <!-- Campos condicionais para Cartão de Crédito -->
                    <div id="cartao-credito-fields" style="display: none;">
                        <div class="form-group">
                            <label for="gasto-cartao">Selecione o Cartão</label>
                            <select id="gasto-cartao" name="cartaoId">
                                <!-- Será preenchido dinamicamente -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gasto-parcelas">Número de Parcelas</label>
                            <select id="gasto-parcelas" name="parcelas">
                                <option value="1">1x (à vista)</option>
                                <option value="2">2x</option>
                                <option value="3">3x</option>
                                <option value="4">4x</option>
                                <option value="5">5x</option>
                                <option value="6">6x</option>
                                <option value="7">7x</option>
                                <option value="8">8x</option>
                                <option value="9">9x</option>
                                <option value="10">10x</option>
                                <option value="11">11x</option>
                                <option value="12">12x</option>
                                <option value="13">13x</option>
                                <option value="14">14x</option>
                                <option value="15">15x</option>
                                <option value="16">16x</option>
                                <option value="17">17x</option>
                                <option value="18">18x</option>
                                <option value="19">19x</option>
                                <option value="20">20x</option>
                                <option value="21">21x</option>
                                <option value="22">22x</option>
                                <option value="23">23x</option>
                                <option value="24">24x</option>
                            </select>
                        </div>
                    </div>

                    <!-- Campos condicionais para Cartão de Débito/Transferência/Pix -->
                    <div id="banco-fields" style="display: none;">
                        <div class="form-group">
                            <label for="gasto-banco">Selecione o Banco</label>
                            <select id="gasto-banco" name="bancoId">
                                <!-- Será preenchido dinamicamente -->
                            </select>
                        </div>
                    </div>

                    <!-- Campo para gasto recorrente -->
                    <div class="form-group" style="margin-top: 1rem;">
                        <label>
                            <input type="checkbox" id="gasto-recorrente" name="recorrente">
                            Este é um gasto recorrente
                        </label>
                    </div>

                    <!-- Campos condicionais para gasto recorrente -->
                    <div id="recorrente-fields" style="display: none;">
                        <div class="form-group">
                            <label for="gasto-frequencia">Frequência</label>
                            <select id="gasto-frequencia" name="frequencia">
                                <option value="mensal">Mensal</option>
                                <option value="bimestral">Bimestral</option>
                                <option value="trimestral">Trimestral</option>
                                <option value="semestral">Semestral</option>
                                <option value="anual">Anual</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gasto-dia-vencimento">Dia do Vencimento</label>
                            <select id="gasto-dia-vencimento" name="diaVencimento">
                                <option value="">Selecione o dia</option>
                                ${Array.from({length: 31}, (_, i) => i + 1).map(dia => `<option value="${dia}">${dia}</option>`).join('')}
                            </select>
                            <small style="display: block; margin-top: 0.5rem; color: var(--subtle-text-color);">
                                Defina o dia exato do vencimento mensal se for diferente da data inicial.
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="gasto-data-fim">Data Final (opcional)</label>
                            <input type="date" id="gasto-data-fim" name="dataFim">
                        </div>
                    </div>

                    <!-- Campo para upload de comprovante -->
                    <div class="form-group">
                        <label for="gasto-comprovante">Comprovante (opcional)</label>
                        <input type="file" id="gasto-comprovante" name="comprovante" accept="image/*">
                        <small style="display: block; margin-top: 0.5rem; color: var(--subtle-text-color);">
                            Aceita imagens até 5MB. A imagem será convertida para base64 e armazenada no banco de dados.
                        </small>
                    </div>

                    <!-- Campo para observações -->
                    <div class="form-group">
                        <label for="gasto-observacao">Observações (opcional)</label>
                        <textarea id="gasto-observacao" name="observacao" rows="3"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">Salvar</button>
                </form>
            `;

            // Abre o modal com o formulário
            openModal('Novo Gasto', formHtml, () => {
                // Inicializa o campo de data com a data atual no fuso horário brasileiro
                const dataFormatada = obterDataAtualBrasilFormatada();
                const campoData = document.getElementById('gasto-data');
                if (campoData) campoData.value = dataFormatada;
            }, async (data) => {
                // Implementação da função de callback que será executada quando o formulário for submetido
                try {
                    // Verificar se foi informada uma nova categoria
                    if (data.categoria === 'nova_categoria') {
                        const novaCategoriaInput = document.getElementById('nova-categoria-input');
                        if (novaCategoriaInput && novaCategoriaInput.value) {
                            // Salva a nova categoria e usa ela no gasto
                            await salvarNovaCategoria(novaCategoriaInput.value);
                            data.categoria = novaCategoriaInput.value;
                        } else {
                            showNotification('Por favor, informe o nome da nova categoria.', 'error');
                            return;
                        }
                    }

                    // Processar o comprovante, se houver
                    const fileInput = document.getElementById('gasto-comprovante');
                    let comprovante = null;
                    
                    if (fileInput && fileInput.files && fileInput.files.length > 0) {
                        const file = fileInput.files[0];
                        // Limitar o tamanho do arquivo para 5MB
                        if (file.size > 5 * 1024 * 1024) {
                            throw new Error('O comprovante deve ter no máximo 5MB.');
                        }
                        
                        // Converter para Base64
                        comprovante = await fileToBase64(file);
                    }
                    
                    // Prepara o documento para salvar
                    const gastoDoc = {
                        descricao: data.descricao,
                        valor: parseFloat(data.valor),
                        data: data.data, // Mantém o formato original para compatibilidade
                        dataObj: converterDataParaFusoBrasil(data.data), // Adiciona a data convertida para o fuso de São Paulo
                        categoria: data.categoria,
                        metodoPagamento: data.metodoPagamento,
                        observacao: data.observacao || '',
                        status: data.metodoPagamento === 'Pendente' ? 'Pendente' : 'Pago',
                        dataCriacao: serverTimestamp(),
                        comprovante: comprovante
                    };

                    // Adiciona campos específicos para cada método de pagamento
                    if (data.metodoPagamento === 'Cartão de Crédito') {
                        gastoDoc.cartaoId = data.cartaoId;
                        gastoDoc.parcelas = parseInt(data.parcelas);
                    } else if (['Cartão de Débito', 'Pix', 'Transferência'].includes(data.metodoPagamento)) {
                        gastoDoc.bancoId = data.bancoId;
                    }

                    // Verifica se é um gasto recorrente
                    if (data.recorrente === 'on') {
                        gastoDoc.recorrente = true;
                        gastoDoc.frequencia = data.frequencia;
                        gastoDoc.diaVencimento = data.diaVencimento !== '' ? parseInt(data.diaVencimento) : null;
                        gastoDoc.dataFim = data.dataFim || null;
                    } else {
                        gastoDoc.recorrente = false;
                    }

                    // Salva o gasto no Firestore
                    const gastosRef = collection(db, 'users', currentUser.uid, 'gastos');
                    const docRef = await addDoc(gastosRef, gastoDoc);
                    
                    // Sincroniza o gasto com banco ou cartão
                    await sincronizarGastoComCartaoOuBanco(gastoDoc, docRef.id);
                    
                    // Se for um gasto com cartão de crédito
                    if (data.metodoPagamento === 'Cartão de Crédito') {
                        if (parseInt(data.parcelas) > 1) {
                            // Cria parcelas para compras parceladas
                            await criarParcelas(docRef.id, gastoDoc);
                        } else {
                            // Para compras à vista, atualizar diretamente a fatura atual
                            const dataCompra = converterDataParaFusoBrasil(data.data);
                            
                            // Carregar informações do cartão para vencimento
                            const cartaoRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', data.cartaoId);
                            const cartaoSnap = await getDoc(cartaoRef);
                            let diaFechamento = 1;
                            let diaVencimento = 10;
                            
                            if (cartaoSnap.exists()) {
                                const cartaoData = cartaoSnap.data();
                                diaFechamento = cartaoData.diaFechamento || diaFechamento;
                                diaVencimento = cartaoData.diaVencimento || diaVencimento;
                            }
                            
                            // Calcular o vencimento baseado na data de compra e fechamento
                            let dataVencimento = new Date(dataCompra);
                            
                            // Se a compra foi após o fechamento, vai para a fatura do próximo mês
                            if (dataCompra.getDate() > diaFechamento) {
                                dataVencimento.setMonth(dataVencimento.getMonth() + 1);
                            }
                            
                            // Ajustar para o dia de vencimento do cartão
                            dataVencimento.setDate(diaVencimento);
                            
                            // Atualiza a fatura
                            await atualizarFaturaCartao(data.cartaoId, dataVencimento, docRef.id, parseFloat(data.valor));
                        }
                    }
                    
                    showNotification('Gasto registrado com sucesso!', 'success');
                    closeModal();
                    
                    // Recarrega a tabela de gastos, se estiver na página correspondente
                    if (window.location.hash === '#gastos') {
                        // Força a recarga da página atual para atualizar a tabela de gastos
                        document.dispatchEvent(new CustomEvent('hashchange'));
                    }
                    
                } catch (error) {
                    console.error('Erro ao salvar gasto:', error);
                    showNotification('Erro ao salvar gasto: ' + error.message, 'error');
                }
            });
            
            // Adiciona os listeners para controlar a visibilidade dos campos condicionais após o modal ser aberto
            const form = document.getElementById('gasto-form');
            if (!form) {
                console.error('Formulário de gasto não encontrado');
                return;
            }
            
            const metodoPagamento = safeQuerySelector(form, '#gasto-metodo');
            const cartaoCreditoFields = safeQuerySelector(form, '#cartao-credito-fields');
            const bancoFields = safeQuerySelector(form, '#banco-fields');
            const gastoRecorrente = safeQuerySelector(form, '#gasto-recorrente');
            const recorrenteFields = safeQuerySelector(form, '#recorrente-fields');
            const categoriasSelect = safeQuerySelector(form, '#gasto-categoria');
            const novaCategoriaField = safeQuerySelector(form, '#nova-categoria-field');
            const novaCategoriaInput = safeQuerySelector(form, '#nova-categoria-input');
            const btnGerenciarCategorias = safeQuerySelector(form, '#btn-gerenciar-categorias');
            
            // Carregar categorias personalizadas do usuário
            if (categoriasSelect) {
                carregarCategoriasPerssonalizadas(categoriasSelect);
                
                // Controla o campo de nova categoria
                categoriasSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'nova_categoria') {
                        if (novaCategoriaField) novaCategoriaField.style.display = 'block';
                        if (novaCategoriaInput) {
                            novaCategoriaInput.focus();
                            novaCategoriaInput.required = true;
                        }
                    } else {
                        if (novaCategoriaField) novaCategoriaField.style.display = 'none';
                        if (novaCategoriaInput) novaCategoriaInput.required = false;
                    }
                });
            }
            
            // Botão para gerenciar categorias
            if (btnGerenciarCategorias) {
                btnGerenciarCategorias.addEventListener('click', () => {
                    abrirGerenciadorCategorias();
                });
            }

            // Controla campos do método de pagamento
            if (metodoPagamento) {
                metodoPagamento.addEventListener('change', async (e) => {
                    if (cartaoCreditoFields) cartaoCreditoFields.style.display = 'none';
                    if (bancoFields) bancoFields.style.display = 'none';

                    if (e.target.value === 'Cartão de Crédito') {
                        if (cartaoCreditoFields) cartaoCreditoFields.style.display = 'block';
                        // Carrega os cartões do usuário
                        const cartoesRef = collection(db, 'users', currentUser.uid, 'cartoes');
                        const cartoesSnap = await getDocs(cartoesRef);
                        const cartaoSelect = safeQuerySelector(form, '#gasto-cartao');
                        if (cartaoSelect) {
                            cartaoSelect.innerHTML = '<option value="">Selecione um cartão</option>';
                            cartoesSnap.forEach(doc => {
                                const cartao = doc.data();
                                cartaoSelect.innerHTML += `<option value="${doc.id}">${cartao.nome} (final ${cartao.final})</option>`;
                            });
                        }
                    } 
                    else if (['Cartão de Débito', 'Pix', 'Transferência'].includes(e.target.value)) {
                        if (bancoFields) bancoFields.style.display = 'block';
                        // Carrega os bancos do usuário
                        const bancosRef = collection(db, 'users', currentUser.uid, 'bancos');
                        const bancosSnap = await getDocs(bancosRef);
                        const bancoSelect = safeQuerySelector(form, '#gasto-banco');
                        if (bancoSelect) {
                            bancoSelect.innerHTML = '<option value="">Selecione um banco</option>';
                            bancosSnap.forEach(doc => {
                                const banco = doc.data();
                                bancoSelect.innerHTML += `<option value="${doc.id}">${banco.nome} - Ag: ${banco.agencia} Conta: ${banco.conta}</option>`;
                            });
                        }
                    }
                });
            }

            // Controla campos de recorrência
            if (gastoRecorrente && recorrenteFields) {
                gastoRecorrente.addEventListener('change', (e) => {
                    recorrenteFields.style.display = e.target.checked ? 'block' : 'none';
                });
            }
        });
        
        // Função para carregar categorias personalizadas do usuário
        async function carregarCategoriasPerssonalizadas(selectElement) {
            if (!currentUser) return;
            
            try {
                const categoriasRef = collection(db, 'users', currentUser.uid, 'categorias');
                const categoriasSnap = await getDocs(categoriasRef);
                
                // Encontrar a opção "Nova Categoria" para inserir antes dela
                const novaCategoriaOption = selectElement.querySelector('option[value="nova_categoria"]');
                
                if (!categoriasSnap.empty) {
                    // Criar um grupo para categorias personalizadas
                    const grupoPersonalizado = document.createElement('optgroup');
                    grupoPersonalizado.label = "Categorias Personalizadas";
                    
                    // Adicionar cada categoria personalizada
                    categoriasSnap.forEach(doc => {
                        const categoria = doc.data();
                        const option = document.createElement('option');
                        option.value = categoria.nome;
                        option.textContent = categoria.nome;
                        option.dataset.categoriaId = doc.id;
                        grupoPersonalizado.appendChild(option);
                    });
                    
                    // Inserir o grupo antes da opção "Nova Categoria"
                    selectElement.insertBefore(grupoPersonalizado, novaCategoriaOption);
                }
            } catch (error) {
                console.error('Erro ao carregar categorias personalizadas:', error);
            }
        }
        
        // Função para editar um gasto existente
        async function editarGasto(gastoId) {
            if (!currentUser || !gastoId) return;
            
            try {
                // Buscar os dados do gasto
                const gastoRef = firestoreDoc(db, 'users', currentUser.uid, 'gastos', gastoId);
                const gastoSnap = await getDoc(gastoRef);
                
                if (!gastoSnap.exists()) {
                    throw new Error('Gasto não encontrado.');
                }
                
                const gastoData = gastoSnap.data();
                
                // Formatar a data para o campo date (YYYY-MM-DD)
                const dataFormatada = gastoData.data;
                
                // Criar HTML do formulário com os dados preenchidos
                const formHtml = `
                    <form id="gasto-form">
                        <div class="form-group">
                            <label for="gasto-descricao">Descrição</label>
                            <input type="text" id="gasto-descricao" name="descricao" value="${gastoData.descricao}" required>
                        </div>
                        <div class="form-group">
                            <label for="gasto-valor">Valor (R$)</label>
                            <input type="number" step="0.01" id="gasto-valor" name="valor" value="${gastoData.valor}" required>
                        </div>
                        <div class="form-group">
                            <label for="gasto-data">Data</label>
                            <input type="date" id="gasto-data" name="data" value="${dataFormatada}" required>
                        </div>
                        <div class="form-group">
                            <label for="gasto-categoria">Categoria</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="gasto-categoria" name="categoria" required style="flex-grow: 1;">
                                    <option value="">Selecione uma categoria</option>
                                    <option value="Alimentação" ${gastoData.categoria === 'Alimentação' ? 'selected' : ''}>Alimentação</option>
                                    <option value="Transporte" ${gastoData.categoria === 'Transporte' ? 'selected' : ''}>Transporte</option>
                                    <option value="Moradia" ${gastoData.categoria === 'Moradia' ? 'selected' : ''}>Moradia</option>
                                    <option value="Saúde" ${gastoData.categoria === 'Saúde' ? 'selected' : ''}>Saúde</option>
                                    <option value="Educação" ${gastoData.categoria === 'Educação' ? 'selected' : ''}>Educação</option>
                                    <option value="Lazer" ${gastoData.categoria === 'Lazer' ? 'selected' : ''}>Lazer</option>
                                    <option value="Vestuário" ${gastoData.categoria === 'Vestuário' ? 'selected' : ''}>Vestuário</option>
                                    <option value="Outros" ${gastoData.categoria === 'Outros' ? 'selected' : ''}>Outros</option>
                                    <!-- Categorias personalizadas serão adicionadas aqui -->
                                    <option value="nova_categoria">+ Nova Categoria</option>
                                </select>
                                <button type="button" id="btn-gerenciar-categorias" class="btn" style="white-space: nowrap;">
                                    <i class="fas fa-cog"></i> Gerenciar
                                </button>
                            </div>
                            <!-- Campo para nova categoria (inicialmente oculto) -->
                            <div id="nova-categoria-field" style="display: none; margin-top: 10px;">
                                <input type="text" id="nova-categoria-input" placeholder="Digite o nome da nova categoria" class="form-control">
                                <small style="display: block; margin-top: 5px; color: var(--subtle-text-color);">
                                    A nova categoria será salva automaticamente quando você registrar o gasto.
                                </small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="gasto-metodo">Método de Pagamento</label>
                            <select id="gasto-metodo" name="metodoPagamento" required>
                                <option value="">Selecione o método</option>
                                <option value="Cartão de Crédito" ${gastoData.metodoPagamento === 'Cartão de Crédito' ? 'selected' : ''}>Cartão de Crédito</option>
                                <option value="Cartão de Débito" ${gastoData.metodoPagamento === 'Cartão de Débito' ? 'selected' : ''}>Cartão de Débito</option>
                                <option value="Pix" ${gastoData.metodoPagamento === 'Pix' ? 'selected' : ''}>Pix</option>
                                <option value="Dinheiro" ${gastoData.metodoPagamento === 'Dinheiro' ? 'selected' : ''}>Dinheiro</option>
                                <option value="Transferência" ${gastoData.metodoPagamento === 'Transferência' ? 'selected' : ''}>Transferência</option>
                                <option value="Boleto" ${gastoData.metodoPagamento === 'Boleto' ? 'selected' : ''}>Boleto</option>
                                <option value="Pendente" ${gastoData.metodoPagamento === 'Pendente' ? 'selected' : ''}>Pagamento Pendente</option>
                            </select>
                        </div>
                        
                        <!-- Campos condicionais para Cartão de Crédito -->
                        <div id="cartao-credito-fields" style="display: ${gastoData.metodoPagamento === 'Cartão de Crédito' ? 'block' : 'none'};">
                            <div class="form-group">
                                <label for="gasto-cartao">Selecione o Cartão</label>
                                <select id="gasto-cartao" name="cartaoId">
                                    <!-- Será preenchido dinamicamente -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="gasto-parcelas">Número de Parcelas</label>
                                <select id="gasto-parcelas" name="parcelas">
                                    <option value="1" ${gastoData.parcelas === 1 ? 'selected' : ''}>1x (à vista)</option>
                                    <option value="2" ${gastoData.parcelas === 2 ? 'selected' : ''}>2x</option>
                                    <option value="3" ${gastoData.parcelas === 3 ? 'selected' : ''}>3x</option>
                                    <option value="4" ${gastoData.parcelas === 4 ? 'selected' : ''}>4x</option>
                                    <option value="5" ${gastoData.parcelas === 5 ? 'selected' : ''}>5x</option>
                                    <option value="6" ${gastoData.parcelas === 6 ? 'selected' : ''}>6x</option>
                                    <option value="7" ${gastoData.parcelas === 7 ? 'selected' : ''}>7x</option>
                                    <option value="8" ${gastoData.parcelas === 8 ? 'selected' : ''}>8x</option>
                                    <option value="9" ${gastoData.parcelas === 9 ? 'selected' : ''}>9x</option>
                                    <option value="10" ${gastoData.parcelas === 10 ? 'selected' : ''}>10x</option>
                                    <option value="11" ${gastoData.parcelas === 11 ? 'selected' : ''}>11x</option>
                                    <option value="12" ${gastoData.parcelas === 12 ? 'selected' : ''}>12x</option>
                                </select>
                            </div>
                        </div>
    
                        <!-- Campos condicionais para Cartão de Débito/Transferência/Pix -->
                        <div id="banco-fields" style="display: ${['Cartão de Débito', 'Pix', 'Transferência'].includes(gastoData.metodoPagamento) ? 'block' : 'none'};">
                            <div class="form-group">
                                <label for="gasto-banco">Selecione o Banco</label>
                                <select id="gasto-banco" name="bancoId">
                                    <!-- Será preenchido dinamicamente -->
                                </select>
                            </div>
                        </div>
    
                        <!-- Campo para gasto recorrente -->
                        <div class="form-group" style="margin-top: 1rem;">
                            <label>
                                <input type="checkbox" id="gasto-recorrente" name="recorrente" ${gastoData.recorrente ? 'checked' : ''}>
                                Este é um gasto recorrente
                            </label>
                        </div>
    
                        <!-- Campos condicionais para gasto recorrente -->
                        <div id="recorrente-fields" style="display: ${gastoData.recorrente ? 'block' : 'none'};">
                            <div class="form-group">
                                <label for="gasto-frequencia">Frequência</label>
                                <select id="gasto-frequencia" name="frequencia">
                                    <option value="mensal" ${gastoData.frequencia === 'mensal' ? 'selected' : ''}>Mensal</option>
                                    <option value="bimestral" ${gastoData.frequencia === 'bimestral' ? 'selected' : ''}>Bimestral</option>
                                    <option value="trimestral" ${gastoData.frequencia === 'trimestral' ? 'selected' : ''}>Trimestral</option>
                                    <option value="semestral" ${gastoData.frequencia === 'semestral' ? 'selected' : ''}>Semestral</option>
                                    <option value="anual" ${gastoData.frequencia === 'anual' ? 'selected' : ''}>Anual</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="gasto-dia-vencimento">Dia do Vencimento</label>
                                <select id="gasto-dia-vencimento" name="diaVencimento">
                                    <option value="">Selecione o dia</option>
                                    ${Array.from({length: 31}, (_, i) => i + 1).map(dia => 
                                        `<option value="${dia}" ${gastoData.diaVencimento === dia ? 'selected' : ''}>${dia}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="gasto-data-fim">Data Final (opcional)</label>
                                <input type="date" id="gasto-data-fim" name="dataFim" value="${gastoData.dataFim || ''}">
                            </div>
                        </div>
    
                        <!-- Campo para observações -->
                        <div class="form-group">
                            <label for="gasto-observacao">Observações (opcional)</label>
                            <textarea id="gasto-observacao" name="observacao" rows="3">${gastoData.observacao || ''}</textarea>
                        </div>
    
                        <button type="submit" class="btn btn-primary">Atualizar</button>
                    </form>
                `;
                
                openModal('Editar Gasto', formHtml, async () => {
                    // Setup após o modal abrir
                    const metodoSelect = document.getElementById('gasto-metodo');
                    const cartaoCreditoFields = document.getElementById('cartao-credito-fields');
                    const bancoFields = document.getElementById('banco-fields');
                    const gastoRecorrente = document.getElementById('gasto-recorrente');
                    const recorrenteFields = document.getElementById('recorrente-fields');
                    const categoriaSelect = document.getElementById('gasto-categoria');
                    const novaCategoriaField = document.getElementById('nova-categoria-field');
                    
                    // Carregar categorias personalizadas
                    await carregarCategoriasPerssonalizadas(categoriaSelect);
                    
                    // Selecionar a categoria atual do gasto
                    Array.from(categoriaSelect.options).forEach(option => {
                        if (option.value === gastoData.categoria) {
                            option.selected = true;
                        }
                    });
                    
                    // Carregar cartões para o select de cartão
                    if (gastoData.metodoPagamento === 'Cartão de Crédito') {
                        const cartaoSelect = document.getElementById('gasto-cartao');
                        const cartoesRef = collection(db, 'users', currentUser.uid, 'cartoes');
                        const cartoesSnap = await getDocs(cartoesRef);
                        
                        cartaoSelect.innerHTML = '<option value="">Selecione um cartão</option>';
                        cartoesSnap.forEach(doc => {
                            const cartao = doc.data();
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = `${cartao.nome} (final ${cartao.final})`;
                            
                            // Selecionar o cartão atual do gasto
                            if (doc.id === gastoData.cartaoId) {
                                option.selected = true;
                            }
                            
                            cartaoSelect.appendChild(option);
                        });
                    }
                    
                    // Carregar bancos para o select de banco
                    if (['Cartão de Débito', 'Pix', 'Transferência'].includes(gastoData.metodoPagamento)) {
                        const bancoSelect = document.getElementById('gasto-banco');
                        const bancosRef = collection(db, 'users', currentUser.uid, 'bancos');
                        const bancosSnap = await getDocs(bancosRef);
                        
                        bancoSelect.innerHTML = '<option value="">Selecione um banco</option>';
                        bancosSnap.forEach(doc => {
                            const banco = doc.data();
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = `${banco.nome} - Ag: ${banco.agencia} Conta: ${banco.conta}`;
                            
                            // Selecionar o banco atual do gasto
                            if (doc.id === gastoData.bancoId) {
                                option.selected = true;
                            }
                            
                            bancoSelect.appendChild(option);
                        });
                    }
                    
                    // Adicionar evento para mostrar/esconder campos de cartão de crédito
                    metodoSelect.addEventListener('change', () => {
                        const metodo = metodoSelect.value;
                        if (metodo === 'Cartão de Crédito') {
                            cartaoCreditoFields.style.display = 'block';
                            bancoFields.style.display = 'none';
                        } else if (['Cartão de Débito', 'Pix', 'Transferência'].includes(metodo)) {
                            cartaoCreditoFields.style.display = 'none';
                            bancoFields.style.display = 'block';
                        } else {
                            cartaoCreditoFields.style.display = 'none';
                            bancoFields.style.display = 'none';
                        }
                    });
                    
                    // Controla o campo de nova categoria
                    categoriaSelect.addEventListener('change', () => {
                        if (categoriaSelect.value === 'nova_categoria') {
                            novaCategoriaField.style.display = 'block';
                        } else {
                            novaCategoriaField.style.display = 'none';
                        }
                    });
                    
                    // Controla campos de recorrência
                    if (gastoRecorrente && recorrenteFields) {
                        gastoRecorrente.addEventListener('change', (e) => {
                            recorrenteFields.style.display = e.target.checked ? 'block' : 'none';
                        });
                    }
                    
                    // Configurar o botão de gerenciar categorias
                    document.getElementById('btn-gerenciar-categorias').addEventListener('click', () => {
                        abrirModalGerenciarCategorias();
                    });
                    
                }, async (data) => {
                    // Callback para quando o formulário é submetido
                    try {
                        // Verificar se foi informada uma nova categoria
                        if (data.categoria === 'nova_categoria') {
                            const novaCategoriaInput = document.getElementById('nova-categoria-input');
                            if (novaCategoriaInput && novaCategoriaInput.value) {
                                // Salva a nova categoria e usa ela no gasto
                                await salvarNovaCategoria(novaCategoriaInput.value);
                                data.categoria = novaCategoriaInput.value;
                            } else {
                                showNotification('Por favor, informe o nome da nova categoria.', 'error');
                                return;
                            }
                        }
                        
                        // Prepara o objeto de atualização
                        const updateData = {
                            descricao: data.descricao,
                            valor: parseFloat(data.valor),
                            data: data.data,
                            dataObj: converterDataParaFusoBrasil(data.data),
                            categoria: data.categoria,
                            metodoPagamento: data.metodoPagamento,
                            observacao: data.observacao || '',
                            dataAtualizacao: serverTimestamp()
                        };
                        
                        // Remove campos específicos antigos
                        if (gastoData.cartaoId && data.metodoPagamento !== 'Cartão de Crédito') {
                            await updateDoc(gastoRef, { cartaoId: deleteField() });
                            await updateDoc(gastoRef, { parcelas: deleteField() });
                        }
                        
                        if (gastoData.bancoId && !['Cartão de Débito', 'Pix', 'Transferência'].includes(data.metodoPagamento)) {
                            await updateDoc(gastoRef, { bancoId: deleteField() });
                        }
                        
                        // Adiciona campos específicos para cada método de pagamento
                        if (data.metodoPagamento === 'Cartão de Crédito') {
                            updateData.cartaoId = data.cartaoId;
                            updateData.parcelas = parseInt(data.parcelas);
                        } else if (['Cartão de Débito', 'Pix', 'Transferência'].includes(data.metodoPagamento)) {
                            updateData.bancoId = data.bancoId;
                        }
                        
                        // Atualiza informações de recorrência
                        updateData.recorrente = data.recorrente === 'on';
                        if (updateData.recorrente) {
                            updateData.frequencia = data.frequencia;
                            updateData.diaVencimento = data.diaVencimento !== '' ? parseInt(data.diaVencimento) : null;
                            updateData.dataFim = data.dataFim || null;
                        } else if (gastoData.recorrente) {
                            await updateDoc(gastoRef, { 
                                frequencia: deleteField(),
                                diaVencimento: deleteField(),
                                dataFim: deleteField()
                            });
                        }
                        
                        // Atualiza o gasto no Firestore
                        await updateDoc(gastoRef, updateData);
                        
                        showNotification('Gasto atualizado com sucesso!', 'success');
                        closeModal();
                    } catch (error) {
                        console.error('Erro ao atualizar gasto:', error);
                        showNotification('Erro ao atualizar gasto.', 'error');
                    }
                });
            } catch (error) {
                console.error('Erro ao editar gasto:', error);
                showNotification('Erro ao editar gasto.', 'error');
                throw error;
            }
        }
        
        // Função para excluir um gasto
        async function excluirGasto(gastoId) {
            if (!currentUser || !gastoId) return;
            
            try {
                const gastoRef = firestoreDoc(db, 'users', currentUser.uid, 'gastos', gastoId);
                const gastoSnap = await getDoc(gastoRef);
                
                if (!gastoSnap.exists()) {
                    throw new Error('Gasto não encontrado.');
                }
                
                const gastoData = gastoSnap.data();
                
                // Se for um gasto com cartão de crédito, atualizar fatura correspondente
                if (gastoData.metodoPagamento === 'Cartão de Crédito' && gastoData.cartaoId) {
                    // Buscar a fatura correspondente baseada na data do gasto
                    const dataGasto = new Date(gastoData.data + 'T00:00:00');
                    const mes = (dataGasto.getMonth() + 1).toString().padStart(2, '0');
                    const ano = dataGasto.getFullYear();
                    const faturaId = `${ano}-${mes}`;
                    
                    const faturaRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', gastoData.cartaoId, 'faturas', faturaId);
                    const faturaSnap = await getDoc(faturaRef);
                    
                    if (faturaSnap.exists()) {
                        const faturaData = faturaSnap.data();
                        const gastos = faturaData.gastos || {};
                        
                        // Remover o gasto da lista de gastos da fatura
                        if (gastos[gastoId]) {
                            delete gastos[gastoId];
                            
                            // Atualizar o valor total da fatura
                            const valorTotal = (parseFloat(faturaData.valorTotal) || 0) - parseFloat(gastoData.valor);
                            
                            await updateDoc(faturaRef, {
                                valorTotal: valorTotal > 0 ? valorTotal : 0,
                                gastos,
                                ultimaAtualizacao: serverTimestamp()
                            });
                        }
                    }
                }
                
                // Se o gasto estiver associado a um banco, atualizar saldo
                if (['Cartão de Débito', 'Pix', 'Transferência'].includes(gastoData.metodoPagamento) && gastoData.bancoId) {
                    const bancoRef = firestoreDoc(db, 'users', currentUser.uid, 'bancos', gastoData.bancoId);
                    const bancoSnap = await getDoc(bancoRef);
                    
                    if (bancoSnap.exists()) {
                        const bancoData = bancoSnap.data();
                        const saldoAtual = parseFloat(bancoData.saldo) || 0;
                        const novoSaldo = saldoAtual + parseFloat(gastoData.valor); // Adiciona o valor do gasto (reverte)
                        
                        await updateDoc(bancoRef, { saldo: novoSaldo });
                    }
                }
                
                // Excluir o gasto
                await deleteDoc(gastoRef);
                
                showNotification('Gasto excluído com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao excluir gasto:', error);
                showNotification('Erro ao excluir gasto.', 'error');
                throw error;
            }
        }
        
        // Função para processar o pagamento de um gasto pendente
        async function realizarPagamentoGasto(gastoId) {
            if (!currentUser || !gastoId) return;
            
            try {
                const gastoRef = firestoreDoc(db, 'users', currentUser.uid, 'gastos', gastoId);
                const gastoSnap = await getDoc(gastoRef);
                
                if (!gastoSnap.exists()) {
                    throw new Error('Gasto não encontrado.');
                }
                
                const gastoData = gastoSnap.data();
                if (gastoData.metodoPagamento !== 'Pendente' && gastoData.pago) {
                    showNotification('Este gasto já está pago.', 'info');
                    return;
                }
                
                // Criar o formulário para pagamento
                const formHtml = `
                    <form id="pagamento-form">
                        <div class="form-group">
                            <label for="metodo-pagamento">Método de Pagamento</label>
                            <select id="metodo-pagamento" name="metodoPagamento" required>
                                <option value="">Selecione o método</option>
                                <option value="Cartão de Crédito">Cartão de Crédito</option>
                                <option value="Cartão de Débito">Cartão de Débito</option>
                                <option value="Pix">Pix</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Transferência">Transferência</option>
                                <option value="Boleto">Boleto</option>
                            </select>
                        </div>
                        
                        <!-- Campos condicionais para Cartão de Crédito -->
                        <div id="cartao-credito-fields" style="display: none;">
                            <div class="form-group">
                                <label for="gasto-cartao">Selecione o Cartão</label>
                                <select id="gasto-cartao" name="cartaoId">
                                    <!-- Será preenchido dinamicamente -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="gasto-parcelas">Número de Parcelas</label>
                                <select id="gasto-parcelas" name="parcelas">
                                    <option value="1">1x (à vista)</option>
                                    <option value="2">2x</option>
                                    <option value="3">3x</option>
                                    <option value="4">4x</option>
                                    <option value="5">5x</option>
                                    <option value="6">6x</option>
                                    <option value="7">7x</option>
                                    <option value="8">8x</option>
                                    <option value="9">9x</option>
                                    <option value="10">10x</option>
                                    <option value="11">11x</option>
                                    <option value="12">12x</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Campos condicionais para Débito/Pix/Transferência -->
                        <div id="banco-fields" style="display: none;">
                            <div class="form-group">
                                <label for="gasto-banco">Selecione o Banco</label>
                                <select id="gasto-banco" name="bancoId">
                                    <!-- Será preenchido dinamicamente -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- Campo para data de pagamento -->
                        <div class="form-group">
                            <label for="data-pagamento">Data do Pagamento</label>
                            <input type="date" id="data-pagamento" name="dataPagamento" value="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                        
                        <!-- Campo para comprovante de pagamento -->
                        <div class="form-group">
                            <label for="comprovante-pagamento">Comprovante de Pagamento (opcional)</label>
                            <input type="file" id="comprovante-pagamento" name="comprovantePagamento" accept="image/*">
                            <small style="display: block; margin-top: 0.5rem; color: var(--subtle-text-color);">
                                Aceita imagens até 5MB. A imagem será convertida para base64.
                            </small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Confirmar Pagamento</button>
                    </form>
                `;
                
                openModal('Realizar Pagamento', formHtml, async () => {
                    // Setup após o modal abrir
                    const metodoSelect = document.getElementById('metodo-pagamento');
                    const cartaoCreditoFields = document.getElementById('cartao-credito-fields');
                    const bancoFields = document.getElementById('banco-fields');
                    
                    // Carregar cartões para o select de cartão
                    const cartaoSelect = document.getElementById('gasto-cartao');
                    const cartoesRef = collection(db, 'users', currentUser.uid, 'cartoes');
                    const cartoesSnap = await getDocs(cartoesRef);
                    
                    cartaoSelect.innerHTML = '<option value="">Selecione um cartão</option>';
                    cartoesSnap.forEach(doc => {
                        const cartao = doc.data();
                        cartaoSelect.innerHTML += `<option value="${doc.id}">${cartao.nome} (final ${cartao.final})</option>`;
                    });
                    
                    // Carregar bancos para o select de banco
                    const bancoSelect = document.getElementById('gasto-banco');
                    const bancosRef = collection(db, 'users', currentUser.uid, 'bancos');
                    const bancosSnap = await getDocs(bancosRef);
                    
                    bancoSelect.innerHTML = '<option value="">Selecione um banco</option>';
                    bancosSnap.forEach(doc => {
                        const banco = doc.data();
                        bancoSelect.innerHTML += `<option value="${doc.id}">${banco.nome} - Ag: ${banco.agencia} Conta: ${banco.conta}</option>`;
                    });
                    
                    // Adicionar evento para mostrar/esconder campos específicos
                    metodoSelect.addEventListener('change', () => {
                        const metodo = metodoSelect.value;
                        
                        cartaoCreditoFields.style.display = metodo === 'Cartão de Crédito' ? 'block' : 'none';
                        bancoFields.style.display = ['Cartão de Débito', 'Pix', 'Transferência'].includes(metodo) ? 'block' : 'none';
                    });
                    
                }, async (data) => {
                    try {
                        // Processar o comprovante, se houver
                        const fileInput = document.getElementById('comprovante-pagamento');
                        let comprovantePagamento = null;
                        
                        if (fileInput && fileInput.files && fileInput.files.length > 0) {
                            const file = fileInput.files[0];
                            if (file.size > 5 * 1024 * 1024) {
                                throw new Error('O comprovante deve ter no máximo 5MB.');
                            }
                            
                            comprovantePagamento = await fileToBase64(file);
                        }
                        
                        // Preparar dados para atualização
                        const updateData = {
                            metodoPagamento: data.metodoPagamento,
                            dataPagamento: data.dataPagamento,
                            pago: true,
                            status: 'Pago',
                            dataAtualizacao: serverTimestamp()
                        };
                        
                        if (comprovantePagamento) {
                            updateData.comprovantePagamento = comprovantePagamento;
                        }
                        
                        // Adicionar dados específicos para cada método de pagamento
                        if (data.metodoPagamento === 'Cartão de Crédito') {
                            updateData.cartaoId = data.cartaoId;
                            updateData.parcelas = parseInt(data.parcelas);
                            
                            // Atualizar a fatura do cartão
                            await sincronizarGastoComCartao(updateData, gastoData, gastoId);
                            
                        } else if (['Cartão de Débito', 'Pix', 'Transferência'].includes(data.metodoPagamento)) {
                            updateData.bancoId = data.bancoId;
                            
                            // Atualizar saldo do banco
                            await atualizarSaldoBanco(data.bancoId, parseFloat(gastoData.valor), false);
                        }
                        
                        // Atualizar o gasto
                        await updateDoc(gastoRef, updateData);
                        
                        showNotification('Pagamento registrado com sucesso!', 'success');
                        closeModal();
                    } catch (error) {
                        console.error('Erro ao processar pagamento:', error);
                        showNotification('Erro ao processar pagamento.', 'error');
                    }
                });
            } catch (error) {
                console.error('Erro ao abrir modal de pagamento:', error);
                showNotification('Erro ao abrir modal de pagamento.', 'error');
                throw error;
            }
        }
        
        // Função para sincronizar um gasto com cartão
        async function sincronizarGastoComCartao(novosDados, dadosAntigos, gastoId) {
            if (!currentUser || !novosDados.cartaoId) return;
            
            try {
                // Determinar mês e ano para a fatura
                const dataGasto = new Date(novosDados.dataPagamento + 'T00:00:00');
                const mes = (dataGasto.getMonth() + 1).toString().padStart(2, '0');
                const ano = dataGasto.getFullYear();
                const faturaId = `${ano}-${mes}`;
                
                // Buscar ou criar a fatura
                const faturaRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', novosDados.cartaoId, 'faturas', faturaId);
                const faturaSnap = await getDoc(faturaRef);
                
                const valorGasto = parseFloat(dadosAntigos.valor);
                
                if (faturaSnap.exists()) {
                    // Atualizar fatura existente
                    const faturaData = faturaSnap.data();
                    const valorTotal = (parseFloat(faturaData.valorTotal) || 0) + valorGasto;
                    
                    // Adicionar o gastoId à lista de gastos da fatura
                    const gastos = faturaData.gastos || {};
                    gastos[gastoId] = true;
                    
                    await updateDoc(faturaRef, {
                        valorTotal,
                        gastos,
                        ultimaAtualizacao: serverTimestamp()
                    });
                } else {
                    // Criar uma nova fatura
                    const gastos = {};
                    gastos[gastoId] = true;
                    
                    await setDoc(faturaRef, {
                        valorTotal: valorGasto,
                        gastos,
                        pago: false,
                        status: "Pendente",
                        dataCriacao: serverTimestamp(),
                        ultimaAtualizacao: serverTimestamp()
                    });
                }
                
                return true;
            } catch (error) {
                console.error('Erro ao sincronizar gasto com cartão:', error);
                return false;
            }
        }
        
        // Função para criar parcelas de um gasto no cartão de crédito
        async function criarParcelas(gastoId, gastoDoc) {
            if (!currentUser || !gastoId || !gastoDoc) return;
            
            try {
                const parcelasRef = collection(db, 'users', currentUser.uid, 'gastos', gastoId, 'parcelas');
                const valorParcela = gastoDoc.valor / gastoDoc.parcelas;
                const dataBase = gastoDoc.dataObj || converterDataParaFusoBrasil(gastoDoc.data);
                
                // Carregar informações do cartão para usar a data de fechamento e vencimento
                let diaFechamento = 1;
                let diaVencimento = 10;
                
                if (gastoDoc.cartaoId) {
                    const cartaoRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', gastoDoc.cartaoId);
                    const cartaoSnap = await getDoc(cartaoRef);
                    if (cartaoSnap.exists()) {
                        const cartaoData = cartaoSnap.data();
                        diaFechamento = cartaoData.diaFechamento || diaFechamento;
                        diaVencimento = cartaoData.diaVencimento || diaVencimento;
                    }
                }
                
                // Criar cada parcela
                const batch = writeBatch(db);
                
                for (let i = 0; i < gastoDoc.parcelas; i++) {
                    // Calcular a data desta parcela
                    const dataParcela = new Date(dataBase);
                    dataParcela.setMonth(dataBase.getMonth() + i);
                    
                    // Ajustar para considerar fechamento e vencimento do cartão
                    let dataVencimento = new Date(dataParcela);
                    
                    // Se a compra foi após o fechamento, vai para a fatura do próximo mês
                    if (dataParcela.getDate() > diaFechamento) {
                        dataVencimento.setMonth(dataVencimento.getMonth() + 1);
                    }
                    
                    // Ajustar para o dia de vencimento do cartão
                    dataVencimento.setDate(diaVencimento);
                    
                    // Formatar data no formato YYYY-MM-DD para armazenar
                    const dataFormatada = dataParcela.toISOString().split('T')[0];
                    const dataVencFormatada = dataVencimento.toISOString().split('T')[0];
                    
                    const parcelaDoc = {
                        parcela: i + 1,
                        valorTotal: gastoDoc.valor,
                        valor: valorParcela,
                        data: dataFormatada,
                        dataVencimento: dataVencFormatada,
                        paga: false
                    };
                    
                    // Adicionar ao batch
                    const newParcelaRef = firestoreDoc(parcelasRef);
                    batch.set(newParcelaRef, parcelaDoc);
                    
                    // Para cada parcela, atualizar a fatura correspondente
                    await atualizarFaturaCartao(gastoDoc.cartaoId, dataVencimento, gastoId, valorParcela);
                }
                
                // Commit do batch
                await batch.commit();
                
                console.log(`${gastoDoc.parcelas} parcelas criadas com sucesso para o gasto ${gastoId}`);
                return true;
            } catch (error) {
                console.error('Erro ao criar parcelas:', error);
                return false;
            }
        }
        
        // Função para atualizar a fatura do cartão quando um novo gasto é registrado
        async function atualizarFaturaCartao(cartaoId, dataVencimento, gastoId, valorParcela) {
            if (!currentUser || !cartaoId || !gastoId) return;
            
            try {
                // Determinar o mês e ano da fatura
                const mes = dataVencimento.getMonth() + 1; // getMonth() retorna 0-11
                const ano = dataVencimento.getFullYear();
                const faturaId = `${ano}-${String(mes).padStart(2, '0')}`;
                
                // Referência para a fatura
                const faturaRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', cartaoId, 'faturas', faturaId);
                
                // Buscar a fatura existente ou criar se não existir
                const faturaSnap = await getDoc(faturaRef);
                
                if (faturaSnap.exists()) {
                    // Atualizar a fatura existente
                    const faturaData = faturaSnap.data();
                    const valorTotal = (parseFloat(faturaData.valorTotal) || 0) + valorParcela;
                    
                    // Adicionar o gastoId à lista de gastos da fatura
                    const gastos = faturaData.gastos || {};
                    gastos[gastoId] = true;
                    
                    await updateDoc(faturaRef, {
                        valorTotal,
                        gastos,
                        ultimaAtualizacao: serverTimestamp()
                    });
                } else {
                    // Criar uma nova fatura
                    const gastos = {};
                    gastos[gastoId] = true;
                    
                    await setDoc(faturaRef, {
                        valorTotal: valorParcela,
                        gastos,
                        pago: false,
                        status: "Pendente",
                        dataCriacao: serverTimestamp(),
                        ultimaAtualizacao: serverTimestamp()
                    });
                }
                
                console.log(`Fatura ${faturaId} atualizada para o cartão ${cartaoId}`);
                return true;
            } catch (error) {
                console.error('Erro ao atualizar fatura:', error);
                return false;
            }
        }
        
        // Função para salvar uma nova categoria
        async function salvarNovaCategoria(nomeCategoria) {
            if (!currentUser || !nomeCategoria) return;
            
            try {
                // Verificar se a categoria já existe
                const categoriasRef = collection(db, 'users', currentUser.uid, 'categorias');
                const q = query(categoriasRef, where('nome', '==', nomeCategoria));
                const querySnap = await getDocs(q);
                
                if (querySnap.empty) {
                    // Se não existir, adiciona a nova categoria
                    await addDoc(categoriasRef, {
                        nome: nomeCategoria,
                        dataCriacao: serverTimestamp()
                    });
                    
                    showNotification(`Categoria "${nomeCategoria}" criada com sucesso!`, 'success');
                }
                
                return true;
            } catch (error) {
                console.error('Erro ao salvar nova categoria:', error);
                showNotification('Erro ao criar nova categoria.', 'error');
                return false;
            }
        }
        
        // Função para abrir o gerenciador de categorias
        function abrirGerenciadorCategorias() {
            if (!currentUser) return;
            
            // Função para carregar todas as categorias existentes
            async function carregarTodasCategorias() {
                const categoriasRef = collection(db, 'users', currentUser.uid, 'categorias');
                const categoriasSnap = await getDocs(categoriasRef);
                
                const categoriasList = document.getElementById('categorias-list');
                categoriasList.innerHTML = '';
                
                if (categoriasSnap.empty) {
                    categoriasList.innerHTML = '<p>Você ainda não tem categorias personalizadas.</p>';
                    return;
                }
                
                categoriasSnap.forEach(doc => {
                    const categoria = doc.data();
                    const categoriaItem = document.createElement('div');
                    categoriaItem.className = 'categoria-item';
                    categoriaItem.style.display = 'flex';
                    categoriaItem.style.justifyContent = 'space-between';
                    categoriaItem.style.alignItems = 'center';
                    categoriaItem.style.padding = '8px 0';
                    categoriaItem.style.borderBottom = '1px solid var(--border-color)';
                    
                    categoriaItem.innerHTML = `
                        <span>${categoria.nome}</span>
                        <div>
                            <button class="btn-editar-categoria" data-id="${doc.id}" data-nome="${categoria.nome}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-excluir-categoria" data-id="${doc.id}" data-nome="${categoria.nome}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    categoriasList.appendChild(categoriaItem);
                });
                
                // Adicionar event listeners para os botões de editar e excluir
                document.querySelectorAll('.btn-editar-categoria').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        const id = this.dataset.id;
                        const nome = this.dataset.nome;
                        editarCategoria(id, nome);
                    });
                });
                
                document.querySelectorAll('.btn-excluir-categoria').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        const id = this.dataset.id;
                        const nome = this.dataset.nome;
                        excluirCategoria(id, nome);
                    });
                });
            }
            
            // Função para editar uma categoria
            async function editarCategoria(id, nomeAtual) {
                const novoNome = prompt('Digite o novo nome para a categoria:', nomeAtual);
                
                if (novoNome && novoNome.trim() !== '' && novoNome !== nomeAtual) {
                    try {
                        const categoriaRef = firestoreDoc(db, 'users', currentUser.uid, 'categorias', id);
                        await updateDoc(categoriaRef, {
                            nome: novoNome,
                            dataAtualizacao: serverTimestamp()
                        });
                        
                        showNotification('Categoria atualizada com sucesso!', 'success');
                        carregarTodasCategorias(); // Recarregar a lista
                    } catch (error) {
                        console.error('Erro ao atualizar categoria:', error);
                        showNotification('Erro ao atualizar categoria.', 'error');
                    }
                }
            }
            
            // Função para excluir uma categoria
            async function excluirCategoria(id, nome) {
                if (confirm(`Tem certeza que deseja excluir a categoria "${nome}"?`)) {
                    try {
                        // Verificar se há gastos usando esta categoria
                        const gastosRef = collection(db, 'users', currentUser.uid, 'gastos');
                        const q = query(gastosRef, where('categoria', '==', nome));
                        const gastosSnap = await getDocs(q);
                        
                        if (!gastosSnap.empty) {
                            const confirmarExclusao = confirm(
                                `Existem ${gastosSnap.size} gastos usando esta categoria. \n\n` +
                                `Se você excluir esta categoria, esses gastos serão movidos para a categoria "Outros". \n\n` +
                                `Deseja continuar?`
                            );
                            
                            if (!confirmarExclusao) return;
                            
                            // Atualizar todos os gastos para a categoria "Outros"
                            const batch = writeBatch(db);
                            gastosSnap.forEach(doc => {
                                batch.update(doc.ref, { categoria: 'Outros' });
                            });
                            await batch.commit();
                        }
                        
                        // Excluir a categoria
                        const categoriaRef = firestoreDoc(db, 'users', currentUser.uid, 'categorias', id);
                        await deleteDoc(categoriaRef);
                        
                        showNotification('Categoria excluída com sucesso!', 'success');
                        carregarTodasCategorias(); // Recarregar a lista
                    } catch (error) {
                        console.error('Erro ao excluir categoria:', error);
                        showNotification('Erro ao excluir categoria.', 'error');
                    }
                }
            }
            
            // Criar o conteúdo do modal
            const formHtml = `
                <div class="gerenciador-categorias">
                    <div class="nova-categoria-form" style="margin-bottom: 20px;">
                        <h4>Adicionar Nova Categoria</h4>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="input-nova-categoria" placeholder="Nome da categoria" class="form-control" style="flex-grow: 1;">
                            <button id="btn-adicionar-categoria" class="btn btn-primary">Adicionar</button>
                        </div>
                    </div>
                    
                    <h4>Categorias Existentes</h4>
                    <div id="categorias-list" style="max-height: 300px; overflow-y: auto;">
                        <!-- Lista de categorias será carregada aqui -->
                        <p>Carregando categorias...</p>
                    </div>
                </div>
            `;
            
            openModal('Gerenciar Categorias', formHtml);
            
            // Carregar categorias existentes
            carregarTodasCategorias();
            
            // Adicionar event listener para o botão de adicionar categoria
            document.getElementById('btn-adicionar-categoria').addEventListener('click', async () => {
                const inputNovaCategoria = document.getElementById('input-nova-categoria');
                const nomeCategoria = inputNovaCategoria.value.trim();
                
                if (nomeCategoria) {
                    const sucesso = await salvarNovaCategoria(nomeCategoria);
                    if (sucesso) {
                        inputNovaCategoria.value = ''; // Limpar o campo
                        carregarTodasCategorias(); // Recarregar a lista
                    }
                } else {
                    showNotification('Digite um nome para a categoria.', 'warning');
                }
            });
        }

        document.getElementById('gastos-table-body').addEventListener('click', async (event) => {
            const target = event.target.closest('button');
            if (!target) return;

            const id = target.dataset.id;
            if (!id) return;

            const docRef = firestoreDoc(db, 'users', currentUser.uid, 'gastos', id);
            
            if (target.classList.contains('pay-btn')) {
                try {
                    // Buscar o gasto pendente
                    const docSnap = await getDoc(docRef);
                    if (!docSnap.exists()) {
                        showNotification('Gasto não encontrado.', 'error');
                        return;
                    }
                    
                    const gasto = docSnap.data();
                    
                    if (gasto.metodoPagamento !== 'Pendente') {
                        showNotification('Este gasto já foi pago.', 'warning');
                        return;
                    }
                    
                    // Buscar bancos e cartões do usuário para o formulário
                    const bancosRef = collection(db, 'users', currentUser.uid, 'bancos');
                    const bancosSnap = await getDocs(bancosRef);
                    let bancosOptions = '';
                    bancosSnap.forEach(doc => {
                        const banco = doc.data();
                        bancosOptions += `<option value="${doc.id}">${banco.nome} - Saldo: R$ ${parseFloat(banco.saldo).toFixed(2)}</option>`;
                    });
                    
                    const cartoesRef = collection(db, 'users', currentUser.uid, 'cartoes');
                    const cartoesSnap = await getDocs(cartoesRef);
                    let cartoesOptions = '';
                    cartoesSnap.forEach(doc => {
                        const cartao = doc.data();
                        cartoesOptions += `<option value="${doc.id}">${cartao.nome} (final ${cartao.final})</option>`;
                    });
                    
                    // Criar formulário para realizar o pagamento
                    const formHtml = `
                        <form id="pagamento-form">
                            <div class="form-group">
                                <label for="pagamento-metodo">Método de Pagamento</label>
                                <select id="pagamento-metodo" name="metodoPagamento" required>
                                    <option value="">Selecione o método</option>
                                    <option value="Cartão de Crédito">Cartão de Crédito</option>
                                    <option value="Cartão de Débito">Cartão de Débito</option>
                                    <option value="Pix">Pix</option>
                                    <option value="Dinheiro">Dinheiro</option>
                                    <option value="Transferência">Transferência</option>
                                    <option value="Boleto">Boleto</option>
                                </select>
                            </div>
                            
                            <div id="pagamento-cartao-credito-fields" style="display: none;">
                                <div class="form-group">
                                    <label for="pagamento-cartao">Selecione o Cartão</label>
                                    <select id="pagamento-cartao" name="cartaoId">
                                        <option value="">Selecione um cartão</option>
                                        ${cartoesOptions}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="pagamento-parcelas">Número de Parcelas</label>
                                    <select id="pagamento-parcelas" name="parcelas">
                                        <option value="1">1x (à vista)</option>
                                        <option value="2">2x</option>
                                        <option value="3">3x</option>
                                        <option value="4">4x</option>
                                        <option value="5">5x</option>
                                        <option value="6">6x</option>
                                        <option value="7">7x</option>
                                        <option value="8">8x</option>
                                        <option value="9">9x</option>
                                        <option value="10">10x</option>
                                        <option value="11">11x</option>
                                        <option value="12">12x</option>
                                        <option value="13">13x</option>
                                        <option value="14">14x</option>
                                        <option value="15">15x</option>
                                        <option value="16">16x</option>
                                        <option value="17">17x</option>
                                        <option value="18">18x</option>
                                        <option value="19">19x</option>
                                        <option value="20">20x</option>
                                        <option value="21">21x</option>
                                        <option value="22">22x</option>
                                        <option value="23">23x</option>
                                        <option value="24">24x</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="pagamento-banco-fields" style="display: none;">
                                <div class="form-group">
                                    <label for="pagamento-banco">Selecione o Banco</label>
                                    <select id="pagamento-banco" name="bancoId">
                                        <option value="">Selecione um banco</option>
                                        ${bancosOptions}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="pagamento-data">Data do Pagamento</label>
                                <input type="date" id="pagamento-data" name="dataPagamento" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="pagamento-observacao">Observações (opcional)</label>
                                <textarea id="pagamento-observacao" name="observacao" rows="2"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Confirmar Pagamento</button>
                        </form>
                    `;
                    
                    openModal(`Realizar Pagamento: ${gasto.descricao} - R$ ${parseFloat(gasto.valor).toFixed(2)}`, formHtml, async (data) => {
                        try {
                            // Atualizar o gasto com as informações de pagamento
                            const gastoAtualizado = {
                                ...gasto,
                                metodoPagamento: data.metodoPagamento,
                                dataPagamento: data.dataPagamento,
                                observacaoPagamento: data.observacao || '',
                                ...(data.cartaoId && { 
                                    cartaoId: data.cartaoId, 
                                    parcelas: data.parcelas,
                                    // Adicionar informação de parcelas
                                    parcela: data.parcelas > 1 ? `1/${data.parcelas}` : "1/1",
                                    numeroParcela: 1,
                                    totalParcelas: parseInt(data.parcelas) || 1
                                }),
                                ...(data.bancoId && { bancoId: data.bancoId }),
                                dataAtualizacao: serverTimestamp()
                            };
                            
                            // Atualizar o documento
                            await updateDoc(docRef, gastoAtualizado);
                            
                            // Sincronizar com cartão ou banco
                            await sincronizarGastoComCartaoOuBanco(gastoAtualizado, id);
                            
                            showNotification('Pagamento registrado com sucesso!', 'success');
                            closeModal();
                            loadGastosData(); // Recarregar a tabela
                        } catch (error) {
                            console.error('Erro ao registrar pagamento:', error);
                            showNotification('Erro ao registrar pagamento.', 'error');
                        }
                    });
                    
                    // Adicionar listeners para controlar a visibilidade dos campos
                    const form = document.getElementById('pagamento-form');
                    if (!form) {
                        console.error('Formulário de pagamento não encontrado');
                        return;
                    }
                    
                    const metodoPagamento = safeQuerySelector(form, '#pagamento-metodo');
                    const cartaoCreditoFields = safeQuerySelector(form, '#pagamento-cartao-credito-fields');
                    const bancoFields = safeQuerySelector(form, '#pagamento-banco-fields');
                    
                    if (metodoPagamento) {
                        metodoPagamento.addEventListener('change', () => {
                            if (cartaoCreditoFields) cartaoCreditoFields.style.display = 'none';
                            if (bancoFields) bancoFields.style.display = 'none';
                            
                            if (metodoPagamento.value === 'Cartão de Crédito') {
                                if (cartaoCreditoFields) cartaoCreditoFields.style.display = 'block';
                            } else if (['Cartão de Débito', 'Pix', 'Transferência'].includes(metodoPagamento.value)) {
                                if (bancoFields) bancoFields.style.display = 'block';
                            }
                        });
                    }
                    
                } catch (error) {
                    console.error('Erro ao preparar pagamento:', error);
                    showNotification('Erro ao preparar formulário de pagamento.', 'error');
                }
            } else if (target.classList.contains('delete-btn')) {
                if (confirm('Tem certeza que deseja excluir este gasto?')) {
                    try {
                        const docSnap = await getDoc(docRef);
                        
                        if (docSnap.exists()) {
                            const gasto = docSnap.data();
                            
                            // Verifica se é uma parcela de cartão de crédito
                            if (gasto.metodoPagamento === 'Cartão de Crédito' && gasto.parcela && gasto.parcelaGrupoId) {
                                // Mostra opções ao usuário para excluir parcelas
                                const opcoesExclusao = confirm(
                                    `Este é um gasto parcelado (${gasto.parcela}).\n\n` +
                                    `Clique em OK para excluir apenas esta parcela.\n` +
                                    `Clique em Cancelar para ver mais opções.`
                                );
                                
                                if (!opcoesExclusao) {
                                    const excluirTodas = confirm(
                                        `Deseja excluir todas as parcelas restantes?\n\n` +
                                        `Clique em OK para excluir esta e todas as parcelas futuras.\n` +
                                        `Clique em Cancelar para manter as outras parcelas.`
                                    );
                                    
                                    if (excluirTodas) {
                                        // Excluir a parcela atual e todas as parcelas futuras
                                        const parcelaAtual = parseInt(gasto.numeroParcela);
                                        const parcelaGrupoId = gasto.parcelaGrupoId;
                                        
                                        // Busca todas as parcelas do mesmo grupo
                                        const parcelasRef = collection(db, 'users', currentUser.uid, 'gastos');
                                        const q = query(parcelasRef, where("parcelaGrupoId", "==", parcelaGrupoId));
                                        const parcelasSnap = await getDocs(q);
                                        
                                        // Exclui cada parcela futura (incluindo a atual)
                                        const excluirPromises = [];
                                        parcelasSnap.forEach(parcelaDoc => {
                                            const parcela = parcelaDoc.data();
                                            if (parcela.numeroParcela >= parcelaAtual) {
                                                // Remove a sincronização do gasto
                                                excluirPromises.push(removerSincronizacaoGasto(parcela, parcelaDoc.id));
                                                
                                                // Exclui o documento do gasto
                                                excluirPromises.push(deleteDoc(parcelaDoc.ref));
                                            }
                                        });
                                        
                                        await Promise.all(excluirPromises);
                                        showNotification(`${parcelasSnap.size - parcelaAtual + 1} parcelas foram excluídas com sucesso!`, 'success');
                                        return;
                                    }
                                }
                            }
                            
                            // Remove a sincronização antes de excluir o gasto
                            await removerSincronizacaoGasto(gasto, id);
                            
                            // Exclui o gasto
                            await deleteDoc(docRef);
                            showNotification('Gasto excluído com sucesso!', 'success');
                        }
                    } catch (error) {
                        console.error('Erro ao excluir gasto:', error);
                        showNotification(`Erro ao excluir gasto: ${error.message}`, 'error');
                    }
                }
            } else if (target.classList.contains('view-btn')) {
                const comprovanteURL = target.dataset.comprovante;
                console.log('Botão de comprovante clicado:', target);
                console.log('URL do comprovante:', comprovanteURL ? comprovanteURL.substring(0, 50) + '...' : 'vazia');
                console.log('Comprimento da URL:', comprovanteURL ? comprovanteURL.length : 0);
                
                // Chamar nossa função especializada para visualizar comprovantes
                visualizarComprovante(comprovanteURL);
            }
        });

        async function sincronizarGastoComCartaoOuBanco(gasto, gastoId) {
            // Se for pagamento pendente, não faz nada
            if (gasto.metodoPagamento === 'Pendente') {
                return; // Não sincroniza com cartão ou banco
            }
            
            // Se for cartão de crédito, atualiza a fatura
            if (gasto.metodoPagamento === 'Cartão de Crédito' && gasto.cartaoId) {
                const cartaoRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', gasto.cartaoId);
                const cartaoSnap = await getDoc(cartaoRef);
                if (cartaoSnap.exists()) {
                    const cartao = cartaoSnap.data();
                    const dataGasto = gasto.dataObj || converterDataParaFusoBrasil(gasto.data);
                    
                    // Determina a fatura correta usando a função auxiliar
                    const { mesFatura, anoFatura, faturaId } = determinarFaturaCartao(dataGasto, cartao);
                    const faturaRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', gasto.cartaoId, 'faturas', faturaId);
                    
                    // Log para debug
                    console.log(`Vinculando gasto "${gasto.descricao}" (R$ ${gasto.valor}) à fatura: ${faturaId}`);
                    console.log(`Detalhes: Data=${gasto.data}, Cartão=${cartao.nome}, Fechamento=dia ${cartao.fechamento}, Vencimento=dia ${cartao.vencimento}`);
                    
                    await runTransaction(db, async (transaction) => {
                        const faturaSnap = await transaction.get(faturaRef);
                        const valorGasto = parseFloat(gasto.valor);

                        if (!faturaSnap.exists()) {
                            transaction.set(faturaRef, { 
                                valorTotal: valorGasto,
                                dataVencimento: new Date(anoFatura, mesFatura + 1, parseInt(cartao.vencimento)),
                                mes: mesFatura + 1,
                                ano: anoFatura,
                                gastos: { [gastoId]: valorGasto }
                            });
                        } else {
                            const faturaData = faturaSnap.data();
                            const novoValor = (faturaData.valorTotal || 0) + valorGasto;
                            const novosGastos = { ...(faturaData.gastos || {}), [gastoId]: valorGasto };
                            transaction.update(faturaRef, { 
                                valorTotal: novoValor, 
                                gastos: novosGastos,
                                mes: mesFatura + 1,
                                ano: anoFatura
                            });
                        }
                    });
                }
            }
            // Se for débito/pix/transferência, atualiza o saldo do banco
            else if (['Cartão de Débito', 'Pix', 'Transferência'].includes(gasto.metodoPagamento) && gasto.bancoId) {
                const bancoRef = firestoreDoc(db, 'users', currentUser.uid, 'bancos', gasto.bancoId);
                
                // Usar atualizarSaldoBanco em vez de fazer diretamente, para garantir consistência
                await atualizarSaldoBanco(gasto.bancoId, parseFloat(gasto.valor), false);
                
                // Log para debug
                console.log(`Atualizando saldo do banco para gasto "${gasto.descricao}" via ${gasto.metodoPagamento}: -R$ ${gasto.valor}`);
            }
        }

        /**
         * Determina em qual fatura um gasto deve ser incluído com base na data do gasto e no fechamento do cartão
         * @param {Date} dataGasto - Data do gasto
         * @param {Object} cartao - Dados do cartão
         * @returns {Object} - Objeto com mesFatura, anoFatura e faturaId
         */
        function determinarFaturaCartao(dataGasto, cartao) {
            let mesFatura = dataGasto.getMonth();
            let anoFatura = dataGasto.getFullYear();
            
            const diaFechamento = parseInt(cartao.fechamento);
            const diaGasto = dataGasto.getDate();
            
            // Log detalhado para depuração
            console.log(`Determinando fatura para gasto: Data=${dataGasto.toLocaleDateString()}, Dia=${diaGasto}, Fechamento=${diaFechamento}`);
            
            // Se a data do gasto for após o dia de fechamento, o gasto vai para a próxima fatura
            if (diaGasto > diaFechamento) {
                console.log(`Gasto após o fechamento (dia ${diaFechamento}), movendo para próxima fatura`);
                mesFatura += 1;
                if (mesFatura > 11) {
                    mesFatura = 0;
                    anoFatura += 1;
                }
            } else {
                console.log(`Gasto antes ou no dia do fechamento (dia ${diaFechamento}), mantendo na fatura atual`);
            }
            
            const faturaId = `${anoFatura}-${String(mesFatura + 1).padStart(2, '0')}`;
            console.log(`Fatura determinada: ${faturaId}`);
            
            return { mesFatura, anoFatura, faturaId };
        }

        async function removerSincronizacaoGasto(gasto, gastoId) {
            if (!gasto || !gastoId) return;

            // Reverte a transação no cartão de crédito
            if (gasto.metodoPagamento === 'Cartão de Crédito' && gasto.cartaoId) {
                const cartaoRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', gasto.cartaoId);
                const cartaoSnap = await getDoc(cartaoRef);
                if (cartaoSnap.exists()) {
                    const cartao = cartaoSnap.data();
                    const dataGasto = new Date(gasto.data + 'T00:00:00');
                    
                    // Determina a fatura correta usando a função auxiliar
                    const { mesFatura, anoFatura, faturaId } = determinarFaturaCartao(dataGasto, cartao);
                    const faturaRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', gasto.cartaoId, 'faturas', faturaId);

                    // Log para debug
                    console.log(`Removendo gasto "${gasto.descricao}" (R$ ${gasto.valor}) da fatura: ${faturaId}`);
                    console.log(`Detalhes: Data=${gasto.data}, Cartão=${cartao.nome}, Fechamento=dia ${cartao.fechamento}, Vencimento=dia ${cartao.vencimento}`);

                    await runTransaction(db, async (transaction) => {
                        const faturaSnap = await transaction.get(faturaRef);
                        if (faturaSnap.exists()) {
                            const faturaData = faturaSnap.data();
                            const valorGasto = parseFloat(gasto.valor);
                            const novoValor = (faturaData.valorTotal || 0) - valorGasto;
                            
                            const novosGastos = { ...(faturaData.gastos || {}) };
                            delete novosGastos[gastoId];
                            
                            if (Object.keys(novosGastos).length === 0) {
                                transaction.delete(faturaRef);
                            } else {
                                transaction.update(faturaRef, { 
                                    valorTotal: novoValor, 
                                    gastos: novosGastos,
                                    mes: mesFatura + 1,
                                    ano: anoFatura
                                });
                            }
                        }
                    });
                }
            }
            // Reverte a transação no banco
            else if (['Cartão de Débito', 'Pix', 'Transferência'].includes(gasto.metodoPagamento) && gasto.bancoId) {
                const bancoRef = firestoreDoc(db, 'users', currentUser.uid, 'bancos', gasto.bancoId);
                await runTransaction(db, async (transaction) => {
                    const bancoSnap = await transaction.get(bancoRef);
                    if (bancoSnap.exists()) {
                        const saldoAtual = parseFloat(bancoSnap.data().saldo);
                        const novoSaldo = saldoAtual + parseFloat(gasto.valor);
                        transaction.update(bancoRef, { saldo: novoSaldo });
                    }
                });
            }
        }

        async function atualizarSincronizacaoGasto(gastoNovo, gastoId, gastoAntigo) {
            // Reverte a sincronização antiga
            await removerSincronizacaoGasto(gastoAntigo, gastoId);
            
            // Aplica a nova sincronização
            await sincronizarGastoComCartaoOuBanco(gastoNovo, gastoId);
        }
        
        /**
         * Função especializada para visualizar comprovantes com tratamento robusto
         * de erros e diferentes formatos de dados
         */
        function visualizarComprovante(comprovanteData) {
            if (!comprovanteData) {
                console.error('Dados do comprovante vazios ou inválidos');
                showNotification('Não foi possível encontrar o comprovante de pagamento.', 'error');
                return;
            }
            
            // Detectar e corrigir o formato da URL de comprovante
            let urlFinal = comprovanteData;
            try {
                // Verificar se a URL está corretamente formatada e corrigir se necessário
                if (!comprovanteData.startsWith('data:')) {
                    // Tentar primeiro como JPEG, que é o caso mais comum
                    urlFinal = 'data:image/jpeg;base64,' + comprovanteData;
                }
                
                // Criar um HTML para mostrar o comprovante em um modal
                // Incluímos múltiplas alternativas para visualizar e baixar
                const modalHtml = `
                    <div style="text-align:center">
                        <!-- Área para mensagens de erro -->
                        <div id="comprovante-error" style="display:none" class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Não foi possível carregar a imagem do comprovante.
                        </div>
                        
                        <!-- Imagem do comprovante -->
                        <img 
                            src="${urlFinal}" 
                            alt="Comprovante de pagamento" 
                            style="max-width:100%; max-height:70vh; margin-bottom:10px;"
                            onerror="document.getElementById('comprovante-error').style.display='block'; this.style.display='none';"
                        >
                        
                        <!-- Botões de ação -->
                        <div style="margin-top:20px">
                            <a href="${urlFinal}" 
                               download="comprovante.jpg" 
                               class="btn btn-primary" 
                               style="margin-right:10px;">
                                <i class="fas fa-download"></i> Baixar Comprovante
                            </a>
                            <button 
                               id="btn-nova-janela" 
                               class="btn">
                                <i class="fas fa-external-link-alt"></i> Abrir em Nova Janela
                            </button>
                        </div>
                        
                        <!-- Se for uma imagem muito grande, mostrar o tamanho -->
                        ${comprovanteData.length > 100000 ? 
                            `<div style="margin-top:15px;font-size:12px;color:#666;">
                                <i class="fas fa-info-circle"></i> 
                                Tamanho da imagem: ${Math.round(comprovanteData.length / 1024)} KB
                            </div>` : ''
                        }
                    </div>
                `;
                
                // Abrir o modal com o comprovante
                openModal('Visualização do Comprovante', modalHtml, () => {
                    // Adicionar o evento para o botão de abrir em nova janela
                    document.getElementById('btn-nova-janela').addEventListener('click', () => {
                        try {
                            const w = window.open();
                            w.document.write(`
                                <html>
                                    <head>
                                        <title>Comprovante de Pagamento</title>
                                        <style>
                                            body {
                                                margin: 0;
                                                padding: 0;
                                                display: flex;
                                                justify-content: center;
                                                align-items: center;
                                                min-height: 100vh;
                                                background-color: #f5f5f5;
                                            }
                                            img {
                                                max-width: 100%;
                                                max-height: 100vh;
                                                box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
                                            }
                                        </style>
                                    </head>
                                    <body>
                                        <img src="${urlFinal}" alt="Comprovante">
                                    </body>
                                </html>
                            `);
                        } catch (e) {
                            console.error('Erro ao abrir em nova janela:', e);
                            alert('Não foi possível abrir o comprovante em uma nova janela. Tente baixar o arquivo.');
                        }
                    });
                });
                
            } catch (error) {
                console.error('Erro ao processar comprovante:', error);
                
                // Mostrar uma tela de erro com opção de download direto
                const modalHtml = `
                    <div>
                        <div class="alert alert-warning" style="margin-bottom:20px">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Não foi possível processar o comprovante como imagem.
                        </div>
                        
                        <p>O comprovante pode estar em um formato incompatível ou corrompido.</p>
                        
                        <div style="margin-top:20px">
                            <button id="btn-download-direto" class="btn btn-primary">
                                <i class="fas fa-download"></i> Tentar Download Direto
                            </button>
                        </div>
                        
                        <div style="margin-top:20px">
                            <p><strong>Informações técnicas:</strong></p>
                            <p>Tamanho dos dados: ${comprovanteData.length} caracteres</p>
                            <p>Primeiros caracteres: ${comprovanteData.substring(0, 30)}...</p>
                        </div>
                    </div>
                `;
                
                openModal('Problema ao Visualizar Comprovante', modalHtml, () => {
                    document.getElementById('btn-download-direto').addEventListener('click', () => {
                        try {
                            // Criar um elemento para download
                            const a = document.createElement('a');
                            a.href = urlFinal;
                            a.download = 'comprovante.jpg';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                        } catch (e) {
                            console.error('Erro ao tentar download:', e);
                            alert('Não foi possível fazer o download do comprovante.');
                        }
                    });
                });
            }
        }

        // --- Configurações ---
        async function loadConfiguracoesData() {
            if (!currentUser) return;
            
            try {
                // Carregar configurações do usuário
                const configRef = firestoreDoc(db, 'users', currentUser.uid, 'config', 'userPreferences');
                const configSnap = await getDoc(configRef);
                
                let userConfig = {};
                
                if (configSnap.exists()) {
                    userConfig = configSnap.data();
                } else {
                    // Configurações padrão se não existirem
                    userConfig = {
                        tema: 'claro',
                        corPrimaria: '#4f46e5',
                        moeda: 'BRL',
                        formatoData: 'DD/MM/YYYY',
                        diaInicioMes: 1,
                        notificacoes: {
                            vencimentos: true,
                            limites: true,
                            diasAntecedencia: 3
                        }
                    };
                    
                    // Salvar configurações padrão
                    await setDoc(configRef, userConfig);
                }
                
                // Preencher os campos do formulário com as configurações do usuário
                document.getElementById('tema-select').value = userConfig.tema || 'claro';
                document.getElementById('cor-primaria').value = userConfig.corPrimaria || '#4f46e5';
                document.getElementById('moeda-select').value = userConfig.moeda || 'BRL';
                document.getElementById('formato-data-select').value = userConfig.formatoData || 'DD/MM/YYYY';
                document.getElementById('dia-inicio-mes').value = userConfig.diaInicioMes || 1;
                
                // Configurações de notificações
                const notificacoes = userConfig.notificacoes || {};
                document.getElementById('notif-vencimentos').checked = notificacoes.vencimentos !== false;
                document.getElementById('notif-limites').checked = notificacoes.limites !== false;
                document.getElementById('dias-antecedencia').value = notificacoes.diasAntecedencia || 3;
                
                // Aplicar tema atual
                aplicarTema(userConfig.tema || 'claro', userConfig.corPrimaria || '#4f46e5');
                
                // Configurar listeners para os botões
                setupConfigButtonListeners();
                
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
                showNotification('Erro ao carregar configurações.', 'error');
            }
        }
        
        // Função para aplicar o tema
        function aplicarTema(tema, corPrimaria) {
            const root = document.documentElement;
            
            // Aplicar cor primária
            root.style.setProperty('--primary-color', corPrimaria);
            
            // Aplicar tema claro ou escuro
            if (tema === 'escuro') {
                root.style.setProperty('--background-color', '#1a1a1a');
                root.style.setProperty('--surface-color', '#2a2a2a');
                root.style.setProperty('--text-color', '#ffffff');
                root.style.setProperty('--subtle-text-color', '#aaaaaa');
                root.style.setProperty('--border-color', '#444444');
                document.body.classList.add('dark-theme');
            } else if (tema === 'sistema') {
                // Verificar preferência do sistema
                const prefereDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (prefereDarkMode) {
                    root.style.setProperty('--background-color', '#1a1a1a');
                    root.style.setProperty('--surface-color', '#2a2a2a');
                    root.style.setProperty('--text-color', '#ffffff');
                    root.style.setProperty('--subtle-text-color', '#aaaaaa');
                    root.style.setProperty('--border-color', '#444444');
                    document.body.classList.add('dark-theme');
                } else {
                    root.style.setProperty('--background-color', '#f1f5f9');
                    root.style.setProperty('--surface-color', '#ffffff');
                    root.style.setProperty('--text-color', '#1e293b');
                    root.style.setProperty('--subtle-text-color', '#64748b');
                    root.style.setProperty('--border-color', '#e2e8f0');
                    document.body.classList.remove('dark-theme');
                }
            } else {
                // Tema claro (padrão)
                root.style.setProperty('--background-color', '#f1f5f9');
                root.style.setProperty('--surface-color', '#ffffff');
                root.style.setProperty('--text-color', '#1e293b');
                root.style.setProperty('--subtle-text-color', '#64748b');
                root.style.setProperty('--border-color', '#e2e8f0');
                document.body.classList.remove('dark-theme');
            }
        }
        
        // Configurar listeners para os botões da página de configurações
        function setupConfigButtonListeners() {
            // Botão de salvar configurações
            document.getElementById('btn-salvar-config').addEventListener('click', async () => {
                try {
                    const tema = document.getElementById('tema-select').value;
                    const corPrimaria = document.getElementById('cor-primaria').value;
                    const moeda = document.getElementById('moeda-select').value;
                    const formatoData = document.getElementById('formato-data-select').value;
                    const diaInicioMes = parseInt(document.getElementById('dia-inicio-mes').value) || 1;
                    
                    const notifVencimentos = document.getElementById('notif-vencimentos').checked;
                    const notifLimites = document.getElementById('notif-limites').checked;
                    const diasAntecedencia = parseInt(document.getElementById('dias-antecedencia').value) || 3;
                    
                    // Criar objeto de configurações
                    const userConfig = {
                        tema,
                        corPrimaria,
                        moeda,
                        formatoData,
                        diaInicioMes,
                        notificacoes: {
                            vencimentos: notifVencimentos,
                            limites: notifLimites,
                            diasAntecedencia
                        },
                    dataAtualizacao: serverTimestamp()
                    };
                    
                    // Salvar no Firestore
                    const configRef = firestoreDoc(db, 'users', currentUser.uid, 'config', 'userPreferences');
                    await setDoc(configRef, userConfig, { merge: true });
                    
                    // Aplicar tema
                    aplicarTema(tema, corPrimaria);
                    
                    showNotification('Configurações salvas com sucesso!', 'success');
            } catch (error) {
                    console.error('Erro ao salvar configurações:', error);
                    showNotification('Erro ao salvar configurações.', 'error');
                }
            });
            
            // Botão de exportar dados
            document.getElementById('btn-exportar-dados').addEventListener('click', async () => {
                try {
                    showNotification('Exportando dados...', 'info');
                    
                    // Coletar todos os dados do usuário
                    const userData = {};
                    
                    // Gastos
                    const gastosSnap = await getDocs(collection(db, 'users', currentUser.uid, 'gastos'));
                    userData.gastos = [];
                    gastosSnap.forEach(doc => {
                        userData.gastos.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Rendas
                    const rendasSnap = await getDocs(collection(db, 'users', currentUser.uid, 'rendas'));
                    userData.rendas = [];
                    rendasSnap.forEach(doc => {
                        userData.rendas.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Cartões
                    const cartoesSnap = await getDocs(collection(db, 'users', currentUser.uid, 'cartoes'));
                    userData.cartoes = [];
                    cartoesSnap.forEach(doc => {
                        userData.cartoes.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Bancos
                    const bancosSnap = await getDocs(collection(db, 'users', currentUser.uid, 'bancos'));
                    userData.bancos = [];
                    bancosSnap.forEach(doc => {
                        userData.bancos.push({
                            id: doc.id,
                            ...doc.data()
                    });
                });
                
                    // Categorias
                    const categoriasSnap = await getDocs(collection(db, 'users', currentUser.uid, 'categorias'));
                    userData.categorias = [];
                    categoriasSnap.forEach(doc => {
                        userData.categorias.push({
                            id: doc.id,
                            ...doc.data()
                    });
                });
                    
                    // Configurações
                    const configSnap = await getDoc(firestoreDoc(db, 'users', currentUser.uid, 'config', 'userPreferences'));
                    if (configSnap.exists()) {
                        userData.configuracoes = configSnap.data();
                    }
                    
                    // Criar o arquivo JSON para download
                    const dataStr = JSON.stringify(userData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    
                    // Criar link de download
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `fincontrole_backup_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    showNotification('Dados exportados com sucesso!', 'success');
                    } catch (error) {
                    console.error('Erro ao exportar dados:', error);
                    showNotification('Erro ao exportar dados.', 'error');
                }
            });
            
            // Botão de importar dados
            document.getElementById('btn-importar-dados').addEventListener('click', () => {
                // Criar um input de arquivo oculto
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'application/json';
                fileInput.style.display = 'none';
                
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                const userData = JSON.parse(event.target.result);
                                
                                if (confirm('Tem certeza que deseja importar estes dados? Isso substituirá seus dados atuais.')) {
                                    showNotification('Importando dados...', 'info');
                                    
                                    // Importar categorias
                                    if (userData.categorias && userData.categorias.length > 0) {
                                        for (const categoria of userData.categorias) {
                                            const { id, ...categoriaData } = categoria;
                                            await setDoc(firestoreDoc(db, 'users', currentUser.uid, 'categorias', id), categoriaData);
                                        }
                                    }
                                    
                                    // Importar bancos
                                    if (userData.bancos && userData.bancos.length > 0) {
                                        for (const banco of userData.bancos) {
                                            const { id, ...bancoData } = banco;
                                            await setDoc(firestoreDoc(db, 'users', currentUser.uid, 'bancos', id), bancoData);
                                        }
                                    }
                                    
                                    // Importar cartões
                                    if (userData.cartoes && userData.cartoes.length > 0) {
                                        for (const cartao of userData.cartoes) {
                                            const { id, ...cartaoData } = cartao;
                                            await setDoc(firestoreDoc(db, 'users', currentUser.uid, 'cartoes', id), cartaoData);
                                        }
                                    }
                                    
                                    // Importar rendas
                                    if (userData.rendas && userData.rendas.length > 0) {
                                        for (const renda of userData.rendas) {
                                            const { id, ...rendaData } = renda;
                                            await setDoc(firestoreDoc(db, 'users', currentUser.uid, 'rendas', id), rendaData);
                                        }
                                    }
                                    
                                    // Importar gastos
                                    if (userData.gastos && userData.gastos.length > 0) {
                                        for (const gasto of userData.gastos) {
                                            const { id, ...gastoData } = gasto;
                                            await setDoc(firestoreDoc(db, 'users', currentUser.uid, 'gastos', id), gastoData);
                                        }
                                    }
                                    
                                    // Importar configurações
                                    if (userData.configuracoes) {
                                        await setDoc(firestoreDoc(db, 'users', currentUser.uid, 'config', 'userPreferences'), userData.configuracoes);
                                    }
                                    
                                    showNotification('Dados importados com sucesso!', 'success');
                                    
                                    // Recarregar a página para aplicar as configurações
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 2000);
                                }
                            } catch (error) {
                                console.error('Erro ao processar arquivo JSON:', error);
                                showNotification('Erro ao processar arquivo. Verifique se é um arquivo JSON válido.', 'error');
                            }
                        };
                        reader.readAsText(file);
                    } catch (error) {
                        console.error('Erro ao ler arquivo:', error);
                        showNotification('Erro ao ler arquivo.', 'error');
                    }
                });
                
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            });
            
            // Botão de alterar senha
            document.getElementById('btn-alterar-senha').addEventListener('click', () => {
                const formHtml = `
                    <form id="alterar-senha-form">
                        <div class="form-group">
                            <label for="senha-atual">Senha Atual</label>
                            <input type="password" id="senha-atual" name="senhaAtual" required>
                        </div>
                        <div class="form-group">
                            <label for="nova-senha">Nova Senha</label>
                            <input type="password" id="nova-senha" name="novaSenha" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmar-senha">Confirmar Nova Senha</label>
                            <input type="password" id="confirmar-senha" name="confirmarSenha" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Alterar Senha</button>
                    </form>
                `;
                
                openModal('Alterar Senha', formHtml, async (data) => {
                    try {
                        if (data.novaSenha !== data.confirmarSenha) {
                            throw new Error('As senhas não coincidem.');
                        }
                        
                        // Reautenticar o usuário
                        const credential = EmailAuthProvider.credential(
                            currentUser.email,
                            data.senhaAtual
                        );
                        
                        await reauthenticateWithCredential(currentUser, credential);
                        
                        // Alterar a senha
                        await updatePassword(currentUser, data.novaSenha);
                        
                        showNotification('Senha alterada com sucesso!', 'success');
                        closeModal();
                    } catch (error) {
                        console.error('Erro ao alterar senha:', error);
                        
                        if (error.code === 'auth/wrong-password') {
                            showNotification('Senha atual incorreta.', 'error');
                        } else if (error.code === 'auth/weak-password') {
                            showNotification('A nova senha é muito fraca.', 'error');
                        } else {
                            showNotification('Erro ao alterar senha: ' + error.message, 'error');
                        }
                    }
                });
            });
            
            // Botão de atualizar perfil
            document.getElementById('btn-atualizar-perfil').addEventListener('click', async () => {
                try {
                    // Buscar dados do usuário
                    const user = currentUser;
                    
                    const formHtml = `
                        <form id="atualizar-perfil-form">
                            <div class="form-group">
                                <label for="nome-usuario">Nome</label>
                                <input type="text" id="nome-usuario" name="nome" value="${user.displayName || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="email-usuario">Email</label>
                                <input type="email" id="email-usuario" name="email" value="${user.email || ''}" required disabled>
                                <small>O email não pode ser alterado.</small>
                            </div>
                            <div class="form-group">
                                <label for="foto-usuario">Foto de Perfil (URL)</label>
                                <input type="url" id="foto-usuario" name="photoURL" value="${user.photoURL || ''}">
                                <small>Deixe em branco para usar a foto padrão.</small>
                            </div>
                            <button type="submit" class="btn btn-primary">Atualizar Perfil</button>
                        </form>
                    `;
                    
                    openModal('Atualizar Perfil', formHtml, async (data) => {
                        try {
                            await updateProfile(currentUser, {
                                displayName: data.nome,
                                photoURL: data.photoURL || null
                            });
                            
                            showNotification('Perfil atualizado com sucesso!', 'success');
                            closeModal();
                            
                            // Atualizar a topbar
                            renderTopbar();
                        } catch (error) {
                            console.error('Erro ao atualizar perfil:', error);
                            showNotification('Erro ao atualizar perfil.', 'error');
                        }
                    });
                } catch (error) {
                    console.error('Erro ao carregar dados do perfil:', error);
                    showNotification('Erro ao carregar dados do perfil.', 'error');
                }
            });
        }
        
        // --- Rendas ---
        function loadRendasData() {
            if (!currentUser) return;
            const tableBody = document.getElementById('rendas-table-body');
            const cardsContainer = document.getElementById('rendas-cards-container');
            const rendasRef = collection(db, 'users', currentUser.uid, 'rendas');
            const q = query(rendasRef);

            // Adicionar evento ao botão "Nova Renda"
            const addRendaBtn = document.getElementById('add-renda-btn');
            addRendaBtn.addEventListener('click', abrirModalNovaRenda);

            // Remove qualquer filtro de mês existente para evitar duplicação
            const filtroExistente = document.querySelector('.filtro-mes-rendas');
            if (filtroExistente) {
                filtroExistente.remove();
            }
            
            // Adicionando opções de filtro por mês
            const filtroMesDiv = document.createElement('div');
            filtroMesDiv.className = 'filtro-mes-rendas';
            
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();
            
            const labelMes = document.createElement('label');
            labelMes.textContent = 'Filtrar por mês:';
            
            const selectMes = document.createElement('select');
            selectMes.id = 'filtro-mes-rendas';
            
            // Adiciona opções para os últimos 12 meses e próximos 6 meses
            for (let i = -11; i <= 6; i++) {
                const data = new Date(anoAtual, mesAtual + i, 1);
                const option = document.createElement('option');
                option.value = `${data.getFullYear()}-${String(data.getMonth() + 1).padStart(2, '0')}`;
                
                // Nome do mês em português
                const nomesMeses = [
                    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                option.textContent = `${nomesMeses[data.getMonth()]} de ${data.getFullYear()}`;
                
                // Seleciona o mês atual por padrão
                if (i === 0) {
                    option.selected = true;
                }
                selectMes.appendChild(option);
            }
            
            // Botão para limpar filtro
            const btnLimparFiltro = document.createElement('button');
            btnLimparFiltro.textContent = 'Mostrar Todos';
            btnLimparFiltro.className = 'btn';
            
            filtroMesDiv.appendChild(labelMes);
            filtroMesDiv.appendChild(selectMes);
            filtroMesDiv.appendChild(btnLimparFiltro);
            
            // Adiciona o filtro acima da tabela
            const rendasPage = document.getElementById('rendas-page');
            const rendasContainer = rendasPage.querySelector('.rendas-container');
            rendasContainer.insertBefore(filtroMesDiv, rendasContainer.firstChild);
            
            // Configurar os botões de alternância de visualização
            const viewButtons = rendasPage.querySelectorAll('.rendas-view-toggle .view-btn');
            const tableView = rendasPage.querySelector('.rendas-table-view');
            const cardsView = rendasPage.querySelector('.rendas-cards-view');
            
            viewButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const view = button.getAttribute('data-view');
                    
                    // Atualizar classes ativas dos botões
                    viewButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Mostrar a visualização selecionada
                    if (view === 'table') {
                        tableView.style.display = 'block';
                        cardsView.style.display = 'none';
                    } else {
                        tableView.style.display = 'none';
                        cardsView.style.display = 'block';
                    }
                    
                    // Salvar a preferência do usuário
                    localStorage.setItem('rendasViewPreference', view);
                });
            });
            
            // Carregar preferência salva ou usar padrão baseado no tamanho da tela
            const savedView = localStorage.getItem('rendasViewPreference');
            const isMobile = window.innerWidth <= 768;
            
            if (savedView) {
                const viewToShow = isMobile ? 'cards' : savedView;
                const button = rendasPage.querySelector(`.rendas-view-toggle .view-btn[data-view="${viewToShow}"]`);
                if (button) button.click();
            } else if (isMobile) {
                const cardsButton = rendasPage.querySelector('.rendas-view-toggle .view-btn[data-view="cards"]');
                if (cardsButton) cardsButton.click();
            }

            function carregarRendasComFiltro(filtroMes = null) {
                rendasUnsubscribe = onSnapshot(q, (querySnapshot) => {
                    tableBody.innerHTML = '';
                    cardsContainer.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        const mensagemVazio = 'Nenhuma renda encontrada.';
                        tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">${mensagemVazio}</td></tr>`;
                        cardsContainer.innerHTML = `<div class="empty-state">${mensagemVazio}</div>`;
                        return;
                    }
                    
                    // Array para armazenar todas as rendas
                    const rendas = [];
                    querySnapshot.forEach(doc => {
                        rendas.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Filtra as rendas pelo mês selecionado, se houver filtro
                    let rendasExibidas = rendas;
                    if (filtroMes) {
                        const [anoFiltro, mesFiltro] = filtroMes.split('-').map(Number);
                        
                        rendasExibidas = rendas.filter(renda => {
                            const dataRenda = new Date(renda.data + 'T00:00:00');
                            const anoRenda = dataRenda.getFullYear();
                            const mesRenda = dataRenda.getMonth() + 1; // getMonth() retorna 0-11
                            
                            return anoRenda === anoFiltro && mesRenda === mesFiltro;
                        });
                    }
                    
                    if (rendasExibidas.length === 0) {
                        const mensagemVazio = 'Nenhuma renda encontrada para o período selecionado.';
                        tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">${mensagemVazio}</td></tr>`;
                        cardsContainer.innerHTML = `<div class="empty-state">${mensagemVazio}</div>`;
                        return;
                    }
                    
                    // Ordena as rendas por data (mais recentes primeiro)
                    rendasExibidas.sort((a, b) => new Date(b.data) - new Date(a.data));
                    
                    // Função para criar o mapeamento de frequência
                    const getFrequenciaMap = () => ({
                        mensal: 'Mensal',
                        quinzenal: 'Quinzenal',
                        semanal: 'Semanal',
                        bimestral: 'Bimestral',
                        trimestral: 'Trimestral',
                        semestral: 'Semestral',
                        anual: 'Anual'
                    });
                    
                    // Função para obter detalhes da renda
                    const getDetalhesRenda = (renda) => {
                        let detalhes = [];
                        
                        if (renda.parcela) {
                            detalhes.push(`Parcela ${renda.parcela}`);
                        }
                        
                        if (renda.recorrente) {
                            const frequenciaMap = getFrequenciaMap();
                            detalhes.push(`Recorrente (${frequenciaMap[renda.frequencia] || renda.frequencia})`);
                        }
                        
                        if (renda.statusRecebimento) {
                            const statusClass = renda.statusRecebimento === 'recebido' ? 'text-success' : 'text-danger';
                            detalhes.push(`<span class="${statusClass}">
                                ${renda.statusRecebimento === 'recebido' ? 'Recebido' : 'Aguardando'}
                            </span>`);
                            
                            if (renda.statusRecebimento === 'recebido' && renda.metodoRecebimento) {
                                detalhes.push(`Via: ${renda.metodoRecebimento}`);
                            }
                        }
                        
                        if (renda.tipoRenda) {
                            detalhes.push(`Tipo: ${renda.tipoRenda === 'fixa' ? 'Fixa' : 'Variável'}`);
                        }
                        
                        if (renda.bancoId) {
                            detalhes.push(`<div class="banco-info" data-banco-id="${renda.bancoId}">Carregando banco...</div>`);
                        }
                        
                        return detalhes;
                    };
                    
                    rendasExibidas.forEach((renda) => {
                        // Obter detalhes da renda
                        const detalhes = getDetalhesRenda(renda);
                        
                        // Criar linha da tabela
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${renda.descricao}</td>
                            <td>R$ ${parseFloat(renda.valor).toFixed(2)}</td>
                            <td>${new Date(renda.data).toLocaleDateString()}</td>
                            <td>${renda.categoria}</td>
                            <td>
                                ${detalhes.length > 0 ? detalhes.join('<br>') : '-'}
                                ${renda.observacao ? `<br><small>${renda.observacao}</small>` : ''}
                            </td>
                            <td class="actions">
                                <button class="edit-btn" data-id="${renda.id}" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" data-id="${renda.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                                ${renda.statusRecebimento === 'aguardando' ? `
                                <button class="view-btn mark-received-btn" data-id="${renda.id}" title="Marcar como recebido">
                                    <i class="fas fa-check-circle"></i>
                                </button>` : ''}
                            </td>
                        `;
                        tableBody.appendChild(row);
                        
                        // Criar card
                        const card = document.createElement('div');
                        card.className = 'renda-card';
                        
                        const statusClass = renda.statusRecebimento === 'recebido' ? 'text-success' : 'text-danger';
                        const statusText = renda.statusRecebimento === 'recebido' ? 'Recebido' : 'Aguardando';
                        
                        card.innerHTML = `
                            <div class="renda-card-header">
                                <h4 class="renda-card-title">${renda.descricao}</h4>
                                <div class="renda-card-valor">R$ ${parseFloat(renda.valor).toFixed(2)}</div>
                            </div>
                            <div class="renda-card-info">
                                <div class="renda-card-info-label">Data:</div>
                                <div>${new Date(renda.data).toLocaleDateString()}</div>
                                
                                <div class="renda-card-info-label">Categoria:</div>
                                <div>${renda.categoria}</div>
                                
                                <div class="renda-card-info-label">Status:</div>
                                <div><span class="${statusClass}">${statusText}</span></div>
                                
                                ${renda.tipoRenda ? `
                                <div class="renda-card-info-label">Tipo:</div>
                                <div>${renda.tipoRenda === 'fixa' ? 'Fixa' : 'Variável'}</div>
                                ` : ''}
                                
                                ${renda.parcela ? `
                                <div class="renda-card-info-label">Parcela:</div>
                                <div>${renda.parcela}</div>
                                ` : ''}
                                
                                ${renda.recorrente ? `
                                <div class="renda-card-info-label">Recorrência:</div>
                                <div>${getFrequenciaMap()[renda.frequencia] || renda.frequencia}</div>
                                ` : ''}
                                
                                ${renda.bancoId ? `
                                <div class="renda-card-info-label">Banco:</div>
                                <div class="banco-info-card" data-banco-id="${renda.bancoId}">Carregando...</div>
                                ` : ''}
                                
                                ${renda.observacao ? `
                                <div class="renda-card-info-label">Observação:</div>
                                <div><small>${renda.observacao}</small></div>
                                ` : ''}
                            </div>
                            <div class="renda-card-actions">
                                <button class="edit-btn" data-id="${renda.id}" title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-btn" data-id="${renda.id}" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ${renda.statusRecebimento === 'aguardando' ? `
                                <button class="mark-received-btn" data-id="${renda.id}" title="Marcar como recebido">
                                    <i class="fas fa-check-circle"></i>
                                </button>` : ''}
                            </div>
                        `;
                        cardsContainer.appendChild(card);
                        
                        // Carrega informações do banco se necessário
                        if (renda.bancoId) {
                            const bancoRef = firestoreDoc(db, 'users', currentUser.uid, 'bancos', renda.bancoId);
                            getDoc(bancoRef).then(bancoDoc => {
                                if (bancoDoc.exists()) {
                                    const banco = bancoDoc.data();
                                    // Atualiza na tabela
                                    const bancoCell = row.querySelector(`.banco-info[data-banco-id="${renda.bancoId}"]`);
                                    if (bancoCell) {
                                        bancoCell.textContent = `Banco: ${banco.nome}`;
                                    }
                                    
                                    // Atualiza no card
                                    const bancoCardInfo = card.querySelector(`.banco-info-card[data-banco-id="${renda.bancoId}"]`);
                                    if (bancoCardInfo) {
                                        bancoCardInfo.textContent = banco.nome;
                                    }
                                }
                            });
                        }
                    });
                    
                    // Adicionar listeners para os botões nos cards
                    document.querySelectorAll('.renda-card .edit-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const rendaId = btn.getAttribute('data-id');
                            editarRenda(rendaId);
                        });
                    });
                    
                    document.querySelectorAll('.renda-card .delete-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const rendaId = btn.getAttribute('data-id');
                            if (confirm('Tem certeza que deseja excluir esta renda?')) {
                                excluirRenda(rendaId);
                            }
                        });
                    });
                    
                    document.querySelectorAll('.renda-card .mark-received-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const rendaId = btn.getAttribute('data-id');
                            abrirModalRecebimento(rendaId);
                        });
                    });
                });
            }

            // Inicializa com o filtro do mês atual
            const mesInicial = `${anoAtual}-${String(mesAtual + 1).padStart(2, '0')}`;
            carregarRendasComFiltro(mesInicial);
            
            // Adiciona listeners para os elementos de filtro (evitando duplicação)
            function onSelectMesChange() {
                carregarRendasComFiltro(selectMes.value);
                
                // Atualizar texto do botão em dispositivos móveis
                if (window.innerWidth <= 576) {
                    const option = selectMes.options[selectMes.selectedIndex];
                    const mesTexto = option.textContent.split(' ')[0];
                    btnLimparFiltro.textContent = 'Todos';
                }
            }
            
            function onBtnLimparFiltroClick() {
                carregarRendasComFiltro(null);
                selectMes.value = mesInicial;
                
                // Atualizar texto do botão em dispositivos móveis
                if (window.innerWidth <= 576) {
                    btnLimparFiltro.textContent = 'Todos';
                }
            }
            
            // Ajustar texto do botão em dispositivos móveis
            if (window.innerWidth <= 576) {
                btnLimparFiltro.textContent = 'Todos';
            }
            
            // Remove listeners antigos se existirem
            selectMes.removeEventListener('change', selectMes._changeListener);
            
            // Adiciona o listener para o botão de excluir todas as rendas
            const deleteAllRendasBtn = document.getElementById('delete-all-rendas-btn');
            deleteAllRendasBtn.addEventListener('click', async () => {
                // Confirmar a exclusão com o usuário
                const filtroAtual = selectMes.value;
                const filtroTexto = filtroAtual ? `do mês ${selectMes.options[selectMes.selectedIndex].textContent}` : "de todos os meses";
                
                const confirmacao = confirm(`Tem certeza que deseja excluir TODAS as rendas ${filtroTexto}? Esta ação não pode ser desfeita.`);
                if (!confirmacao) return;
                
                // Segunda confirmação para garantir
                const segundaConfirmacao = confirm(`ATENÇÃO: Esta ação excluirá permanentemente todas as rendas ${filtroTexto}. Confirma a exclusão?`);
                if (!segundaConfirmacao) return;
                
                try {
                    // Mostrar indicador de carregamento
                    showNotification('Excluindo rendas, por favor aguarde...', 'info');
                    
                    // Buscar todas as rendas
                    const rendasRef = collection(db, 'users', currentUser.uid, 'rendas');
                    let q = query(rendasRef);
                    
                    // Se houver filtro de mês, aplicá-lo
                    if (filtroAtual) {
                        const [anoFiltro, mesFiltro] = filtroAtual.split('-').map(Number);
                        const primeiroDia = new Date(anoFiltro, mesFiltro - 1, 1).toISOString().split('T')[0];
                        const ultimoDia = new Date(anoFiltro, mesFiltro, 0).toISOString().split('T')[0];
                        
                        q = query(rendasRef, 
                            where("data", ">=", primeiroDia),
                            where("data", "<=", ultimoDia)
                        );
                    }
                    
                    const rendasSnap = await getDocs(q);
                    
                    if (rendasSnap.empty) {
                        showNotification('Não há rendas para excluir.', 'info');
                        return;
                    }
                    
                    // Armazenar todas as promessas de exclusão
                    const deletePromises = [];
                    let contadorRendas = 0;
                    
                    // Para cada renda, verificar se ela está associada a um banco
                    // e atualizar o saldo do banco se necessário antes de excluí-la
                    for (const doc of rendasSnap.docs) {
                        const renda = doc.data();
                        contadorRendas++;
                        
                        // Se a renda já foi recebida e tem um banco associado, 
                        // precisamos reverter o saldo do banco
                        if (renda.statusRecebimento === 'recebido' && renda.bancoId) {
                            // Reverter o saldo do banco (subtrair o valor da renda)
                            const bancoRef = firestoreDoc(db, 'users', currentUser.uid, 'bancos', renda.bancoId);
                            const bancoSnap = await getDoc(bancoRef);
                            
                            if (bancoSnap.exists()) {
                                const banco = bancoSnap.data();
                                const novoSaldo = parseFloat(banco.saldo) - parseFloat(renda.valor);
                                
                                // Atualizar o saldo do banco
                                deletePromises.push(updateDoc(bancoRef, { 
                                    saldo: novoSaldo.toFixed(2),
                                    dataAtualizacao: serverTimestamp()
                                }));
                            }
                        }
                        
                        // Excluir a renda
                        deletePromises.push(deleteDoc(doc.ref));
                    }
                    
                    // Executar todas as promessas de exclusão
                    await Promise.all(deletePromises);
                    
                    showNotification(`${contadorRendas} rendas foram excluídas com sucesso!`, 'success');
                    
                    // Recarregar os dados da página
                    loadRendasData();
                } catch (error) {
                    console.error('Erro ao excluir rendas:', error);
                    showNotification(`Erro ao excluir rendas: ${error.message}`, 'error');
                }
            });
            btnLimparFiltro.removeEventListener('click', btnLimparFiltro._clickListener);
            
            // Adiciona novos listeners e armazena referências
            selectMes._changeListener = onSelectMesChange;
            btnLimparFiltro._clickListener = onBtnLimparFiltroClick;
            
            selectMes.addEventListener('change', onSelectMesChange);
            btnLimparFiltro.addEventListener('click', onBtnLimparFiltroClick);
            
            // Adiciona handler para botões de edição e exclusão na tabela
            tableBody.addEventListener('click', async function(event) {
                const target = event.target.closest('button');
                if (!target) return;
                
                const rendaId = target.dataset.id;
                if (!rendaId) return;
                
                // Gerencia evento para o botão de exclusão
                if (target.classList.contains('delete-btn')) {
                    if (confirm('Tem certeza que deseja excluir esta renda?')) {
                        await excluirRenda(rendaId);
                    }
                }
                // Gerencia evento para o botão de edição
                else if (target.classList.contains('edit-btn')) {
                    try {
                        await editarRenda(rendaId);
                    } catch (error) {
                        console.error('Erro ao editar renda:', error);
                        showNotification('Erro ao editar renda.', 'error');
                    }
                }
            });
            
            // Adiciona listener para marcar como recebido
            tableBody.addEventListener('click', async (event) => {
                const target = event.target.closest('.mark-received-btn');
                if (!target) return;
                
                const rendaId = target.dataset.id;
                if (!rendaId) return;
                
                // Usa a função centralizada para abrir o modal de recebimento
                await abrirModalRecebimento(rendaId);
            });
            
            /**
             * Função para excluir uma renda
             * @param {string} rendaId - ID da renda a ser excluída
             */
            async function excluirRenda(rendaId) {
                try {
                    // Primeiro busca os detalhes da renda para verificar se há banco associado
                    const rendaRef = firestoreDoc(db, 'users', currentUser.uid, 'rendas', rendaId);
                    const rendaSnap = await getDoc(rendaRef);
                    
                    if (rendaSnap.exists()) {
                        const rendaData = rendaSnap.data();
                        
                        // Se a renda já foi recebida e tem um banco associado, reverte o saldo
                        if (rendaData.statusRecebimento === 'recebido' && rendaData.bancoId) {
                            await atualizarSaldoBanco(rendaData.bancoId, parseFloat(rendaData.valor), false);
                        }
                        
                        // Exclui a renda
                        await deleteDoc(rendaRef);
                        showNotification('Renda excluída com sucesso!', 'success');
                    } else {
                        showNotification('Erro: Renda não encontrada.', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao excluir renda:', error);
                    showNotification('Erro ao excluir renda.', 'error');
                }
            }
        }

        /**
         * Função para abrir o modal de cadastro de nova renda
         */
        async function abrirModalNovaRenda() {
            try {
                if (!currentUser) return;
                
                const hoje = new Date().toISOString().split('T')[0];
                
                // Cria o formulário de nova renda
                const formHtml = `
                    <form id="renda-form">
                        <div class="form-group">
                            <label for="renda-descricao">Descrição</label>
                            <input type="text" id="renda-descricao" name="descricao" required>
                        </div>
                        <div class="form-group">
                            <label for="renda-valor">Valor (R$)</label>
                            <input type="number" step="0.01" id="renda-valor" name="valor" required>
                        </div>
                        <div class="form-group">
                            <label for="renda-data">Data</label>
                            <input type="date" id="renda-data" name="data" value="${hoje}" required>
                        </div>
                        <div class="form-group">
                            <label for="renda-categoria">Categoria</label>
                            <select id="renda-categoria" name="categoria" required>
                                <option value="">Selecione uma categoria</option>
                                <option value="Salário">Salário</option>
                                <option value="Freelance">Freelance</option>
                                <option value="Investimentos">Investimentos</option>
                                <option value="Outros">Outros</option>
                                <!-- Categorias personalizadas serão adicionadas aqui -->
                            </select>
                            <button type="button" id="btn-gerenciar-categorias-renda" class="btn" style="white-space: nowrap; margin-top: 0.5rem;">
                                <i class="fas fa-cog"></i> Gerenciar Categorias
                            </button>
                        </div>
                        
                        <!-- Tipo de Renda -->
                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="renda-tipo">Tipo de Renda</label>
                            <select id="renda-tipo" name="tipoRenda" required>
                                <option value="fixa">Fixa</option>
                                <option value="variavel">Variável</option>
                            </select>
                        </div>
                        
                        <!-- Status de recebimento -->
                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="renda-status">Status de Recebimento</label>
                            <select id="renda-status" name="statusRecebimento" required>
                                <option value="aguardando">Aguardando Recebimento</option>
                                <option value="recebido">Já Recebido</option>
                            </select>
                        </div>
                        
                        <!-- Campos condicionais para rendas já recebidas -->
                        <div id="recebimento-fields" style="display: none;">
                            <div class="form-group">
                                <label for="renda-metodo">Método de Recebimento</label>
                                <select id="renda-metodo" name="metodoRecebimento">
                                    <option value="">Selecione o método</option>
                                    <option value="Pix">Pix</option>
                                    <option value="Transferência">Transferência</option>
                                    <option value="Depósito">Depósito</option>
                                    <option value="Dinheiro">Dinheiro</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="renda-data-recebimento">Data de Recebimento</label>
                                <input type="date" id="renda-data-recebimento" name="dataRecebimento" value="${hoje}">
                            </div>
                            <div class="form-group" id="banco-container">
                                <label for="renda-banco">Banco de Destino</label>
                                <select id="renda-banco" name="bancoId">
                                    <option value="">Selecione um banco</option>
                                    <!-- Será preenchido dinamicamente -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- Campo para observações -->
                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="renda-observacao">Observações (opcional)</label>
                            <textarea id="renda-observacao" name="observacao" rows="3"></textarea>
                        </div>
                        
                        <button type="submit" id="renda-submit-btn" class="btn btn-primary">Salvar</button>
                    </form>
                `;
                
                openModal('Nova Renda', formHtml, async (data) => {
                    try {
                        // Desabilita o botão de submit para evitar múltiplos cliques
                        const submitBtn = document.getElementById('renda-submit-btn');
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
                        }
                        
                        // Preparar os dados da nova renda
                        const rendaData = {
                            ...data,
                            dataCriacao: serverTimestamp(),
                            dataAtualizacao: serverTimestamp()
                        };
                        
                        // Adiciona a renda no Firestore
                        const rendasRef = collection(db, 'users', currentUser.uid, 'rendas');
                        const docRef = await addDoc(rendasRef, rendaData);
                        
                        // Ajustar saldo do banco se necessário
                        if (data.statusRecebimento === 'recebido' && data.bancoId) {
                            await atualizarSaldoBanco(data.bancoId, parseFloat(data.valor), true);
                        }
                        
                        showNotification('Renda cadastrada com sucesso!', 'success');
                        closeModal();
                    } catch (error) {
                        console.error('Erro ao cadastrar renda:', error);
                        showNotification('Erro ao cadastrar renda.', 'error');
                        
                        // Reabilita o botão em caso de erro
                        const submitBtn = document.getElementById('renda-submit-btn');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = 'Salvar';
                        }
                    }
                });
                
                // Carregar categorias personalizadas
                const categoriasSelect = document.getElementById('renda-categoria');
                await carregarCategoriasPerssonalizadasRendas(categoriasSelect);
                
                // Botão para gerenciar categorias
                document.getElementById('btn-gerenciar-categorias-renda').addEventListener('click', () => {
                    abrirGerenciadorCategoriasRendas();
                });
                
                // Controla campos de recebimento
                const rendaStatus = document.getElementById('renda-status');
                const recebimentoFields = document.getElementById('recebimento-fields');
                
                rendaStatus.addEventListener('change', async (e) => {
                    recebimentoFields.style.display = e.target.value === 'recebido' ? 'block' : 'none';
                    
                    // Se marcou como recebido, já preenche a data de recebimento com a data atual
                    if (e.target.value === 'recebido') {
                        document.getElementById('renda-data-recebimento').value = hoje;
                        
                        // Carrega os bancos do usuário
                        const bancosRef = collection(db, 'users', currentUser.uid, 'bancos');
                        const bancosSnap = await getDocs(bancosRef);
                        const bancoSelect = document.getElementById('renda-banco');
                        bancoSelect.innerHTML = '<option value="">Selecione um banco</option>';
                        
                        if (bancosSnap.empty) {
                            bancoSelect.innerHTML += '<option value="" disabled>Nenhum banco cadastrado</option>';
                        } else {
                            bancosSnap.forEach(doc => {
                                const banco = doc.data();
                                bancoSelect.innerHTML += `<option value="${doc.id}">${banco.nome} - Ag: ${banco.agencia} Conta: ${banco.conta}</option>`;
                            });
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao abrir modal de nova renda:', error);
                showNotification('Erro ao abrir modal de nova renda.', 'error');
            }
        }

        /**
         * Carrega as categorias personalizadas de rendas no select fornecido
         * @param {HTMLSelectElement} selectElement - Elemento select para adicionar as categorias
         */
        async function carregarCategoriasPerssonalizadasRendas(selectElement) {
            if (!currentUser || !selectElement) return;
            
            try {
                const categoriasRef = collection(db, 'users', currentUser.uid, 'categoriasRendas');
                const categoriasSnap = await getDocs(categoriasRef);
                
                if (!categoriasSnap.empty) {
                    categoriasSnap.forEach(doc => {
                        const categoria = doc.data();
                        const option = document.createElement('option');
                        option.value = categoria.nome;
                        option.textContent = categoria.nome;
                        selectElement.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar categorias de rendas:', error);
            }
        }

        /**
         * Função para salvar uma nova categoria de renda
         * @param {string} nomeCategoria - Nome da nova categoria
         * @returns {Promise<boolean>} Sucesso ou falha da operação
         */
        async function salvarNovaCategoriaRenda(nomeCategoria) {
            if (!nomeCategoria || !currentUser) return false;
            
            try {
                // Verificar se a categoria já existe
                const categoriasRef = collection(db, 'users', currentUser.uid, 'categoriasRendas');
                const q = query(categoriasRef, where('nome', '==', nomeCategoria));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    showNotification('Esta categoria já existe.', 'warning');
                    return false;
                }
                
                // Adicionar a nova categoria
                await addDoc(categoriasRef, {
                    nome: nomeCategoria,
                    dataCriacao: serverTimestamp(),
                    dataAtualizacao: serverTimestamp()
                });
                
                showNotification('Categoria adicionada com sucesso!', 'success');
                return true;
            } catch (error) {
                console.error('Erro ao salvar nova categoria:', error);
                showNotification('Erro ao salvar nova categoria.', 'error');
                return false;
            }
        }

        // Função para abrir o gerenciador de categorias de rendas
        function abrirGerenciadorCategoriasRendas() {
            if (!currentUser) return;
            
            // Função para carregar todas as categorias existentes
            async function carregarTodasCategoriasRendas() {
                const categoriasRef = collection(db, 'users', currentUser.uid, 'categoriasRendas');
                const categoriasSnap = await getDocs(categoriasRef);
                
                const categoriasList = document.getElementById('categorias-rendas-list');
                categoriasList.innerHTML = '';
                
                if (categoriasSnap.empty) {
                    categoriasList.innerHTML = '<p>Você ainda não tem categorias personalizadas de rendas.</p>';
                    return;
                }
                
                categoriasSnap.forEach(doc => {
                    const categoria = doc.data();
                    const categoriaItem = document.createElement('div');
                    categoriaItem.className = 'categoria-item';
                    categoriaItem.style.display = 'flex';
                    categoriaItem.style.justifyContent = 'space-between';
                    categoriaItem.style.alignItems = 'center';
                    categoriaItem.style.padding = '8px 0';
                    categoriaItem.style.borderBottom = '1px solid var(--border-color)';
                    
                    categoriaItem.innerHTML = `
                        <span>${categoria.nome}</span>
                        <div>
                            <button class="btn-editar-categoria-renda" data-id="${doc.id}" data-nome="${categoria.nome}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-excluir-categoria-renda" data-id="${doc.id}" data-nome="${categoria.nome}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    categoriasList.appendChild(categoriaItem);
                });
                
                // Adicionar event listeners para os botões de editar e excluir
                document.querySelectorAll('.btn-editar-categoria-renda').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        const nome = e.currentTarget.dataset.nome;
                        editarCategoriaRenda(id, nome);
                    });
                });
                
                document.querySelectorAll('.btn-excluir-categoria-renda').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.dataset.id;
                        const nome = e.currentTarget.dataset.nome;
                        excluirCategoriaRenda(id, nome);
                    });
                });
            }
            
            // Função para editar uma categoria
            async function editarCategoriaRenda(id, nomeAtual) {
                const novoNome = prompt('Digite o novo nome para a categoria:', nomeAtual);
                
                if (novoNome && novoNome.trim() !== '' && novoNome !== nomeAtual) {
                    try {
                        const categoriaRef = firestoreDoc(db, 'users', currentUser.uid, 'categoriasRendas', id);
                        await updateDoc(categoriaRef, {
                            nome: novoNome,
                            dataAtualizacao: serverTimestamp()
                        });
                        
                        showNotification('Categoria atualizada com sucesso!', 'success');
                        carregarTodasCategoriasRendas(); // Recarregar a lista
                    } catch (error) {
                        console.error('Erro ao atualizar categoria:', error);
                        showNotification('Erro ao atualizar categoria.', 'error');
                    }
                }
            }
            
            // Função para excluir uma categoria
            async function excluirCategoriaRenda(id, nome) {
                if (confirm(`Tem certeza que deseja excluir a categoria "${nome}"?`)) {
                    try {
                        // Verificar se há rendas usando esta categoria
                        const rendasRef = collection(db, 'users', currentUser.uid, 'rendas');
                        const q = query(rendasRef, where('categoria', '==', nome));
                        const rendasSnap = await getDocs(q);
                        
                        if (!rendasSnap.empty) {
                            const confirmarExclusao = confirm(
                                `Existem ${rendasSnap.size} rendas usando esta categoria. \n\n` +
                                `Se você excluir esta categoria, essas rendas serão movidas para a categoria "Outros". \n\n` +
                                `Deseja continuar?`
                            );
                            
                            if (!confirmarExclusao) return;
                            
                            // Atualizar todas as rendas para a categoria "Outros"
                            const batch = writeBatch(db);
                            rendasSnap.forEach(doc => {
                                batch.update(doc.ref, { categoria: 'Outros' });
                            });
                            await batch.commit();
                        }
                        
                        // Excluir a categoria
                        const categoriaRef = firestoreDoc(db, 'users', currentUser.uid, 'categoriasRendas', id);
                        await deleteDoc(categoriaRef);
                        
                        showNotification('Categoria excluída com sucesso!', 'success');
                        carregarTodasCategoriasRendas(); // Recarregar a lista
                    } catch (error) {
                        console.error('Erro ao excluir categoria:', error);
                        showNotification('Erro ao excluir categoria.', 'error');
                    }
                }
            }
            
            // Criar o conteúdo do modal
            const formHtml = `
                <div class="gerenciador-categorias-rendas">
                    <div class="nova-categoria-form" style="margin-bottom: 20px;">
                        <h4>Adicionar Nova Categoria de Renda</h4>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="input-nova-categoria-renda" placeholder="Nome da categoria" class="form-control" style="flex-grow: 1;">
                            <button id="btn-adicionar-categoria-renda" class="btn btn-primary">Adicionar</button>
                        </div>
                    </div>
                    
                    <h4>Categorias Existentes</h4>
                    <div id="categorias-rendas-list" style="max-height: 300px; overflow-y: auto;">
                        <!-- Lista de categorias será carregada aqui -->
                        <p>Carregando categorias...</p>
                    </div>
                </div>
            `;
            
            openModal('Gerenciar Categorias de Rendas', formHtml);
            
            // Carregar categorias existentes
            carregarTodasCategoriasRendas();
            
            // Adicionar event listener para o botão de adicionar categoria
            document.getElementById('btn-adicionar-categoria-renda').addEventListener('click', async () => {
                const inputNovaCategoria = document.getElementById('input-nova-categoria-renda');
                const nomeCategoria = inputNovaCategoria.value.trim();
                
                if (nomeCategoria) {
                    const sucesso = await salvarNovaCategoriaRenda(nomeCategoria);
                    if (sucesso) {
                        inputNovaCategoria.value = ''; // Limpar o campo
                        carregarTodasCategoriasRendas(); // Recarregar a lista
                    }
                } else {
                    showNotification('Digite um nome para a categoria.', 'warning');
                }
            });
        }

        /**
         * Função para editar uma renda existente
         * @param {string} rendaId - ID da renda a ser editada
         */
        async function editarRenda(rendaId) {
            try {
                if (!currentUser || !rendaId) return;
                
                const rendaRef = firestoreDoc(db, 'users', currentUser.uid, 'rendas', rendaId);
                const rendaSnap = await getDoc(rendaRef);
                
                if (!rendaSnap.exists()) {
                    showNotification('Renda não encontrada.', 'error');
                    return;
                }
                
                const renda = rendaSnap.data();
                
                // Cria o formulário de edição com os dados da renda
                const formHtml = `
                    <form id="renda-edit-form">
                        <div class="form-group">
                            <label for="renda-descricao">Descrição</label>
                            <input type="text" id="renda-descricao" name="descricao" value="${renda.descricao}" required>
                        </div>
                        <div class="form-group">
                            <label for="renda-valor">Valor (R$)</label>
                            <input type="number" step="0.01" id="renda-valor" name="valor" value="${renda.valor}" required>
                        </div>
                        <div class="form-group">
                            <label for="renda-data">Data</label>
                            <input type="date" id="renda-data" name="data" value="${renda.data}" required>
                        </div>
                        <div class="form-group">
                            <label for="renda-categoria">Categoria</label>
                            <select id="renda-categoria" name="categoria" required>
                                <option value="">Selecione uma categoria</option>
                                <option value="Salário" ${renda.categoria === 'Salário' ? 'selected' : ''}>Salário</option>
                                <option value="Freelance" ${renda.categoria === 'Freelance' ? 'selected' : ''}>Freelance</option>
                                <option value="Investimentos" ${renda.categoria === 'Investimentos' ? 'selected' : ''}>Investimentos</option>
                                <option value="Outros" ${renda.categoria === 'Outros' ? 'selected' : ''}>Outros</option>
                                <!-- Categorias personalizadas serão adicionadas aqui -->
                            </select>
                            <button type="button" id="btn-gerenciar-categorias-renda-edit" class="btn" style="white-space: nowrap; margin-top: 0.5rem;">
                                <i class="fas fa-cog"></i> Gerenciar Categorias
                            </button>
                        </div>
                        
                        <!-- Tipo de Renda -->
                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="renda-tipo">Tipo de Renda</label>
                            <select id="renda-tipo" name="tipoRenda" required>
                                <option value="fixa" ${renda.tipoRenda === 'fixa' ? 'selected' : ''}>Fixa</option>
                                <option value="variavel" ${renda.tipoRenda === 'variavel' ? 'selected' : ''}>Variável</option>
                            </select>
                        </div>
                        
                        <!-- Status de recebimento -->
                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="renda-status">Status de Recebimento</label>
                            <select id="renda-status" name="statusRecebimento" required>
                                <option value="aguardando" ${renda.statusRecebimento === 'aguardando' ? 'selected' : ''}>Aguardando Recebimento</option>
                                <option value="recebido" ${renda.statusRecebimento === 'recebido' ? 'selected' : ''}>Já Recebido</option>
                            </select>
                        </div>
                        
                        <!-- Campos condicionais para rendas já recebidas -->
                        <div id="recebimento-fields" style="display: ${renda.statusRecebimento === 'recebido' ? 'block' : 'none'};">
                            <div class="form-group">
                                <label for="renda-metodo">Método de Recebimento</label>
                                <select id="renda-metodo" name="metodoRecebimento">
                                    <option value="">Selecione o método</option>
                                    <option value="Pix" ${renda.metodoRecebimento === 'Pix' ? 'selected' : ''}>Pix</option>
                                    <option value="Transferência" ${renda.metodoRecebimento === 'Transferência' ? 'selected' : ''}>Transferência</option>
                                    <option value="Depósito" ${renda.metodoRecebimento === 'Depósito' ? 'selected' : ''}>Depósito</option>
                                    <option value="Dinheiro" ${renda.metodoRecebimento === 'Dinheiro' ? 'selected' : ''}>Dinheiro</option>
                                    <option value="Cheque" ${renda.metodoRecebimento === 'Cheque' ? 'selected' : ''}>Cheque</option>
                                    <option value="Outro" ${renda.metodoRecebimento === 'Outro' ? 'selected' : ''}>Outro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="renda-data-recebimento">Data de Recebimento</label>
                                <input type="date" id="renda-data-recebimento" name="dataRecebimento" value="${renda.dataRecebimento || ''}">
                            </div>
                            <div class="form-group" id="banco-container">
                                <label for="renda-banco">Banco de Destino</label>
                                <select id="renda-banco" name="bancoId">
                                    <option value="">Selecione um banco</option>
                                    <!-- Será preenchido dinamicamente -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- Campo para observações -->
                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label for="renda-observacao">Observações (opcional)</label>
                            <textarea id="renda-observacao" name="observacao" rows="3">${renda.observacao || ''}</textarea>
                        </div>
                        
                        <button type="submit" id="renda-submit-btn" class="btn btn-primary">Atualizar</button>
                    </form>
                `;
                
                openModal('Editar Renda', formHtml, async (data) => {
                    try {
                        // Desabilita o botão de submit para evitar múltiplos cliques
                        const submitBtn = document.getElementById('renda-submit-btn');
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
                        }
                        
                        const valorAntigo = parseFloat(renda.valor);
                        const valorNovo = parseFloat(data.valor);
                        const diferencaValor = valorNovo - valorAntigo;
                        
                        // Verifica se houve mudança no banco e no status
                        const mudouBanco = (renda.bancoId || '') !== (data.bancoId || '');
                        const mudouStatus = renda.statusRecebimento !== data.statusRecebimento;
                        
                        // Preparar os dados atualizados da renda
                        const rendaAtualizada = {
                            ...data,
                            dataAtualizacao: serverTimestamp()
                        };
                        
                        // Atualiza a renda no Firestore
                        await updateDoc(rendaRef, rendaAtualizada);
                        
                        // Ajustar saldo do banco conforme necessário
                        if (data.statusRecebimento === 'recebido') {
                            // Se o status mudou de aguardando para recebido
                            if (mudouStatus && data.bancoId) {
                                await atualizarSaldoBanco(data.bancoId, valorNovo, true);
                            } 
                            // Se o banco mudou, mas já era recebido
                            else if (mudouBanco) {
                                // Remove do banco antigo
                                if (renda.bancoId) {
                                    await atualizarSaldoBanco(renda.bancoId, valorAntigo, false);
                                }
                                
                                // Adiciona ao novo banco
                                if (data.bancoId) {
                                    await atualizarSaldoBanco(data.bancoId, valorNovo, true);
                                }
                            }
                            // Se o valor mudou, mas o banco é o mesmo
                            else if (diferencaValor !== 0 && data.bancoId && !mudouBanco) {
                                await atualizarSaldoBanco(data.bancoId, Math.abs(diferencaValor), diferencaValor > 0);
                            }
                        } 
                        // Se o status mudou de recebido para aguardando
                        else if (mudouStatus && renda.bancoId) {
                            await atualizarSaldoBanco(renda.bancoId, valorAntigo, false);
                        }
                        
                        showNotification('Renda atualizada com sucesso!', 'success');
                        closeModal();
                    } catch (error) {
                        console.error('Erro ao atualizar renda:', error);
                        showNotification('Erro ao atualizar renda.', 'error');
                        
                        // Reabilita o botão em caso de erro
                        const submitBtn = document.getElementById('renda-submit-btn');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = 'Atualizar';
                        }
                    }
                });
                
                // Carregar categorias personalizadas
                const categoriasSelect = document.getElementById('renda-categoria');
                await carregarCategoriasPerssonalizadasRendas(categoriasSelect);
                
                // Carregar bancos se for renda recebida
                if (renda.statusRecebimento === 'recebido') {
                    const bancosRef = collection(db, 'users', currentUser.uid, 'bancos');
                    const bancosSnap = await getDocs(bancosRef);
                    const bancoSelect = document.getElementById('renda-banco');
                    bancoSelect.innerHTML = '<option value="">Selecione um banco</option>';
                    
                    if (bancosSnap.empty) {
                        bancoSelect.innerHTML += '<option value="" disabled>Nenhum banco cadastrado</option>';
                    } else {
                        bancosSnap.forEach(doc => {
                            const banco = doc.data();
                            const selected = renda.bancoId === doc.id ? 'selected' : '';
                            bancoSelect.innerHTML += `<option value="${doc.id}" ${selected}>${banco.nome} - Ag: ${banco.agencia} Conta: ${banco.conta}</option>`;
                        });
                    }
                }
                
                // Botão para gerenciar categorias
                document.getElementById('btn-gerenciar-categorias-renda-edit').addEventListener('click', () => {
                    abrirGerenciadorCategoriasRendas();
                });
                
                // Controla campos de recebimento
                const rendaStatus = document.getElementById('renda-status');
                const recebimentoFields = document.getElementById('recebimento-fields');
                
                rendaStatus.addEventListener('change', async (e) => {
                    recebimentoFields.style.display = e.target.value === 'recebido' ? 'block' : 'none';
                    
                    // Se marcou como recebido, já preenche a data de recebimento com a data atual
                    if (e.target.value === 'recebido') {
                        const hoje = new Date().toISOString().split('T')[0];
                        document.getElementById('renda-data-recebimento').value = hoje || renda.dataRecebimento || '';
                        
                        // Carrega os bancos do usuário
                        const bancosRef = collection(db, 'users', currentUser.uid, 'bancos');
                        const bancosSnap = await getDocs(bancosRef);
                        const bancoSelect = document.getElementById('renda-banco');
                        bancoSelect.innerHTML = '<option value="">Selecione um banco</option>';
                        
                        if (bancosSnap.empty) {
                            bancoSelect.innerHTML += '<option value="" disabled>Nenhum banco cadastrado</option>';
                        } else {
                            bancosSnap.forEach(doc => {
                                const banco = doc.data();
                                const selected = renda.bancoId === doc.id ? 'selected' : '';
                                bancoSelect.innerHTML += `<option value="${doc.id}" ${selected}>${banco.nome} - Ag: ${banco.agencia} Conta: ${banco.conta}</option>`;
                            });
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao abrir edição de renda:', error);
                showNotification('Erro ao carregar dados da renda.', 'error');
            }
        }

        /**
         * Atualiza o saldo de um banco após o recebimento de uma renda
         * @param {string} bancoId - ID do banco
         * @param {number} valor - Valor da renda
         * @param {boolean} adicionar - Se true, adiciona ao saldo; se false, subtrai do saldo
         */
        async function atualizarSaldoBanco(bancoId, valor, adicionar = true) {
            if (!bancoId || isNaN(valor)) return;
            
            const bancoRef = firestoreDoc(db, 'users', currentUser.uid, 'bancos', bancoId);
            
            await runTransaction(db, async (transaction) => {
                const bancoSnap = await transaction.get(bancoRef);
                if (bancoSnap.exists()) {
                    const saldoAtual = parseFloat(bancoSnap.data().saldo);
                    const novoSaldo = adicionar ? saldoAtual + valor : saldoAtual - valor;
                    transaction.update(bancoRef, { saldo: novoSaldo });
                }
            });
        }
        
        /**
         * Abre o modal para registrar o recebimento de uma renda
         * @param {string} rendaId - ID da renda
         */
        async function abrirModalRecebimento(rendaId) {
            try {
                const rendaRef = firestoreDoc(db, 'users', currentUser.uid, 'rendas', rendaId);
                const rendaSnap = await getDoc(rendaRef);
                
                if (!rendaSnap.exists()) {
                    showNotification('Erro: Renda não encontrada.', 'error');
                    return;
                }
                
                const renda = rendaSnap.data();
                
                // Abre modal para registrar o recebimento
                const formHtml = `
                    <form id="recebimento-form">
                        <p>Registrar recebimento para: <strong>${renda.descricao}</strong></p>
                        <p>Valor: <strong>R$ ${parseFloat(renda.valor).toFixed(2)}</strong></p>
                        
                        <div class="form-group">
                            <label for="recebimento-data">Data de Recebimento</label>
                            <input type="date" id="recebimento-data" name="dataRecebimento" value="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="recebimento-metodo">Método de Recebimento</label>
                            <select id="recebimento-metodo" name="metodoRecebimento" required>
                                <option value="">Selecione o método</option>
                                <option value="Pix">Pix</option>
                                <option value="Transferência">Transferência</option>
                                <option value="Depósito">Depósito</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        
                        <div id="banco-destino-container" class="form-group">
                            <label for="recebimento-banco">
                                <span style="display: flex; align-items: center; gap: 5px;">
                                    <span>Banco de Destino</span>
                                    <span class="tooltip" style="position: relative; cursor: help;">
                                        <i class="fas fa-info-circle" style="color: var(--primary-color);"></i>
                                        <span class="tooltiptext" style="position: absolute; width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px; z-index: 1; bottom: 125%; left: 50%; margin-left: -125px; visibility: hidden; opacity: 0; transition: opacity 0.3s;">
                                            Ao selecionar um banco, o valor será automaticamente adicionado ao saldo.
                                        </span>
                                    </span>
                                </span>
                            </label>
                            <select id="recebimento-banco" name="bancoId">
                                <option value="">Selecione um banco</option>
                                <!-- Será preenchido dinamicamente -->
                            </select>
                            <div id="banco-saldo-atual" style="margin-top: 5px; font-size: 0.85rem; color: var(--subtle-text-color);"></div>
                            <div id="banco-saldo-apos" style="margin-top: 2px; font-size: 0.85rem; color: var(--secondary-color); display: none;">
                                <i class="fas fa-arrow-right"></i> Saldo após recebimento: <strong></strong>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="recebimento-obs">Observações (opcional)</label>
                            <textarea id="recebimento-obs" name="observacao" rows="2">${renda.observacao || ''}</textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Registrar Recebimento</button>
                    </form>
                `;
                
                // Carrega os bancos antes de abrir o modal
                const bancosRef = collection(db, 'users', currentUser.uid, 'bancos');
                const bancosSnap = await getDocs(bancosRef);
                
                // Armazena os dados dos bancos para uso posterior
                const bancos = {};
                
                // Preenche as opções do select com os bancos
                let bancosOptions = '<option value="">Selecione um banco</option>';
                
                if (bancosSnap.empty) {
                    bancosOptions += '<option value="" disabled>Nenhum banco cadastrado</option>';
                } else {
                    bancosSnap.forEach(doc => {
                        const banco = doc.data();
                        bancos[doc.id] = banco;
                        bancosOptions += `<option value="${doc.id}">${banco.nome} - Ag: ${banco.agencia} Conta: ${banco.conta}</option>`;
                    });
                }
                
                // Atualiza o HTML do formulário para incluir as opções de banco
                const formHtmlComBancos = formHtml.replace('<!-- Será preenchido dinamicamente -->', bancosOptions);
                
                openModal('Registrar Recebimento', formHtmlComBancos, async (data) => {
                    try {
                        // Inicializa tooltips
                        initializeTooltips();
                        
                        // Adiciona evento para mostrar o saldo atual do banco e a simulação após recebimento
                        const bancoSelect = document.getElementById('recebimento-banco');
                        bancoSelect.addEventListener('change', function() {
                            const bancoId = this.value;
                            const saldoAtualEl = document.getElementById('banco-saldo-atual');
                            const saldoAposEl = document.getElementById('banco-saldo-apos');
                            
                            if (bancoId && bancos[bancoId]) {
                                const saldoAtual = parseFloat(bancos[bancoId].saldo);
                                const valorRenda = parseFloat(renda.valor);
                                const saldoApos = saldoAtual + valorRenda;
                                
                                saldoAtualEl.textContent = `Saldo atual: R$ ${saldoAtual.toFixed(2)}`;
                                saldoAposEl.querySelector('strong').textContent = `R$ ${saldoApos.toFixed(2)}`;
                                saldoAposEl.style.display = 'block';
                            } else {
                                saldoAtualEl.textContent = '';
                                saldoAposEl.style.display = 'none';
                            }
                        });
                        
                        // Atualiza a renda
                        await updateDoc(rendaRef, {
                            statusRecebimento: 'recebido',
                            dataRecebimento: data.dataRecebimento,
                            metodoRecebimento: data.metodoRecebimento,
                            bancoId: data.bancoId || null,
                            observacao: data.observacao || renda.observacao,
                            dataAtualizacao: serverTimestamp()
                        });
                        
                        // Se tem banco associado, atualiza o saldo
                        if (data.bancoId) {
                            await atualizarSaldoBanco(data.bancoId, parseFloat(renda.valor), true);
                            showNotification(`Recebimento registrado e saldo do banco ${bancos[data.bancoId].nome} atualizado!`, 'success');
                        } else {
                            showNotification('Recebimento registrado com sucesso!', 'success');
                        }
                        
                        closeModal();
                        
                        // Recarregar os dados se estiver no dashboard
                        if (window.location.hash === '#dashboard') {
                            loadDashboardData();
                }
            } catch (error) {
                        console.error('Erro ao registrar recebimento:', error);
                        showNotification('Erro ao registrar recebimento.', 'error');
                    }
                });
            } catch (error) {
                console.error('Erro ao processar renda:', error);
                showNotification('Erro ao processar operação.', 'error');
            }
        }
        
        /**
         * Abre o modal para registrar o pagamento de um gasto
         * @param {string} gastoId - ID do gasto
         */
        async function abrirModalPagamento(gastoId) {
            try {
                const gastoRef = firestoreDoc(db, 'users', currentUser.uid, 'gastos', gastoId);
                const gastoSnap = await getDoc(gastoRef);
                
                if (!gastoSnap.exists()) {
                    showNotification('Erro: Gasto não encontrado.', 'error');
                    return;
                }
                
                const gasto = gastoSnap.data();
                
                // Abre modal para registrar o pagamento
                const formHtml = `
                    <form id="pagamento-form">
                        <p>Registrar pagamento para: <strong>${gasto.descricao}</strong></p>
                        <p>Valor: <strong>R$ ${parseFloat(gasto.valor).toFixed(2)}</strong></p>
                        
                        <div class="form-group">
                            <label for="pagamento-data">Data de Pagamento</label>
                            <input type="date" id="pagamento-data" name="dataPagamento" value="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="pagamento-metodo">Método de Pagamento</label>
                            <select id="pagamento-metodo" name="metodoPagamento" required>
                                <option value="">Selecione o método</option>
                                <option value="Dinheiro">Dinheiro</option>
                                <option value="Pix">Pix</option>
                                <option value="Transferência">Transferência</option>
                                <option value="Cartão de Débito">Cartão de Débito</option>
                                <option value="Cartão de Crédito">Cartão de Crédito</option>
                                <option value="Boleto">Boleto</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        
                        <div id="banco-origem-container" class="form-group" style="display: none;">
                            <label for="pagamento-banco">
                                <span style="display: flex; align-items: center; gap: 5px;">
                                    <span>Banco de Origem</span>
                                    <span class="tooltip" style="position: relative; cursor: help;">
                                        <i class="fas fa-info-circle" style="color: var(--primary-color);"></i>
                                        <span class="tooltiptext" style="position: absolute; width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px; z-index: 1; bottom: 125%; left: 50%; margin-left: -125px; visibility: hidden; opacity: 0; transition: opacity 0.3s;">
                                            Ao selecionar um banco, o valor será automaticamente deduzido do saldo.
                                        </span>
                                    </span>
                                </span>
                            </label>
                            <select id="pagamento-banco" name="bancoId">
                                <option value="">Selecione um banco</option>
                                <!-- Será preenchido dinamicamente -->
                            </select>
                            <div id="banco-saldo-atual" style="margin-top: 5px; font-size: 0.85rem; color: var(--subtle-text-color);"></div>
                            <div id="banco-saldo-apos" style="margin-top: 2px; font-size: 0.85rem; color: var(--danger-color); display: none;">
                                <i class="fas fa-arrow-right"></i> Saldo após pagamento: <strong></strong>
                            </div>
                        </div>
                        
                        <div id="cartao-container" class="form-group" style="display: none;">
                            <label for="pagamento-cartao">Cartão</label>
                            <select id="pagamento-cartao" name="cartaoId">
                                <option value="">Selecione um cartão</option>
                                <!-- Será preenchido dinamicamente -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="pagamento-obs">Observações (opcional)</label>
                            <textarea id="pagamento-obs" name="observacao" rows="2">${gasto.observacao || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="pagamento-comprovante">Comprovante de Pagamento (opcional)</label>
                            <input type="file" id="pagamento-comprovante" name="comprovante" accept="image/*">
                            <small style="display: block; margin-top: 0.5rem; color: var(--subtle-text-color);">
                                Aceita imagens até 5MB
                            </small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Registrar Pagamento</button>
                    </form>
                `;
                
                // Carrega os bancos e cartões antes de abrir o modal
                const bancosRef = collection(db, 'users', currentUser.uid, 'bancos');
                const bancosSnap = await getDocs(bancosRef);
                
                const cartoesRef = collection(db, 'users', currentUser.uid, 'cartoes');
                const cartoesSnap = await getDocs(cartoesRef);
                
                // Armazena os dados dos bancos e cartões para uso posterior
                const bancos = {};
                const cartoes = {};
                
                // Preenche as opções do select com os bancos
                let bancosOptions = '<option value="">Selecione um banco</option>';
                
                if (bancosSnap.empty) {
                    bancosOptions += '<option value="" disabled>Nenhum banco cadastrado</option>';
                } else {
                    bancosSnap.forEach(doc => {
                        const banco = doc.data();
                        bancos[doc.id] = banco;
                        bancosOptions += `<option value="${doc.id}">${banco.nome} - Ag: ${banco.agencia} Conta: ${banco.conta}</option>`;
                    });
                }
                
                // Preenche as opções do select com os cartões
                let cartoesOptions = '<option value="">Selecione um cartão</option>';
                
                if (cartoesSnap.empty) {
                    cartoesOptions += '<option value="" disabled>Nenhum cartão cadastrado</option>';
                } else {
                    cartoesSnap.forEach(doc => {
                        const cartao = doc.data();
                        cartoes[doc.id] = cartao;
                        cartoesOptions += `<option value="${doc.id}">${cartao.nome} (final ${cartao.final})</option>`;
                    });
                }
                
                // Atualiza o HTML do formulário para incluir as opções de banco e cartão
                let formHtmlAtualizado = formHtml.replace('<!-- Será preenchido dinamicamente -->', bancosOptions);
                formHtmlAtualizado = formHtmlAtualizado.replace('<!-- Será preenchido dinamicamente -->', cartoesOptions);
                
                openModal(
                    'Registrar Pagamento', 
                    formHtmlAtualizado, 
                    // Setup callback - executa quando o modal é aberto e o conteúdo é inserido no DOM
                    () => {
                        try {
                            // Inicializa tooltips
                            initializeTooltips();
                            
                            // Inicializa os campos de método de pagamento e seus containers
                            const metodoSelect = document.getElementById('pagamento-metodo');
                            const bancoContainer = document.getElementById('banco-origem-container');
                            const cartaoContainer = document.getElementById('cartao-container');
                            
                            if (!metodoSelect || !bancoContainer || !cartaoContainer) {
                                console.error('Elementos não encontrados:', { 
                                    metodoSelect: !!metodoSelect, 
                                    bancoContainer: !!bancoContainer, 
                                    cartaoContainer: !!cartaoContainer 
                                });
                                return;
                            }
                            
                            console.log('Inicializando modal de pagamento');
                            console.log('Método atual:', metodoSelect.value);
                            
                            // Função para atualizar a exibição com base no método selecionado
                            function atualizarCamposMetodo(metodo) {
                                console.log('Atualizando campos para método:', metodo);
                                // Mostra o campo de banco para métodos que usam banco
                                if (['Pix', 'Transferência', 'Cartão de Débito'].includes(metodo)) {
                                    bancoContainer.style.display = 'block';
                                    cartaoContainer.style.display = 'none';
                                    console.log('Mostrando banco, escondendo cartão');
                                } 
                                // Mostra o campo de cartão para cartão de crédito
                                else if (metodo === 'Cartão de Crédito') {
                                    bancoContainer.style.display = 'none';
                                    cartaoContainer.style.display = 'block';
                                    console.log('Escondendo banco, mostrando cartão');
                                } 
                                // Esconde ambos para outros métodos
                                else {
                                    bancoContainer.style.display = 'none';
                                    cartaoContainer.style.display = 'none';
                                    console.log('Escondendo banco e cartão');
                                }
                            }
                            
                            // Adiciona o evento de mudança
                            metodoSelect.addEventListener('change', function() {
                                const metodo = this.value;
                                console.log('Método alterado para:', metodo);
                                atualizarCamposMetodo(metodo);
                            });
                            
                            // Verifica o valor inicial e configura a interface apropriada
                            // Usamos timeout para garantir que o DOM está totalmente renderizado
                            setTimeout(() => {
                                const metodoAtual = metodoSelect.value;
                                console.log('Aplicando método inicial:', metodoAtual);
                                atualizarCamposMetodo(metodoAtual);
                                
                                // Se não tem um valor selecionado, verifica novamente em 300ms
                                // Isso é necessário pois às vezes o valor não é carregado imediatamente
                                if (!metodoAtual) {
                                    setTimeout(() => {
                                        const metodoAtualizado = metodoSelect.value;
                                        console.log('Verificação adicional - método:', metodoAtualizado);
                                        atualizarCamposMetodo(metodoAtualizado);
                                    }, 300);
                                }
                            }, 50);
                            
                            // Adiciona evento para mostrar o saldo atual do banco e a simulação após pagamento
                            const bancoSelect = document.getElementById('pagamento-banco');
                            if (bancoSelect) {
                                bancoSelect.addEventListener('change', function() {
                                    const bancoId = this.value;
                                    const saldoAtualEl = document.getElementById('banco-saldo-atual');
                                    const saldoAposEl = document.getElementById('banco-saldo-apos');
                                    
                                    if (bancoId && bancos[bancoId]) {
                                        const saldoAtual = parseFloat(bancos[bancoId].saldo);
                                        const valorGasto = parseFloat(gasto.valor);
                                        const saldoApos = saldoAtual - valorGasto;
                                        
                                        saldoAtualEl.textContent = `Saldo atual: R$ ${saldoAtual.toFixed(2)}`;
                                        saldoAposEl.querySelector('strong').textContent = `R$ ${saldoApos.toFixed(2)}`;
                                        saldoAposEl.style.display = 'block';
                                    } else {
                                        saldoAtualEl.textContent = '';
                                        saldoAposEl.style.display = 'none';
                                    }
                                });
                            }
                        } catch (error) {
                            console.error('Erro ao configurar modal:', error);
                        }
                    },
                    // Submit callback - executa quando o formulário é enviado
                    async (data) => {
                    try {
                        // Upload do comprovante se existir
                        const comprovanteFile = document.getElementById('pagamento-comprovante').files[0];
                        let comprovanteURL = null;
                        
                        if (comprovanteFile) {
                            if (comprovanteFile.size > 5 * 1024 * 1024) { // 5MB
                                throw new Error('O arquivo é muito grande. O tamanho máximo é 5MB.');
                            }
                            
                            const base64Original = await fileToBase64(comprovanteFile);
                            const { base64, redimensionada } = await verificarTamanhoBase64(base64Original, 1);
                            comprovanteURL = base64;
                            
                            if (redimensionada) {
                                showNotification('A imagem foi redimensionada para economizar espaço.', 'info');
                            }
                        }
                        
                        // Atualiza o gasto
                        const updateData = {
                            pago: true,
                            dataPagamento: data.dataPagamento,
                            metodoPagamento: data.metodoPagamento,
                            observacao: data.observacao || gasto.observacao,
                            dataAtualizacao: serverTimestamp()
                        };
                        
                        // Adiciona comprovante se existir
                        if (comprovanteURL) {
                            updateData.comprovantePagamento = comprovanteURL;
                        }
                        
                        // Adiciona bancoId ou cartaoId se fornecidos
                        if (['Pix', 'Transferência', 'Cartão de Débito'].includes(data.metodoPagamento) && data.bancoId) {
                            updateData.bancoId = data.bancoId;
                        } else if (data.metodoPagamento === 'Cartão de Crédito' && data.cartaoId) {
                            updateData.cartaoId = data.cartaoId;
                        }
                        
                        await updateDoc(gastoRef, updateData);
                        
                        // Se tem banco associado, atualiza o saldo
                        if (['Pix', 'Transferência', 'Cartão de Débito'].includes(data.metodoPagamento) && data.bancoId) {
                            try {
                                await atualizarSaldoBanco(data.bancoId, parseFloat(gasto.valor), false);
                                console.log(`Saldo bancário atualizado para gasto via ${data.metodoPagamento}: -R$ ${gasto.valor}`);
                                showNotification(`Pagamento registrado e saldo do banco ${bancos[data.bancoId].nome} atualizado!`, 'success');
                            } catch (error) {
                                console.error('Erro ao atualizar saldo bancário:', error);
                                showNotification(`Pagamento registrado, mas ocorreu um erro ao atualizar o saldo bancário: ${error.message}`, 'error');
                            }
                        } 
                        // Se tem cartão associado, atualiza a fatura
                        else if (data.metodoPagamento === 'Cartão de Crédito' && data.cartaoId) {
                            await sincronizarGastoComCartaoOuBanco({...gasto, ...updateData}, gastoId);
                            showNotification(`Pagamento registrado e fatura do cartão ${cartoes[data.cartaoId].nome} atualizada!`, 'success');
                        } else {
                            showNotification('Pagamento registrado com sucesso!', 'success');
                        }
                        
                        // Recarregar os dados se estiver no dashboard
                        if (window.location.hash === '#dashboard') {
                            loadDashboardData();
                        }
                    } catch (error) {
                        console.error('Erro ao registrar pagamento:', error);
                        showNotification('Erro ao registrar pagamento.', 'error');
                    }
                });
            } catch (error) {
                console.error('Erro ao processar gasto:', error);
                showNotification('Erro ao processar operação.', 'error');
            }
        }

        async function loadFaturaAtual(cartaoId, mes = new Date()) {
            try {
                // Obter referência da fatura baseada no mês atual
                const mesFormatado = String(mes.getMonth() + 1).padStart(2, '0');
                const anoFormatado = mes.getFullYear();
                const faturaId = `${anoFormatado}-${mesFormatado}`;
                
                const faturaRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', cartaoId, 'faturas', faturaId);
                const faturaSnap = await getDoc(faturaRef);
                
                let totalFatura = 0;
                let somaLancamentos = 0; // Nova variável para calcular a soma real dos lançamentos
                const tableBody = document.getElementById('fatura-table-body');
                tableBody.innerHTML = '';
                
                // Se a fatura não existe ou não tem gastos
                if (!faturaSnap.exists() || !faturaSnap.data().gastos || Object.keys(faturaSnap.data().gastos).length === 0) {
                    document.getElementById('fatura-vazia').style.display = 'block';
                    document.getElementById('cartao-detalhe-valor-fatura').textContent = 'R$ 0,00';
                    document.getElementById('cartao-detalhe-total-fatura').textContent = 'R$ 0,00';
                    
                    // Limpa o status da fatura
                    const statusElement = document.getElementById('cartao-detalhe-status-fatura');
                    if (statusElement) {
                        statusElement.textContent = '';
                    }
                    
                    // Esconde o botão de pagar fatura
                    document.getElementById('btn-pagar-fatura').style.display = 'none';
                    
                    // Busca o cartão para atualizar o limite disponível
                    const cartaoRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', cartaoId);
                    const cartaoSnap = await getDoc(cartaoRef);
                    if (cartaoSnap.exists()) {
                        const cartao = cartaoSnap.data();
                        
                        // Buscar todos os gastos parcelados futuros deste cartão
                        const gastosRef = collection(db, 'users', currentUser.uid, 'gastos');
                        const q = query(
                            gastosRef, 
                            where("cartaoId", "==", cartaoId),
                            where("metodoPagamento", "==", "Cartão de Crédito")
                        );
                        const gastosSnap = await getDocs(q);
                        
                        // Calcular o valor total de todas as parcelas futuras
                        let totalParcelasFuturas = 0;
                        
                        // Obter o mês e ano da fatura atual
                        const dataFaturaAtual = mes;
                        const mesFaturaAtual = dataFaturaAtual.getMonth();
                        const anoFaturaAtual = dataFaturaAtual.getFullYear();
                        
                        gastosSnap.forEach(doc => {
                            const gasto = doc.data();
                            const dataGasto = new Date(gasto.data);
                            const mesGasto = dataGasto.getMonth();
                            const anoGasto = dataGasto.getFullYear();
                            
                            // Verificar se o gasto está em uma fatura futura (mês posterior ao atual)
                            const ehFaturaFutura = 
                                (anoGasto > anoFaturaAtual) || 
                                (anoGasto === anoFaturaAtual && mesGasto > mesFaturaAtual);
                            
                            // Adicionar apenas se for uma parcela futura
                            if (ehFaturaFutura) {
                                totalParcelasFuturas += parseFloat(gasto.valor);
                            }
                        });
                        
                        // Calcular o limite disponível considerando parcelas futuras
                        const limiteDisponivel = parseFloat(cartao.limite) - totalParcelasFuturas;
                        document.getElementById('cartao-detalhe-limite-disponivel').textContent = `R$ ${limiteDisponivel.toFixed(2)}`;
                        
                        // Adicionar informação sobre parcelas futuras
                        if (totalParcelasFuturas > 0) {
                            const infoElement = document.createElement('small');
                            infoElement.style.display = 'block';
                            infoElement.style.marginTop = '5px';
                            infoElement.style.fontSize = '0.8rem';
                            infoElement.style.color = 'var(--subtle-text-color)';
                            infoElement.textContent = `(Inclui R$ ${totalParcelasFuturas.toFixed(2)} em parcelas futuras)`;
                            
                            const limiteElement = document.getElementById('cartao-detalhe-limite-disponivel');
                            if (limiteElement.nextElementSibling && limiteElement.nextElementSibling.tagName === 'SMALL') {
                                limiteElement.nextElementSibling.remove();
                            }
                            limiteElement.parentNode.appendChild(infoElement);
                        }
                    }
                    return;
                }
                
                document.getElementById('fatura-vazia').style.display = 'none';
                
                // Se a fatura existe, buscamos os gastos associados a ela
                const faturaData = faturaSnap.data();
                totalFatura = parseFloat(faturaData.valorTotal || 0);
                
                // Recuperar os gastos associados a esta fatura
                if (faturaData.gastos) {
                    const gastosIds = Object.keys(faturaData.gastos);
                    
                    // Buscar detalhes dos gastos
                    for (const gastoId of gastosIds) {
                        try {
                            const gastoRef = firestoreDoc(db, 'users', currentUser.uid, 'gastos', gastoId);
                            const gastoSnap = await getDoc(gastoRef);
                            
                            if (gastoSnap.exists()) {
                                const gasto = gastoSnap.data();
                                const valorGasto = parseFloat(gasto.valor);
                                somaLancamentos += valorGasto; // Somar ao total de lançamentos
                                
                                const row = document.createElement('tr');
                                // Determinar a informação de parcelas
                                let parcelasInfo = "1/1"; // Padrão para compras à vista
                                if (gasto.parcela) {
                                    parcelasInfo = gasto.parcela; // Usa o formato já existente (ex: "2/12")
                                } else if (gasto.numeroParcela && gasto.totalParcelas) {
                                    parcelasInfo = `${gasto.numeroParcela}/${gasto.totalParcelas}`;
                                }
                                
                                row.innerHTML = `
                                    <td>${new Date(gasto.data).toLocaleDateString()}</td>
                                    <td>${gasto.descricao}</td>
                                    <td>${gasto.categoria}</td>
                                    <td>${parcelasInfo}</td>
                                    <td>R$ ${valorGasto.toFixed(2)}</td>
                                    <td class="actions">
                                        <button class="edit-btn" data-id="${gastoId}" title="Editar"><i class="fas fa-edit"></i></button>
                                        <button class="delete-btn" data-id="${gastoId}" title="Excluir"><i class="fas fa-trash"></i></button>
                                    </td>
                                `;
                                tableBody.appendChild(row);
                            }
                        } catch (error) {
                            console.error(`Erro ao buscar gasto ${gastoId}:`, error);
                        }
                    }
                }
                
                // Verificar se há discrepância entre o valor total armazenado e o calculado
                if (Math.abs(totalFatura - somaLancamentos) > 0.01) { // Tolerância de 1 centavo para erros de arredondamento
                    console.warn(`Discrepância detectada na fatura ${faturaId}: Valor armazenado R$ ${totalFatura.toFixed(2)} vs. Soma dos lançamentos R$ ${somaLancamentos.toFixed(2)}`);
                    
                    // Corrigir o valor total da fatura no Firestore
                    await updateDoc(faturaRef, { valorTotal: somaLancamentos });
                    totalFatura = somaLancamentos; // Usar o valor recalculado
                    
                    showNotification('O valor da fatura foi recalculado e corrigido.', 'info');
                }
                
                // Atualiza o valor total da fatura
                document.getElementById('cartao-detalhe-valor-fatura').textContent = `R$ ${totalFatura.toFixed(2)}`;
                document.getElementById('cartao-detalhe-total-fatura').textContent = `R$ ${totalFatura.toFixed(2)}`;
                
                // Exibe o status da fatura
                const statusFatura = faturaData.pago === true || faturaData.status === "Paga" ? "Paga" : "Pendente";
                const statusElement = document.getElementById('cartao-detalhe-status-fatura');
                if (statusElement) {
                    statusElement.textContent = statusFatura;
                    statusElement.style.color = statusFatura === "Paga" ? "var(--success-color)" : "var(--primary-color)";
                } else {
                    // Cria o elemento de status se não existir
                    const valorFaturaElement = document.getElementById('cartao-detalhe-valor-fatura');
                    const statusSpan = document.createElement('span');
                    statusSpan.id = 'cartao-detalhe-status-fatura';
                    statusSpan.textContent = statusFatura;
                    statusSpan.style.color = statusFatura === "Paga" ? "var(--success-color)" : "var(--primary-color)";
                    statusSpan.style.marginLeft = '10px';
                    statusSpan.style.fontWeight = 'bold';
                    valorFaturaElement.parentNode.appendChild(statusSpan);
                }
                
                // Atualiza a visibilidade do botão de pagar fatura
                const btnPagarFatura = document.getElementById('btn-pagar-fatura');
                if (statusFatura === "Paga") {
                    btnPagarFatura.style.display = 'none';
                    
                    // Adiciona botão para visualizar comprovante se existir
                    const comprovanteBtnContainer = document.getElementById('comprovante-fatura-container');
                    if (comprovanteBtnContainer) {
                        comprovanteBtnContainer.remove(); // Remove o container existente se houver
                    }
                    
                    if (faturaData.comprovantePagamento) {
                        const container = document.createElement('div');
                        container.id = 'comprovante-fatura-container';
                        container.style.marginTop = '10px';
                        container.innerHTML = `
                            <button class="btn btn-sm view-btn" style="background-color: var(--light-bg-color); color: var(--text-color);"
                                    data-comprovante="${faturaData.comprovantePagamento}">
                                <i class="fas fa-receipt"></i> Ver Comprovante
                            </button>
                        `;
                        
                        // Encontrar um elemento pai adequado para inserir o botão
                        const valorFaturaElement = document.getElementById('cartao-detalhe-valor-fatura');
                        if (valorFaturaElement && valorFaturaElement.parentNode) {
                            valorFaturaElement.parentNode.appendChild(container);
                            
                            // Adicionar evento de clique para visualizar comprovante
                            container.querySelector('.view-btn').addEventListener('click', function() {
                                const comprovanteURL = this.dataset.comprovante;
                                if (comprovanteURL && typeof visualizarComprovante === 'function') {
                                    visualizarComprovante(comprovanteURL);
                                } else {
                                    console.error('URL do comprovante não encontrada ou função visualizarComprovante não está disponível');
                                }
                            });
                        } else {
                            console.error('Elemento pai para o botão de comprovante não encontrado');
                        }
                    }
                } else {
                    btnPagarFatura.style.display = 'inline-block';
                    
                    // Remove o botão de comprovante se existir
                    const comprovanteBtnContainer = document.getElementById('comprovante-fatura-container');
                    if (comprovanteBtnContainer) {
                        comprovanteBtnContainer.remove();
                    } else {
                        console.log('Botão de comprovante não encontrado para remoção');
                    }
                }
                
                // Calcula e atualiza o limite disponível considerando todas as parcelas futuras
                const cartaoRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', cartaoId);
                const cartaoSnap = await getDoc(cartaoRef);
                if (cartaoSnap.exists()) {
                    const cartao = cartaoSnap.data();
                    
                    // Buscar todos os gastos parcelados futuros deste cartão
                    const gastosRef = collection(db, 'users', currentUser.uid, 'gastos');
                    const q = query(
                        gastosRef, 
                        where("cartaoId", "==", cartaoId),
                        where("metodoPagamento", "==", "Cartão de Crédito")
                    );
                    const gastosSnap = await getDocs(q);
                    
                    // Calcular o valor total de todas as parcelas (atuais e futuras)
                    let totalParcelasFuturas = 0;
                    
                    // Obter o mês e ano da fatura atual
                    const dataFaturaAtual = mes;
                    const mesFaturaAtual = dataFaturaAtual.getMonth();
                    const anoFaturaAtual = dataFaturaAtual.getFullYear();
                    
                    gastosSnap.forEach(doc => {
                        const gasto = doc.data();
                        const dataGasto = new Date(gasto.data);
                        const mesGasto = dataGasto.getMonth();
                        const anoGasto = dataGasto.getFullYear();
                        
                        // Verificar se o gasto está em uma fatura futura (mês posterior ao atual)
                        const ehFaturaFutura = 
                            (anoGasto > anoFaturaAtual) || 
                            (anoGasto === anoFaturaAtual && mesGasto > mesFaturaAtual);
                        
                        // Adicionar apenas se for uma parcela futura (não incluída na fatura atual)
                        if (ehFaturaFutura) {
                            totalParcelasFuturas += parseFloat(gasto.valor);
                        }
                    });
                    
                    // Calcular o limite disponível considerando a fatura atual e parcelas futuras
                    const limiteDisponivel = parseFloat(cartao.limite) - totalFatura - totalParcelasFuturas;
                    document.getElementById('cartao-detalhe-limite-disponivel').textContent = `R$ ${limiteDisponivel.toFixed(2)}`;
                    
                    // Adicionar informação sobre parcelas futuras
                    if (totalParcelasFuturas > 0) {
                        const infoElement = document.createElement('small');
                        infoElement.style.display = 'block';
                        infoElement.style.marginTop = '5px';
                        infoElement.style.fontSize = '0.8rem';
                        infoElement.style.color = 'var(--subtle-text-color)';
                        infoElement.textContent = `(Inclui R$ ${totalParcelasFuturas.toFixed(2)} em parcelas futuras)`;
                        
                        const limiteElement = document.getElementById('cartao-detalhe-limite-disponivel');
                        if (limiteElement.nextElementSibling && limiteElement.nextElementSibling.tagName === 'SMALL') {
                            limiteElement.nextElementSibling.remove();
                        }
                        limiteElement.parentNode.appendChild(infoElement);
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar fatura:', error);
                showNotification('Erro ao carregar fatura.', 'error');
            }
        }

        function setupCartaoActions(cartaoId, cartao) {
            // Botão de editar cartão
            document.getElementById('btn-editar-cartao').onclick = () => {
                const formHtml = `
                    <form id="cartao-form">
                        <div class="form-group">
                            <label for="cartao-nome">Nome do Cartão</label>
                            <input type="text" id="cartao-nome" name="nome" value="${cartao.nome}" required>
                        </div>
                        <div class="form-group">
                            <label for="cartao-final">Final</label>
                            <input type="text" id="cartao-final" name="final" pattern="\\d*" maxlength="4" value="${cartao.final}" required>
                        </div>
                        <div class="form-group">
                            <label for="cartao-limite">Limite</label>
                            <input type="number" step="0.01" id="cartao-limite" name="limite" value="${cartao.limite}" required>
                        </div>
                        <div class="form-group">
                            <label for="cartao-vencimento">Dia do Vencimento</label>
                            <input type="number" id="cartao-vencimento" name="vencimento" min="1" max="31" value="${cartao.vencimento}" required>
                        </div>
                        <div class="form-group">
                            <label for="cartao-fechamento">Dia do Fechamento</label>
                            <input type="number" id="cartao-fechamento" name="fechamento" min="1" max="31" value="${cartao.fechamento}" required>
                        </div>
                        <div class="form-group">
                            <label for="cartao-status">Status</label>
                            <select id="cartao-status" name="status" required>
                                <option value="Ativo" ${cartao.status === 'Ativo' ? 'selected' : ''}>Ativo</option>
                                <option value="Inativo" ${cartao.status === 'Inativo' ? 'selected' : ''}>Inativo</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Atualizar</button>
                    </form>
                `;
                
                openModal('Editar Cartão', formHtml, async (data) => {
                    try {
                        const cartaoData = {
                            ...data,
                    dataAtualizacao: serverTimestamp()
                        };
                        
                        await updateDoc(firestoreDoc(db, 'users', currentUser.uid, 'cartoes', cartaoId), cartaoData);
                        showNotification('Cartão atualizado com sucesso!', 'success');
                        closeModal();
                    } catch (error) {
                        console.error('Erro ao atualizar cartão:', error);
                        showNotification('Erro ao atualizar cartão.', 'error');
                    }
                });
            };
            
            // Botão de excluir cartão
            document.getElementById('btn-excluir-cartao').onclick = async () => {
                if (confirm('Tem certeza que deseja excluir este cartão? Esta ação não pode ser desfeita.')) {
                    try {
                        // Primeiro, busca todos os gastos associados a este cartão
                        const gastosRef = collection(db, 'users', currentUser.uid, 'gastos');
                        const q = query(gastosRef, where("cartaoId", "==", cartaoId));
                        const gastosSnap = await getDocs(q);

                        // Exclui cada gasto encontrado
                        const deletePromises = [];
                        gastosSnap.forEach(gastoDoc => {
                            deletePromises.push(deleteDoc(gastoDoc.ref));
                        });
                        await Promise.all(deletePromises);
                        
                        // Agora, exclui o cartão
                        await deleteDoc(firestoreDoc(db, 'users', currentUser.uid, 'cartoes', cartaoId));
                        
                        showNotification('Cartão e todos os seus gastos foram excluídos com sucesso!', 'success');
                        document.getElementById('cartao-detalhe').style.display = 'none';
                        document.getElementById('cartao-detalhe-vazio').style.display = 'flex';
                        loadCartoesData(); // Recarrega a lista de cartões
            } catch (error) {
                        console.error('Erro ao excluir cartão e seus gastos:', error);
                        showNotification('Erro ao excluir o cartão.', 'error');
                    }
                }
            };
            
            // Botões de navegação da fatura
            let mesFatura = new Date();
            
            function atualizarMesFatura() {
                document.getElementById('cartao-detalhe-mes-fatura').textContent = 
                    mesFatura.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                loadFaturaAtual(cartaoId, mesFatura);
                
                // Atualiza o estado dos botões
                const hoje = new Date();
                const mesAtual = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                // Aumentar o limite para 12 meses à frente
                const mesLimite = new Date(hoje.getFullYear() + 1, hoje.getMonth(), 1);
                
                document.getElementById('btn-fatura-proxima').disabled = mesFatura >= mesLimite;
                document.getElementById('btn-fatura-anterior').disabled = false;
                document.getElementById('btn-fatura-atual').disabled = 
                    mesFatura.getMonth() === mesAtual.getMonth() && 
                    mesFatura.getFullYear() === mesAtual.getFullYear();
            }
            
            // Remover listeners anteriores para evitar duplicação
            const btnAnterior = document.getElementById('btn-fatura-anterior');
            const btnAtual = document.getElementById('btn-fatura-atual');
            const btnProxima = document.getElementById('btn-fatura-proxima');
            
            // Limpar eventos antigos usando cloneNode
            const newBtnAnterior = btnAnterior.cloneNode(true);
            const newBtnAtual = btnAtual.cloneNode(true);
            const newBtnProxima = btnProxima.cloneNode(true);
            
            btnAnterior.parentNode.replaceChild(newBtnAnterior, btnAnterior);
            btnAtual.parentNode.replaceChild(newBtnAtual, btnAtual);
            btnProxima.parentNode.replaceChild(newBtnProxima, btnProxima);
            
            // Adicionar novos listeners
            newBtnAnterior.onclick = () => {
                mesFatura.setMonth(mesFatura.getMonth() - 1);
                atualizarMesFatura();
            };
            
            newBtnAtual.onclick = () => {
                mesFatura = new Date();
                document.getElementById('cartao-detalhe-mes-fatura').textContent = 'atual';
                loadFaturaAtual(cartaoId);
            };
            
            newBtnProxima.onclick = () => {
                mesFatura.setMonth(mesFatura.getMonth() + 1);
                atualizarMesFatura();
            };
            
            // Configuramos apenas o texto sem recarregar a fatura
            mesFatura = new Date();
            document.getElementById('cartao-detalhe-mes-fatura').textContent = 'atual';
            
            // Botão para pagar fatura
            document.getElementById('btn-pagar-fatura').onclick = () => {
                // Formata o ID da fatura com base no mês atual
                const mesFormatado = String(mesFatura.getMonth() + 1).padStart(2, '0');
                const anoFormatado = mesFatura.getFullYear();
                const faturaId = `${anoFormatado}-${mesFormatado}`;
                
                // Obtém o valor da fatura atual
                const valorFaturaEl = document.getElementById('cartao-detalhe-valor-fatura');
                const valorFaturaTexto = valorFaturaEl.textContent.replace('R$ ', '');
                const valorFatura = parseFloat(valorFaturaTexto) || 0;
                
                if (valorFatura <= 0) {
                    showNotification('Não há valor a pagar nesta fatura.', 'info');
                    return;
                }
                
                // Chama a função para pagar a fatura
                pagarFatura(cartaoId, faturaId, valorFatura);
            };
            
            // Botão de adicionar lançamento
            document.getElementById('btn-add-lancamento').onclick = () => {
                const formHtml = `
                    <form id="lancamento-form">
                        <div class="form-group">
                            <label for="lancamento-descricao">Descrição</label>
                            <input type="text" id="lancamento-descricao" name="descricao" required>
                        </div>
                        <div class="form-group">
                            <label for="lancamento-valor">Valor (R$)</label>
                            <input type="number" step="0.01" id="lancamento-valor" name="valor" required>
                        </div>
                        <div class="form-group">
                            <label for="lancamento-data">Data</label>
                            <input type="date" id="lancamento-data" name="data" required>
                        </div>
                        <div class="form-group">
                            <label for="lancamento-categoria">Categoria</label>
                            <select id="lancamento-categoria" name="categoria" required>
                                <option value="">Selecione uma categoria</option>
                                <option value="Alimentação">Alimentação</option>
                                <option value="Transporte">Transporte</option>
                                <option value="Moradia">Moradia</option>
                                <option value="Saúde">Saúde</option>
                                <option value="Educação">Educação</option>
                                <option value="Lazer">Lazer</option>
                                <option value="Vestuário">Vestuário</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Adicionar</button>
                    </form>
                `;
                
                openModal('Novo Lançamento', formHtml, () => {
                    // Inicializa o campo de data com a data atual no fuso horário brasileiro
                    const dataFormatada = obterDataAtualBrasilFormatada();
                    const campoData = document.getElementById('lancamento-data');
                    if (campoData) campoData.value = dataFormatada;
                }, async (data) => {
                    try {
                        // Primeiro, criar um gasto normal
                        const gastoData = {
                            ...data,
                            metodoPagamento: 'Cartão de Crédito',
                            cartaoId: cartaoId,
                            dataCriacao: serverTimestamp(),
                            dataObj: converterDataParaFusoBrasil(data.data) // Adiciona a data convertida para o fuso de São Paulo
                        };
                        
                        // Adicionar o gasto à coleção de gastos
                        const gastoRef = await addDoc(collection(db, 'users', currentUser.uid, 'gastos'), gastoData);
                        
                        // Atualizar a fatura do cartão
                        const dataGasto = converterDataParaFusoBrasil(data.data);
                        let mesFatura = dataGasto.getMonth();
                        let anoFatura = dataGasto.getFullYear();
                        
                        // Busca o cartão para obter o dia de fechamento
                        const cartaoRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', cartaoId);
                        const cartaoSnap = await getDoc(cartaoRef);
                        const cartao = cartaoSnap.data();
                        
                        // Ajusta o mês da fatura baseado no dia de fechamento
                        if (dataGasto.getDate() > parseInt(cartao.fechamento)) {
                            mesFatura += 1;
                            if (mesFatura > 11) {
                                mesFatura = 0;
                                anoFatura += 1;
                            }
                        }
                        
                        const faturaId = `${anoFatura}-${String(mesFatura + 1).padStart(2, '0')}`;
                        const faturaRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', cartaoId, 'faturas', faturaId);
                        
                        await runTransaction(db, async (transaction) => {
                            const faturaSnap = await transaction.get(faturaRef);
                            const valorGasto = parseFloat(data.valor);
                            
                            if (!faturaSnap.exists()) {
                                transaction.set(faturaRef, { 
                                    valorTotal: valorGasto,
                                    dataVencimento: new Date(anoFatura, mesFatura + 1, parseInt(cartao.vencimento)),
                                    gastos: { [gastoRef.id]: valorGasto },
                                    status: "Pendente",
                                    pago: false
                                });
                            } else {
                                const faturaData = faturaSnap.data();
                                const novoValor = (faturaData.valorTotal || 0) + valorGasto;
                                const novosGastos = { ...(faturaData.gastos || {}), [gastoRef.id]: valorGasto };
                                transaction.update(faturaRef, { valorTotal: novoValor, gastos: novosGastos });
                            }
                        });
                        
                        showNotification('Lançamento adicionado com sucesso!', 'success');
                        closeModal();
                        loadFaturaAtual(cartaoId);
                    } catch (error) {
                        console.error('Erro ao adicionar lançamento:', error);
                        showNotification('Erro ao adicionar lançamento.', 'error');
                    }
                });
            };
        }

        // --- Bancos ---
        // Variável para controlar o mês atual das movimentações
        let movimentacoesMesAtual = new Date();
        
        // --- Cartões ---
        function loadCartoesData() {
            if (!currentUser) return;
            const tableBody = document.getElementById('cartoes-sidebar-list');
            const cartoesRef = collection(db, 'users', currentUser.uid, 'cartoes');
            const q = query(cartoesRef);

            cartoesUnsubscribe = onSnapshot(q, (querySnapshot) => {
                tableBody.innerHTML = '';
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<div class="cartao-sidebar-empty">Nenhum cartão cadastrado.</div>';
                    document.getElementById('cartao-detalhe').style.display = 'none';
                    document.getElementById('cartao-detalhe-vazio').style.display = 'flex';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const cartao = doc.data();
                    const row = document.createElement('div');
                    row.className = 'cartao-sidebar-item';
                    row.dataset.id = doc.id;
                    row.innerHTML = `
                        <h4>${cartao.nome}</h4>
                        <p>Final: ${cartao.final}</p>
                    `;
                    row.addEventListener('click', () => {
                        document.querySelectorAll('.cartao-sidebar-item').forEach(item => item.classList.remove('active'));
                        row.classList.add('active');
                        loadCartaoDetalhes(doc.id);
                    });
                    tableBody.appendChild(row);
                });

                // Se houver um cartão selecionado no hash, carrega ele
                const cartaoId = window.location.hash.split('#')[2];
                if (cartaoId) {
                    const cartaoItem = document.querySelector(`.cartao-sidebar-item[data-id="${cartaoId}"]`);
                    if (cartaoItem) {
                        cartaoItem.click();
                    }
                }
            });
        }

        async function loadCartaoDetalhes(cartaoId) {
            // Forçar a página a rolar para o topo para visualizar todo o conteúdo
            window.scrollTo(0, 0);
            
            try {
                const docRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', cartaoId);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const cartao = docSnap.data();
                    
                    // Mostra a área de detalhes e esconde a mensagem vazia
                    document.getElementById('cartao-detalhe').style.display = 'block';
                    document.getElementById('cartao-detalhe-vazio').style.display = 'none';
                    
                    // Atualiza os detalhes do cartão
                    document.getElementById('cartao-detalhe-nome').textContent = cartao.nome;
                    document.getElementById('cartao-detalhe-final').textContent = `Final ${cartao.final}`;
                    document.getElementById('cartao-detalhe-limite').textContent = `R$ ${parseFloat(cartao.limite).toFixed(2)}`;
                    
                    // Formata as datas de vencimento e fechamento
                    // Tratamento para garantir que vencimento e fechamento sejam números
                    const diaVencimento = parseInt(cartao.vencimento);
                    const diaFechamento = parseInt(cartao.fechamento);
                    
                    document.getElementById('cartao-detalhe-vencimento').textContent = `Dia ${diaVencimento}`;
                    document.getElementById('cartao-detalhe-fechamento').textContent = `Dia ${diaFechamento}`;
                    
                    // Atualiza o status com ícone
                    const statusEl = document.getElementById('cartao-detalhe-status');
                    statusEl.innerHTML = `
                        <i class="fas fa-${cartao.status === 'Ativo' ? 'check-circle' : 'times-circle'}"></i>
                        ${cartao.status}
                    `;
                    statusEl.style.color = cartao.status === 'Ativo' ? 'var(--secondary-color)' : 'var(--danger-color)';
                    
                    // Atualiza a bandeira do cartão
                    const bandeiraEl = document.getElementById('cartao-detalhe-bandeira');
                    bandeiraEl.innerHTML = `<i class="fab fa-cc-visa"></i>`; // Você pode adicionar lógica para outras bandeiras
                    
                    // Carrega a fatura atual
                    await loadFaturaAtual(cartaoId);
                    
                    // Configura os botões de ação
                    setupCartaoActions(cartaoId, cartao);
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes do cartão:', error);
                showNotification('Erro ao carregar detalhes do cartão.', 'error');
            }
        }
        
        // --- Bancos ---
        function loadBancosData() {
            if (!currentUser) return;
            const tableBody = document.getElementById('bancos-table-body');
            const bancosRef = collection(db, 'users', currentUser.uid, 'bancos');
            const q = query(bancosRef);
            
            const bancosLoading = document.getElementById('bancos-loading');
            const bancosEmpty = document.getElementById('bancos-empty');
            const bancosLista = document.getElementById('bancos-lista');
            const bancosCardsView = document.querySelector('.bancos-cards-view');
            
            // Mostrar estado de carregamento
            if (bancosLoading) bancosLoading.style.display = 'block';
            if (bancosEmpty) bancosEmpty.style.display = 'none';
            if (bancosLista) bancosLista.style.display = 'none';

            bancosUnsubscribe = onSnapshot(q, (querySnapshot) => {
                tableBody.innerHTML = '';
                if (bancosCardsView) bancosCardsView.innerHTML = '';
                
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Nenhum banco cadastrado.</td></tr>';
                    
                    // Esconder loading e mostrar estado vazio
                    if (bancosLoading) bancosLoading.style.display = 'none';
                    if (bancosEmpty) bancosEmpty.style.display = 'block';
                    return;
                }
                
                // Esconder loading e mostrar lista
                if (bancosLoading) bancosLoading.style.display = 'none';
                if (bancosEmpty) bancosEmpty.style.display = 'none';
                if (bancosLista) bancosLista.style.display = 'block';
                
                querySnapshot.forEach((doc) => {
                    const banco = doc.data();
                    
                    // Criar linha na tabela (visualização desktop)
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${banco.nome}</td>
                        <td>${banco.tipoConta}</td>
                        <td>${banco.agencia}</td>
                        <td>${banco.conta}</td>
                        <td>R$ ${parseFloat(banco.saldo).toFixed(2)}</td>
                        <td class="actions">
                            <button class="edit-btn" data-id="${doc.id}" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="delete-btn" data-id="${doc.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                        </td>
                    `;

                    tableBody.appendChild(row);
                    
                    // Criar card para visualização mobile
                    if (bancosCardsView) {
                        const card = document.createElement('div');
                        card.className = 'banco-card';
                        
                        // Definir ícone baseado no tipo de conta
                        let iconeBanco = 'fa-university';
                        if (banco.tipoConta === 'Conta Digital') iconeBanco = 'fa-mobile-alt';
                        else if (banco.tipoConta === 'Conta Poupança') iconeBanco = 'fa-piggy-bank';
                        
                        card.innerHTML = `
                            <div class="banco-card-header">
                                <div class="banco-card-title">
                                    <i class="fas ${iconeBanco}"></i> ${banco.nome}
                                </div>
                                <div class="banco-card-saldo">R$ ${parseFloat(banco.saldo).toFixed(2)}</div>
                            </div>
                            <div class="banco-card-info">
                                <div class="banco-card-info-item">
                                    <span class="banco-card-label">Tipo de Conta</span>
                                    <span class="banco-card-value">${banco.tipoConta}</span>
                                </div>
                                <div class="banco-card-info-item">
                                    <span class="banco-card-label">Agência</span>
                                    <span class="banco-card-value">${banco.agencia}</span>
                                </div>
                                <div class="banco-card-info-item">
                                    <span class="banco-card-label">Conta</span>
                                    <span class="banco-card-value">${banco.conta}</span>
                                </div>
                            </div>
                            <div class="banco-card-actions">
                                <button class="edit-btn" data-id="${doc.id}"><i class="fas fa-edit"></i> Editar</button>
                                <button class="delete-btn" data-id="${doc.id}"><i class="fas fa-trash"></i> Excluir</button>
                            </div>
                        `;
                        
                        bancosCardsView.appendChild(card);
                    }
                });
                
                // Carregar movimentações após carregar os bancos
                carregarMovimentacoesMes(movimentacoesMesAtual);
            });
            
            // Configurar os botões de navegação entre meses
            const btnMesAnterior = document.getElementById('btn-mes-anterior');
            const btnMesProximo = document.getElementById('btn-mes-proximo');
            const mesAtualLabel = document.getElementById('mes-atual-label');
            
            // Atualizar o label do mês atual
            atualizarLabelMes();
            
            // Adicionar eventos aos botões
            btnMesAnterior.addEventListener('click', () => {
                movimentacoesMesAtual.setMonth(movimentacoesMesAtual.getMonth() - 1);
                atualizarLabelMes();
                carregarMovimentacoesMes(movimentacoesMesAtual);
            });
            
            btnMesProximo.addEventListener('click', () => {
                movimentacoesMesAtual.setMonth(movimentacoesMesAtual.getMonth() + 1);
                atualizarLabelMes();
                carregarMovimentacoesMes(movimentacoesMesAtual);
            });
            
            // Função para atualizar o label do mês
            function atualizarLabelMes() {
                const meses = [
                    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                const mes = meses[movimentacoesMesAtual.getMonth()];
                const ano = movimentacoesMesAtual.getFullYear();
                mesAtualLabel.textContent = `${mes} de ${ano}`;
            }
            
            // Adiciona listener para os botões de ação na tabela de bancos
            tableBody.addEventListener('click', async (event) => {
                const target = event.target.closest('button');
                if (!target) return;
                
                const id = target.dataset.id;
                if (!id) return;
                
                const docRef = firestoreDoc(db, 'users', currentUser.uid, 'bancos', id);
                
                if (target.classList.contains('delete-btn')) {
                    if (confirm('Tem certeza que deseja excluir este banco?')) {
                        try {
                            const docSnap = await getDoc(docRef);
                            
                            if (docSnap.exists()) {
                                const banco = docSnap.data();
                                
                                // Verifica se há gastos associados a este banco
                                const gastosRef = collection(db, 'users', currentUser.uid, 'gastos');
                                const q = query(gastosRef, where("bancoId", "==", id));
                                const gastosSnap = await getDocs(q);
                                
                                if (!gastosSnap.empty) {
                                    if (!confirm(`Este banco possui ${gastosSnap.size} gasto(s) associado(s). Deseja excluí-lo mesmo assim? Isso não irá excluir os gastos.`)) {
                                        return;
                                    }
                                }
                                
                                // Exclui o banco
                                await deleteDoc(docRef);
                                showNotification('Banco excluído com sucesso!', 'success');
                            }
                        } catch (error) {
                            console.error('Erro ao excluir banco:', error);
                            showNotification(`Erro ao excluir banco: ${error.message}`, 'error');
                        }
                    }
                } 
                else if (target.classList.contains('edit-btn')) {
                    try {
                        const docSnap = await getDoc(docRef);
                        
                        if (docSnap.exists()) {
                            const bancoAtual = docSnap.data();
                            
                            const formHtml = `
                                <form id="banco-form">
                                    <div class="form-group">
                                        <label for="banco-nome">Nome do Banco</label>
                                        <input type="text" id="banco-nome" name="nome" value="${bancoAtual.nome}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="banco-tipo">Tipo de Conta</label>
                                        <select id="banco-tipo" name="tipoConta" required>
                                            <option value="Conta Corrente" ${bancoAtual.tipoConta === 'Conta Corrente' ? 'selected' : ''}>Conta Corrente</option>
                                            <option value="Conta Poupança" ${bancoAtual.tipoConta === 'Conta Poupança' ? 'selected' : ''}>Conta Poupança</option>
                                            <option value="Conta Salário" ${bancoAtual.tipoConta === 'Conta Salário' ? 'selected' : ''}>Conta Salário</option>
                                            <option value="Conta Digital" ${bancoAtual.tipoConta === 'Conta Digital' ? 'selected' : ''}>Conta Digital</option>
                                            <option value="Conta Conjunta" ${bancoAtual.tipoConta === 'Conta Conjunta' ? 'selected' : ''}>Conta Conjunta</option>
                                            <option value="Outra" ${bancoAtual.tipoConta === 'Outra' ? 'selected' : ''}>Outra</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="banco-agencia">Agência</label>
                                        <input type="text" id="banco-agencia" name="agencia" value="${bancoAtual.agencia}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="banco-conta">Conta</label>
                                        <input type="text" id="banco-conta" name="conta" value="${bancoAtual.conta}" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="banco-saldo">Saldo (R$)</label>
                                        <input type="number" step="0.01" id="banco-saldo" name="saldo" value="${bancoAtual.saldo}" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Atualizar</button>
                                </form>
                            `;
                            
                            openModal('Editar Banco', formHtml, async (data) => {
                                try {
                                    const bancoData = {
                                        ...data,
                            dataAtualizacao: serverTimestamp()
                                    };
                        
                                    await updateDoc(docRef, bancoData);
                                    showNotification('Banco atualizado com sucesso!', 'success');
                                    closeModal();
                    } catch (error) {
                                    console.error('Erro ao atualizar banco:', error);
                                    showNotification('Erro ao atualizar banco.', 'error');
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Erro ao carregar banco:', error);
                        showNotification('Erro ao carregar banco.', 'error');
                    }
                }
            });
        }

        // Função para carregar as movimentações do mês selecionado
        async function carregarMovimentacoesMes(data) {
            if (!currentUser) return;
            
            const movimentacoesLoading = document.getElementById('movimentacoes-loading');
            const movimentacoesEmpty = document.getElementById('movimentacoes-empty');
            const movimentacoesContent = document.getElementById('movimentacoes-content');
            const tableBody = document.getElementById('movimentacoes-table-body');
            const cardsView = document.querySelector('.movimentacoes-cards-view');
            
            // Mostrar loading e esconder outros elementos
            movimentacoesLoading.style.display = 'block';
            movimentacoesEmpty.style.display = 'none';
            movimentacoesContent.style.display = 'none';
            
            // Limpar conteúdos anteriores
            if (tableBody) tableBody.innerHTML = '';
            if (cardsView) cardsView.innerHTML = '';
            
            // Calcular o primeiro e último dia do mês
            const primeiroDia = new Date(data.getFullYear(), data.getMonth(), 1);
            const ultimoDia = new Date(data.getFullYear(), data.getMonth() + 1, 0);
            
            // Formatar as datas para consulta
            const primeiroDiaStr = primeiroDia.toISOString().split('T')[0];
            const ultimoDiaStr = ultimoDia.toISOString().split('T')[0];
            
            try {
                // Buscar todos os bancos para referência
                const bancosRef = collection(db, 'users', currentUser.uid, 'bancos');
                const bancosSnapshot = await getDocs(bancosRef);
                const bancos = {};
                bancosSnapshot.forEach(doc => {
                    bancos[doc.id] = { id: doc.id, ...doc.data() };
                });
                
                // Buscar gastos do mês que estão associados a bancos
                const gastosRef = collection(db, 'users', currentUser.uid, 'gastos');
                const gastosQuery = query(gastosRef, 
                    where("data", ">=", primeiroDiaStr),
                    where("data", "<=", ultimoDiaStr)
                );
                
                // Buscar rendas do mês que estão associadas a bancos
                const rendasRef = collection(db, 'users', currentUser.uid, 'rendas');
                const rendasQuery = query(rendasRef, 
                    where("data", ">=", primeiroDiaStr),
                    where("data", "<=", ultimoDiaStr),
                    where("statusRecebimento", "==", "recebido")
                );
                
                // Executar as consultas
                const [gastosSnapshot, rendasSnapshot] = await Promise.all([
                    getDocs(gastosQuery),
                    getDocs(rendasQuery)
                ]);
                
                // Combinar resultados em um array de movimentações
                const movimentacoes = [];
                
                // Adicionar gastos
                gastosSnapshot.forEach(doc => {
                    const gasto = doc.data();
                    if (gasto.bancoId && bancos[gasto.bancoId]) {
                        movimentacoes.push({
                            id: doc.id,
                            data: gasto.data,
                            descricao: gasto.descricao,
                            bancoId: gasto.bancoId,
                            bancoNome: bancos[gasto.bancoId].nome,
                            tipo: 'Saída',
                            valor: parseFloat(gasto.valor),
                            metodoPagamento: gasto.metodoPagamento
                        });
                    }
                });
                
                // Adicionar rendas
                rendasSnapshot.forEach(doc => {
                    const renda = doc.data();
                    if (renda.bancoId && bancos[renda.bancoId]) {
                        movimentacoes.push({
                            id: doc.id,
                            data: renda.data,
                            descricao: renda.descricao,
                            bancoId: renda.bancoId,
                            bancoNome: bancos[renda.bancoId].nome,
                            tipo: 'Entrada',
                            valor: parseFloat(renda.valor)
                        });
                    }
                });
                
                // Ordenar movimentações por data (mais recente primeiro)
                movimentacoes.sort((a, b) => new Date(b.data) - new Date(a.data));
                
                // Atualizar a tabela
                tableBody.innerHTML = '';
                
                if (movimentacoes.length === 0) {
                    movimentacoesLoading.style.display = 'none';
                    movimentacoesEmpty.style.display = 'block';
                    return;
                }
                
                // Calcular saldo acumulado para cada movimentação
                // Precisaríamos de um saldo inicial para fazer isso corretamente,
                // então vamos simplificar e mostrar apenas o valor da transação
                
                // Preencher a tabela e os cards
                movimentacoes.forEach(mov => {
                    // Criar linha para tabela (visualização desktop)
                    const row = document.createElement('tr');
                    const dataFormatada = formatarData(mov.data);
                    const valorClasse = mov.tipo === 'Entrada' ? 'valor-positivo' : 'valor-negativo';
                    
                    row.innerHTML = `
                        <td>${dataFormatada}</td>
                        <td>${mov.descricao}</td>
                        <td>${mov.bancoNome}</td>
                        <td>${mov.tipo}</td>
                        <td class="${valorClasse}">R$ ${Math.abs(mov.valor).toFixed(2)}</td>
                        <td>-</td>
                    `;
                    
                    tableBody.appendChild(row);
                    
                    // Criar card para visualização mobile
                    if (cardsView) {
                        const card = document.createElement('div');
                        card.className = 'movimentacao-card';
                        const tipoClass = mov.tipo === 'Entrada' ? 'entrada' : 'saida';
                        
                        card.innerHTML = `
                            <div class="movimentacao-card-header">
                                <div class="movimentacao-card-data">
                                    ${dataFormatada}
                                </div>
                                <div class="movimentacao-card-tipo ${tipoClass}">
                                    ${mov.tipo}
                                </div>
                            </div>
                            <div class="movimentacao-card-descricao">
                                ${mov.descricao}
                            </div>
                            <div class="movimentacao-card-info">
                                <div class="movimentacao-card-banco">
                                    ${mov.bancoNome}
                                </div>
                                <div class="movimentacao-card-valores">
                                    <div class="movimentacao-card-valor ${tipoClass}">
                                        R$ ${Math.abs(mov.valor).toFixed(2)}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        cardsView.appendChild(card);
                    }
                });
                
                // Mostrar a tabela
                movimentacoesLoading.style.display = 'none';
                movimentacoesContent.style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao carregar movimentações:', error);
                movimentacoesLoading.style.display = 'none';
                movimentacoesEmpty.style.display = 'block';
                movimentacoesEmpty.innerHTML = `
                    <i class="fas fa-exclamation-circle fa-3x" style="color: var(--danger-color);"></i>
                    <p style="margin-top: 1rem;">Erro ao carregar movimentações: ${error.message}</p>
                `;
            }
        }
        
        // Função auxiliar para obter valor das faturas não pagas
        async function carregarValorFaturasNaoPagas(mes = dashboardMesAtual) {
            if (!currentUser) return 0;
            
            // Obter o mês selecionado para filtrar as faturas
            const mesAtual = mes.getMonth() + 1;
            const anoAtual = mes.getFullYear();
            const mesFaturaAtual = `${anoAtual}-${String(mesAtual).padStart(2, '0')}`;
            
            // Buscar todos os cartões do usuário
            const cartoesRef = collection(db, 'users', currentUser.uid, 'cartoes');
            const cartoesSnapshot = await getDocs(cartoesRef);
            
            if (cartoesSnapshot.empty) {
                return 0;
            }
            
            const cartoes = [];
            cartoesSnapshot.forEach(doc => {
                cartoes.push({ id: doc.id, ...doc.data() });
            });
            
            // Buscar as faturas para cada cartão e somar valores das não pagas
            let valorFaturasNaoPagas = 0;
            
            for (const cartao of cartoes) {
                const faturaRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', cartao.id, 'faturas', mesFaturaAtual);
                const faturaSnap = await getDoc(faturaRef);
                
                if (faturaSnap.exists()) {
                    const fatura = faturaSnap.data();
                    const faturaPaga = fatura.pago === true || fatura.status === "Paga";
                    
                    if (!faturaPaga) {
                        valorFaturasNaoPagas += parseFloat(fatura.valorTotal || 0);
                    }
                }
            }
            
            return valorFaturasNaoPagas;
        }
        
        // Variável para armazenar dados progressivos entre meses
        const dadosProgressivos = {
            ultimoMesSaldo: 0,
            ultimoMesPositivo: 0,
            ultimoMesNegativo: 0,
            mesesSaldo: {}
        };
        
        // Função para atualizar o resumo progressivo
        async function atualizarResumoProgressivo(saldoAtual, recebimentosPendentes, gastosPendentes, faturasNaoPagas) {
            // Elementos do resumo progressivo
            const valorPositivoElement = document.getElementById('resumo-valor-positivo');
            const valorNegativoElement = document.getElementById('resumo-valor-negativo');
            const saldoPrevistoElement = document.getElementById('resumo-saldo-previsto');
            
            // Data do mês atual do dashboard
            const mesKey = `${dashboardMesAtual.getFullYear()}-${dashboardMesAtual.getMonth()+1}`;
            const hoje = new Date();
            const mesHoje = `${hoje.getFullYear()}-${hoje.getMonth()+1}`;
            
            // Verificar se é o mês atual ou um mês futuro/passado
            const isCurrentMonth = mesKey === mesHoje;
            const isFutureMonth = dashboardMesAtual > hoje;
            const isPastMonth = dashboardMesAtual < new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            
            // Calcular valores para o resumo
            let valorTotalPositivo = 0;
            let valorTotalNegativo = 0;
            let saldoPrevisto = 0;
            
            // Adicionar fator de variação para demonstração visual
            // Quanto mais distante do mês atual, maior a variação
            const monthsDiff = (dashboardMesAtual.getFullYear() - hoje.getFullYear()) * 12 + 
                              (dashboardMesAtual.getMonth() - hoje.getMonth());
            
            // Para mês atual, usar dados reais conforme os requisitos:
            if (isCurrentMonth) {
                // Valor Total Positivo = Saldo em bancos + Rendas Esperadas (recebimentosPendentes)
                valorTotalPositivo = saldoAtual + recebimentosPendentes;
                
                // Valor Total Negativo = Gastos pendentes + Faturas não pagas
                valorTotalNegativo = gastosPendentes + faturasNaoPagas;
                
                // Saldo Previsto = Valor Total Positivo - Valor Total Negativo
                saldoPrevisto = valorTotalPositivo - valorTotalNegativo;
                
                // Armazenar para uso nos meses futuros
                dadosProgressivos.ultimoMesSaldo = saldoPrevisto;
                dadosProgressivos.ultimoMesPositivo = valorTotalPositivo;
                dadosProgressivos.ultimoMesNegativo = valorTotalNegativo;
                dadosProgressivos.mesesSaldo[mesKey] = saldoPrevisto;
                
                console.log("Mês atual:", {
                    saldoAtual,
                    recebimentosPendentes,
                    gastosPendentes,
                    faturasNaoPagas,
                    valorTotalPositivo,
                    valorTotalNegativo,
                    saldoPrevisto
                });
            } 
            // Para meses futuros, aplicar as regras específicas para cálculos futuros
            else if (isFutureMonth) {
                // Tentar obter o saldo do mês anterior
                const mesAnterior = new Date(dashboardMesAtual);
                mesAnterior.setMonth(mesAnterior.getMonth() - 1);
                const mesAnteriorKey = `${mesAnterior.getFullYear()}-${mesAnterior.getMonth()+1}`;
                
                // Usar o saldo previsto do mês anterior como base
                const saldoMesAnterior = dadosProgressivos.mesesSaldo[mesAnteriorKey] || dadosProgressivos.ultimoMesSaldo;
                
                // Quando o saldo do mês anterior é negativo, isso representa uma dívida
                // que deve ser considerada no cálculo do próximo mês
                
                // Tratamento do saldo do mês anterior:
                // 1. Se for negativo, subtraímos das rendas esperadas
                // 2. Se for positivo, somamos às rendas esperadas
                if (saldoMesAnterior < 0) {
                    // Subtrai o saldo negativo (como valor positivo) das rendas esperadas
                    valorTotalPositivo = recebimentosPendentes - Math.abs(saldoMesAnterior);
                    // Se mesmo após a subtração ainda tivermos valor positivo, mantemos,
                    // caso contrário, definimos como zero (não podemos ter valor positivo negativo)
                    valorTotalPositivo = Math.max(0, valorTotalPositivo);
                } else {
                    // Se o saldo anterior for positivo, somamos ele às rendas esperadas
                    valorTotalPositivo = recebimentosPendentes + saldoMesAnterior;
                }
                
                // Valor Total Negativo = Gastos pendentes + Faturas não pagas
                valorTotalNegativo = gastosPendentes + faturasNaoPagas;
                
                // Saldo Previsto = Valor Total Positivo - Valor Total Negativo
                // O saldo negativo anterior já foi descontado do Valor Total Positivo
                saldoPrevisto = valorTotalPositivo - valorTotalNegativo;
                
                // Armazenar este saldo para uso nos próximos meses
                dadosProgressivos.mesesSaldo[mesKey] = saldoPrevisto;
                
                console.log("Mês futuro:", {
                    mesKey,
                    saldoMesAnterior,
                    recebimentosPendentes,
                    detalhesPositivo: saldoMesAnterior < 0 
                        ? `${recebimentosPendentes} - ${Math.abs(saldoMesAnterior)} = ${valorTotalPositivo}` 
                        : `${recebimentosPendentes} + ${saldoMesAnterior} = ${valorTotalPositivo}`,
                    gastosPendentes,
                    faturasNaoPagas,
                    valorTotalPositivo,
                    valorTotalNegativo,
                    saldoPrevisto
                });
            } 
            // Para meses passados, mostrar valores históricos simulados
            else if (isPastMonth) {
                // Para meses passados, simulamos valores que mostrem uma progressão
                // Quanto mais no passado, menores os valores para mostrar evolução
                const fatorRetrocesso = 1 - Math.abs(monthsDiff) * 0.1; // 10% menor por mês no passado
                const fatorMin = 0.5; // Garantir pelo menos 50% dos valores atuais
                
                // Valores base (mais baixos que o atual, para mostrar evolução)
                valorTotalPositivo = Math.max(saldoAtual * 0.8 + recebimentosPendentes * 0.7, 0) * Math.max(fatorRetrocesso, fatorMin);
                valorTotalNegativo = Math.max((gastosPendentes + faturasNaoPagas) * 0.9, 0) * Math.max(fatorRetrocesso, fatorMin);
                saldoPrevisto = valorTotalPositivo - valorTotalNegativo;
                
                // Armazenar este saldo para referência
                dadosProgressivos.mesesSaldo[mesKey] = saldoPrevisto;
                
                console.log("Mês passado:", {
                    monthsDiff,
                    fatorRetrocesso,
                    valorTotalPositivo,
                    valorTotalNegativo,
                    saldoPrevisto
                });
            }
            
            // Atualizar os elementos HTML com os valores calculados
            valorPositivoElement.textContent = `R$ ${valorTotalPositivo.toFixed(2)}`;
            valorNegativoElement.textContent = `R$ ${valorTotalNegativo.toFixed(2)}`;
            saldoPrevistoElement.textContent = `R$ ${saldoPrevisto.toFixed(2)}`;
            
            // Atualizar a cor do saldo previsto
            if (saldoPrevisto < 0) {
                saldoPrevistoElement.style.color = 'var(--danger-color)';
            } else {
                saldoPrevistoElement.style.color = 'var(--secondary-color)';
            }
        }
        
        // Função para formatar data (YYYY-MM-DD para DD/MM/YYYY)
        function formatarData(dataStr) {
            const partes = dataStr.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }
        
        // Configurar os listeners para os botões de ação nos lançamentos
        document.getElementById('fatura-table-body').addEventListener('click', async (event) => {
            const target = event.target.closest('button');
            if (!target) return;

            const gastoId = target.dataset.id;
            if (!gastoId) return;

            const cartaoId = document.querySelector('.cartao-sidebar-item.active').dataset.id;
            
            // Referência ao gasto
            const gastoRef = firestoreDoc(db, 'users', currentUser.uid, 'gastos', gastoId);
            
            // Buscar o gasto para ter acesso à data e obter o ID da fatura
            const gastoSnap = await getDoc(gastoRef);
            if (!gastoSnap.exists()) {
                showNotification('Lançamento não encontrado.', 'error');
                return;
            }
            
            const gasto = gastoSnap.data();
            
            // Busca o cartão para obter o dia de fechamento
            const cartaoRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', cartaoId);
            const cartaoSnap = await getDoc(cartaoRef);
            const cartao = cartaoSnap.data();
            
            // Calcula o mês e ano da fatura
            const dataGasto = new Date(gasto.data + 'T00:00:00');
            let mesFatura = dataGasto.getMonth();
            let anoFatura = dataGasto.getFullYear();
            
            // Ajusta o mês da fatura baseado no dia de fechamento
            if (dataGasto.getDate() > parseInt(cartao.fechamento)) {
                mesFatura += 1;
                if (mesFatura > 11) {
                    mesFatura = 0;
                    anoFatura += 1;
                }
            }
            
            const faturaId = `${anoFatura}-${String(mesFatura + 1).padStart(2, '0')}`;
            const faturaRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', cartaoId, 'faturas', faturaId);

            if (target.classList.contains('delete-btn')) {
                if (confirm('Tem certeza que deseja excluir este lançamento?')) {
                    try {
                        // 1. Primeiro, remover o lançamento da fatura
                        await runTransaction(db, async (transaction) => {
                            const faturaSnap = await transaction.get(faturaRef);
                            if (faturaSnap.exists()) {
                                const faturaData = faturaSnap.data();
                                const valorGasto = parseFloat(gasto.valor);
                                const novoValor = (faturaData.valorTotal || 0) - valorGasto;
                                
                                const novosGastos = { ...(faturaData.gastos || {}) };
                                delete novosGastos[gastoId];
                                
                                // Se não houver mais gastos, excluir a fatura
                                if (Object.keys(novosGastos).length === 0) {
                                    transaction.delete(faturaRef);
                                } else {
                                    transaction.update(faturaRef, { 
                                        valorTotal: novoValor, 
                                        gastos: novosGastos 
                                    });
                                }
                            }
                        });
                        
                        // 2. Depois, excluir o gasto
                        await deleteDoc(gastoRef);
                        
                        showNotification('Lançamento excluído com sucesso!', 'success');
                        loadFaturaAtual(cartaoId);
                    } catch (error) {
                        console.error('Erro ao excluir lançamento:', error);
                        showNotification('Erro ao excluir lançamento.', 'error');
                    }
                }
            } else if (target.classList.contains('edit-btn')) {
                try {
                    const formHtml = `
                        <form id="lancamento-form">
                            <div class="form-group">
                                <label for="lancamento-descricao">Descrição</label>
                                <input type="text" id="lancamento-descricao" name="descricao" value="${gasto.descricao}" required>
                            </div>
                            <div class="form-group">
                                <label for="lancamento-valor">Valor (R$)</label>
                                <input type="number" step="0.01" id="lancamento-valor" name="valor" value="${gasto.valor}" required>
                            </div>
                            <div class="form-group">
                                <label for="lancamento-data">Data</label>
                                <input type="date" id="lancamento-data" name="data" value="${gasto.data}" required>
                            </div>
                            <div class="form-group">
                                <label for="lancamento-categoria">Categoria</label>
                                <select id="lancamento-categoria" name="categoria" required>
                                    <option value="Alimentação" ${gasto.categoria === 'Alimentação' ? 'selected' : ''}>Alimentação</option>
                                    <option value="Transporte" ${gasto.categoria === 'Transporte' ? 'selected' : ''}>Transporte</option>
                                    <option value="Moradia" ${gasto.categoria === 'Moradia' ? 'selected' : ''}>Moradia</option>
                                    <option value="Saúde" ${gasto.categoria === 'Saúde' ? 'selected' : ''}>Saúde</option>
                                    <option value="Educação" ${gasto.categoria === 'Educação' ? 'selected' : ''}>Educação</option>
                                    <option value="Lazer" ${gasto.categoria === 'Lazer' ? 'selected' : ''}>Lazer</option>
                                    <option value="Vestuário" ${gasto.categoria === 'Vestuário' ? 'selected' : ''}>Vestuário</option>
                                    <option value="Outros" ${gasto.categoria === 'Outros' ? 'selected' : ''}>Outros</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Atualizar</button>
                        </form>
                    `;
                    
                    openModal('Editar Lançamento', formHtml, async (data) => {
                        try {
                            const valorAntigo = parseFloat(gasto.valor);
                            const valorNovo = parseFloat(data.valor);
                            const diferencaValor = valorNovo - valorAntigo;
                            
                            // 1. Atualizar a fatura com a diferença de valor
                            await runTransaction(db, async (transaction) => {
                                const faturaSnap = await transaction.get(faturaRef);
                                if (faturaSnap.exists()) {
                                    const faturaData = faturaSnap.data();
                                    const novoValorTotal = (faturaData.valorTotal || 0) + diferencaValor;
                                    
                                    // Atualizar o valor do gasto na fatura
                                    const novosGastos = { ...(faturaData.gastos || {}) };
                                    novosGastos[gastoId] = valorNovo;
                                    
                                    transaction.update(faturaRef, { 
                                        valorTotal: novoValorTotal, 
                                        gastos: novosGastos 
                                    });
                                }
                            });
                            
                            // 2. Atualizar o gasto
                            const novoGastoData = {
                                ...data,
                                metodoPagamento: 'Cartão de Crédito', // Garante que mantenha o método
                                cartaoId: cartaoId, // Garante que mantenha o cartão
                                dataAtualizacao: serverTimestamp()
                            };
                            
                            await updateDoc(gastoRef, novoGastoData);
                            
                            showNotification('Lançamento atualizado com sucesso!', 'success');
                            closeModal();
                            loadFaturaAtual(cartaoId);
                    } catch (error) {
                            console.error('Erro ao atualizar lançamento:', error);
                            showNotification('Erro ao atualizar lançamento.', 'error');
                    }
                    });
                } catch (error) {
                    console.error('Erro ao carregar lançamento:', error);
                    showNotification('Erro ao carregar lançamento.', 'error');
                }
            }
        });
            
        // Adiciona o botão para adicionar novo cartão
        document.getElementById('add-cartao-btn').addEventListener('click', () => {
            const formHtml = `
                <form id="cartao-form">
                    <div class="form-group">
                        <label for="cartao-nome">Nome do Cartão</label>
                        <input type="text" id="cartao-nome" name="nome" required>
                        </div>
                    <div class="form-group">
                        <label for="cartao-final">Final</label>
                        <input type="text" id="cartao-final" name="final" pattern="\\d*" maxlength="4" required>
                    </div>
                    <div class="form-group">
                        <label for="cartao-limite">Limite</label>
                        <input type="number" step="0.01" id="cartao-limite" name="limite" required>
                    </div>
                    <div class="form-group">
                        <label for="cartao-vencimento">Dia do Vencimento</label>
                        <input type="number" id="cartao-vencimento" name="vencimento" min="1" max="31" required>
                    </div>
                    <div class="form-group">
                        <label for="cartao-fechamento">Dia do Fechamento</label>
                        <input type="number" id="cartao-fechamento" name="fechamento" min="1" max="31" required>
                    </div>
                    <div class="form-group">
                        <label for="cartao-status">Status</label>
                        <select id="cartao-status" name="status" required>
                            <option value="Ativo">Ativo</option>
                            <option value="Inativo">Inativo</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Cadastrar</button>
                </form>
            `;
            
            openModal('Adicionar Novo Cartão', formHtml, async (data) => {
                try {
                    const cartaoData = {
                        ...data,
                        dataCriacao: serverTimestamp()
                    };
                    
                    await addDoc(collection(db, 'users', currentUser.uid, 'cartoes'), cartaoData);
                    showNotification('Cartão cadastrado com sucesso!', 'success');
                    closeModal();
                } catch (error) {
                    console.error('Erro ao cadastrar cartão:', error);
                    showNotification('Erro ao cadastrar cartão.', 'error');
                }
            });
        });
              
        // Adiciona o botão para adicionar novo banco
        document.getElementById('add-banco-btn').addEventListener('click', () => {
            const formHtml = `
                <form id="banco-form">
                    <div class="form-group">
                        <label for="banco-nome">Nome do Banco</label>
                        <input type="text" id="banco-nome" name="nome" required>
                    </div>
                    <div class="form-group">
                        <label for="banco-tipo">Tipo de Conta</label>
                        <select id="banco-tipo" name="tipoConta" required>
                            <option value="Conta Corrente">Conta Corrente</option>
                            <option value="Conta Poupança">Conta Poupança</option>
                            <option value="Conta Salário">Conta Salário</option>
                            <option value="Conta Digital">Conta Digital</option>
                            <option value="Conta Conjunta">Conta Conjunta</option>
                            <option value="Outra">Outra</option>
                        </select>
                </div>
                    <div class="form-group">
                        <label for="banco-agencia">Agência</label>
                        <input type="text" id="banco-agencia" name="agencia" required>
                    </div>
                    <div class="form-group">
                        <label for="banco-conta">Conta</label>
                        <input type="text" id="banco-conta" name="conta" required>
                    </div>
                    <div class="form-group">
                        <label for="banco-saldo">Saldo Inicial (R$)</label>
                        <input type="number" step="0.01" id="banco-saldo" name="saldo" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Cadastrar</button>
                </form>
            `;
            
            openModal('Adicionar Novo Banco', formHtml, async (data) => {
                try {
                    const bancoData = {
                        ...data,
                        dataCriacao: serverTimestamp()
                    };
                    
                    await addDoc(collection(db, 'users', currentUser.uid, 'bancos'), bancoData);
                    showNotification('Banco cadastrado com sucesso!', 'success');
                    closeModal();
                } catch (error) {
                    console.error('Erro ao cadastrar banco:', error);
                    showNotification('Erro ao cadastrar banco.', 'error');
                }
            });
        });

        // ... existing code ...
        async function carregarPrevisaoFinanceira() {
            if (!currentUser) return;
            
            // Verificar se já existe a seção de previsão financeira
            // As seções de Balanço Mensal e Previsão Financeira foram completamente removidas
        }

        // Função para pagar fatura de cartão de crédito
        async function pagarFatura(cartaoId, faturaId, valorFatura) {
            try {
                // Buscar bancos do usuário para mostrar no modal
                const bancosRef = collection(db, 'users', currentUser.uid, 'bancos');
                const bancosSnap = await getDocs(bancosRef);
                
                // Verificar se o usuário tem bancos cadastrados
                if (bancosSnap.empty) {
                    showNotification('Você precisa cadastrar um banco antes de pagar uma fatura.', 'warning');
                    return;
                }
                
                // Criar lista de opções de bancos
                let bancosOptions = '';
                const bancos = {};
                
                bancosSnap.forEach(doc => {
                    const banco = doc.data();
                    bancos[doc.id] = banco;
                    bancosOptions += `<option value="${doc.id}">${banco.nome} - Saldo: R$ ${parseFloat(banco.saldo).toFixed(2)}</option>`;
                });
                
                // Criar o formulário do modal
                const formHtml = `
                    <form id="pagar-fatura-form">
                        <div class="form-group">
                            <label for="banco-pagamento">Selecione o banco para pagamento</label>
                            <select id="banco-pagamento" name="bancoId" required>
                                <option value="">Selecione um banco</option>
                                ${bancosOptions}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="data-pagamento">Data de pagamento</label>
                            <input type="date" id="data-pagamento" name="dataPagamento" value="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="valor-pagamento">Valor a pagar</label>
                            <input type="number" step="0.01" id="valor-pagamento" name="valorPagamento" value="${valorFatura}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="observacao-pagamento">Observação (opcional)</label>
                            <textarea id="observacao-pagamento" name="observacao" rows="2"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="fatura-comprovante">Comprovante de Pagamento (opcional)</label>
                            <input type="file" id="fatura-comprovante" name="comprovante" accept="image/*">
                            <small style="display: block; margin-top: 0.5rem; color: var(--subtle-text-color);">
                                Aceita imagens até 5MB. A imagem será convertida para base64 e armazenada no banco de dados.
                            </small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary">Confirmar Pagamento</button>
                    </form>
                `;
                
                // Abrir o modal com o formulário
                openModal('Pagar Fatura', formHtml, async (data) => {
                    try {
                        const bancoId = data.bancoId;
                        const valorPagamento = parseFloat(data.valorPagamento);
                        
                        // Verificar se o banco selecionado existe
                        if (!bancos[bancoId]) {
                            throw new Error('Banco inválido.');
                        }
                        
                        // Verificar se o banco tem saldo suficiente
                        const saldoBanco = parseFloat(bancos[bancoId].saldo);
                        if (saldoBanco < valorPagamento) {
                            throw new Error('Saldo insuficiente para pagar a fatura.');
                        }
                        
                        // Upload do comprovante se existir
                        const comprovanteFile = document.getElementById('fatura-comprovante').files[0];
                        let comprovanteURL = null;
                        
                        if (comprovanteFile) {
                            if (comprovanteFile.size > 5 * 1024 * 1024) { // 5MB
                                throw new Error('O arquivo é muito grande. O tamanho máximo é 5MB.');
                            }
                            
                            const base64Original = await fileToBase64(comprovanteFile);
                            const { base64, redimensionada } = await verificarTamanhoBase64(base64Original, 1);
                            comprovanteURL = base64;
                            
                            if (redimensionada) {
                                showNotification('A imagem foi redimensionada para economizar espaço.', 'info');
                            }
                        }
                        
                        // Registrar o pagamento da fatura
                        const faturaRef = firestoreDoc(db, 'users', currentUser.uid, 'cartoes', cartaoId, 'faturas', faturaId);
                        
                        await runTransaction(db, async (transaction) => {
                            // 1. Primeiro fazemos TODAS as leituras
                            const faturaDoc = await transaction.get(faturaRef);
                            
                            if (!faturaDoc.exists()) {
                                throw new Error('Fatura não encontrada.');
                            }
                            
                            const faturaData = faturaDoc.data();
                            
                            // Leitura do banco
                            const bancoRef = firestoreDoc(db, 'users', currentUser.uid, 'bancos', bancoId);
                            const bancoDoc = await transaction.get(bancoRef);
                            
                            if (!bancoDoc.exists()) {
                                throw new Error('Banco não encontrado.');
                            }
                            
                            // 2. Depois fazemos TODAS as escritas
                            // Atualizar a fatura com informações de pagamento
                            transaction.update(faturaRef, {
                                pago: true,
                                status: "Paga",
                                dataPagamento: data.dataPagamento,
                                valorPago: valorPagamento,
                                bancoId: bancoId,
                                observacao: data.observacao || '',
                                ...(comprovanteURL && { comprovantePagamento: comprovanteURL }),
                                dataAtualizacao: serverTimestamp()
                            });
                            
                            // Atualizar o saldo do banco
                            const novoSaldo = saldoBanco - valorPagamento;
                            transaction.update(bancoRef, { saldo: novoSaldo.toString() });
                            
                            // Registrar o gasto relacionado ao pagamento da fatura
                            const gastoData = {
                                descricao: `Pagamento de fatura - ${bancos[bancoId].nome}`,
                                valor: valorPagamento.toString(),
                                data: data.dataPagamento,
                                categoria: 'Cartão de Crédito',
                                metodoPagamento: 'Transferência',
                                bancoId: bancoId,
                                cartaoId: cartaoId,
                                observacao: `Pagamento da fatura de cartão ${faturaId}`,
                                dataCriacao: serverTimestamp()
                            };
                            
                            const gastoRef = firestoreDoc(collection(db, 'users', currentUser.uid, 'gastos'));
                            transaction.set(gastoRef, gastoData);
                        });
                        
                        showNotification('Fatura paga com sucesso!', 'success');
                        closeModal();
                        
                        // Recarregar os dados
                        if (window.location.hash.startsWith('#cartoes')) {
                            loadCartaoDetalhes(cartaoId);
                } else {
                            loadDashboardData(dashboardMesAtual);
                        }
                    } catch (error) {
                        console.error('Erro ao pagar fatura:', error);
                        showNotification(`Erro ao pagar fatura: ${error.message}`, 'error');
                    }
                });
            } catch (error) {
                console.error('Erro ao preparar pagamento de fatura:', error);
                showNotification('Erro ao preparar pagamento de fatura.', 'error');
            }
        }
        
        // Removido código duplicado da função setupCartaoActions
        
        // --- Sistema de Metas e Limites ---
        
        // Eventos para os botões de gerenciamento de metas e limites
        document.getElementById('btn-gerenciar-metas-rendas').addEventListener('click', function() {
            abrirGerenciadorMetasRendas();
        });
        
        document.getElementById('btn-gerenciar-limites-gastos').addEventListener('click', function() {
            abrirGerenciadorLimitesGastos();
        });
        
        // Função para abrir o gerenciador de metas de rendas
        async function abrirGerenciadorMetasRendas() {
            try {
                if (!currentUser) return;
                
                // Buscar categorias de rendas para o select
                const categoriasRendasRef = collection(db, 'users', currentUser.uid, 'categoriasRendas');
                const categoriasRendasSnap = await getDocs(categoriasRendasRef);
                
                // Categorias padrão + personalizadas
                let opcoesCategorias = `
                    <option value="">Selecione uma categoria</option>
                    <option value="Salário">Salário</option>
                    <option value="Freelance">Freelance</option>
                    <option value="Investimentos">Investimentos</option>
                    <option value="Outros">Outros</option>
                `;
                
                // Adicionar categorias personalizadas
                categoriasRendasSnap.forEach(doc => {
                    const categoria = doc.data();
                    opcoesCategorias += `<option value="${categoria.nome}">${categoria.nome}</option>`;
                });
                
                // Buscar metas existentes
                const metasRendasRef = collection(db, 'users', currentUser.uid, 'metasRendas');
                const metasRendasSnap = await getDocs(metasRendasRef);
                
                // Criar lista de metas existentes
                let listaMetasRendas = '';
                if (metasRendasSnap.empty) {
                    listaMetasRendas = '<p>Você ainda não configurou nenhuma meta de renda.</p>';
                } else {
                    listaMetasRendas = '<div class="metas-list">';
                    metasRendasSnap.forEach(doc => {
                        const meta = doc.data();
                        listaMetasRendas += `
                            <div class="meta-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color);">
                                <div>
                                    <strong>${meta.categoria}</strong><br>
                                    Meta: R$ ${parseFloat(meta.valorMeta).toFixed(2)}
                                </div>
                                <div>
                                    <button class="btn-excluir-meta-renda" data-id="${doc.id}" style="background: none; border: none; cursor: pointer; color: var(--danger-color);">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    listaMetasRendas += '</div>';
                }
                
                // HTML para o modal
                const formHtml = `
                    <div class="metas-rendas-container">
                        <div class="nova-meta-form" style="margin-bottom: 20px;">
                            <h4>Adicionar Nova Meta de Renda</h4>
                            <form id="form-nova-meta-renda">
                                <div class="form-group">
                                    <label for="categoria-meta-renda">Categoria</label>
                                    <select id="categoria-meta-renda" name="categoria" class="form-control" required>
                                        ${opcoesCategorias}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="valor-meta-renda">Valor Meta Mensal (R$)</label>
                                    <input type="number" step="0.01" id="valor-meta-renda" name="valorMeta" class="form-control" required>
                                </div>
                                <div class="form-actions" style="margin-top: 15px;">
                                    <button type="submit" class="btn btn-primary">Adicionar Meta</button>
                                </div>
                            </form>
                        </div>
                        
                        <h4>Metas Existentes</h4>
                        <div id="lista-metas-rendas">
                            ${listaMetasRendas}
                        </div>
                    </div>
                `;
                
                openModal('Gerenciar Metas de Rendas', formHtml);
                
                // Lidar com a adição de nova meta
                document.getElementById('form-nova-meta-renda').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const form = e.target;
                    const categoria = form.categoria.value;
                    const valorMeta = parseFloat(form.valorMeta.value);
                    
                    if (!categoria || !valorMeta || isNaN(valorMeta)) {
                        showNotification('Por favor, preencha todos os campos corretamente.', 'warning');
                        return;
                    }
                    
                    // Verificar se já existe uma meta para esta categoria
                    const metaExistenteQuery = query(metasRendasRef, where("categoria", "==", categoria));
                    const metaExistenteSnap = await getDocs(metaExistenteQuery);
                    
                    if (!metaExistenteSnap.empty) {
                        showNotification('Já existe uma meta para esta categoria. Exclua a meta existente primeiro.', 'warning');
                        return;
                    }
                    
                    try {
                        // Adicionar nova meta
                        await addDoc(metasRendasRef, {
                            categoria: categoria,
                            valorMeta: valorMeta,
                            dataCriacao: serverTimestamp(),
                            dataAtualizacao: serverTimestamp()
                        });
                        
                        showNotification('Meta de renda adicionada com sucesso!', 'success');
                        
                        // Recarregar o modal
                        closeModal();
                        abrirGerenciadorMetasRendas();
                        
                        // Atualizar o dashboard se estiver na página inicial
                        if (window.location.hash === '#dashboard' || window.location.hash === '') {
                            carregarMetasDashboard();
                        }
                    } catch (error) {
                        console.error('Erro ao adicionar meta de renda:', error);
                        showNotification('Erro ao adicionar meta de renda.', 'error');
                    }
                });
                
                // Adicionar listeners para excluir metas
                document.querySelectorAll('.btn-excluir-meta-renda').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('Tem certeza que deseja excluir esta meta?')) {
                            const metaId = btn.dataset.id;
                            
                            try {
                                await deleteDoc(firestoreDoc(db, 'users', currentUser.uid, 'metasRendas', metaId));
                                showNotification('Meta excluída com sucesso!', 'success');
                                
                                // Recarregar modal
                                closeModal();
                                abrirGerenciadorMetasRendas();
                                
                                // Atualizar dashboard se estiver na página inicial
                                if (window.location.hash === '#dashboard' || window.location.hash === '') {
                                    carregarMetasDashboard();
                                }
                            } catch (error) {
                                console.error('Erro ao excluir meta:', error);
                                showNotification('Erro ao excluir meta.', 'error');
                            }
                        }
                    });
                });
                
            } catch (error) {
                console.error('Erro ao carregar gerenciador de metas de rendas:', error);
                showNotification('Erro ao carregar gerenciador de metas.', 'error');
            }
        }
        
        // Função para abrir o gerenciador de limites de gastos
        async function abrirGerenciadorLimitesGastos() {
            try {
                if (!currentUser) return;
                
                // Buscar categorias de gastos para o select
                const categoriasGastosRef = collection(db, 'users', currentUser.uid, 'categorias');
                const categoriasGastosSnap = await getDocs(categoriasGastosRef);
                
                // Categorias padrão + personalizadas
                let opcoesCategorias = `
                    <option value="">Selecione uma categoria</option>
                    <option value="Alimentação">Alimentação</option>
                    <option value="Transporte">Transporte</option>
                    <option value="Moradia">Moradia</option>
                    <option value="Saúde">Saúde</option>
                    <option value="Educação">Educação</option>
                    <option value="Lazer">Lazer</option>
                    <option value="Vestuário">Vestuário</option>
                    <option value="Outros">Outros</option>
                `;
                
                // Adicionar categorias personalizadas
                categoriasGastosSnap.forEach(doc => {
                    const categoria = doc.data();
                    opcoesCategorias += `<option value="${categoria.nome}">${categoria.nome}</option>`;
                });
                
                // Buscar limites existentes
                const limitesGastosRef = collection(db, 'users', currentUser.uid, 'limitesGastos');
                const limitesGastosSnap = await getDocs(limitesGastosRef);
                
                // Criar lista de limites existentes
                let listaLimitesGastos = '';
                if (limitesGastosSnap.empty) {
                    listaLimitesGastos = '<p>Você ainda não configurou nenhum limite de gasto.</p>';
                } else {
                    listaLimitesGastos = '<div class="limites-list">';
                    limitesGastosSnap.forEach(doc => {
                        const limite = doc.data();
                        listaLimitesGastos += `
                            <div class="limite-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color);">
                                <div>
                                    <strong>${limite.categoria}</strong><br>
                                    Limite: R$ ${parseFloat(limite.valorLimite).toFixed(2)}
                                </div>
                                <div>
                                    <button class="btn-excluir-limite-gasto" data-id="${doc.id}" style="background: none; border: none; cursor: pointer; color: var(--danger-color);">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    listaLimitesGastos += '</div>';
                }
                
                // HTML para o modal
                const formHtml = `
                    <div class="limites-gastos-container">
                        <div class="novo-limite-form" style="margin-bottom: 20px;">
                            <h4>Adicionar Novo Limite de Gasto</h4>
                            <form id="form-novo-limite-gasto">
                                <div class="form-group">
                                    <label for="categoria-limite-gasto">Categoria</label>
                                    <select id="categoria-limite-gasto" name="categoria" class="form-control" required>
                                        ${opcoesCategorias}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="valor-limite-gasto">Valor Limite Mensal (R$)</label>
                                    <input type="number" step="0.01" id="valor-limite-gasto" name="valorLimite" class="form-control" required>
                                </div>
                                <div class="form-actions" style="margin-top: 15px;">
                                    <button type="submit" class="btn btn-primary">Adicionar Limite</button>
                                </div>
                            </form>
                        </div>
                        
                        <h4>Limites Existentes</h4>
                        <div id="lista-limites-gastos">
                            ${listaLimitesGastos}
                        </div>
                    </div>
                `;
                
                openModal('Gerenciar Limites de Gastos', formHtml);
                
                // Lidar com a adição de novo limite
                document.getElementById('form-novo-limite-gasto').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const form = e.target;
                    const categoria = form.categoria.value;
                    const valorLimite = parseFloat(form.valorLimite.value);
                    
                    if (!categoria || !valorLimite || isNaN(valorLimite)) {
                        showNotification('Por favor, preencha todos os campos corretamente.', 'warning');
                        return;
                    }
                    
                    // Verificar se já existe um limite para esta categoria
                    const limiteExistenteQuery = query(limitesGastosRef, where("categoria", "==", categoria));
                    const limiteExistenteSnap = await getDocs(limiteExistenteQuery);
                    
                    if (!limiteExistenteSnap.empty) {
                        showNotification('Já existe um limite para esta categoria. Exclua o limite existente primeiro.', 'warning');
                        return;
                    }
                    
                    try {
                        // Adicionar novo limite
                        await addDoc(limitesGastosRef, {
                            categoria: categoria,
                            valorLimite: valorLimite,
                            dataCriacao: serverTimestamp(),
                            dataAtualizacao: serverTimestamp()
                        });
                        
                        showNotification('Limite de gasto adicionado com sucesso!', 'success');
                        
                        // Recarregar o modal
                        closeModal();
                        abrirGerenciadorLimitesGastos();
                        
                        // Atualizar o dashboard se estiver na página inicial
                        if (window.location.hash === '#dashboard' || window.location.hash === '') {
                            carregarMetasDashboard();
                        }
                    } catch (error) {
                        console.error('Erro ao adicionar limite de gasto:', error);
                        showNotification('Erro ao adicionar limite de gasto.', 'error');
                    }
                });
                
                // Adicionar listeners para excluir limites
                document.querySelectorAll('.btn-excluir-limite-gasto').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('Tem certeza que deseja excluir este limite?')) {
                            const limiteId = btn.dataset.id;
                            
                            try {
                                await deleteDoc(firestoreDoc(db, 'users', currentUser.uid, 'limitesGastos', limiteId));
                                showNotification('Limite excluído com sucesso!', 'success');
                                
                                // Recarregar modal
                                closeModal();
                                abrirGerenciadorLimitesGastos();
                                
                                // Atualizar dashboard se estiver na página inicial
                                if (window.location.hash === '#dashboard' || window.location.hash === '') {
                                    carregarMetasDashboard();
                                }
                            } catch (error) {
                                console.error('Erro ao excluir limite:', error);
                                showNotification('Erro ao excluir limite.', 'error');
                            }
                        }
                    });
                });
                
            } catch (error) {
                console.error('Erro ao carregar gerenciador de limites de gastos:', error);
                showNotification('Erro ao carregar gerenciador de limites.', 'error');
            }
        }
        
        // Função para carregar metas no dashboard
        async function carregarMetasDashboard() {
            try {
                if (!currentUser) return;
                
                // Elementos do DOM
                const dashboardMetasList = document.getElementById('dashboard-metas-list');
                const dashboardMetasLoading = document.getElementById('dashboard-metas-loading');
                const dashboardMetasEmpty = document.getElementById('dashboard-metas-empty');
                
                dashboardMetasLoading.style.display = 'block';
                dashboardMetasEmpty.style.display = 'none';
                dashboardMetasList.style.display = 'none';
                
                // Buscar metas de rendas
                const metasRendasRef = collection(db, 'users', currentUser.uid, 'metasRendas');
                const metasRendasSnap = await getDocs(metasRendasRef);
                
                // Buscar limites de gastos
                const limitesGastosRef = collection(db, 'users', currentUser.uid, 'limitesGastos');
                const limitesGastosSnap = await getDocs(limitesGastosRef);
                
                // Verificar se há metas ou limites configurados
                if (metasRendasSnap.empty && limitesGastosSnap.empty) {
                    dashboardMetasLoading.style.display = 'none';
                    dashboardMetasEmpty.style.display = 'block';
                    return;
                }
                
                // Obter o início e fim do mês para filtrar os dados
                const inicioDoMes = new Date(dashboardMesAtual.getFullYear(), dashboardMesAtual.getMonth(), 1);
                const fimDoMes = new Date(dashboardMesAtual.getFullYear(), dashboardMesAtual.getMonth() + 1, 0);
                
                // Formatar para comparação com string ISO
                const inicioDoMesStr = inicioDoMes.toISOString().split('T')[0];
                const fimDoMesStr = fimDoMes.toISOString().split('T')[0];
                
                // Buscar todas as rendas do mês
                const rendasRef = collection(db, 'users', currentUser.uid, 'rendas');
                const rendasQuery = query(
                    rendasRef, 
                    where("data", ">=", inicioDoMesStr),
                    where("data", "<=", fimDoMesStr)
                );
                const rendasSnap = await getDocs(rendasQuery);
                
                // Calcular valor total por categoria de renda
                const rendasPorCategoria = {};
                rendasSnap.forEach(doc => {
                    const renda = doc.data();
                    const categoria = renda.categoria;
                    const valor = parseFloat(renda.valor);
                    
                    if (!rendasPorCategoria[categoria]) {
                        rendasPorCategoria[categoria] = 0;
                    }
                    rendasPorCategoria[categoria] += valor;
                });
                
                // Buscar todos os gastos do mês
                const gastosRef = collection(db, 'users', currentUser.uid, 'gastos');
                const gastosQuery = query(
                    gastosRef, 
                    where("data", ">=", inicioDoMesStr),
                    where("data", "<=", fimDoMesStr)
                );
                const gastosSnap = await getDocs(gastosQuery);
                
                // Calcular valor total por categoria de gasto
                const gastosPorCategoria = {};
                gastosSnap.forEach(doc => {
                    const gasto = doc.data();
                    const categoria = gasto.categoria;
                    const valor = parseFloat(gasto.valor);
                    
                    if (!gastosPorCategoria[categoria]) {
                        gastosPorCategoria[categoria] = 0;
                    }
                    gastosPorCategoria[categoria] += valor;
                });
                
                // Construir HTML para exibir as metas
                dashboardMetasList.innerHTML = '';
                
                // Adicionar metas de rendas
                if (!metasRendasSnap.empty) {
                    const metasRendasHTML = document.createElement('div');
                    metasRendasHTML.className = 'metas-container';
                    metasRendasHTML.innerHTML = '<h4 style="margin-top: 0;">Metas de Rendas</h4>';
                    
                    metasRendasSnap.forEach(doc => {
                        const meta = doc.data();
                        const categoriaRenda = meta.categoria;
                        const valorMeta = parseFloat(meta.valorMeta);
                        const valorAtual = rendasPorCategoria[categoriaRenda] || 0;
                        const percentual = (valorAtual / valorMeta) * 100;
                        
                        // Determinar cor da barra de progresso
                        let progressColor;
                        if (percentual >= 100) {
                            progressColor = 'var(--secondary-color)'; // verde
                        } else if (percentual >= 75) {
                            progressColor = '#4CAF50'; // verde mais claro
                        } else if (percentual >= 50) {
                            progressColor = '#FFC107'; // amarelo
                        } else {
                            progressColor = '#FF9800'; // laranja
                        }
                        
                        metasRendasHTML.innerHTML += `
                            <div class="meta-item" style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <strong>${categoriaRenda}</strong>
                                    <span>R$ ${valorAtual.toFixed(2)} / R$ ${valorMeta.toFixed(2)}</span>
                                </div>
                                <div style="background-color: #f1f1f1; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 8px; width: ${Math.min(percentual, 100)}%; background-color: ${progressColor};"></div>
                                </div>
                                <div style="text-align: right; margin-top: 3px; font-size: 0.85rem; color: var(--subtle-text-color);">
                                    ${percentual.toFixed(0)}%
                                </div>
                            </div>
                        `;
                    });
                    
                    dashboardMetasList.appendChild(metasRendasHTML);
                }
                
                // Adicionar limites de gastos
                if (!limitesGastosSnap.empty) {
                    const limitesGastosHTML = document.createElement('div');
                    limitesGastosHTML.className = 'limites-container';
                    limitesGastosHTML.innerHTML = '<h4 style="margin-top: 20px;">Limites de Gastos</h4>';
                    
                    limitesGastosSnap.forEach(doc => {
                        const limite = doc.data();
                        const categoriaGasto = limite.categoria;
                        const valorLimite = parseFloat(limite.valorLimite);
                        const valorAtual = gastosPorCategoria[categoriaGasto] || 0;
                        const percentual = (valorAtual / valorLimite) * 100;
                        
                        // Determinar cor da barra de progresso
                        let progressColor;
                        if (percentual >= 100) {
                            progressColor = 'var(--danger-color)'; // vermelho
                        } else if (percentual >= 90) {
                            progressColor = '#FF5722'; // laranja avermelhado
                        } else if (percentual >= 75) {
                            progressColor = '#FFC107'; // amarelo
                        } else {
                            progressColor = '#4CAF50'; // verde
                        }
                        
                        limitesGastosHTML.innerHTML += `
                            <div class="limite-item" style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <strong>${categoriaGasto}</strong>
                                    <span>R$ ${valorAtual.toFixed(2)} / R$ ${valorLimite.toFixed(2)}</span>
                                </div>
                                <div style="background-color: #f1f1f1; border-radius: 4px; overflow: hidden;">
                                    <div style="height: 8px; width: ${Math.min(percentual, 100)}%; background-color: ${progressColor};"></div>
                                </div>
                                <div style="text-align: right; margin-top: 3px; font-size: 0.85rem; color: var(--subtle-text-color);">
                                    ${percentual.toFixed(0)}%
                                </div>
                            </div>
                        `;
                    });
                    
                    dashboardMetasList.appendChild(limitesGastosHTML);
                }
                
                // Exibir metas
                dashboardMetasLoading.style.display = 'none';
                dashboardMetasList.style.display = 'block';
                
            } catch (error) {
                console.error('Erro ao carregar metas:', error);
                document.getElementById('dashboard-metas-loading').style.display = 'none';
                document.getElementById('dashboard-metas-empty').style.display = 'block';
                document.getElementById('dashboard-metas-empty').innerHTML = `
                    <i class="fas fa-exclamation-circle" style="font-size: 2rem; margin-bottom: 1rem; color: var(--danger-color);"></i>
                    <p>Erro ao carregar metas personalizadas.</p>
                `;
            }
        }
    </script>
    
    <!-- CSS Responsivo para Mobile -->
    <style>
        /* Estilo para o botão de menu mobile */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
        }
        
        /* Classes para controlar a visibilidade do menu em dispositivos móveis */
        .sidebar-mobile-hidden {
            display: none !important;
        }
        
        .sidebar-mobile-visible {
            display: block !important; /* Alterado para block em vez de flex */
            position: fixed;
            top: 60px;
            left: 0;
            width: 100%;
            height: auto;
            z-index: 1000;
            background-color: var(--surface-color);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        /* Media Queries para Responsividade */
        @media (max-width: 1024px) {
            #app-container {
                grid-template-columns: 220px 1fr;
            }
            
            .sidebar {
                padding: 1rem;
            }
            
            .sidebar-header {
                font-size: 1.25rem;
                margin-bottom: 1.5rem;
            }
            
            .sidebar nav li a {
                padding: 0.75rem 0.75rem;
                margin-bottom: 0.4rem;
            }
        }
        
        @media (max-width: 768px) {
            /* Ajuste específico para a página de cartões em tablet */
            #cartoes-page .card > div {
                grid-template-columns: 1fr !important;
                display: flex !important;
                flex-direction: column !important;
                height: auto !important;
            }

            .mobile-menu-toggle {
                display: block;
            }
            
            #app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                grid-template-areas:
                    "topbar"
                    "main";
            }
            
            .sidebar {
                display: none; /* Escondido por padrão em mobile */
                grid-area: unset;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: 1rem;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .sidebar nav ul {
                display: block; /* Alterado para block para layout vertical */
                width: 100%;
                padding-bottom: 0.5rem;
            }
            
            .sidebar nav li {
                margin-bottom: 0.5rem;
                width: 100%;
            }
            
            .sidebar nav li a {
                padding: 0.75rem 1rem;
                margin-bottom: 0;
                white-space: nowrap;
                display: flex;
                align-items: center;
                width: 100%;
                font-size: 1rem;
            }
            
            .sidebar nav li a span {
                display: inline-block;
                margin-left: 10px;
            }
            
            .sidebar-header {
                display: none;
            }
            
            .logout-link {
                margin-top: 1rem;
                width: 100%;
                text-align: center;
                padding: 0.75rem !important;
                color: var(--danger-color) !important;
                border-top: 1px solid var(--border-color);
            }
            
            .topbar {
                padding: 0 1rem;
                height: 60px;
            }
            
            main {
                padding: 1rem;
            }
            
            /* Adaptações para tabelas */
            .data-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            /* Dashboard e cards */
            #dashboard-cards-container {
                grid-template-columns: 1fr;
            }
            
            .dashboard-card {
                margin-bottom: 1rem;
            }
            
            /* Autenticação */
            #auth-container {
                width: 90%;
                max-width: 400px;
                padding: 1rem;
                margin: 0.5rem auto;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            }
            
            #auth-container h1 {
                font-size: 1.5rem;
            }
            
            #auth-container p {
                font-size: 0.9rem;
                margin-bottom: 1rem;
            }
            
            .auth-tab {
                padding: 0.5rem;
                font-size: 0.9rem;
            }
            
            .form-group {
                margin-bottom: 0.75rem;
            }
            
            .form-group input:not([type="checkbox"]),
            .form-group select,
            .form-group textarea {
                padding: 0.5rem;
                font-size: 16px; /* Prevenir zoom no iOS */
            }
        }
        
        @media (max-width: 576px) {
            .topbar h2 {
                font-size: 1.1rem;
            }
            
            .user-profile span {
                display: none;
            }
            
            /* Cartões de crédito */
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .card-header button {
                width: 100%;
            }
            
            /* Layout específico para cartões */
            #cartoes-page .card {
                overflow: visible !important;
                height: auto !important;
            }
            
            #cartoes-page .card > div {
                grid-template-columns: 1fr !important;
                height: auto !important;
                overflow: visible !important;
                max-height: none !important;
                display: block !important;
            }
            
            #cartoes-page .card > div > div {
                overflow: visible !important;
                height: auto !important;
                max-height: none !important;
                overflow-x: hidden !important;
            }
            
            #cartao-detalhe {
                overflow: visible !important;
                height: auto !important;
            }
            
            #cartoes-page .cartao-fatura,
            #cartoes-page .cartao-header {
                margin: 1rem 0;
            }
            
            #cartao-detalhe-vazio {
                height: 200px !important;
            }
            
            /* Ajuste para cards de dashboard */
            .dashboard-card {
                flex: 1 1 100%;
            }
            
            /* Ajustes para o Modal */
            .modal-content {
                width: 95%;
                padding: 1rem;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .modal-body {
                max-height: 70vh;
                overflow-y: auto;
                padding-right: 0.5rem;
            }
            
            .modal-footer {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .modal-footer button {
                width: 100%;
            }
            
            /* Formulários responsivos */
            .form-group input, .form-group select {
                font-size: 16px; /* Previne zoom em dispositivos iOS */
            }
            
            /* Bancos e movimentações */
            .mes-navigation {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
            }
            
            /* Dashboard */
            .dashboard-section .card-header {
                padding: 0.75rem 1rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .dashboard-section .card-header .btn {
                width: 100%;
                padding: 0.5rem;
            }
            
            /* Dashboard cards de resumo */
            #dashboard-resumo-cards {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            #dashboard-resumo-cards .dashboard-card {
                flex: 1 1 45%;
                min-width: 130px;
                margin-bottom: 0.5rem;
            }
            
            /* Gráficos responsivos */
            .dashboard-chart-container {
                height: auto !important;
                min-height: 250px;
                max-height: 300px;
            }
            
            /* Ajustes de layout para faturas e cartões */
            .cartao-visual {
                padding: 1rem;
            }
            
            .info-box {
                padding: 0.75rem;
            }
            
            /* Ajustes para navegação de faturas */
            .fatura-navigation {
                display: flex;
                flex-direction: column;
                width: 100%;
                margin-bottom: 1rem;
            }
            
            .fatura-navigation button {
                margin: 0.25rem 0;
                width: 100%;
            }
            
            /* Ajustes para visualização de comprovantes */
            .comprovante-img {
                max-width: 100%;
                height: auto;
            }
            
            /* Ajustes para botões nos cards */
            .btn {
                padding: 0.75rem;
            }
        }
    </style>
    
    <!-- Script para gerenciamento de menu em dispositivos móveis -->
    <script>
        // Função para configurar o menu mobile
        function setupMobileMenu() {
            // Após o DOM estar completamente carregado
            document.addEventListener('DOMContentLoaded', () => {
                // Configuração inicial e depois a cada 500ms para garantir que tudo foi carregado
                const initMobileMenu = () => {
                    const menuToggle = document.getElementById('mobile-menu-toggle');
                    const sidebar = document.getElementById('app-sidebar');
                    
                    if (menuToggle && sidebar) {
                        // Adicionar evento de clique no botão do menu
                        menuToggle.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Toggle da classe para mostrar/ocultar o sidebar
                            if (sidebar.classList.contains('sidebar-mobile-visible')) {
                                sidebar.classList.remove('sidebar-mobile-visible');
                            } else {
                                sidebar.classList.add('sidebar-mobile-visible');
                            }
                        });
                        
                        // Fechar o menu ao clicar em um link
                        const navLinks = sidebar.querySelectorAll('.nav-link');
                        navLinks.forEach(link => {
                            link.addEventListener('click', () => {
                                if (window.innerWidth <= 768) {
                                    sidebar.classList.remove('sidebar-mobile-visible');
                                }
                            });
                        });
                        
                        // Fechar o menu ao clicar fora
                        document.body.addEventListener('click', (e) => {
                            if (sidebar.classList.contains('sidebar-mobile-visible')) {
                                if (!sidebar.contains(e.target) && e.target !== menuToggle && !menuToggle.contains(e.target)) {
                                    sidebar.classList.remove('sidebar-mobile-visible');
                                }
                            }
                        });
                        
                        // Fechar o menu ao redimensionar para desktop
                        window.addEventListener('resize', () => {
                            if (window.innerWidth > 768) {
                                sidebar.classList.remove('sidebar-mobile-visible');
                            }
                        });
                    }
                };
                
                // Iniciar configuração e repetir algumas vezes para garantir
                initMobileMenu();
                setTimeout(initMobileMenu, 500);
                setTimeout(initMobileMenu, 1500);
            });
        }
        
        // Iniciar configuração do menu mobile
        setupMobileMenu();
    </script>
    <script>
        // As funções relacionadas a horas extras foram movidas para o arquivo js/compatibility.js
    </script>
</body>
</html>
